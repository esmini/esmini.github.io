<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>esmini user guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>esmini user guide</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a></li>
<li><a href="#_getting_started">2. Getting started</a>
<ul class="sectlevel2">
<li><a href="#_run_esmini">2.1. Run esmini</a></li>
<li><a href="#_get_complete_esmini">2.2. Get complete esmini</a></li>
<li><a href="#_build_esmini_quick_guide">2.3. Build esmini - quick guide</a></li>
</ul>
</li>
<li><a href="#_tools_overview">3. Tools overview</a>
<ul class="sectlevel2">
<li><a href="#_applications">3.1. Applications</a></li>
<li><a href="#_scripts">3.2. Scripts</a></li>
<li><a href="#_shared_libraries">3.3. Shared libraries</a></li>
</ul>
</li>
<li><a href="#_use_cases">4. Use cases</a>
<ul class="sectlevel2">
<li><a href="#_view_a_scenario">4.1. View a scenario</a></li>
<li><a href="#_screenshots_and_video_clips">4.2. Screenshots and video clips</a></li>
<li><a href="#_logging">4.3. Logging</a></li>
<li><a href="#_replay_scenario">4.4. Replay scenario</a></li>
<li><a href="#_view_road_network">4.5. View road network</a></li>
<li><a href="#_plot_scenario_data">4.6. Plot scenario data</a></li>
<li><a href="#_save_osi_data">4.7. Save OSI data</a></li>
</ul>
</li>
<li><a href="#_scenario_features">5. Scenario features</a>
<ul class="sectlevel2">
<li><a href="#_speed_profile">5.1. Speed profile</a></li>
<li><a href="#_condition_delay">5.2. Condition delay</a></li>
<li><a href="#_road_signs">5.3. Road signs</a></li>
<li><a href="#_expressions">5.4. Expressions</a></li>
<li><a href="#_parameter_distributions">5.5. Parameter distributions</a></li>
<li><a href="#_trajectories">5.6. Trajectories</a></li>
<li><a href="#_friction">5.7. Friction</a></li>
<li><a href="#_sumo_integration">5.8. SUMO integration</a></li>
</ul>
</li>
<li><a href="#_positioning">6. Positioning</a>
<ul class="sectlevel2">
<li><a href="#_position_modes">6.1. Position modes</a></li>
<li><a href="#_mode_specification">6.2. Mode specification</a></li>
<li><a href="#_trajectory_interpolation_and_alignment">6.3. Trajectory interpolation and alignment</a></li>
<li><a href="#_example_2">6.4. Example</a></li>
<li><a href="#_relative_positions_and_routes">6.5. Relative positions and routes</a></li>
<li><a href="#_reference_line_and_center_lane">6.6. Reference line and center lane</a></li>
</ul>
</li>
<li><a href="#_controllers">7. Controllers</a>
<ul class="sectlevel2">
<li><a href="#_controller_concept">7.1. Controller concept</a></li>
<li><a href="#_background_and_motivation">7.2. Background and motivation</a></li>
<li><a href="#_brief_on_implementation">7.3. Brief on implementation</a></li>
<li><a href="#_how_it_works_for_the_user">7.4. How it works for the user</a></li>
<li><a href="#_the_ghost_concept">7.5. The ghost concept</a></li>
<li><a href="#_esmini_embedded_controllers">7.6. esmini embedded controllers</a></li>
<li><a href="#_how_to_add_a_new_controller">7.7. How to add a new controller</a></li>
</ul>
</li>
<li><a href="#_openscenegraph_and_3d_models">8. OpenSceneGraph and 3D models</a>
<ul class="sectlevel2">
<li><a href="#_get_osgconv">8.1. Get osgconv</a></li>
<li><a href="#_convert_osgb_models_for_use_in_unity">8.2. Convert osgb models for use in Unity</a></li>
<li><a href="#_import_into_unity">8.3. Import into Unity</a></li>
<li><a href="#_colors_textures_and_wheel_rotations">8.4. Colors, textures and wheel rotations</a></li>
<li><a href="#_lighting">8.5. Lighting</a></li>
</ul>
</li>
<li><a href="#_support_qa">9. Support / Q&amp;A</a>
<ul class="sectlevel2">
<li><a href="#_various_issues">9.1. Various issues</a></li>
<li><a href="#_further_issues_at_esmini_github_page">9.2. Further issues at esmini GitHub page</a></li>
</ul>
</li>
<li><a href="#_command_reference">10. Command reference</a>
<ul class="sectlevel2">
<li><a href="#_esmini">10.1. esmini</a></li>
<li><a href="#_replayer">10.2. replayer</a></li>
<li><a href="#_odrviewer">10.3. odrviewer</a></li>
<li><a href="#_plot_dat_py">10.4. plot_dat.py</a></li>
</ul>
</li>
<li><a href="#_build_guide">11. Build guide</a>
<ul class="sectlevel2">
<li><a href="#_build_configurations_in_visual_studio_and_visual_studio_code">11.1. Build configurations in Visual Studio and Visual Studio Code</a></li>
<li><a href="#_build_configurations_from_command_line">11.2. Build configurations from command line</a></li>
<li><a href="#_external_dependencies">11.3. External dependencies</a></li>
<li><a href="#_additional_platform_dependencies">11.4. Additional platform dependencies</a></li>
<li><a href="#_run_and_debug_with_linux_and_visual_studio_code">11.5. Run and Debug with Linux and visual studio code</a></li>
<li><a href="#_dynamic_protobuf_linking">11.6. Dynamic protobuf linking</a></li>
<li><a href="#_slim_esmini_customize_configration">11.7. Slim esmini - customize configration</a></li>
<li><a href="#_msys2_mingw_w64_support">11.8. MSYS2 / MinGW-w64 support</a></li>
<li><a href="#_build_esmini_project">11.9. Build esmini project</a></li>
<li><a href="#_centos_7_linux">11.10. CentOS 7 (Linux)</a></li>
</ul>
</li>
<li><a href="#_for_esmini_developers_and_contributors">12. For esmini developers and contributors</a>
<ul class="sectlevel2">
<li><a href="#_branch_strategy">12.1. Branch strategy</a></li>
<li><a href="#_formatting">12.2. Formatting</a></li>
<li><a href="#_test">12.3. Test</a></li>
<li><a href="#_sanitizers">12.4. Sanitizers</a></li>
</ul>
</li>
<li><a href="#_esmini_lib_programming">13. esmini lib programming</a>
<ul class="sectlevel2">
<li><a href="#_about_the_lib_itself">13.1. About the lib itself</a></li>
<li><a href="#_how_to_interact_with_esmini_lib_api">13.2. How to interact with esmini lib API</a></li>
<li><a href="#_functionality">13.3. Functionality</a></li>
<li><a href="#_simplest_example">13.4. Simplest example</a></li>
</ul>
</li>
<li><a href="#_hello_world_programming_tutorial">14. Hello World programming tutorial</a>
<ul class="sectlevel2">
<li><a href="#preparations">14.1. Preparations</a></li>
<li><a href="#_how_to_build_run_and_debug_hello_world">14.2. How to build, run and debug "Hello World"</a></li>
<li><a href="#_examples_2">14.3. Examples</a></li>
<li><a href="#_python_binding">14.4. Python binding</a></li>
<li><a href="#_c_binding">14.5. C# binding</a></li>
</ul>
</li>
<li><a href="#_scenario_construction_tips">15. Scenario construction tips</a>
<ul class="sectlevel2">
<li><a href="#_opendrive">15.1. OpenDRIVE</a></li>
<li><a href="#_openscenario_xml">15.2. OpenSCENARIO XML</a></li>
<li><a href="#_scenario_creation_tips_examples">15.3. Examples</a></li>
</ul>
</li>
<li><a href="#_run_asam_openscenario_examples">16. Run ASAM OpenSCENARIO examples</a></li>
<li><a href="#_about_this_document">17. About this document</a>
<ul class="sectlevel2">
<li><a href="#_how_to_generate_html_from_asciidoc">17.1. How to generate HTML from AsciiDoc</a></li>
<li><a href="#_how_to_view_previous_versions">17.2. How to view previous versions</a></li>
</ul>
</li>
<li><a href="#_version">18. Version</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><img src="https://avatars.githubusercontent.com/u/49203938" alt="160" width="160"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>esmini is a software tool to play OpenSCENARIO XML files. It&#8217;s provided both as a stand alone application and as a shared library for linking with custom applications. In addition some tools have been developed to support design and analysis of traffic scenarios.</p>
</div>
<div class="paragraph">
<p>The scope of this user guide is to provide examples on how to use the tools. It also includes a programming tutorial on how to use esmini in custom applications.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started">2. Getting started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Download latest release from here: <a href="https://github.com/esmini/esmini/releases/latest" class="bare">https://github.com/esmini/esmini/releases/latest</a></p>
</div>
<div class="paragraph">
<p>First time make sure to pick the demo package for your platform (Windows, Linux or Mac). In addition to application binaries it also includes some content like example scenarios and basic 3D models. The binary (bin) packages includes only executables and libraries.</p>
</div>
<div class="paragraph">
<p>On Windows, make sure the zip file is not blocked: Right click, click Properties, at bottom right check Unblock. For more info, see <a href="#_blocked_by_windows_defender_smartscreen">Blocked by Windows Defender SmartScreen</a>.</p>
</div>
<div class="paragraph">
<p>To install the package, just unzip it anywhere. A single subfolder named <code>esmini</code> is created. This is the root folder for esmini. No files are stored outside this folder structure and no system files or registry is modified in any way.</p>
</div>
<div class="sect2">
<h3 id="_run_esmini">2.1. Run esmini</h3>
<div class="paragraph">
<p>Try to run one of the examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>go to folder esmini/run/esmini</p>
</li>
<li>
<p>double click on a .bat file, e.g. <code>run_cut-in.bat</code> or run it from a command line.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These scripts should work on all platforms (in spite extension ".bat").</p>
</div>
<div class="paragraph">
<p>You can also run the examples explicitly from a command line:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc</code></p>
</div>
<div class="paragraph">
<p>For common Mac issues, please see <a href="#_mac_issues_and_limitations">Mac issues and limitations</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_get_complete_esmini">2.2. Get complete esmini</h3>
<div class="paragraph">
<p>The demo package contains only a subset of esmini tools and content (e.g. scenario examples, scripts and models).</p>
</div>
<div class="paragraph">
<p>To get the complete content, first download or clone the project from GitHub: <a href="https://github.com/esmini/esmini" class="bare">https://github.com/esmini/esmini</a>. E.g:<br>
<code>git clone https://github.com/esmini/esmini.git</code></p>
</div>
<div class="paragraph">
<p>Then either build yourself, see step 2 in next chapter <a href="#_build_esmini_quick_guide">Build esmini - quick guide</a>, or:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download pre-built binary package for your system (e.g. esmini-bin_win_x64.zip) from latest release:
<a href="https://github.com/esmini/esmini/releases" class="bare">https://github.com/esmini/esmini/releases</a>. Copy the content into the esmini-demo folder.</p>
</li>
<li>
<p>Download the complete 3D model package from <a href="https://dl.dropboxusercontent.com/s/5gk8bvgzqiaaoco/models.7z?dl=1">here</a>. Unpack into esmini/resources (it should end up in a <code>models</code> subfolder). These assets work on all platforms. The environment models (roads, landscape, buildings&#8230;&#8203;) have been created using <a href="https://vires.mscsoftware.com/solutions/3d-environment-road-network">VIRES Road Network Editor</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_build_esmini_quick_guide">2.3. Build esmini - quick guide</h3>
<div class="paragraph">
<p>Supported systems: Windows, Linux and Mac.</p>
</div>
<div class="paragraph">
<p>Make sure you have a C++ compiler and <a href="https://cmake.org/">CMake</a> installed.</p>
</div>
<div class="paragraph">
<p>On Windows <a href="https://visualstudio.microsoft.com/">Visual Studio</a> is recommended (Community/free version is good enough for building esmini). Make sure to check the "Desktop development with C++" package for installation, no more is needed.</p>
</div>
<div class="paragraph">
<p>On Linux, e.g. Ubuntu, some additional system tools and libraries are needed. Run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>sudo apt install build-essential gdb ninja-build git pkg-config libgl1-mesa-dev libpthread-stubs0-dev libjpeg-dev libxml2-dev libpng-dev libtiff5-dev libgdal-dev libpoppler-dev libdcmtk-dev libgstreamer1.0-dev libgtk2.0-dev libcairo2-dev libpoppler-glib-dev libxrandr-dev libxinerama-dev curl cmake black</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;re ready to build esmini. From esmini root folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>mkdir build
cd build
cmake ..
cmake --build . --config Release --target install</code></pre>
</div>
</div>
<div class="paragraph">
<p>The build process automatically downloads 3rd party library binaries and the complete 3D model package.</p>
</div>
<div class="paragraph">
<p>After successful build, the binaries will be copied into <code>esmini/bin</code> folder. Try from command line:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc</code></p>
</div>
<div class="paragraph">
<p>That&#8217;s all. Details and variants, see <a href="#_build_guide">Build guide</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tools_overview">3. Tools overview</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_applications">3.1. Applications</h3>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>esmini</strong>
</td>
<td class="hdlist2">
<p>Play OpenSCENARIO file. Many options, e.g. view on screen, save images to file or just save log data for post processing.<br>
Example:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc</code><br></p>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/cut-in.png" alt="cut in">
</div>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>replayer</strong>
</td>
<td class="hdlist2">
<p>Replay recorded esmini scenarios. Main difference from esmini is the ability to freely move forward and backward in the scenario at various speeds.<br>
Example:<br>
<code>./bin/replayer --window 60 60 800 400 --file sim.dat</code><br></p>
<div class="paragraph">
<p>See <a href="#_use_cases">Use cases</a> how to create recordings (<code>.dat</code> files) from esmini.</p>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>odrviewer</strong>
</td>
<td class="hdlist2">
<p>Visualize and verify OpenDRIVE road networks. Draw road features, like reference line and lanes, on top of a 3D model (provided or generated). Optionally populate with random traffic that will randomly find its way through the road network.<br>
Example:<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr</code></p>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/odrviewer.png" alt="odrviewer">
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_scripts">3.2. Scripts</h3>
<div class="paragraph">
<p>esmini comes with a collection of scripts for various purposes, like preprocessing of scenario files and plotting or conversion of simulation output files. The scripts are located in the <code>scripts</code> folder. A few examples:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>odrplot</strong></dt>
<dd>
<p>Simple 2D plot of OpenDRIVE road lanes with indicated road IDs, in a two step process.<br>
Prerequisites: Python + <a href="https://matplotlib.org/">matplotlib</a><br>
Example:<br>
<code>./bin/odrplot ./resources/xodr/fabriksgatan.xodr</code> (will create a track.csv file)<br>
<code>python ./EnvironmentSimulator/Applications/odrplot/xodr.py track.csv</code></p>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/odrplot.png" alt="odrplot">
</div>
</div>
</dd>
<dt class="hdlist1"><strong>plot_dat</strong></dt>
<dd>
<p>Simple 2D plot of scenario data<br>
Prerequisites: Python + <a href="https://matplotlib.org/">matplotlib</a><br>
Example:<br>
<code>./bin/esmini --headless --osc ./resources/xosc/acc-test.xosc --fixed_timestep 0.05 --record sim.dat</code> (will create the .dat file)<br>
<code>./scripts/plot_dat.py sim.dat --param speed</code></p>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_dat.png" alt="plot dat">
</div>
</div>
</dd>
<dt class="hdlist1"><strong>dat2csv</strong></dt>
<dd>
<p>Convert esmini recording (.dat) file to standard .csv format<br>
Example:<br>
<code>./scripts/dat2csv sim.dat</code><br>
will create sim.csv.</p>
</dd>
<dt class="hdlist1"><strong>osi2csv.py</strong></dt>
<dd>
<p>Convert OSI trace file (from esmini) to .csv format<br>
Example:<br>
<code>./scripts/osi2csv.py ./ground_truth.osi</code><br>
will create ground_truth.csv</p>
<div class="paragraph">
<p>See <a href="#_save_osi_data">Save OSI data</a> how to create OSI groundtruth trace (<code>.osi</code> file) from esmini.</p>
</div>
</dd>
<dt class="hdlist1"><strong>plot_csv</strong></dt>
<dd>
<p>Simple 2D plot of scenario data, similar to plot_dat<br>
Prerequisites: Python + <a href="https://matplotlib.org/">matplotlib</a><br>
Example:<br>
<code>./bin/esmini --headless --osc ./resources/xosc/acc-test.xosc --fixed_timestep 0.05 --osi_file sim.osi</code> (will create an osi trace file)<br>
<code>./scripts/osi2csv.py sim.osi</code> (convert to .csv)<br>
<code>./scripts/plot_csv.py sim.csv --param ax</code> will plot the x component of acceleration vector.</p>
</dd>
<dt class="hdlist1"><strong>dat2xosc.py</strong></dt>
<dd>
<p>Convert any scenario to a fixed trajectory based scenario. See more info in <a href="https://github.com/esmini/esmini/blob/dev/scripts/dat2xosc.py">script</a>.</p>
</dd>
<dt class="hdlist1"><strong>move_to_origin.py</strong></dt>
<dd>
<p>Translate a scenario to origin. Useful for scenarios with large coordinates causing precision issues. See more info in <a href="https://github.com/esmini/esmini/blob/dev/scripts/move_to_origin.py">script</a>.</p>
</dd>
<dt class="hdlist1"><strong>xodr_lines2curves.py</strong></dt>
<dd>
<p>Smoothen polyline roads by converting them to parametric curves. See more info in  <a href="https://github.com/esmini/esmini/blob/dev/scripts/xodr_lines2curves.py">script</a>.</p>
</dd>
<dt class="hdlist1"><strong>run_schema_comply.py</strong></dt>
<dd>
<p>Validate xosc and xodr scenario files for compliance with the XML schema of the corresponding standard. See more info in <a href="https://github.com/esmini/esmini/blob/dev/scripts/run_schema_comply.py">script</a> and section <a href="#_run_xml_schema_validation_tests">Run XML schema validation tests</a>.</p>
</dd>
<dt class="hdlist1"><strong>compile_osg_apps.sh</strong></dt>
<dd>
<p>Compile OSG applications for viewing and converting OpenSceneGraph 3D models. See more info section <a href="#_get_osgconv">Get osgconv</a> / <a href="#_build_yourself">Build yourself</a>.</p>
</dd>
<dt class="hdlist1"><strong>run_repeat_compare.sh</strong></dt>
<dd>
<p>Run a scenario multiple times and compare the results, expected to be identical. See more info in <a href="https://github.com/esmini/esmini/blob/dev/scripts/run_repeat_compare.sh">script</a>.</p>
</dd>
</dl>
</div>
<div id="osiviewer" class="dlist">
<dl>
<dt class="hdlist1"><strong>osiviewer.py</strong></dt>
<dd>
<p>Visualize OSI trace files. Only supporting a small, limited subset of OSI content, e.g. lanes, stationary and moving objects.<br>
Example:<br>
<code>./scripts/osiviewer.py ground_truth.osi</code><br></p>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/osiviewer.png" alt="osiviewer">
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_shared_libraries">3.3. Shared libraries</h3>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>esminiLib</strong>
</td>
<td class="hdlist2">
<p>High level API for running, controlling and monitoring scenarios<br></p>
<div class="paragraph">
<p>See headerfile <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp">esminiLib.hpp</a>
and <a href="#_hello_world_programming_tutorial">Hello World programming tutorial</a></p>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>esminiRMLib</strong>
</td>
<td class="hdlist2">
<p>High level API for parsing and query road networks (only road manager)<br></p>
<div class="paragraph">
<p>See headerfile <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/Libraries/esminiRMLib/esminiRMLib.hpp">esminiRMLib.hpp</a>
and code example <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/rm-basic">rm-basic</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_cases">4. Use cases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here follows basic examples showing some, but not all, features in esmini and companion tools. It should give an idea of the possibilities and limitations. For a full list of features and functions, see <a href="#_command_reference">Command reference</a>.</p>
</div>
<div class="paragraph">
<p>To quickly see available launch options, simply run the corresponding application with no arguments, for example:</p>
</div>
<div class="paragraph">
<p><code>./bin/odrviewer</code></p>
</div>
<div class="sect2">
<h3 id="_view_a_scenario">4.1. View a scenario</h3>
<div class="sect3">
<h4 id="_basic_features">4.1.1. Basic features</h4>
<div class="paragraph">
<p>Specify a window and scenario file. Example:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc</code></p>
</div>
<div class="paragraph">
<p>Visualize trails from moving entities:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --trail_mode 3</code></p>
</div>
<div class="paragraph">
<p>Show entities as bounding boxes:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --bounding_boxes</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/cut-in_trail_and_bb.png" alt="cut in trail and bb">
</div>
<div class="title">Trail and bounding box in combination</div>
</div>
</div>
<div class="sect3">
<h4 id="_camera_control">4.1.2. Camera control</h4>
<div class="paragraph">
<p>In addition to several OSG standard camera models esmini adds a set of special purpose camera modes that follows following scenario entities in various ways. Further, the user can add custom cameras via <a href="#_custom_camera_positions">API</a> or launch arguments.</p>
</div>
<div class="paragraph">
<p>Top level camera mode is selected on keys '1' to '8'. Mode 2-8 are OpenSceneGraph standard cameras. Mode 1 hands over camera control to esmini. In this mode, switch camera model by pressing 'k' which will toggle between all available esmini camera model.</p>
</div>
<div class="paragraph">
<p>The default camera model is esmini "orbit" which allows for rotating (left-mouse button), zooming (right-mouse button) and panning (scroll wheel / middle mouse button) while following the first entity.</p>
</div>
<div class="paragraph">
<p>To follow another vehicle press <code>Tab</code> (next vehicle) or <code>Shift TAB</code> (previous vehicle). Also <code>Backspace</code> is mapped to previous vehicle, since shift-TAB do not work on all platforms.</p>
</div>
<div class="paragraph">
<p>For a complete list of cameras and functions, see <a href="#_command_reference">Command reference</a>.</p>
</div>
<div class="paragraph">
<p>esmini camera mode can be selected by launch argument. Here are a few common use cases:</p>
</div>
<div class="paragraph">
<p>Follow exact behind vehicle:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --camera_mode fixed</code></p>
</div>
<div class="paragraph">
<p>Orthogonal (no perspective) top view follow vehicle:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --camera_mode top</code></p>
</div>
<div class="paragraph">
<p>Follow vehicle from inside "driver" point of view:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --camera_mode driver</code></p>
</div>
<div class="paragraph">
<p>Follow vehicle with some flex and allow rotate, pan and zoom:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --camera_mode flex-orbit</code></p>
</div>
<div class="paragraph">
<p>In addition to pre-defined camera modes, the user can add custom cameras from API or via launch argument. Custom cameras can be fixed, semi-fixed (fixed position but unconstrained orientation) or relative current vehicle. Here is a few examples:</p>
</div>
<div class="paragraph">
<p>Custom camera in front of vehicle, e.g. sensor mount position:
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --custom_camera 3,0,0.6,0,0</code></p>
</div>
<div class="paragraph">
<p>Custom camera with fixed position but dynamic orientation, always pointing at current vehicle:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --custom_fixed_camera 170,10,5</code></p>
</div>
<div class="videoblock">
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/custom_camera_fixed_pos.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Custom fixed camera:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --custom_fixed_camera 240,15,10,3.5,0.2</code></p>
</div>
<div class="videoblock">
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/custom_camera_fixed_pos_and_rot.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Custom fixed top view camera:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --custom_fixed_top_camera 180,-1.54,2301,4.71239</code></p>
</div>
<div class="videoblock">
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/custom_camera_fixed_top_view.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_some_key_shortcut_commands">4.1.3. Some key shortcut commands</h4>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>Space</strong>
</td>
<td class="hdlist2">
<p>Toggle pause/play simulation</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Enter</strong>
</td>
<td class="hdlist2">
<p>Step simulation one frame forward</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Tab</strong>
</td>
<td class="hdlist2">
<p>Move camera to next vehicle</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Shift-Tab or Backspace</strong>
</td>
<td class="hdlist2">
<p>Move camera to previous vehicle</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>'j'</strong>
</td>
<td class="hdlist2">
<p>Toggle show entity trail points and lines (press mulitpe times to switch modes)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>','</strong>
</td>
<td class="hdlist2">
<p>Toggle bounding box modes</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Esc</strong>
</td>
<td class="hdlist2">
<p>Quit</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See <a href="#_command_reference">Command reference</a> for a complete list of key shortcut commands.</p>
</div>
</div>
<div class="sect3">
<h4 id="_road_network_visualization">4.1.4. Road network visualization</h4>
<div class="paragraph">
<p>Visualize OpenDRIVE road features:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --road_features on</code></p>
</div>
<div class="paragraph">
<p>If a 3D model representation of the road network is missing (i.e. empty or missing SceneGraphFile element of the <a href="https://www.asam.net/static_downloads/ASAM_OpenSCENARIO_V1.1.1_Model_Documentation/modelDocumentation/content/RoadNetwork.html">OpenSCENARIO RoadNetwork class</a>), then esmini will generate a <em>very</em> simple model.</p>
</div>
<div class="paragraph">
<p>Example:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc</code></p>
</div>
<div class="paragraph">
<p>Add optional flat ground plane:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --ground_plane</code></p>
</div>
<div class="paragraph">
<p>The generated model can be saved:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --save_generated_model</code><br>
Then look for <code>generated_road.osgb</code> in the current directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="_background_color">4.1.5. Background color</h4>
<div class="paragraph">
<p>esmini default background color is skyish, light blue. Change by launch argument --clear-color &lt;r,g,b&gt;, where r, g, b are the red, green, blue components as floating numbers in the range (0:1). Some examples:</p>
</div>
<div class="paragraph">
<p>Black background:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --clear-color 0,0,0</code></p>
</div>
<div class="paragraph">
<p>White background:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --clear-color 1,1,1</code></p>
</div>
<div class="paragraph">
<p>Gray background:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --clear-color 0.3,0.3,0.3</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_anti_alias">4.1.6. Anti-alias</h4>
<div class="paragraph">
<p>esmini make use of OpenSceneGraph sub-sampling method for anti-alias. Default setting is 4 (samples). This can be controlled by the launch argument <code>--aa_mode &lt;samples&gt;</code>. To disable anti-alias:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --aa_mode 0</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_screenshots_and_video_clips">4.2. Screenshots and video clips</h3>
<div class="paragraph">
<p>esmini can save screenshots in uncompressed <a href="https://en.wikipedia.org/wiki/Truevision_TGA">TGA</a> format. These images can be converted into other image formats or even video clips in a post process.</p>
</div>
<div class="paragraph">
<p>esminiLib also supports grabbing screenshots via API, also from a pure off-screen rendering setup (requiring neither monitor nor graphics hardware). See <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/image-capture">image-capture</a> code example.</p>
</div>
<div class="paragraph">
<p>Here follows a few examples using launch arguments and runtime key commands.</p>
</div>
<div class="sect3">
<h4 id="_save_screenshots">4.2.1. Save screenshots</h4>
<div class="paragraph">
<p>Press 'c' at any time to store a single screenshot.</p>
</div>
<div class="paragraph">
<p>Press 'C' at any time to start storing screen shot for every frame onward. Press 'C' again to stop.</p>
</div>
</div>
<div class="sect3">
<h4 id="_create_video_clip_of_a_scenario">4.2.2. Create video clip of a scenario</h4>
<div class="paragraph">
<p>First, run the scenario and automatically save screenshots for all frames:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --fixed_timestep 0.033 --capture_screen</code></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Note</strong> We added the --fixed_timestep argument to make sure we get a smooth video with constant delta-time for a smooth and continuous video clip. If --fixed_timestep is skipped esmini will progress time between frames according to actual system time passed since last frame, which can vary over time for many reasons (e.g. due to esmini or other processes CPU load).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Then, create a video clip using ffmpeg:<br>
<code>ffmpeg -f image2 -framerate 30 -i screen_shot_%5d.tga -c:v libx264 -vf format=yuv420p -crf 20 out.mp4</code></p>
</div>
<div class="paragraph">
<p>The above ffmpeg command will create a MPEG4 video with reasonable compression (crf 20). To create a lossless, but still compressed, video e.g. for further post processing:</p>
</div>
<div class="paragraph">
<p><code>ffmpeg -f image2 -framerate 30 -i screen_shot_%5d.tga -c:v libx264 -qp 0 out.mp4</code></p>
</div>
<div class="paragraph">
<p>To change framerate of the output video, use the fps filter. E.g. from input 30 fps to output 15 fps:</p>
</div>
<div class="paragraph">
<p><code>ffmpeg -f image2 -framerate 30 -i screen_shot_%5d.tga -c:v libx264 -vf format=yuv420p,fps=15 -crf 20 out.mp4</code></p>
</div>
<div class="paragraph">
<p>To concatenate multiple files, first create a text file listing the input files. Example:</p>
</div>
<div class="paragraph">
<p><code>video_list.txt</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>file 'no_features_10.mkv'
file 'features_10.mkv'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then run the ffmpeg command, like:
<code>ffmpeg -f concat -i video_list.txt -c copy merged.mkv</code></p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> The input files must be same timebase and resolution to work well.</p>
</div>
<div class="paragraph">
<p>Get ffmpeg: <a href="http://ffmpeg.org/download.html" class="bare">http://ffmpeg.org/download.html</a></p>
</div>
<div class="paragraph">
<p>Some details regarding H.264 encoding can be found <a href="https://trac.ffmpeg.org/wiki/Encode/H.264">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_off_screen_rendering">4.2.3. Off-screen rendering</h4>
<div class="paragraph">
<p>Whenever esmini is launched with the <code>--window &lt;x-pos&gt; &lt;y-pos&gt; &lt;width&gt; &lt;height&gt;</code> argument a viewer will be created with specified window. The <code>--headless</code> flag controls whether any window will be "on screen" or only off-screen. Of course, <code>--headless</code> in combination with no window (no --window argument) will skip rendering altogether, which is a very performance-saving mode to use when possible.</p>
</div>
<div class="paragraph">
<p>Example:<br>
<code>./bin/esmini.exe --window 60 60 4000 2000 --headless --capture_screen --osc .\resources\xosc\cut-in.xosc</code><br>
will render images into a virtual frame buffer of size 4k x 2k pixels and then store to file. Note: The size of the virtual frame buffer is not limited by size of any connected display.</p>
</div>
<div class="paragraph">
<p>To run esmini completely without rendering, just omit the --window argument:<br>
<code>./bin/esmini.exe --osc .\resources\xosc\cut-in.xosc</code> --fixed_timestep 0.01 --record sim.dat<br>
will run the specified scenario quickly and store a .dat file for later analysis or viewing (with replayer).</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> If --fixed_timestep is omitted esmini will adapt timesteps to actual frametime, so a 30 seconds scenario will take 30 seconds - i.e. no performance gain.</p>
</div>
</div>
<div class="sect3">
<h4 id="_software_rendering_no_gfx_hw">4.2.4. Software rendering (no gfx hw)</h4>
<div class="paragraph">
<p>By default any available 3D graphics hardware will be utilized. As fallback esmini (via OSG) will utilize <a href="https://www.mesa3d.org">Mesa3D</a> which is a software implementation of the OpenGL graphics stack including parts normally hosted in the graphics hardware system. The Mesa3D approach is useful when running on cloud/cluster machines lacking graphics hardware, perhaps even lacking a window system (like slimmed and headless Ubuntu without X11 support).</p>
</div>
<div class="paragraph">
<p><strong>Mesa3D on Linux</strong><br>
Mesa3D is normally installed with Linux distributions. Check OpenGL support with the following command:<br>
<code>glxinfo -B</code></p>
</div>
<div class="paragraph">
<p>If the command is not available, then Mesa3D utility package is probably missing. Install as:<br>
<code>sudo apt install mesa-utils</code></p>
</div>
<div class="paragraph">
<p>To run headless with a virtual frame buffer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Activate <a href="https://en.wikipedia.org/wiki/Xvfb">xvfb</a>:<br>
<code>Xvfb :99 -screen 0 1920x1080x24+32 &amp; export DISPLAY=:99</code><br></p>
</li>
<li>
<p>Then run esmini as usual</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For troubleshooting, the following command might give information about the graphics system:<br>
<code>lspci -vnn | grep VGA -A 12</code></p>
</div>
<div class="paragraph">
<p><strong>Mesa3D on Windows</strong><br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Grab the Mesa3D binary from <a href="https://downloads.fdossena.com/geth.php?r=mesa64-latest">here</a>.</p>
</li>
<li>
<p>Unpack and place opengl32.dll in the same folder as esmini executable.</p>
</li>
<li>
<p>Then run esmini as usual</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logging">4.3. Logging</h3>
<div class="paragraph">
<p>esmini can produce log files in different formats and for different purposes, explained next.</p>
</div>
<div class="sect3">
<h4 id="_the_basic_text_log_file">4.3.1. The basic text log file</h4>
<div class="paragraph">
<p>By default esmini is creating a <code>log.txt</code> in the folder from which esmini is launched. In case of esminiLib it will end up in the folder that the application linking esminiLib was launched from. The log filename can be customized.</p>
</div>
<div class="paragraph">
<p>The log file includes the same information normally seen in the terminal window (stdout).</p>
</div>
<div class="paragraph">
<p>To disable output to terminal:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --disable_stdout</code></p>
</div>
<div class="paragraph">
<p>To disable creation of the logfile (<code>log.txt</code>):<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --disable_log</code></p>
</div>
<div class="paragraph">
<p>esmini has enhanced logger from release v2.41.0 supporting log verbosity levels, log file appending, enabling/disabling meta data and filtering on module level logging.</p>
</div>
<div class="sect4">
<h5 id="_log_verbosity">Log verbosity</h5>
<div class="paragraph">
<p>There are four log verbosity levels:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>error</p>
</li>
<li>
<p>warn</p>
</li>
<li>
<p>info</p>
</li>
<li>
<p>debug</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The log level can be set from command line argument. If not provided, then <code>info</code> level is set by default. Log verbosity goes from <code>error</code> (low) to <code>debug</code> (high). Log entries will be included from <code>error</code> up to the specified level.</p>
</div>
<div class="paragraph">
<p>Example 1: <code>--log_level debug</code> will include all entries (<code>error</code>, <code>warn</code>, <code>info</code> and <code>debug</code>) as the highest level has been selected.</p>
</div>
<div class="paragraph">
<p>Example 2: <code>--log_level warn</code> will include <code>error</code> and <code>warn</code> entries only.</p>
</div>
<div class="paragraph">
<p>Developers can use <code>LOG_ERROR</code>, <code>LOG_WARN</code>, <code>LOG_INFO</code> and <code>LOG_DEBUG</code> macros to effectively prioritize log messages.</p>
</div>
</div>
<div class="sect4">
<h5 id="_log_metadata">Log metadata</h5>
<div class="paragraph">
<p>Logger can add source code meta data with every logged entry, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>file name</p>
</li>
<li>
<p>function/method name</p>
</li>
<li>
<p>line number</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>indicating the location of the log entry in the source code.</p>
</div>
<div class="paragraph">
<p><code>--log_meta_data</code> is the command line parameter for enabling meta data.</p>
</div>
</div>
<div class="sect4">
<h5 id="_log_append">Log append</h5>
<div class="paragraph">
<p><code>--log_append</code> is another command line option. Instead of overwriting any existing log file, entries will be appended to the same log file. In other words, logs of multiple scenarios will be put in the same single log file.</p>
</div>
</div>
<div class="sect4">
<h5 id="_log_filtering_on_modules">Log filtering on modules</h5>
<div class="paragraph">
<p>If there is a need to gather log entries of any particular module(s) i.e. hpp/cpp file then <code>--log_only_modules</code> option can be set from the command line. It will create a filter for the logger to pick only log entries from specified modules, ignoring all others. Example:</p>
</div>
<div class="paragraph">
<p><code>--log_only_modules playerbase</code></p>
</div>
<div class="paragraph">
<p>will only log from <code>playerbase.hpp/cpp</code> files. All other log entries will be skipped.</p>
</div>
<div class="paragraph">
<p>Opposite to log only modules, there is an option to skip specific modules. Example:</p>
</div>
<div class="paragraph">
<p><code>--log_skip_modules playerbase,Replay</code></p>
</div>
<div class="paragraph">
<p>will skip all log entries from <code>playerbase.hpp/cpp</code> and <code>Replay.hpp/cpp</code> files. Entries from all other modules will be included.</p>
</div>
<div class="paragraph">
<p>Note that <code>--log_only_modules</code> and <code>--log_skip_modules</code> are mutually exclusive. If a module is listed in both options, then priority is given to <code>--log_only_modules</code>. Hence logging will be enabled for specified module, ignoring its presence in <code>--log_skip_modules</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_log_use_case_example">Log use case example</h5>
<div class="paragraph">
<p>Assume you&#8217;re only interested in storyboard events, like actions and triggers. First step is to run a representative scenario to find out what modules you&#8217;re interested in. Example:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --log_meta_data</code></p>
</div>
<div class="paragraph">
<p>It will show all log entries up to <code>info</code> level, including meta data. Look for the module names in the log entries. Then run the scenario again with module filter. Example:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --log_only_modules Storyboard,StoryboardElement,OSCCondition</code></p>
</div>
<div class="paragraph">
<p>It will show only log entries relating to storyboard, including triggering. Example excerpt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">...
[0.001] [info] OverTakerStartSpeedEvent standbyState -&gt; startTransition -&gt; runningState
[0.001] [info] OverTakerStartSpeedAction initState -&gt; startTransition -&gt; runningState
[6.179] [info] Trigger /------------------------------------------------
[6.179] [info] CutInStartCondition == true, HWT: 0.40 &gt; 0.40, edge rising
[6.179] [info] Triggering entity 0: Ego
[6.179] [info] Trigger  ------------------------------------------------/
[6.179] [info] OverTakerStartSpeedAction runningState -&gt; endTransition -&gt; completeState
[6.179] [info] OverTakerStartSpeedEvent complete after 1 execution
[6.179] [info] OverTakerStartSpeedEvent runningState -&gt; endTransition -&gt; completeState
[6.179] [info] Event OverTakerStartSpeedEvent ended, overwritten by event CutInEvent
[6.179] [info] CutInEvent standbyState -&gt; startTransition -&gt; runningState
[6.179] [info] CutInAction initState -&gt; startTransition -&gt; runningState
[7.696] [info] Trigger /------------------------------------------------
[7.696] [info] BrakeCondition_HWT_0.7 == true, HWT: 0.70 &gt; 0.70, edge rising
[7.696] [info] Triggering entity 0: Ego
[7.696] [info] Trigger  ------------------------------------------------/
[7.696] [info] Other events ongoing, OvertakerBrakeEvent will run in parallel
[7.696] [info] OvertakerBrakeEvent standbyState -&gt; startTransition -&gt; runningState
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_scenario_recording_dat">4.3.2. Scenario recording (.dat)</h4>
<div class="paragraph">
<p>In addition esmini can save a <code>.dat</code> file which captures the state of all entities. This file can later be used either to replay (see <a href="#_replay_scenario">Replay scenario</a>) the scenario or converted to <code>.csv</code> for further analysis, e.g. in Excel.</p>
</div>
<div class="paragraph">
<p>To create a recording with regular timesteps:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --fixed_timestep 0.05 --record sim.dat</code></p>
</div>
<div class="paragraph">
<p>To convert the .dat file into .csv, do either of:<br>
<code>./bin/dat2csv sim.dat</code><br>
or<br>
<code>python ./scripts/dat2csv.py sim.dat</code></p>
</div>
<div class="paragraph">
<p>Only a subset of the .dat file information is extracted. To extract some more info, e.g. road coordinates, run:
<code>./scripts/dat2csv --extended sim.dat</code><br></p>
</div>
<div class="paragraph">
<p>You can create .dat files from multiple scenarios in a single command, like this on Linux (bash):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">for f in ./my_scenarios/*.xosc; do ./bin/esmini --headless --fixed_timestep 0.05 --osc $f --record `basename $f .xosc`.dat; done</code></pre>
</div>
</div>
<div class="paragraph">
<p>It also works in Git bash on Windows.</p>
</div>
</div>
<div class="sect3">
<h4 id="_csv_logger">4.3.3. CSV logger</h4>
<div class="paragraph">
<p>To create a more complete csv logfile, compared to the content of the .dat file, activate the CSV_Logger:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --fixed_timestep 0.05 --csv_logger full_log.csv</code></p>
</div>
<div class="paragraph">
<p>full_log.csv will contain more detailed states for all scenario entities. To also include collision detection:<br></p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --fixed_timestep 0.05 --csv_logger full_log.csv --collision</code></p>
</div>
<div class="paragraph">
<p>All collisions (overlap) between entity bounding boxes will be registered in the <code>collision_ids</code> column of each entity. It will contain the IDs of any entities overlapping at given frame.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_replay_scenario">4.4. Replay scenario</h3>
<div class="paragraph">
<p>Replay a scenario recording (.dat file):<br>
<code>./bin/replayer --window 60 60 800 400 --res_path ./resources --file sim.dat</code></p>
</div>
<div class="paragraph">
<p>The <code>--res_path</code> is a special path directive should normally point to esmini/resources folder, where it will look for the OpenDRIVE file, 3D models and model_ids table (model_ids.txt). It also works to add one or multiple --path &lt;path&gt; directives, like for esmini.</p>
</div>
<div class="paragraph">
<p>Once loaded the scenario recording will start playing in normal speed. Here are a few key commands:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>Space</strong>
</td>
<td class="hdlist2">
<p>Toggle pause/play simulation</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Tab</strong>
</td>
<td class="hdlist2">
<p>Move camera to next vehicle</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Shift-Tab or Backspace</strong>
</td>
<td class="hdlist2">
<p>Move camera to previous vehicle</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>'n'</strong>
</td>
<td class="hdlist2">
<p>Toggle show active trajectories</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>','</strong>
</td>
<td class="hdlist2">
<p>Toggle bounding box modes</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Esc</strong>
</td>
<td class="hdlist2">
<p>Quit</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Arrow keys:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>Left</strong>
</td>
<td class="hdlist2">
<p>Pause and move to previous frame</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Right</strong>
</td>
<td class="hdlist2">
<p>Pause and move to next frame</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Shift + Left</strong>
</td>
<td class="hdlist2">
<p>Pause and jump 10 frames back</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Shift + Right</strong>
</td>
<td class="hdlist2">
<p>Pause and jump 10 frames forward</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Ctrl + Left</strong>
</td>
<td class="hdlist2">
<p>Jump to beginning</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Ctrl + Right</strong>
</td>
<td class="hdlist2">
<p>Jump to end</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See <a href="#_command_reference">Command reference</a> for a complete list of key shortcut commands.</p>
</div>
<div class="paragraph">
<p>Some launch arguments:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>--collision</strong>
</td>
<td class="hdlist2">
<p>Pause and move to previous frame</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>--quit_at_end</strong>
</td>
<td class="hdlist2">
<p>Quit application when reaching end of scenario</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>--repeat</strong>
</td>
<td class="hdlist2">
<p>Loop scenario</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>--dir &lt;path&gt;</strong>
</td>
<td class="hdlist2">
<p>Directory containing replays to overlay, pair with "file" argument, where "file" is .dat filename match substring</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="paragraph">
<p>Enable collision detection and pause playing at every occasion of collision: <br>
<code>./bin/replayer --window 60 60 800 400 --file sim.dat --res_path ./resources --collision</code></p>
</div>
<div class="videoblock">
<div class="title">Video clip demonstrating some features in replayer</div>
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/ltap-od_collision.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>The .dat file in the clip above was created with the command:<br>
<code>./bin/esmini --headless --osc ./resources/xosc/ltap-od.xosc --disable_controllers --fixed_timestep 0.033 --record sim.dat </code></p>
</div>
<div class="paragraph">
<p>and then launched in replayer:<br>
<code>./bin/replayer --window 60 60 800 400 --file sim.dat --res_path ./resources --collision</code></p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> The --disable_controllers flag is just specified to disable the interactive controller that normally is activated in that specific scenario. For more information about controllers, see <a href="https://github.com/esmini/esmini/blob/master/docs/Controllers.md">Controllers in esmini</a>.</p>
</div>
<div class="paragraph">
<p>Combine esmini and replayer in a one-liner command:<br>
<code>./bin/esmini --headless --fixed_timestep 0.05 --record sim.dat --osc ./resources/xosc/cut-in.xosc;./bin/replayer --window 60 60 800 400 --res_path ./resources --file sim.dat</code></p>
</div>
<div class="paragraph">
<p>With bash (use Git Bash on Windows) preview all scenarios (.xosc files) in a folder, at double speed:<br>
<code>for f in my_scenarios/*.xosc; do ./bin/esmini --headless --fixed_timestep 0.05 --osc $f --record <code>basename $f .xosc</code>.dat;./bin/replayer --window 60 60 1200 600 --res_path ./resources --file <code>basename $f .xosc</code>.dat --time_scale 2 --quit_at_end; done</code></p>
</div>
<div class="paragraph">
<p>just replace <code>my_scenarios</code> with your folder path</p>
</div>
<div class="sect3">
<h4 id="_multiple_scenarios_in_parallel">4.4.1. Multiple scenarios in parallel</h4>
<div class="paragraph">
<p>Next example, play multiple variants of a scenario in parallel:<br>
<code>./bin/replayer --window 60 60 800 400 --file sim --res_path ./resources --capture_screen --dir tmp</code></p>
</div>
<div class="paragraph">
<p>The <code>--dir</code> argument points to a folder containing sim1.dat, sim2.dat and sim3.dat.<br>
The <code>--capture_screen</code> argument will save each frame as an image file on disk.</p>
</div>
<div class="videoblock">
<div class="title">Video clip demonstrating parallel scenarios in replayer</div>
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/replay_multiple_scenario_variants.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_save_merged_dat_files">4.4.2. Save merged .dat files</h4>
<div class="paragraph">
<p>Merged data from multiple .dat files can be saved into one single .dat file, e.g. for plotting:<br>
<code>./bin/replayer --file sim_ --dir . --save_merged sim_merged.dat</code></p>
</div>
<div class="paragraph">
<p>replayer will look in current folder (".") for any .dat file starting with "sim_", i.e. "sim_*.dat". The files will be merged and saved as sim_merged.dat.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_view_road_network">4.5. View road network</h3>
<div class="sect3">
<h4 id="_visualize_opendrive_geometry">4.5.1. Visualize OpenDRIVE geometry</h4>
<div class="paragraph">
<p>By default odrviewer will create a simple 3D model of the OpenDRIVE description and populate it with sparse traffic:<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr</code></p>
</div>
<div class="paragraph">
<p>Add OpenDRIVE features, like reference line and lanes, on top (toggle on 'o'):<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr --road_features</code></p>
</div>
<div class="paragraph">
<p>Remove all traffic, just visualize the road geometry:<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr --density 0</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_evaluate_opendrive_connectivity">4.5.2. Evaluate OpenDRIVE connectivity</h4>
<div class="paragraph">
<p>Increase traffic to exercise all junctions and lanes of the road network:<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr --density 7 --road_features</code></p>
</div>
<div class="paragraph">
<p>Use custom 3D model:<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr --model ./resources/models/fabriksgatan.osgb --density 5</code></p>
</div>
<div class="paragraph">
<p>Slow down traffic:<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr --model ./resources/models/fabriksgatan.osgb --density 3 --speed_factor 0.6</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_inspect_opendrive_geometry_and_road_ids">4.5.3. Inspect OpenDRIVE geometry and road IDs</h4>
<div class="paragraph">
<p>esmini odrplot is a small application that creates a track.csv file that can be plotted with another small Python script xodr.py:<br>
<code>./bin/odrplot ./resources/xodr/fabriksgatan.xodr</code><br>
<code>./EnvironmentSimulator/Applications/odrplot/xodr.py track.csv</code></p>
</div>
<div class="paragraph">
<p>Combine in a one-liner:<br>
<code>./bin/odrplot ./resources/xodr/fabriksgatan.xodr;./EnvironmentSimulator/Applications/odrplot/xodr.py track.csv</code></p>
</div>
<div class="paragraph">
<p>To navigate in the plot, click the four-arrow icon (see image below) and then use mouse according to:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>Left button</strong>
</td>
<td class="hdlist2">
<p>Pan (move left, right, up, down)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Right button</strong>
</td>
<td class="hdlist2">
<p>Zoom</p>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/odrplot_help.png" alt="odrplot help">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_plot_scenario_data">4.6. Plot scenario data</h3>
<div class="paragraph">
<p>esmini can plot data in two ways: Off-line (plot content of .dat files) and runtime (a set of pre-defined values).</p>
</div>
<div class="sect3">
<h4 id="_off_line_plotting">4.6.1. Off-line plotting</h4>
<div class="paragraph">
<p>esmini provides a Python based script, plot_dat.py, to plot information in .dat files.</p>
</div>
<div class="paragraph">
<p>First, create a .dat file. For that we don&#8217;t need a window. Run esmini headless:<br>
<code>./bin/esmini --headless --fixed_timestep 0.05 --osc ./resources/xosc/acc-test.xosc --record sim.dat</code></p>
</div>
<div class="paragraph">
<p>The scenario looks like this:<br></p>
</div>
<div class="videoblock">
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/acc-test.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Next, plot speed over time:<br>
<code>./scripts/plot_dat.py sim.dat --param speed</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_dat.png" alt="plot dat">
</div>
</div>
<div class="paragraph">
<p>To see what parameters are available for plot:<br>
<code>./scripts/plot_dat.py sim.dat --list_params</code></p>
</div>
<div class="paragraph">
<p>will output a list similar to:<br>
<code>
Plottable parameters:<br>
id, model_id, obj_type, obj_category, ctrl_type, time, speed, wheel_angle, wheel_rot, centerOffsetX, centerOffsetY, centerOffsetZ, width, length, height, scaleMode, visibilityMask, x, y, z, h, p, r, roadId, laneId, offset, t, s
</code></p>
</div>
<div class="paragraph">
<p>Most parameters does normally not make sense to plot, but it depends on the test case. Maybe it&#8217;s interesting to see when a car makes a lane change. Plot laneId over time:<br>
<code>./scripts/plot_dat.py sim.dat --param laneId</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_dat_lane_id.png" alt="plot dat lane id">
</div>
</div>
<div class="paragraph">
<p>A plot can show multiple parameters:<br>
<code>./scripts/plot_dat.py sim.dat --param laneId --param speed</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_dat_lane_speed.png" alt="plot dat lane speed">
</div>
</div>
<div class="paragraph">
<p>To plot trajectories, change X-axis parameter from <code>time</code> to <code>x</code> and plot <code>y</code> parameter (over x):<br>
<code>./scripts/plot_dat.py sim.dat --x_axis x --param y</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_dat_x_y.png" alt="plot dat x y">
</div>
</div>
<div class="paragraph">
<p>Lock axis aspect ratio, i.e. make axis scale equal:<br>
<code>./scripts/plot_dat.py sim.dat --x_axis x --param y --equal_axis_aspect</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_dat_x_y_eq_axis.png" alt="plot dat x y eq axis">
</div>
</div>
<div class="paragraph">
<p>Plot merged .dat files (created as described in <a href="#_save_merged_dat_files">Save merged .dat files</a>)<br></p>
</div>
<div class="paragraph">
<p><code>./scripts/plot_dat.py --param speed sim_merged.dat</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_merged_dat_files.png" alt="plot merged dat files">
</div>
</div>
<div class="paragraph">
<p>Entity IDs will get an offset multiplier of 100, corresponding to the order of which the dat files were read by replayer. The mapping between ID range and dat file is printed to the console by replayer when the merged dat file is created, as the following example of four input files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Scenarios corresponding to IDs (0:99): sim_fsm.dat
Scenarios corresponding to IDs (100:199): sim_ref.dat
Scenarios corresponding to IDs (200:299): sim_reg.dat
Scenarios corresponding to IDs (300:399): sim_rss.dat</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_runtime_plotting">4.6.2. Runtime plotting</h4>
<div class="paragraph">
<p>From version 2.32.0 esmini can plot some pre-configured data values during simulation. Simply add launch flag <code>--plot</code>.</p>
</div>
<div class="paragraph">
<p>Features so far:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One or multiple entities can be selected by checkboxes on top</p>
</li>
<li>
<p>Selection of variables can be reduced by checkboxes to the right</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/implot.png" alt="implot">
</div>
<div class="title">Screenshot of a cut-in scenario with line plotting feature enabled</div>
</div>
<div class="paragraph">
<p>By default the plotting is executing in a separate thread, having minimal impact on esmini performance. It is also possible to execute in synchronous mode, where plotting is part of esmini main thread and stepping is done in synch. The mode can be specified explicitly. Examples:</p>
</div>
<div class="paragraph">
<p>Simply enable plotting, default mode:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --fixed_timestep 0.05 --plot</code></p>
</div>
<div class="paragraph">
<p>Enforce synchronous mode:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --fixed_timestep 0.05 --plot synchronous</code></p>
</div>
<div class="paragraph">
<p>Asynchronous mode can be specified as well, although it&#8217;s default hence not needed:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --fixed_timestep 0.05 --plot asynchronous</code></p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> On macos OpenGL window must be part of main thread. Hence synchronous mode is enforced on macos.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_save_osi_data">4.7. Save OSI data</h3>
<div class="paragraph">
<p>esmini can provide OSI groundtruth data in three ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Send over UDP</p>
</li>
<li>
<p>API to fetch via function call from a custom application</p>
</li>
<li>
<p>Save to OSI trace file</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Only trace file way is described here. To save OSI data, add argument <code>--osi_file [filename]</code>. The filename is optional. If omitted it will be named <code>ground_truth.osi</code>. Example:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --osi_file</code></p>
</div>
<div class="paragraph">
<p>will create <code>ground_truth.osi</code> in the current folder. The format is according to the OSI standard "Binary trace file", see OSI documentation <a href="https://opensimulationinterface.github.io/osi-documentation/index.html#_osi_trace_files">2.2.6 OSI trace files</a>.</p>
</div>
<div class="paragraph">
<p>esmini provides a script, osi2csv.py, that converts an OSI trace file into .csv format. The script can also serve as example how to parse and extract data from an OSI trace file:</p>
</div>
<div class="paragraph">
<p><code>./scripts/osi2csv.py ground_truth.osi</code></p>
</div>
<div class="paragraph">
<p>will create ground_truth.csv.<br>
(if file type association is not setup, try: <code>python ./scripts/osi2csv.py ground_truth.osi</code>)</p>
</div>
<div class="paragraph">
<p>However the .csv file created with osi2csv will not contain all OSI information. To get a readable text file including the complete content of a OSI trace file you can make use of the Python script <a href="https://github.com/OpenSimulationInterface/open-simulation-interface/blob/v3.5.0/format/osi2read.py">format/osi2read.py</a> in the OSI project.</p>
</div>
<div class="paragraph">
<p>Use as following example:</p>
</div>
<div class="paragraph">
<p><code>../open-simulation-interface/format/osi2read.py --data ./ground_truth.osi --output ground_truth --type GroundTruth</code></p>
</div>
<div class="paragraph">
<p>it should create <code>ground_truth.txth</code> which is readable in a text editor.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Note</strong>:</p>
</div>
<div class="paragraph">
<p>See <a href="#_osi_for_python_on_windows">OSI for Python on Windows</a> for hints how to install dependencies (OSI and Protobuf).</p>
</div>
<div class="paragraph">
<p>The above script link points to OSI tag v3.5.0. In more recent OSI versions the script has moved to another folder: <a href="https://github.com/OpenSimulationInterface/open-simulation-interface/blob/master/osi3trace/osi2read.py">osi3trace/osi2read.py</a>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scenario_features">5. Scenario features</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_speed_profile">5.1. Speed profile</h3>
<div class="paragraph">
<p>(introduced in esmini v2.23.0)</p>
</div>
<div class="paragraph">
<p>The OpenSCENARIO <a href="https://www.asam.net/static_downloads/ASAM_OpenSCENARIO_V1.1.1_Model_Documentation/modelDocumentation/content/SpeedAction.html">SpeedAction</a> will reach a specified speed in a way described by additional attributes, e.g. shape and duration. To achieve multiple speed target over time you would need to add multiple SpeedAction events to the scenario. Moreover, there is no way to explicitly control the jerk (acceleration/deceleration rates).</p>
</div>
<div class="paragraph">
<p>However with the SpeedProfileAction (introduced in OpenSCENARIO v1.2) you can specify a series of speed targets over time, in one action. Optionally you can also specify dynamic constraints for jerk (gradually changing acceleration and deceleration), acceleration and speed.</p>
</div>
<div class="paragraph">
<p>If you run the example scenario <a href="https://github.com/esmini/esmini/blob/master/resources/xosc/speed-profile.xosc">speed-profile.xosc</a> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>./bin/esmini.exe --window 60 60 800 400 --osc ./resources/xosc/speed-profile.xosc --fixed_timestep 0.01 --record sim.dat
./scripts/plot_dat.py sim.dat --param speed</code></pre>
</div>
</div>
<div class="paragraph">
<p>you should get the following plotted speed curves:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile1.png" alt="speed profile1">
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong> You might need to add <code>python</code> or <code>python2</code> in front of the python command. And matplotlib is needed, see odrplot in <a href="#_tools_overview">Tools overview</a>.</p>
</div>
<div class="paragraph">
<p><strong>Tip:</strong> For quick experiments, skip the visualization and bring the plot asap by replacing the two commands with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>./bin/esmini.exe --headless --osc ./resources/xosc/speed-profile.xosc --fixed_timestep 0.01 --record sim.dat;./scripts/plot_dat.py sim.dat --param speed</code></pre>
</div>
</div>
<div class="paragraph">
<p>The scenario includes two cars with identical speed profiles with one exception: The white Car1 use activate dynamic constraints by setting FollowingMode="follow" while the red Car2 will apply constant acceleration (linear interpolation) between speed targets by setting FollowingMode="position".</p>
</div>
<div class="paragraph">
<p>The action for white car:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;SpeedProfileAction</span> <span class="attribute-name">followingMode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">follow</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;DynamicConstraints</span>
        <span class="attribute-name">maxAcceleration</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">5.0</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">maxDeceleration</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">maxAccelerationRate</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">maxDecelerationRate</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">maxSpeed</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">50</span><span class="delimiter">&quot;</span></span>
    <span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/SpeedProfileAction&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The time values are relative each other and start of the action. In this case the action is triggered at simulation time = 2 seconds. Initial speed for both cars is 0. First entry has therefor no effect since it applies speed = 0 at time = 2 (2 + 0). After additional 4 seconds (sim time = 6s) the speed target is 10 m/s. At sim time 10s the speed target is 4 m/s and finally after 2 more seconds the final speed target value is 8.0 m/s.</p>
</div>
<div class="paragraph">
<p>The "follow" mode deserves some additional explanation. As shown in the figure, it start and ends with zero acceleration. Then is basically will try to match the acceleration "lines" but cutting the corners according to acceleration and deceleration rate constraints. This way the intermediate speed values will not always be reached. However, the final speed value will be reached.</p>
</div>
<div class="paragraph">
<p>If the target speed or accelerations can&#8217;t be reached with given constraints the action will revert to linear mode (FollowingMode="position") for the remainder of the profile. This "failure" is logged.</p>
</div>
<div class="paragraph">
<p>Another approach would be to try to perform a best effort, but that would require additional input to decide whether to prioritize reaching specified speed targets or respect time stamps&#8230;&#8203;</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Note</strong>: The implementation of this feature is preliminary and experimental. Behavior and details might change.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s manipulate the scenario in different ways to illustrate some special cases of the speed-profile feature.</p>
</div>
<div class="sect3">
<h4 id="_special_case_single_entry">5.1.1. Special case: Single entry</h4>
<div class="paragraph">
<p>(Special case implementation introduced in esmini v2.23.1)</p>
</div>
<div class="paragraph">
<p>Compared to SpeedAction, the SpeedProfileAction offers more tools in terms of dynamic constraints. Hence it can be actually be useful also for single entry, i.e. reach a single target speed.</p>
</div>
<div class="paragraph">
<p>The implementation differs for the single entry case. Target speed will be reached if constraints allows for it. If not, the speed will still be reached, but later than specified.</p>
</div>
<div class="paragraph">
<p>There are three sub cases:</p>
</div>
<div class="paragraph">
<p><strong>1. Speed can be reached within time</strong></p>
</div>
<div class="paragraph">
<p>The speed profile will contain three phases: Jerk, constant acceleration, jerk.</p>
</div>
<div class="paragraph">
<p>Example:<br>
Replace the four entries in speed-profile.xosc with the following ones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile5.png" alt="speed profile5">
</div>
</div>
<div class="paragraph">
<p>Initial positive jerk will be applied until necessary acceleration is reached. Keep constant acceleration (linear segment in the speed profile) until negative jerk needs to be applied in order to reach target speed on time and at zero acceleration.</p>
</div>
<div class="paragraph">
<p><strong>2. Speed can&#8217;t be reached in time due to acceleration constraints</strong></p>
</div>
<div class="paragraph">
<p>This speed profile will also contain three phases: Jerk, constant acceleration, jerk.</p>
</div>
<div class="paragraph">
<p>Example:<br>
Replace the four entries in speed-profile.xosc with the following ones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile6.png" alt="speed profile6">
</div>
</div>
<div class="paragraph">
<p>Initial positive jerk will be applied until maximum acceleration is reached (or maximum deceleration). Keep constant acceleration (linear segment in the speed profile) until negative jerk needs to be applied in order to reach target speed at zero acceleration. Due to the acceleration limitation there will be a delay as well. The log file will include something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>SpeedProfile: Constraining acceleration from 5.86 to 5.00
SpeedProfile: Extend 0.46 s</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>3. Speed can&#8217;t be reached in time due to jerk constraints</strong></p>
</div>
<div class="paragraph">
<p>This speed profile will contain only two jerk phases.</p>
</div>
<div class="paragraph">
<p>Example:<br>
Keep entries from last case, but change jerk settings as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">  maxAccelerationRate=&quot;3.0&quot;
  maxDecelerationRate=&quot;2.0&quot;</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile7.png" alt="speed profile7">
</div>
</div>
<div class="paragraph">
<p>In this case the jerk settings are too weak to reach target speed in time. Not enough acceleration can be achieved in the given time window.</p>
</div>
<div class="paragraph">
<p>Positive jerk will be applied until negative jerk has to be applied in order to reach target speed at zero acceleration. Hence there is no room for a phase of constant acceleration. Due to the jerk limitation there will be a delay. The log file will include something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>SpeedProfile: Can't reach target speed 10.00 on target time 3.00s with given jerk constraints, extend to 4.08s</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_what_if_current_speed_differ_from_the_first_entry">5.1.2. What if current speed differ from the first entry?</h4>
<div class="paragraph">
<p>Replace the four entries with the following ones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile2.png" alt="speed profile2">
</div>
</div>
<div class="paragraph">
<p>What we see here is that for linear mode (FollowingMode="position") the speed of the first entry will apply immediately regardless of the current speed at the time of the action being triggered. For constrained mode (FollowingMode="follow") we see that the initial speed value (3.0) is overridden by the current speed (0.0). From there it will strive for the second entry, obeying the constraints.</p>
</div>
<div class="paragraph">
<p>The overall idea with the "follow" mode is to maintain continuity in the speed profile, up to jerk degree.</p>
</div>
</div>
<div class="sect3">
<h4 id="_what_if_time_is_missing_in_entry">5.1.3. What if time is missing in entry?</h4>
<div class="paragraph">
<p>Replace any entries with the following ones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile3.png" alt="speed profile3">
</div>
</div>
<div class="paragraph">
<p>Specified max acceleration will be applied until target speed is reached. Note: In the non-linear case and with multiple entries, the function will fail if the specified acceleration can&#8217;t be reached with given jerk constraints (maxAcceleration and maxDeceleration). Try to lower the maxAcceleration/deceleration in this case.</p>
</div>
<div class="paragraph">
<p>You can also combine entries with and without time constraint, like in following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">15.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile4.png" alt="speed profile4">
</div>
</div>
<div class="paragraph">
<p>Car will accelerate until speed 10 m/s is reached, then spend 3 seconds to reach 15 m/s.</p>
</div>
</div>
<div class="sect3">
<h4 id="_initial_acceleration_taken_into_account">5.1.4. Initial acceleration taken into account</h4>
<div class="paragraph">
<p>(from release v2.23.2)</p>
</div>
<div class="paragraph">
<p>What if the acceleration is not zero when the SpeedProfileAction is started, for example interrupting an ongoing SpeedAction in Follow mode?</p>
</div>
<div class="paragraph">
<p>To maintain a continuous acceleration profile the action will use current acceleration as initial value. The standard states that the acceleration is expected to be zero at start and end of the action. The esmini interpretation is that the CHANGE is zero at start while the ACTUAL value is zero at end (since the action can only control acceleration while being active, not before).</p>
</div>
<div class="paragraph">
<p>Example:
Once again starting from <a href="https://github.com/esmini/esmini/blob/master/resources/xosc/speed-profile.xosc">speed-profile.xosc</a>, instead of setting an instant initial speed make it ramp up from 0 to 5 m/s over a duration of 4 seconds by tweaking the initial speed actions, for both entities, as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedActionDynamics</span> <span class="attribute-name">dynamicsShape</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">linear</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">dynamicsDimension</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">time</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedActionTarget&gt;</span>
        <span class="tag">&lt;AbsoluteTargetSpeed</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/SpeedActionTarget&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile8.png" alt="speed profile8">
</div>
</div>
<div class="paragraph">
<p>The initial speed action will apply constant acceleration until time = 2.0 seconds, when the SpeedProfileAction is triggered. While the linear profile will jump to 0 m/s (as specified in first entry) the follow mode profile will just apply necessary jerk to reach target acceleration with respect to following entries.</p>
</div>
<div class="paragraph">
<p>Initial acceleration is also respected for the special case of a single entry, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>the result becomes:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile9.png" alt="speed profile9">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sharp_brake_to_stop_profile">5.1.5. Sharp brake-to-stop profile</h4>
<div class="paragraph">
<p>To skip jerk phase, e.g. as in emergency brake with an abrupt stop, just set AccelerationRate to a large number.</p>
</div>
<div class="paragraph">
<p>Example:
Once again starting from <a href="https://github.com/esmini/esmini/blob/master/resources/xosc/speed-profile.xosc">speed-profile.xosc</a>, change speed in the Init speed actions to 10.0 and replace the speed profile actions as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileAction</span> <span class="attribute-name">followingMode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">follow</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;DynamicConstraints</span>
            <span class="attribute-name">maxAcceleration</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">5.0</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">maxDeceleration</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">maxAccelerationRate</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">1E10</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">maxDecelerationRate</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">maxSpeed</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">50</span><span class="delimiter">&quot;</span></span>
        <span class="tag">/&gt;</span>
        <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/SpeedProfileAction&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile10.png" alt="speed profile10">
</div>
</div>
<div class="paragraph">
<p><strong>Note</strong>: A drawback is that the setting will affect any acceleration phase in the complete profile. In other words, a limitation is that entries can&#8217;t have individual settings. In the example above it&#8217;s not problem since the first jerk phase is a deceleration while the second is an acceleration. If different rate values of same type are needed, it can be achieved by defining multiple SpeedProfile actions in a sequence, with individual performance settings.</p>
</div>
</div>
<div class="sect3">
<h4 id="_more_info">5.1.6. More info</h4>
<div class="paragraph">
<p>To get more understanding of the implementation, see a few slides <a href="https://drive.google.com/file/d/1DmjVHftcsbU71Ce_GASZ6IArcPA6teNF/view?usp=sharing">here</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_condition_delay">5.2. Condition delay</h3>
<div class="paragraph">
<p>Conditions can be delayed individually. A simple use case is to delay the closure of a scenario run, for example three seconds after any collision.</p>
</div>
<div class="paragraph">
<p>It gets more flexible, and complex, when combining delay with grouping, which is a way to represent AND and OR logical operations, see <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/07_components_scenario/07_06_conditions_triggers.html#_triggers_and_condition_groups">OpenSCENARIO XML v1.3 User guide - Triggers and condition groups</a>.</p>
</div>
<div class="paragraph">
<p>Consider the following example, based on the test scenario <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/Unittest/xosc/condition_delay.xosc">condition_delay.xosc</a> (used by test case TestConditionDelay in <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/Unittest/ScenarioEngine_test.cpp">ScenarioEngine_test</a>).</p>
</div>
<div class="paragraph">
<p>The scenario is basically one car accelerating linearly from 50 to 100 km/h (13.9 - 27.8 m/s) during two seconds, and then decelerating back to 50 km/h, again over two seconds. The speed is greater than 25 m/s in the time window 3.2 - 4.8 seconds. By 6.0 seconds the speed has decreased to 20.8 m/s.</p>
</div>
<div class="paragraph">
<p>There is one event including a LaneChange action and a StartTrigger containing three condition groups:</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>condition</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>delay</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>edge</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Group1</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">C1: SimulationTime  6.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">C2: Speed  25.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Group2</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">C3: SimulationTime  6.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">C4: Speed  25.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rising</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Group3</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">C5: SimulationTime  6.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">C6: Speed  25.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Briefly, the action will happen whenever all (two) conditions within any of the three groups becomes true. It can be illustrated as below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/condition_delay.png" alt="condition delay">
</div>
</div>
<div class="paragraph">
<p>The solid blue curve represents the speed profile. The two dashed curves represents the speed profile as interpreted by the two delayed speed conditions. The yellow area above the horizontal thick line represents speed  25 m/s. The blue area to the right of the vertical thick line represents time  6.0 s.</p>
</div>
<div class="paragraph">
<p>The first gray pyramid illustrates when condition C2 evaluates true. The gray dot represents when C4 evaluates true. The red pyramid represents C6 = true. Only the red pyramid is in the blue area (time  6s). In summary, only group 3 will evaluate to true. More specifically, it will become true as soon as speed becomes greater than 25 m/s, which happens at 7.2 seconds, which is passed 6 seconds.</p>
</div>
<div class="paragraph">
<p>Hopefully the above example gives some idea how condition delay works and how it can be utilized.</p>
</div>
</div>
<div class="sect2">
<h3 id="_road_signs">5.3. Road signs</h3>
<div class="paragraph">
<p>(framework updated in esmini v2.25.0)</p>
</div>
<div class="sect3">
<h4 id="_the_system">5.3.1. The system</h4>
<div class="paragraph">
<p>Road signs are specified in the <a href="https://www.asam.net/index.php?eID=dumpFile&amp;t=f&amp;f=4422&amp;token=e590561f3c39aa2260e5442e29e93f6693d1cccd#top-016f925e-bfe2-481d-b603-da4524d7491f">OpenDRIVE</a> road network description file. A road sign is identified by up to four parameters:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>country code</p>
</li>
<li>
<p>type</p>
</li>
<li>
<p>subtype</p>
</li>
<li>
<p>value</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Country code is a two letter word according to the <a href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2">ISO 3166-1 alpha-2 system</a>. Examples: Sweden = se, Germany = de.</p>
</div>
<div class="paragraph">
<p>Type and subtype defines the semantic meaning of the sign. The value is used when applicable to further specify information, e.g. speed or weight. Data type and meaning of the parameters may differ between countries. However a mapping to each country&#8217;s system is often feasible.</p>
</div>
<div class="paragraph">
<p>Examples:
In <a href="https://www.transportstyrelsen.se/sv/vagtrafik/Vagmarken/">Sweden a speed sign</a> belongs to the category prohibition signs named "c". Within that category speed signs is a sub group with index 31. Within that group each sign has a value of speed/10, e.g. 5=50km/h, 10=100km/h. So the parameters for a Swedish speed limit 90 km/h sign becomes: se, c, 31, 9.</p>
</div>
<div class="paragraph">
<p>In <a href="https://en.wikipedia.org/wiki/Road_signs_in_Germany">Germany</a> there are no similar categories. Instead all signs have a unique group or type number, e.g. speed signs make up group 274. Then the value defines the speed. No need for subtype. So the parameters for a German  speed limit 90 km/h sign becomes: de, 274, -, 90.</p>
</div>
</div>
<div class="sect3">
<h4 id="_esmini_sign_catalogs">5.3.2. esmini sign catalogs</h4>
<div class="paragraph">
<p>Instead of hard-coding road sign support esmini will lookup the <a href="https://opensimulationinterface.github.io/open-simulation-interface/structosi3_1_1TrafficSign_1_1MainSign_1_1Classification.html">OSI code</a> from a separate sign definition file, which is unique for each country. Name convention for the file is: <code>country code</code> + "_traffic_signals.txt". Example: Swedish catalog is named "se_traffic_signals.txt".</p>
</div>
<div class="paragraph">
<p>The file is a simple text format each line defining a sign ID and corresponding OSI type.</p>
</div>
<div class="paragraph">
<p>Swedish example: <code>c.31-7=TYPE_SPEED_LIMIT_BEGIN</code><br>
German example: <code>274=TYPE_SPEED_LIMIT_BEGIN</code></p>
</div>
<div class="paragraph">
<p>Type is mandatory. For esmini to distinguish between subtype and value different separators are used: "." before subtype and "-" before value. For some signs the value is optional, e.g. for speed signs it simply specify the speed limit. But for some signs it is used as a subtype to identify a variant of a sign, as in the German 101 type category.</p>
</div>
<div class="paragraph">
<p>Example files can be found in <a href="https://github.com/esmini/esmini/tree/master/resources/traffic_signals">esmini/resources/traffic_signals</a>.</p>
</div>
<div class="paragraph">
<p>Currently (v2.25.0) the esmini sign support is very limited. However, it should be fairly straight forward to add signs into existing catalogs and even catalogs (for more countries).</p>
</div>
</div>
<div class="sect3">
<h4 id="_sign_3d_models">5.3.3. Sign 3D models</h4>
<div class="paragraph">
<p>esmini road signs are created as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A basic 3D geometry is modeled in Blender, e.g. round face for speed signs</p>
</li>
<li>
<p>Assign a material with any texture image mapped on the sign face</p>
</li>
<li>
<p>The 3D model is exported in <code>.dae</code> format (example <a href="https://drive.google.com/uc?export=download&amp;id=11v7xz9Mqw_Vx4An_FoLfKVlwcWJc-mnE">here</a>)</p>
</li>
<li>
<p>Find textures of the needed sign(s) and convert them into some common format, e.g. <code>.png</code>. Recommended size is 256, but larger is OK. If possible make it size 2^n x 2^m to avoid performance penalty on low spec/old systems.</p>
</li>
<li>
<p>Rename image to the same name as the texture image in the dae file (sign_image.png in the example dae)</p>
</li>
<li>
<p>Convert the .dae file into .osgb using osgconv. The texture will be embedded in the.osgb file by default.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed_sign_blender.png" alt="speed sign blender">
</div>
<div class="title">Speed sign in Blender</div>
</div>
<div class="paragraph">
<p>A <a href="https://github.com/esmini/esmini/blob/master/scripts/bake_signs.sh">script</a> is available as a starting point for automating the two last steps in the process above.</p>
</div>
</div>
<div class="sect3">
<h4 id="_example">5.3.4. Example</h4>
<div class="paragraph">
<p>The OpenDRIVE file <a href="https://github.com/esmini/esmini/blob/master/resources/xodr/straight_500m_signs.xodr">straight_500m_signs.xodr</a> includes a bunch of speed signs, some Swedish and some German ones. It shows how the signs are specified in terms of the country code, type, subtype and value attributes.</p>
</div>
<div class="paragraph">
<p>It also shows how to specify the 3D model using the <code>name</code> attribute: If filename composed by country, type, subtype and value is not found, the <code>name</code> attribute + ".osgb" will be used for a second and final attempt.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed_sign1.png" alt="speed sign1">
</div>
<div class="title">Swedish speed sign</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed_sign2.png" alt="speed sign2">
</div>
<div class="title">German speed sign</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_expressions">5.4. Expressions</h3>
<div class="paragraph">
<p>From OpenSCENARIO v1.1 <a href="https://www.asam.net/index.php?eID=dumpFile&amp;t=f&amp;f=4908&amp;token=ae9d9b44ab9257e817072a653b5d5e98ee0babf8#_expressions">expressions</a> including mathematical operations are supported in assignment of value to OpenSCENARIO <a href="https://www.asam.net/index.php?eID=dumpFile&amp;t=f&amp;f=4908&amp;token=ae9d9b44ab9257e817072a653b5d5e98ee0babf8#_parameters">parameters</a> and XML element attributes. Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;ParameterDeclaration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PI</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">double</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.14159</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;ParameterDeclaration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">KPH2MPS</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">double</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1/3.6</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

...

<span class="tag">&lt;Position&gt;</span>
    <span class="tag">&lt;LanePosition</span> <span class="attribute-name">roadId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">laneId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">s</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">40</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;Orientation</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">absolute</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">h</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${sin(0.25*$PI)}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/LanePosition&gt;</span>
<span class="tag">&lt;/Position&gt;</span>

...

<span class="tag">&lt;SpeedActionTarget&gt;</span>
    <span class="tag">&lt;AbsoluteTargetSpeed</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${110 * $KPH2MPS}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/SpeedActionTarget&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>h and (speed value) evaluates to 0.707106 and 30.55558 respectively</p>
</div>
<h4 id="_supported_expression_operators_and_functions" class="discrete">Supported expression operators and functions</h4>
<h5 id="_operators" class="discrete">Operators</h5>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>+</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>-</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>*</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">multiply</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>/</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>%</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IEEE 754 remainder, see <a href="https://en.cppreference.com/w/cpp/numeric/math/remainder">C++ std::remainder</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>**</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">power</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&lt;</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&lt;=</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&gt;</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&gt;=</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>==</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">equal</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>!=</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not equal</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&amp;&amp;</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">logical AND</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>||</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">logical OR</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>See <a href="https://github.com/esmini/esmini/blob/a53f09d85194509aa9d0c12971b1c73963c21d34/externals/expr/expr.h#L169">expr.h</a> for complete and updated list.</p>
</div>
<h5 id="_functions" class="discrete">Functions</h5>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>round</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">see <a href="https://en.cppreference.com/w/c/numeric/math/rint">C++ rint</a> (Round to nearest, halfway cases to even. Aligned with IEEE 754 default)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>floor</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">see <a href="https://en.cppreference.com/w/c/numeric/math/floor">C++ floor</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>ceil</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">see  <a href="https://en.cppreference.com/w/c/numeric/math/ceil">C++ ceil</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>sqrt</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">square root</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>pow</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">see <a href="https://en.cppreference.com/w/c/numeric/math/pow">C++ pow</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Following functions are supported by esmini, but not specified in OpenSCENARIO &lt;= 1.2, hence use with care since they may not work in other tools</p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>sin</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>cos</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>tan</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>asin</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>acos</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>atan</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>sign</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>abs</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>max</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>min</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>See <a href="https://github.com/esmini/esmini/blob/c9dc63c45be0dc479c22b78be74d047fc4449e7c/EnvironmentSimulator/Modules/ScenarioEngine/SourceFiles/simple_expr.c#L101">simple_expr.c</a> for complete and updated list.</p>
</div>
<h5 id="_strings" class="discrete">Strings</h5>
<div class="paragraph">
<p>From v2.35.0 string concatenation is supported. Whenever a string is detected that is netiher an opeator nor a function, the complete expression is treated as a string and '+' (plus) operator will merge surrounding evaluated strings which also can be evaluated parameters.</p>
</div>
<div class="paragraph">
<p>This can be useful when running permutations of scenarios, where names of actors or storyboard elements can be made unique by including parameters values.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="paragraph">
<p><code>${Event_overtake_ + $ActorName}</code> &#8594; <code>Event_overtake_Target4</code></p>
</div>
<div class="paragraph">
<p><code>${Event_change_speed_to_ + $Speed}</code> &#8594; <code>Event_change_speed_to_110</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_parameter_distributions">5.5. Parameter distributions</h3>
<div class="paragraph">
<p>Parameter values and distributions can be specified in a separate <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/09_reuse_mechanisms/09_03_parameter_distribution.html">Parameter value distribution file</a>. This is a convenient way of running multiple variations, or parameter value permutations, of a single scenario.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example: <a href="https://github.com/esmini/esmini/blob/master/resources/xosc/cut-in_parameter_set.xosc">cut-in_parameter_set.xosc</a>.</p>
</div>
<div class="paragraph">
<p>To run all permutations with esmini, the following variants works:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in_parameter_set.xosc</code></p>
</li>
<li>
<p><code>./bin/esmini --window 60 60 800 400 --param_dist ./resources/xosc/cut-in_parameter_set.xosc</code></p>
</li>
<li>
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --param_dist ./resources/xosc/cut-in_parameter_set.xosc</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The first two will use the scenario file referred to by the <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/ParameterValueDistribution.html">ParameterValueDistriution element</a> inside the parameter value distribution file (<code>cut-in_parameter_set.xosc</code>). The third example will apply the parameter settings on the scenario defined by the <code>osc</code> launch argument, overriding any scenario reference in the specified <code>param_dist</code> file. This can be useful when a single parameter distribution applies to multiple scenarios (instead of having one parameter file for each scenario).</p>
</div>
<div class="paragraph">
<p>How to abort:</p>
</div>
<div class="paragraph">
<p><code>"ESC"</code> (in window) will terminate current run<br>
<code>"Ctrl-C"</code> (in terminal) will terminate all runs</p>
</div>
<div class="paragraph">
<p>The log files are now named according to:
<code>log_&lt;permutation&gt;_of_&lt;total#permutations&gt;.txt</code></p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="paragraph">
<p><code>log_1_of_12.txt</code> relates to the 1:th run of 12, permutation index 0<br>
<code>log_4_of_12.txt</code> relates to the 4:th run of 12, permutation index 3</p>
</div>
<div class="paragraph">
<p>Of course this will apply also to custom log filenames. Example:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in_parameter_set.xosc --logfile_path my_scenario.txt</code></p>
</div>
<div class="paragraph">
<p>will output <code>my_scenario_1_of_12.txt</code>, <code>my_scenario_2_of_12.txt</code> &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Also any recording (.dat), osi and csv files will be named in similar way. Example:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in_parameter_set.xosc --record sim.dat --osi_file gt.osi --csv_logger data_log.csv</code></p>
</div>
<div class="paragraph">
<p>will output complete sets of files:<br>
<code>log_1_of_12.txt</code> &#8230;&#8203;<br>
<code>sim_1_of_12.dat</code> &#8230;&#8203;<br>
<code>gt_1_of_12.osi</code> &#8230;&#8203;<br>
<code>data_log_1_of_12.csv</code> &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>To run a specific permutation only, specify index like this:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in_parameter_set.xosc --param_permutation 2</code></p>
</div>
<div class="paragraph">
<p>will run 3:rd permutation (of 12 available in this case)</p>
</div>
<div class="paragraph">
<p>Save the resulting OpenSCENARIO file with populated parameter values:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in_parameter_set.xosc --save_xosc</code></p>
</div>
<div class="paragraph">
<p>will output all twelve scenarios <code>cut-in_1_of_12.xosc</code> &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>To just save the scenario files quickly without executing them, add optional <code>quit</code> argument to the <code>save_osc</code> option, like this:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in_parameter_set.xosc --save_xosc quit</code></p>
</div>
<div class="paragraph">
<p>To view all results in parallel, make use of replayer like this:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --headless --fixed_timestep 0.05 --osc ./resources/xosc/cut-in_parameter_set.xosc --record sim.dat ; ./bin/replayer --window 60 60 800 400 --res_path ./resources/ --file sim_ --dir .</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/param_dist0.jpg" alt="param dist0">
</div>
<div class="title">View all permutations in parallel</div>
</div>
<div class="sect3">
<h4 id="_parallel_execution">5.5.1. Parallel execution</h4>
<div class="paragraph">
<p>Making use of Python threading pool framework we can utilize any multiple CPU kernels and run scenario variants in parallel. This is handled by the script <a href="https://github.com/esmini/esmini/blob/master/scripts/run_distribution.py">scripts/run_distribution.py</a>.</p>
</div>
<div class="paragraph">
<p>Usage: <code>run_distribution.py &lt;esmini args&gt;</code></p>
</div>
<div class="paragraph">
<p>Make sure to add at least the following esmini arguments:<br>
<code>--osc &lt;parameter distribution file&gt;</code><br>
<code>--fixed_timestep &lt;timestep&gt;</code><br>
<code>--headless</code></p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="paragraph">
<p><code>python ./scripts/run_distribution.py --osc ./resources/xosc/cut-in_parameter_set.xosc --fixed_timestep 0.05 --headless --record sim.dat</code></p>
</div>
<div class="paragraph">
<p>Of course, the --headless (and --fixed_timestep) is not required. It is possible to run with viewer as well:</p>
</div>
<div class="paragraph">
<p><code>python ./scripts/run_distribution.py --osc ./resources/xosc/cut-in_parameter_set.xosc --window 60 60 800 400</code></p>
</div>
<div class="paragraph">
<p>but the windows will open on top of each other at the same location on the screen, so you need to manually move them apart to see the parallel runs. Anyway, this use case is probably not relevant so the recommendation is to run headless with fixed time step.</p>
</div>
<div class="paragraph">
<p>Putting it all together, execute the scenario permutations in parallel and then view the result in replayer:</p>
</div>
<div class="paragraph">
<p><code>python ./scripts/run_distribution.py --osc ./resources/xosc/cut-in_parameter_set.xosc --fixed_timestep 0.05 --headless --record sim.dat ; ./bin/replayer --window 60 60 800 400 --res_path ./resources/ --file sim_ --dir .</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_finding_out_number_of_permutations">5.5.2. Finding out number of permutations</h4>
<div class="paragraph">
<p>To find out the number of permutations of a specific scenario and parameter distribution, use the <code>--return_nr_permutations</code> launch argument. Example:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --osc ./resources/xosc/cut-in_parameter_set.xosc --return_nr_permutations</code></p>
</div>
<div class="paragraph">
<p>Output:
<code>Nr permutations: 12</code></p>
</div>
<div class="paragraph">
<p>For scripters: esmini will also return the number of permutations as exit code, for simple use in scripts.
After executing the above the exit code can be inspected/verified from shell as well:</p>
</div>
<div class="paragraph">
<p>PowerShell:<br>
<code>echo $LastExitCode</code> <br>
<code>6</code></p>
</div>
<div class="paragraph">
<p>bash:<br>
<code>echo $?</code><br>
<code>6</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_trajectories">5.6. Trajectories</h3>
<div class="paragraph">
<p>Using OpenSCENARIO <a href="https://www.asam.net/static_downloads/ASAM_OpenSCENARIO_V1.2.0_Model_Documentation/modelDocumentation/content/FollowTrajectoryAction.html">FollowTrajectoryAction</a> you can define various types of trajectories for entities to follow.</p>
</div>
<div class="paragraph">
<p>esmini supports all three (as of OpenSCENARIO 1.2) <a href="https://www.asam.net/static_downloads/ASAM_OpenSCENARIO_V1.2.0_Model_Documentation/modelDocumentation/content/Shape.html">shapes</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>polyline</p>
</li>
<li>
<p>clothoid</p>
</li>
<li>
<p>nurbs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here follows a few design choices for the polyline type that affect the behavior.</p>
</div>
<div class="paragraph">
<p>When FollowMode is <code>follow</code> esmini will:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Calculate heading based on direction of the line segments. However corners are interpolated in order to look better and avoid discontinuities.</p>
</li>
<li>
<p>Calculate speed based on current speed (when action is triggered) and then with constant acceleration per segment reach destination vertex on time (or earlier if distance is too short vs time). This approach results in a continuous speed profile.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When FollowMode is <code>position</code> esmini will:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For world coordinates, apply whatever heading is specified in the vertices (note that 0.0 is default). Lane and road coordinates will align to road direction as default.</p>
</li>
<li>
<p>For each segment, calculate constant speed needed to reach next vertex on time. This approach results in a discontinuous speed profile.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_trajectory_moving_and_driving_direction">5.6.1. Trajectory moving and driving direction</h4>
<div class="paragraph">
<p>The driving direction and entity direction can be controlled by trajectory configuration combined with entity speed and heading. It&#8217;s possible to follow trajectory in opposite direction and also to drive forward or reverse along the trajectory. The table below lists some combinations and possibilities.</p>
</div>
<table class="tableblock frame-all grid-all stripes-even stretch">
<colgroup>
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 6.6666%;">
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 13.3336%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">trajectory type</th>
<th class="tableblock halign-left valign-top">specified heading</th>
<th class="tableblock halign-left valign-top">time-stamps</th>
<th class="tableblock halign-left valign-top">speed sign</th>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">entity heading</th>
<th class="tableblock halign-left valign-top">moving direction</th>
<th class="tableblock halign-left valign-top">entity (in tc)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">clothoid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bicycle1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">clothoid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">scooter1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">polyline/nurbs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">car_white</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">polyline/nurbs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">car_red</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">polyline/nurbs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 *</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">car_blue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">polyline/nurbs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">car_yellow</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">polyline/nurbs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">van_red</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">polyline/nurbs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 *</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">motorbike</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">polyline/nurbs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">car_trailer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">polyline/nurbs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">semi_tractor</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">polyline/nurbs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1 *</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">truck_yellow</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>* calculated based on entity heading sign</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>specified heading</strong>
</td>
<td class="hdlist2">
<p>explicit heading (optionally supported by some shape types) in trajectory control points pointing forward (-90 &lt; heading &lt; 90 deg along trajectory s axis) or backwards. n/a indicates not supported, "-" not specified, 1 forward, -1 backwards.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>timestamps</strong>
</td>
<td class="hdlist2">
<p>"-" indicates not specified or timeReference == None, "yes" indicates specified heading and timeReference != None</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>speed sign</strong>
</td>
<td class="hdlist2">
<p>1 for speed &gt;= 0, -1 for speed &lt; 0. For timestamp mode, the magnitude of speed and overall motion direction is given by trajectory control point&#8217;s timestamps and heading. Allowing for reversing, the initial heading of the entity, if specified, affects whether speed is positive (driving forward) or negative (reversing).</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>entity heading</strong>
</td>
<td class="hdlist2">
<p>Entity heading relative trajectory s-axis direction (heading/tangent). 1: facing along s, -1: facing away from s. When not specified, entity heading will be aligned forward (1) or backwards (-1) according to the speed sign. Interpolation will be applied based on specified followingMode, see previous section.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>moving direction</strong>
</td>
<td class="hdlist2">
<p>reference point motion along trajectory s-axis or opposite direction, given by: speed sign * entity heading</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>entity (in tc)</strong>
</td>
<td class="hdlist2">
<p>Corresponding entity in the smoke test scenario <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Unittest/xosc/trajectory_speed.xosc">trajectory_speed.xosc</a>, which checks the various trajectory configurations.</p>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_example_scenarios">Example scenarios</h5>
<div class="paragraph">
<p>The following test cases cover the various cases and beyond.</p>
</div>
<div class="videoblock">
<div class="title">test case scenario <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/Unittest/xosc/trajectory_speed.xosc">trajectory_speed.xosc</a></div>
<div class="content">
<iframe width="854" height="480" src="https://www.youtube.com/embed/mSekcv5Mqeo?rel=0&amp;autoplay=1&amp;loop=1&amp;controls=0&amp;playlist=mSekcv5Mqeo" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="videoblock">
<div class="title">scenario <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/Unittest/xosc/trajectory_special_cases.xosc">trajectory_special_cases.xosc</a> including example how to transition between reverse and forward driving</div>
<div class="content">
<iframe width="854" height="480" src="https://www.youtube.com/embed/sjOgdx8qfEM?rel=0&amp;autoplay=1&amp;loop=1&amp;controls=0&amp;playlist=sjOgdx8qfEM" frameborder="0" allowfullscreen></iframe>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_friction">5.7. Friction</h3>
<div class="paragraph">
<p>From v2.37.0 esmini supports road friction defined in <a href="https://publications.pages.asam.net/standards/ASAM_OpenDRIVE/ASAM_OpenDRIVE_Specification/latest/specification/11_lanes/11_07_lane_properties.html#sec-8345bf25-d584-4a5b-8fa7-e15c920ab219">OpenDRIVE lane material</a>.</p>
</div>
<div class="paragraph">
<p>Each lane within a lane section can have one or multiple segments of individual friction values, specified by s-value and friction coefficient.</p>
</div>
<div class="paragraph">
<p>Default friction coefficient is 1.0 as of v2.37.0, but might change in later versions. Lower friction (&lt;1.0, slippery) will be visualized as bluish color. The lower friction, the more blue color. High friction values (&gt;1.0,  "grippy") is indicated by redish color.</p>
</div>
<div class="paragraph">
<p>The friction is calculated per wheel. The values are reported in OSI ground-truth.</p>
</div>
<div class="paragraph">
<p>Example road: <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/Unittest/xodr/straight_highway_500m.xodr">straight_highway_500m.xodr</a> (used by test scenario <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/Unittest/xosc/friction_and_lane_change_edge_case.xosc">friction_and_lane_change_edge_case.xosc</a>)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/friction.jpg" alt="friction">
</div>
<div class="title">Road with various friction segments, coefficient evaluated per wheel</div>
</div>
</div>
<div class="sect2">
<h3 id="_sumo_integration">5.8. SUMO integration</h3>
<div class="paragraph">
<p><a href="https://eclipse.dev/sumo/">SUMO</a> is a great open source traffic simulation tool. It has been integrated with esmini, making it possible to run SUMO simulations in esmini, and even mix or co-simulate SUMO vehicles with OpenSCENARIO vehicles.</p>
</div>
<div class="paragraph">
<p><strong>NOTE:</strong> Even though SUMO has been linked with esmini for quite long, it&#8217;s on a experimental level and has not been used a lot. Hence, expect shortcomings and issues. The currently integrated SUMO version, as of esmini v2.37.1, is 1.6.0 while the current SUMO version is 1.19.0. There is plans to update SUMO version in esmini in a soon future.</p>
</div>
<div class="paragraph">
<p>This chapter explains how to create a SUMO simulation and then how to use it in esmini. For just using SUMO simulations there is no need to install SUMO, it is already embedded with esmini (as long as it has not been explicitly excluded, see <a href="#_slim_esmini_customize_configration">Slim esmini - customize configration</a>). Only to create SUMO content it has to be installed.</p>
</div>
<div class="sect3">
<h4 id="_install_sumo">5.8.1. Install SUMO</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get SUMO from here: <a href="https://eclipse.dev/sumo/" class="bare">https://eclipse.dev/sumo/</a></p>
</li>
<li>
<p>Install normally, check any option to add sumo to environment path variable</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_try_example_from_esmini">5.8.2. Try example from esmini</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Launch <code>sumo-gui</code> application</p>
</li>
<li>
<p>File &#8594; Open Simulation</p>
</li>
<li>
<p>Navigate to <code>esmini/resources/sumo_inputs</code> and select <code>multi_intersections.sumocfg</code></p>
</li>
<li>
<p>Set Delay (ms) to 100, otherwise simulation will run super-quick</p>
</li>
<li>
<p>Run (Play button or Simulation &#8594; Run)</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_same_scenario_in_esmini">5.8.3. Running the same scenario in esmini</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a terminal, from esmini root folder, run:</p>
</li>
<li>
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/sumo-test.xosc</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_sumo_simulation">5.8.4. Create a SUMO simulation</h4>
<div class="paragraph">
<p>First, there is a great complete guide at <a href="https://sumo.dlr.de/docs/" class="bare">https://sumo.dlr.de/docs/</a></p>
</div>
<div class="paragraph">
<p>The main flow of our example is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Convert an OpenDRIVE file into a SUMO road network</p>
</li>
<li>
<p>Identify some trips (start and end points) within the road network</p>
</li>
<li>
<p>From the trips, resolve complete routes wthich are assigned to vehicles and distribute over time</p>
</li>
<li>
<p>Create a configuration referring to the road network and route definition</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Step-by-step:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new folder, e.g. "my_sumo", for this example</p>
</li>
<li>
<p>Copy esmini/EnvironmentSimulator/Unittest/xodr/simple_3way_motorway.xodr into the new folder</p>
</li>
<li>
<p>Open a terminal in the new folder</p>
</li>
<li>
<p>Convert the xodr into a SUMO <a href="https://sumo.dlr.de/docs/Networks/SUMO_Road_Networks.html">road network</a>:<br>
<code>netconvert --opendrive fabriksgatan.xodr -o my_sumo.net.xml</code></p>
</li>
<li>
<p>Create some traffic using <a href="https://sumo.dlr.de/docs/Tools/Trip.html#randomtripspy">randomTrips.py</a> (and <a href="https://sumo.dlr.de/docs/duarouter.html">duarouter</a>):<br>
<code>randomTrips.py -n my_sumo.net.xml -e 60 -o my_sumo.trips.xml --route-file my_sumo.rou.xml</code></p>
<div class="paragraph">
<p>If this fails, it may be because of lacking .py file association. Try:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>python3 randomTrips.py ...
python randomTrips.py ...
python3 tools/randomTrips.py ...
python tools/randomTrips.py ...</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Create the configuration file</p>
<div class="paragraph">
<p>Save the following lines into a new file named "my_sumo.sumocfg":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;iso-8859-1&quot;?&gt;</span>
<span class="tag">&lt;configuration&gt;</span>
    <span class="tag">&lt;input&gt;</span>
        <span class="tag">&lt;net-file</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my_sumo.net.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;route-files</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">my_sumo.rou.xml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/input&gt;</span>
    <span class="tag">&lt;time&gt;</span>
        <span class="tag">&lt;begin</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;end</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">60</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;step-length</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.01</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/time&gt;</span>
<span class="tag">&lt;/configuration&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Open Sumo, load the created config file "my_sumo.sumocfg" and run as in first example, <a href="#_try_example_from_esmini">Try example from esmini</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_connect_a_sumo_simulation_to_a_scenario_in_esmini">5.8.5. Connect a SUMO simulation to a scenario in esmini</h4>
<div class="paragraph">
<p>Currently, as of esmini v2.37.1, SUMO is integrated in terms of a controller. To add a SUMO simulation, define an entity as usual, assign the SumoController and set its "filepath" property to the sumocfg file.</p>
</div>
<div class="paragraph">
<p>Now when we have a complete SUMO configuration, do the following steps in order to use it in esmini:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Copy the three files: my_sumo.net.xml, my_sumo.rou.xml and my_sumo.sumocfg (roadnetwork, routes, config) to <code>esmini/resources/sumo_inputs</code></p>
</li>
<li>
<p>Create a file named "my_sumo.xosc", in <code>esmini/resources/xosc</code> with the following content:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;OpenSCENARIO&gt;</span>
    <span class="tag">&lt;FileHeader</span> <span class="attribute-name">author</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">esmini team</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">date</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2024-03-06T10:00:00</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">description</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sumo integration example</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">revMajor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">revMinor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;ParameterDeclarations</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;CatalogLocations&gt;</span>
        <span class="tag">&lt;VehicleCatalog&gt;</span>
            <span class="tag">&lt;Directory</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">../xosc/Catalogs/Vehicles</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/VehicleCatalog&gt;</span>
        <span class="tag">&lt;ControllerCatalog&gt;</span>
            <span class="tag">&lt;Directory</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">../xosc/Catalogs/Controllers</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/ControllerCatalog&gt;</span>
    <span class="tag">&lt;/CatalogLocations&gt;</span>
    <span class="tag">&lt;RoadNetwork&gt;</span>
        <span class="tag">&lt;LogicFile</span> <span class="attribute-name">filepath</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">../xodr/fabriksgatan.xodr</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/RoadNetwork&gt;</span>
    <span class="tag">&lt;Entities&gt;</span>
        <span class="tag">&lt;ScenarioObject</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SumoVehicles</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;CatalogReference</span> <span class="attribute-name">catalogName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VehicleCatalog</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">entryName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">car_red</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;ObjectController&gt;</span>
                <span class="tag">&lt;Controller</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SumoController</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;Properties&gt;</span>
                        <span class="tag">&lt;File</span> <span class="attribute-name">filepath</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">../sumo_inputs/my_sumo.sumocfg</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;/Properties&gt;</span>
                <span class="tag">&lt;/Controller&gt;</span>
            <span class="tag">&lt;/ObjectController&gt;</span>
        <span class="tag">&lt;/ScenarioObject&gt;</span>
    <span class="tag">&lt;/Entities&gt;</span>
    <span class="tag">&lt;Storyboard&gt;</span>
        <span class="tag">&lt;Init&gt;</span>
            <span class="tag">&lt;Actions</span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/Init&gt;</span>
        <span class="tag">&lt;StopTrigger</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/Storyboard&gt;</span>
<span class="tag">&lt;/OpenSCENARIO&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Run from esmini root folder:</p>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/my_sumo.xosc</code></p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_positioning">6. Positioning</h2>
<div class="sectionbody">
<div class="paragraph">
<p>esmini supports all OpenSCENARIO position types. To support various use cases esmini add some mechanisms and interpretations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Align by omit</strong>: Lacking position component values (x, y, z, heading, pitch, roll) in the scenario file is interpreted as "please align this component to the road surface". E.g. missing z value will project the position on the road surface, missing pitch value will ensure object is aligned with road pitch (e.g. up- and downhill).</p>
</li>
<li>
<p><strong>PositionMode</strong>: Any position/object can be set and configured with respect to alignment via API calls. For example: x, y and heading can be set as absolute values while pitch and roll can be set as relative to the road surface.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See more details below in <a href="#_position_modes">Position modes</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Trajectory interpolation</strong>: Based omitted position components and followingMode setting esmini will apply different mechanisms to follow and interpolate trajectory vertices/control points.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See details below in <a href="#_trajectory_interpolation_and_alignment">Trajectory interpolation and alignment</a></p>
</div>
<div class="sect2">
<h3 id="_position_modes">6.1. Position modes</h3>
<div class="paragraph">
<p>The purpose of position modes is to allow flexible and detailed control whether to interpret Z (elevation), heading, pitch and roll as absolute values or relative to the road. X and Y will always be interpreted as absolute values.</p>
</div>
<div class="paragraph">
<p>For some use cases orientation should be aligned to road surface, e.g. a vehicle simply driving along a hilly road. In some cases pitch and roll should be zero, e.g. signs and buildings along the road. External vehicle models can choose whether to report relative or absolute values. It can also be combination, e.g. explicit/absolute heading while z, roll and pitch are realative (to the road) - or any other combination.</p>
</div>
<div class="paragraph">
<p>The mode can be specified explicitly when calling a set position function. Example:</p>
</div>
<div class="paragraph">
<p><code>pos.SetInertiaPosMode(x, y, z, h, p, r, PosMode::Z_REL | PosMode::H_ABS | PosMode::P_REL | PosMode::R_REL);</code></p>
</div>
<div class="paragraph">
<p>In above example x, y, and h will be interpretated as absolute values while z, p, and r as relative to the road.</p>
</div>
<div class="sect3">
<h4 id="_persistent_mode_setting">6.1.1. Persistent mode setting</h4>
<div class="paragraph">
<p>In most cases the same mode setting will be used throughout the simulation for each object. For this reason, as conveience, the mode can be set once per object. Example:</p>
</div>
<div class="paragraph">
<p><code>pos.SetMode(Position::PosModeType::SET, PosMode::Z_REL | PosMode::H_ABS | PosMode::P_REL | PosMode::R_REL);</code></p>
</div>
<div class="paragraph">
<p>Then, when calling set functions, mode can be set to zero. Example:</p>
</div>
<div class="paragraph">
<p><code>pos.SetInertiaPosMode(x, y, z, h, p, r, 0);</code></p>
</div>
<div class="paragraph">
<p>or use the simple variants skipping the mode argument. Example:</p>
</div>
<div class="paragraph">
<p><code>pos.SetInertiaPos(x, y, z, h, p, r);</code></p>
</div>
<div class="paragraph">
<p>These cases will utilize the current setting.</p>
</div>
</div>
<div class="sect3">
<h4 id="_two_types_of_settings">6.1.2. Two types of settings</h4>
<div class="paragraph">
<p>Note the type=SET argument of the SetMode() example above. It specifies as to which type of operations the settings applies to. There are two types of modes: SET and UPDATE. SET applies to API calls setting Cartesian coordinates. UPDATE applies to position updates by default controller and API calls setting Lane and Road coordinates.</p>
</div>
<div class="paragraph">
<p>This way a position object can, for example, maintain relative heading follow the curvature of the road when updated by the default controller, while heading can be set explicitly in terms of absolute value by API calls.</p>
</div>
<div class="paragraph">
<p><code>pos.SetMode(Position::PosModeType::UPDATE, PosMode::Z_REL | PosMode::H_REL | PosMode::P_REL | PosMode::R_REL);</code></p>
</div>
<div class="paragraph">
<p><code>pos.SetMode(Position::PosModeType::SET, PosMode::Z_REL | PosMode::H_ABS | PosMode::P_REL | PosMode::R_REL);</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_default_values">6.1.3. Default values</h4>
<div class="paragraph">
<p>There will be a default setting for both SET and UPDATE which will be applied until changed by SetMode() function:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>SET</strong>
</td>
<td class="hdlist2">
<p>PosMode::Z_REL | PosMode::H_ABS | PosMode::P_REL | PosMode::R_REL</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>UPDATE</strong>
</td>
<td class="hdlist2">
<p>PosMode::Z_REL | PosMode::H_REL | PosMode::P_REL | PosMode::R_REL</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Further examples</strong></p>
</div>
<div class="paragraph">
<p>Specify only mode for Z, reuse whatever setting for the remaining components:</p>
</div>
<div class="paragraph">
<p><code>pos.SetInertiaPosMode(x, y, z, h, p, r, PosMode::Z_ABS);</code></p>
</div>
<div class="paragraph">
<p>Set/reset default value for pitch, reuse whatever setting for the other components:</p>
</div>
<div class="paragraph">
<p><code>pos.SetInertiaPosMode(x, y, z, h, p, r, PosMode::Z_MASK &amp; PosMode::Z_DEF);</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mode_specification">6.2. Mode specification</h3>
<div class="paragraph">
<p>Mode is coded in four chunks of three bits. One chunk for each of the position components Z, Heading, Pitch and Roll. Chunks are padded and aligned to segments of four bytes.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 25%;">
<col style="width: 37.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Z</th>
<th class="tableblock halign-left valign-top">Comment</th>
<th class="tableblock halign-left valign-top">Hex</th>
<th class="tableblock halign-left valign-top">Int</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SKIP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XXXX XXXX XXXX XXX0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first bit is zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Z_DEF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XXXX XXXX XXXX XX01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first bit is one, second is zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0001</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Z_ABS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XXXX XXXX XXXX X011</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first and second bit is one, third zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0003</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Z_REL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XXXX XXXX XXXX X111</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first, second and third bits are all one</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0007</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 25%;">
<col style="width: 37.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">H</th>
<th class="tableblock halign-left valign-top">Comment</th>
<th class="tableblock halign-left valign-top">Hex</th>
<th class="tableblock halign-left valign-top">Int</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SKIP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XXXX XXXX XXX0 XXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first bit is zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">H_DEF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XXXX XXXX XX01 XXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first bit is one, second is zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0010</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">H_ABS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XXXX XXXX X011 XXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first and second bit is one, third zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0030</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">48</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">H_REL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XXXX XXXX X111 XXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first, second and third bits are all one</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0070</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">112</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 25%;">
<col style="width: 37.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">P</th>
<th class="tableblock halign-left valign-top">Comment</th>
<th class="tableblock halign-left valign-top">Hex</th>
<th class="tableblock halign-left valign-top">Int</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SKIP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XXXX XXX0 XXXX XXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first bit is zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">P_DEF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XXXX XX01 XXXX XXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first bit is one, second is zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">256</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">P_ABS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XXXX X011 XXXX XXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first and second bit is one, third zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0300</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">768</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">P_REL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XXXX X111 XXXX XXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first, second and third bits are all one</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0700</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1,792</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 25%;">
<col style="width: 37.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">R</th>
<th class="tableblock halign-left valign-top">Comment</th>
<th class="tableblock halign-left valign-top">Hex</th>
<th class="tableblock halign-left valign-top">Int</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SKIP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XXX0 XXXX XXXX XXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first bit is zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x0000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">R_DEF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XX01 XXXX XXXX XXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first bit is one, second is zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4,096</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">R_ABS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X011 XXXX XXXX XXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first and second bit is one, third zero</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x3000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12,288</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">R_REL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X111 XXXX XXXX XXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">first, second and third bits are all one</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x7000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">28,672</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Looking up values in the table above, modes can be specified in numerous ways.</p>
</div>
<div class="paragraph">
<p>For example: To set world position with relative Z and absolute Pitch, reusing setting for the other components, any of the following identical examples will work:</p>
</div>
<div class="paragraph">
<p><code>pos.SetInertiaPosMode(x, y, z, h, p, r, PosMode::Z_REL | PosMode::P_ABS);</code><br>
=<br>
<code>pos.SetInertiaPosMode(x, y, z, h, p, r, 0x7 | 0x300);</code><br>
=<br>
<code>pos.SetInertiaPosMode(x, y, z, h, p, r, 0x307);</code><br>
=<br>
<code>pos.SetInertiaPosMode(x, y, z, h, p, r, 0x0307);</code><br>
=<br>
<code>pos.SetInertiaPosMode(x, y, z, h, p, r, 7 | 768);</code><br>
=<br>
<code>pos.SetInertiaPosMode(x, y, z, h, p, r, 7 + 768);</code><br>
=<br>
<code>pos.SetInertiaPosMode(x, y, z, h, p, r, 775);</code></p>
</div>
<div class="sect3">
<h4 id="_use_cases_2">6.2.1. Use cases</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Simple 2D vehicle model. Report only X, Y and Heading. Align Z, pitch and roll to the road surface:
<code>pos.SetMode(Position::PosModeType::SET, PosMode::H_ABS);</code><br>
<code>pos.SetInertiaPos(x, y, 0.0, h, 0.0, 0.0);</code><br>
or use short version of the same function, applying zero to z, p, r:<br>
<code>pos.SetInertiaPos(x, y, h);</code><br></p>
</li>
<li>
<p>Advanced 3D vehicle model. Report all 6 DOF: X, Y, Z, Heading, Pitch and Roll. I.e. no explicit alignment to road surface:
<code>pos.SetMode(Position::PosModeType::SET, PosMode::Z_ABS | PosMode::H_ABS | PosMode::P_ABS | PosMode::R_ABS);</code><br>
<code>pos.SetInertiaPos(x, y, 0.0, h, 0.0, 0.0);</code><br>
or use short version of the same function, applying zero to z, p, r:<br>
<code>pos.SetInertiaPos(x, y, h);</code><br></p>
</li>
<li>
<p>Rotate a pedestrian 90 degree left to move forward facing the road driving direction, as on a hoverboard:<br>
<code>pos.SetHeadingRelative(1.5708);</code><br>
<code>pos.SetMode(Position::PosModeType::UPDATE, PosMode::H_REL);</code><br>
Default controller will now move the pedestrian along the road but rotated 90 degree.</p>
</li>
<li>
<p>Put pedestrian on a hoverboard moving sideways forward (heading=90 degrees) along the road, 1 meter above ground:<br>
<code>pos.SetHeadingRelative(1.57);</code><br>
<code>pos.SetZRelative(1.0);</code><br>
<code>pos.SetMode(Position::PosModeType::UPDATE, PosMode::Z_REL | PosMode::H_REL);</code><br>
Default controller will now move the pedestrian along the road 1 meter above ground, with maintained heading relative to the road.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_trajectory_interpolation_and_alignment">6.3. Trajectory interpolation and alignment</h3>
<div class="paragraph">
<p>For convenience, esmini can calculate heading and align to the tangent of each segment (polyline and NURBS). Further, to smoothen motion esmini can interpolate corners of polyline trajectories. The behavior is based on omitted position components and <code>followingMode</code> settings.</p>
</div>
<div class="paragraph">
<p>In general specified angles (heading, pitch and roll) will be interpolated over the segment between two vertices/control points. However, in many cases it&#8217;s prefered to just align heading with the tangent of the curve. For these cases it should not be necessary to specify the angles, but rather have esmini calculate them.</p>
</div>
<div class="paragraph">
<p>First, when z value is missing, i.e. elevation is not specified, esmini will project the points to the road surface. Availability of z will also affect alignment of orientation. General rule is that ground trajectories (elevation not specified) will align pitch and roll to the road surface, while these components will be set to zero for floating (specified z values) trajectories.</p>
</div>
<div class="paragraph">
<p>Missing angles will be handled according to the table below:</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Input</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>missing angle component</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>z specified?</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>align orientation to</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">heading</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trajectory</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">heading</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trajectory</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pitch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">trajectory</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pitch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">road surface</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">roll</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">roll</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">road surface</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>While moving along polylines, which tangent is not continuous, it&#8217;s usually preferred to interpolate/smoothen orientation along whole linear segments or at least when passing vertex corners.</p>
</div>
<div class="paragraph">
<p>The table below shows what interpolation method will be applied based on FollowingMode setting for the trajectory:</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>FollowingMode</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Interpolate mode</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">position</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">corner</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">follow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">segment</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Polyline trajectory orientation interpolation can be disabled altogether by setting the <code>disable_pline_interpolation</code> option (see esmini <a href="#_launch_commands">Launch commands</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_example_2">6.4. Example</h3>
<div class="paragraph">
<p>There is a code and scenario example illustrating the various interpolation and position modes:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/esmini/esmini/tree/dev/EnvironmentSimulator/code-examples/position-mode" class="bare">https://github.com/esmini/esmini/tree/dev/EnvironmentSimulator/code-examples/position-mode</a></p>
</div>
<div class="paragraph">
<p>Video clip:</p>
</div>
<div class="videoblock">
<div class="content">
<iframe width="854" height="480" src="https://www.youtube.com/embed/87TbahvpLBM?rel=0&amp;autoplay=1&amp;loop=1&amp;controls=0&amp;playlist=87TbahvpLBM" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>This specific example includes four objects:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pedestrian/skater on the road<br>
Initially it&#8217;s standing still, aligned along the road x-axis (relative heading = 0).</p>
</li>
<li>
<p>Box2 moving along a NURBS trajectory<br>
Specified z will make it "floating" (not projected on ground). Omitted heading will have esmini calculate heading along the tangent.</p>
</li>
<li>
<p>Box3 moving along another NURBS trajectory<br>
Also floating. Demonstrating specified roll will be interpolated between control points.</p>
</li>
<li>
<p>Box1 moving along a polyline trajectory<br>
followingMode = position will make smoothly transitions at vertex corners.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The application will control and report the motion for the skater. At 5 seconds it will rotate 90 degree and move this way along the road, like riding a hoverboard. Then at 15 seconds it will move one meter up from road surface (z=1 relative road) and also rotate back 90 degrees (heading=0 relative road) and move this way along the road, like on a flyboard. During the complete scenario pitch and roll is set to 0 (absolute value - not aligned to road).</p>
</div>
</div>
<div class="sect2">
<h3 id="_relative_positions_and_routes">6.5. Relative positions and routes</h3>
<div class="paragraph">
<p>For the OpenSCENARIO <code>RelativeRoadPosition</code> and <code>RelativeLanePosition</code> the <code>ds</code> and <code>dsLane</code> attributes specifies an offset along the s-axis of the road and lane respectively. In case the offset results in a s-value outside the boundary of the current road, the target location will be searched via connected roads and lanes, even through junctions.</p>
</div>
<div class="paragraph">
<p>In case the action object (the one being positioned) has been assigned a route, the route will be respected, i.e. the target location will be along the route. If the action object lacks a route, any route of the referenced entity will be respected instead. If neither objects has a route assigned the default routing rules will apply.</p>
</div>
<div class="paragraph">
<p>In the image below two cars, red and blue, are being positioned by means of <code>RelativeRoadPosition</code> or <code>RelativeLanePosition</code> with the white car as the reference entity. They have both the same <code>ds</code> value, i.e. same longitudinal distance (along s-axis) from the white car. Since the red car has an assigned route, it ends up along that route. The blue car, lacking a route, will end up along the route of the referenced white car.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/relative_position_routing.jpg" alt="relative position routing">
</div>
<div class="title">Relative positioning with and without own route</div>
</div>
</div>
<div class="sect2">
<h3 id="_reference_line_and_center_lane">6.6. Reference line and center lane</h3>
<div class="paragraph">
<p>In <a href="https://www.asam.net/index.php?eID=dumpFile&amp;t=f&amp;f=4422&amp;token=e590561f3c39aa2260e5442e29e93f6693d1cccd#top-05e95dfd-ce05-40c8-af93-d065229e6968"><code>OpenDRIVE definition of laneOffset</code></a>: A lane offset may be used to shift the center lane away from the road reference line.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/lane_offset_standard_way.png" alt="lane offset standard way">
</div>
</div>
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/2%2B1_road">2+1 roads</a> can be defined utilizing lane offset:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/lane_offset_two_plus_one.jpg" alt="lane offset two plus one">
</div>
</div>
<div class="paragraph">
<p><code>lane id</code> relates to reference lane. <code>lane offset</code> relates to the current lane. <code>t</code> relates to reference line.</p>
</div>
<table class="tableblock frame-all grid-all fit-content">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">white car</th>
<th class="tableblock halign-left valign-top">red car</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>lane id</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>lane offset</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>t</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1.75</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.75</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A 2+1 example example scenario is found here: <a href="https://github.com/esmini/esmini/blob/master/resources/xosc/two_plus_one_road.xosc">resources/xosc/two_plus_one_road.xosc</a></p>
</div>
<div class="paragraph">
<p><strong>Note</strong>: In esmini versions prior to 2.43 the reference line was incorrectly affected by lane offset as well. The <code>t</code>-values in the table then became -5.25 for the white car and -1.75 for the red car.</p>
</div>
<div class="sect3">
<h4 id="_visualization">6.6.1. Visualization</h4>
<div class="paragraph">
<p>esmini can indicate various road features; toggle key 'o' or launch option <code>--road_features</code>.
The center lane is indicated by thick red line and reference line is indicated by semi-thick yellow line.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/two_plus_one_road_features.jpg" alt="two plus one road features">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_controllers">7. Controllers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_controller_concept">7.1. Controller concept</h3>
<div class="paragraph">
<p>OpenSCENARIO provides the controller concept as a way to outsource control the motion and appearance of scenario entities. For the OpenSCENARIO description of the controller concept, see <a href="https://www.asam.net/index.php?eID=dumpFile&amp;t=f&amp;f=4908&amp;token=ae9d9b44ab9257e817072a653b5d5e98ee0babf8#_controllers">OpenSCENARIO User Guide</a>.</p>
</div>
<div class="paragraph">
<p>Controllers can be assigned to object of type Vehicle or Pedestrian. Once assigned, controllers are activated for a given domain (e.g longitudinal, lateral, Lighting, Animation) using the ActivateControllerAction. It&#8217;s also possible to activate immediately as part of the AssignControllerAction.</p>
</div>
<div class="paragraph">
<p>While the ActivateControllerAction is executing, the Controller assigned to that object will manage specified domain(s). Controllers may be internal (part of the simulator) or external (defined in another file).</p>
</div>
<div class="paragraph">
<p>Intended use cases for Controllers include:<br>
- Specifying that a vehicle is controlled by the system under test.
- Defining smart actor behavior, where a controller takes intelligent decisions in response to the road network or other actors. Hence, controllers can be used, for example, to make agents in a scenario behave in a human-like way.
- Assigning a vehicle to direct human control.</p>
</div>
<div class="paragraph">
<p>The Controller element contains Properties, which can be used to specify controller behavior either directly or by a file reference.</p>
</div>
<div class="paragraph">
<p>Although OpenSCENARIO from v1.2 supports assignment of multiple controllers to an object, esmini is currently only supporting one controller to be assigned (and hence activated) to an object at the time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_background_and_motivation">7.2. Background and motivation</h3>
<div class="paragraph">
<p>esmini version &lt; 2.0 totally lacked support for controllers. Instead some similar functionality were implemented as part of different example-applications. For example, EgoSimulator provided interactive control of one vehicle. There was also an "external" mode which allowed for an external vehicle simulator to report current position for the typical Ego (VUT/SUT&#8230;&#8203;) vehicle.</p>
</div>
<div class="paragraph">
<p>First, this approach made the example code of simple applications complex. Secondly, it limited the use cases of esmini since functionality was tightly embedded in the applications.</p>
</div>
<div class="paragraph">
<p>Controllers provides a much more flexible way of adding functionality to esmini, in a way harmonizing with the standard (OpenSCENARIO 1.X). A side effect of this "outsourcing" of functionality is that the former demo applications could be reduced to a minimum both in number and size.</p>
</div>
</div>
<div class="sect2">
<h3 id="_brief_on_implementation">7.3. Brief on implementation</h3>
<div class="paragraph">
<p>Controllers was introduced in esmini v2.0. Briefly it works as follows:</p>
</div>
<div class="paragraph">
<p>There is a collection of embedded controllers coming with esmini. Each controller inherit from the base class Controller (Controller.h/cpp). In order for esmini to be aware of the existence of a controller it has to be registered. This is done through the ScenarioReader method <a href="https://github.com/esmini/esmini/blob/3d1abcd6b3e3855707dc424f7c25477bbf136078/EnvironmentSimulator/Modules/ScenarioEngine/SourceFiles/ScenarioReader.hpp#L132"><code>RegisterController</code></a>. It will put the controller into a collection to have available when the scenario is being parsed. So all controllers need to be registered prior to loading the scenario.</p>
</div>
<div class="paragraph">
<p>A controller is registered with the following information:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Its static name which is used as identifier.</p>
</li>
<li>
<p>A pointer to a function instantiating the controller.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This architecture makes it possible for an external module to create a controller and registering it without modifying any of esmini modules. In that way it is a semi-plugin concept, you can say.</p>
</div>
<div class="paragraph">
<p><strong>Note</strong>: Even though ScenarioReader have a helper function for registering all the embedded controllers the RegisterController can be called from any module directly, at any time prior to scenario initialization.</p>
</div>
<div class="paragraph">
<p>esmini catalog framework supports controllers as well, so controllers can be defined in catalogs as presets, just like vehicles and routes for example.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_it_works_for_the_user">7.4. How it works for the user</h3>
<div class="paragraph">
<p>Controllers are completely handled in the OpenSCENARIO file. With one exception: esmini provides the --disable-controllers option which totally ignore any controllers, just performing the scenario with DefaultControllers, which can be handy when previewing and debugging scenarios.</p>
</div>
<div class="paragraph">
<p>In terms of OpenSCENARIO a controller is assigned to an entity (object) in any of two ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>As part of the Entities section and ScenarioObject definition, using the ObjectController element.</p>
</li>
<li>
<p>The AssignControllerAction which can be triggered as any action at any time during the simulation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once assigned the controller must finally be activated using the ActivateControllerAction which can be triggered at any time. It provides an attribute to specify which domain(s) to control: Lateral, Longitudinal or both.</p>
</div>
<div class="paragraph">
<p>Example 1: Implicit assignment of controller using the <code>ObjectController</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;Entities&gt;</span>
   <span class="tag">&lt;ScenarioObject</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Ego</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;CatalogReference</span> <span class="attribute-name">catalogName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VehicleCatalog</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">entryName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">$HostVehicle</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;ObjectController&gt;</span>
          <span class="tag">&lt;Controller</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MyController</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
             <span class="tag">&lt;Properties&gt;</span>
                 <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">esminiController</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">InteractiveController</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                 <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">speedFactor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.5</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
             <span class="tag">&lt;/Properties&gt;</span>
          <span class="tag">&lt;/Controller&gt;</span>
      <span class="tag">&lt;/ObjectController&gt;</span>
   <span class="tag">&lt;/ScenarioObject&gt;</span>
<span class="tag">&lt;/Entities&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example 2: As above, but using catalog reference:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;Entities&gt;</span>
   <span class="tag">&lt;ScenarioObject</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Ego</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;CatalogReference</span> <span class="attribute-name">catalogName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VehicleCatalog</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">entryName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">$HostVehicle</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;ObjectController&gt;</span>
            <span class="tag">&lt;CatalogReference</span> <span class="attribute-name">catalogName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ControllerCatalog</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">entryName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">interactiveDriver</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/ObjectController&gt;</span>
   <span class="tag">&lt;/ScenarioObject&gt;</span>
<span class="tag">&lt;/Entities&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example 3: Activate controller in the <code>Init</code> section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;Init&gt;</span>
   <span class="tag">&lt;Actions&gt;</span>
      <span class="tag">&lt;Private</span> <span class="attribute-name">entityRef</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Ego</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;PrivateAction&gt;</span>
            <span class="tag">&lt;TeleportAction&gt;</span>
               <span class="tag">&lt;Position&gt;</span>
                  <span class="tag">&lt;LanePosition</span> <span class="attribute-name">roadId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">laneId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">s</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">$EgoStartS</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
               <span class="tag">&lt;/Position&gt;</span>
            <span class="tag">&lt;/TeleportAction&gt;</span>
         <span class="tag">&lt;/PrivateAction&gt;</span>
         <span class="tag">&lt;PrivateAction&gt;</span>
              <span class="tag">&lt;ActivateControllerAction</span> <span class="attribute-name">longitudinal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lateral</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;/PrivateAction&gt;</span>
      <span class="tag">&lt;/Private&gt;</span>
   <span class="tag">&lt;/Actions&gt;</span>
<span class="tag">&lt;/Init&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example 4: Assign and activate the controller in the <code>Storyboard</code> section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;Event</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">InteractiveEvent</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">maximumExecutionCount</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">priority</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">overwrite</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;Action</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AssignControllerAction</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;PrivateAction&gt;</span>
          <span class="tag">&lt;ControllerAction&gt;</span>
              <span class="tag">&lt;AssignControllerAction&gt;</span>
                  <span class="tag">&lt;CatalogReference</span> <span class="attribute-name">catalogName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ControllerCatalog</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">entryName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">interactiveDriver</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
              <span class="tag">&lt;/AssignControllerAction&gt;</span>
          <span class="tag">&lt;/ControllerAction&gt;</span>
      <span class="tag">&lt;/PrivateAction&gt;</span>
   <span class="tag">&lt;/Action&gt;</span>
   <span class="tag">&lt;Action</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ActivateControllerAction</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;PrivateAction&gt;</span>
          <span class="tag">&lt;ControllerAction&gt;</span>
              <span class="tag">&lt;ActivateControllerAction</span> <span class="attribute-name">longitudinal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lateral</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
          <span class="tag">&lt;/ControllerAction&gt;</span>
      <span class="tag">&lt;/PrivateAction&gt;</span>
   <span class="tag">&lt;/Action&gt;</span>
   <span class="tag">&lt;StartTrigger&gt;</span>
      <span class="tag">&lt;ConditionGroup&gt;</span>
         <span class="tag">&lt;Condition</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">delay</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">conditionEdge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">none</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;ByValueCondition&gt;</span>
               <span class="tag">&lt;SimulationTimeCondition</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">rule</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">greaterThan</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/ByValueCondition&gt;</span>
         <span class="tag">&lt;/Condition&gt;</span>
      <span class="tag">&lt;/ConditionGroup&gt;</span>
   <span class="tag">&lt;/StartTrigger&gt;</span>
<span class="tag">&lt;/Event&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To disable any controller simply apply ActivateControllerAction on no domain, like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;ActivateControllerAction</span> <span class="attribute-name">longitudinal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lateral</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That should work in all OpenSCENARIO supporting tools. In esmini you can also assign <code>DefaultController</code> which will disconnect any assigned controller.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_ghost_concept">7.5. The ghost concept</h3>
<div class="paragraph">
<p>The purpose of the ghost concept is to support external driver models. The idea is to launch a forerunner, which performs the maneuvers in the OSC file. The resulting trajectory (also called trail), including speed and heading info, is registered. The driver model can then use the ghost trail as guidance. More specifically, the driver model can probe the trail at any timestamp or distance from its current pos and use the result for both steering and speed target.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/ghost_concept1.png" alt="ghost concept1">
</div>
</div>
<div class="paragraph">
<p>A typical use case is having an external Ego vehicle simulator, including System Under test (SUT) and a driver model. Instead of the driver model (in the external simulator) being aware of and execute scenario maneuvers it can hand over to esmini to play the maneuvers and then simply try to mimic it, following in ghost&#8217;s trail. This way the external simulator can benefit from esmini scenario engine and just concentrate on following the ghost.</p>
</div>
<div class="paragraph">
<p>The ghost feature is available in the following esmini embedded controllers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_followghost">FollowGhost</a></p>
</li>
<li>
<p><a href="#_externalcontroller">ExternalController</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are two different methods to probe the ghost trail:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>By time: Ask for ghost state (pos, heading, speed&#8230;&#8203;) at specific timestamp</p>
</li>
<li>
<p>By distance: Ask for ghost state at a specific distance, from a position (typically current Ego position)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Both methods will return a RoadInfo structure including position details e.g. world position (absolute and relative Ego), road coordinates, road pitch, trail heading, heading angle to the target point and ghost speed at that point.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">typedef struct
{
    float global_pos_x;   // target position, in global coordinate system
    float global_pos_y;   // target position, in global coordinate system
    float global_pos_z;   // target position, in global coordinate system
    float local_pos_x;    // target position, relative vehicle (pivot position object) coordinate system
    float local_pos_y;    // target position, relative vehicle (pivot position object) coordinate system
    float local_pos_z;    // target position, relative vehicle (pivot position object) coordinate system
    float angle;          // heading angle to target from and relative vehicle (pivot position object) coordinate system
    float road_heading;   // road heading at steering target point
    float road_pitch;     // road pitch (inclination) at steering target point
    float road_roll;      // road roll (camber) at target point
    float trail_heading;  // trail heading (only when used for trail lookups, else equals road_heading)
    float curvature;      // road curvature at steering target point
    float speed_limit;    // speed limit given by OpenDRIVE type entry
    id_t  roadId;         // target position, road ID
    id_t  junctionId;     // target position, junction ID (SE_ID_UNDEFINED if not in a junction)
    int   laneId;         // target position, lane ID
    float laneOffset;     // target position, lane offset (lateral distance from lane center)
    float s;              // target position, s (longitudinal distance along reference line)
    float t;              // target position, t (lateral distance from reference line)
} SE_RoadInfo;</code></pre>
</div>
</div>
<h4 id="_time_method" class="discrete">Time method</h4>
<div class="paragraph">
<p>This approach is trivial, it will give the state of ghost at the specified timestamp using the API call:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/esmini/esmini/blob/362bcae28253f4eef2778e6f11b7a8393e6a3cd4/EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp#L815">int SE_GetRoadInfoGhostTrailTime(int object_id, float time, SE_RoadInfo* data, float* speed_ghost);</a></p>
</div>
<h4 id="_distance_method" class="discrete">Distance method</h4>
<div class="paragraph">
<p>The API call is:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/esmini/esmini/blob/362bcae28253f4eef2778e6f11b7a8393e6a3cd4/EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp#L805">int SE_GetRoadInfoAlongGhostTrail(int object_id, float lookahead_distance, SE_RoadInfo *data, float *speed_ghost);</a></p>
</div>
<div class="paragraph">
<p>The method needs some further explanation. The basic idea is to look specified distance along the ghost trail and receive information at that target point. The tricky part is where to start measuring the distance from. This is how it works:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/ghost_concept2.png" alt="ghost concept2">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From Ego, find closest point on trail (blue point)</p>
</li>
<li>
<p>From that point, look forward x meters along trail (red dot)</p>
</li>
<li>
<p>Get info from that target point</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ideally, two points are used: One closer for target speed and one more distant for steering target.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/ghost_targets.jpg" alt="ghost targets">
</div>
<div class="title">Different lookahead for speed and steering control</div>
</div>
<div class="paragraph">
<p>Tuning parameters:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Lookahead distance along trail</p>
<div class="ulist">
<ul>
<li>
<p>Typically speed dependent (look further at higher speeds)</p>
</li>
<li>
<p>Potentially decrease distance with increased curvature (to stay on road)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Headstart time</p>
<div class="ulist">
<ul>
<li>
<p>As small as possible, but enough for required lookahead distance</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Note:</strong>
If lookahead distance is too large, the steering target angle becomes irrelevant, leading to driving off road</p>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/ghost_concept3.png" alt="ghost concept3">
</div>
<div class="title">Too large lookahead distance</div>
</div>
<h4 id="_actions_and_triggers" class="discrete">Actions and triggers</h4>
<div class="paragraph">
<p>Most actions that affects motion will be transferred from the original entity (Ego) to its ghost, for example: <code>SpeedAction</code>, <code>LaneChangeAction</code> and <code>TeleportAction</code>. In addition, triggers will be affected in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Entity triggers: Replace any occurrence of original entity with ghost in the list of <code>TriggeringEntities</code>. For example, if the vehicle should brake when reaching a specified position, then it&#8217;s the ghost that should trigger the action - not the original entity.</p>
</li>
<li>
<p>Other triggers: Restart ghost from where the Ego is now, in effect rewind ghost <code>headStartTime</code> seconds and recreate trajectory from there. The purpose is to enable ghost to react on triggers that happens in the "real" scenario (which plays out <code>headStartTime</code> seconds behind the ghost)</p>
</li>
<li>
<p><code>SimulationTime</code> trigger conditions for events where Ego is the actor will be adjusted wrt ghost <code>headStartTime</code> time. For example, if vehicle should brake after 20 seconds of driving (simulationTime = 20), then it will be changed to simulationTime = 17 (for headstart 3s), since the ghost has been driving for 20 seconds at that point.</p>
</li>
</ul>
</div>
<h5 id="_examples" class="discrete">Examples</h5>
<div class="paragraph">
<p>The following examples shows two different triggers for a lane change action. First example uses TraveledDistanceCondition. Ghost will be the triggering entity and since this is independent of other road users, there is no need to restart ghost.</p>
</div>
<div class="paragraph">
<p>The second example, on the other hand, uses TimeHeadwayCondition which calculates the time gap between the white Ego car and the red Target car, hence depending on other road users. Since ghost is running ahead of time it does not make sense to involve ghost in such conditions, hence Ego will be the triggering entity.</p>
</div>
<div class="paragraph">
<p>Example 1: Trigger based on traveled distance - no restart</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;ByEntityCondition&gt;</span>
    <span class="tag">&lt;TriggeringEntities</span> <span class="attribute-name">triggeringEntitiesRule</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">any</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;EntityRef</span> <span class="attribute-name">entityRef</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Ego</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/TriggeringEntities&gt;</span>
    <span class="tag">&lt;EntityCondition&gt;</span>
        <span class="tag">&lt;TraveledDistanceCondition</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/EntityCondition&gt;</span>
<span class="tag">&lt;/ByEntityCondition&gt;</span></code></pre>
</div>
</div>
<div class="videoblock">
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/traveled_distance.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Example 2: Trigger based on time headway - restart ghost</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;ByEntityCondition&gt;</span>
    <span class="tag">&lt;TriggeringEntities</span> <span class="attribute-name">triggeringEntitiesRule</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">any</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;EntityRef</span> <span class="attribute-name">entityRef</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Ego</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/TriggeringEntities&gt;</span>
    <span class="tag">&lt;EntityCondition&gt;</span>
        <span class="tag">&lt;TimeHeadwayCondition</span>
            <span class="attribute-name">entityRef</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Target</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">freespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">coordinateSystem</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">road</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">relativeDistanceType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">longitudinal</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">rule</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lessThan</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/EntityCondition&gt;</span>
<span class="tag">&lt;/ByEntityCondition&gt;</span></code></pre>
</div>
</div>
<div class="videoblock">
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/time_headway.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Note that the strategy results in desired behavior in probably the majority of cases, but not all. There might be exceptions where another behavior is expected or required. The manipulation described above is handled by the methods <code>SetupGhost()</code> and <code>ReplaceObjectInTrigger()</code> in <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Modules/ScenarioEngine/SourceFiles/ScenarioEngine.cpp">ScenarioEngine.cpp</a> which can be modified to fit custom needs.</p>
</div>
<h4 id="_controllers_and_ghost" class="discrete">Controllers and ghost</h4>
<div class="paragraph">
<p>OpenSCENARIO 1.2 onwards supports multiple assigned controllers. All except the first controller will be handed over to the ghost. Hence make sure to put the ghost controller first, since it will stick to the "Ego".</p>
</div>
<div class="paragraph">
<p>Example scenario, where ghost is utilizing the followRoute controller: <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/Unittest/xosc/follow_route_ghost_starting_on_route.xosc">follow_route_ghost_starting_on_route.xosc</a>.</p>
</div>
<h4 id="_additional_notes_on_using_the_ghost_feature" class="discrete">Additional notes on using the ghost feature</h4>
<div class="paragraph">
<p>Timestamps in log are always of same reference. Whenever a ghost is involved the time will start at -<code>headStartTime</code>, in order for the actual scenario to start at simulationTime = 0. Example: Assuming <code>headStartTime = 3s</code>, a log message for an Ego action like:</p>
</div>
<div class="paragraph">
<p><code>-2.100: SpeedChange standbyState &#8594; startTransition &#8594; runningState</code></p>
</div>
<div class="paragraph">
<p>means that action SpeedChange (Ego action that has been moved to ghost) is performed 0.9 (-2.1 + 3) seconds after ghost was launched. This would, for example, be the case for a <code>simulationTime = 0.9</code> condition.</p>
</div>
</div>
<div class="sect2">
<h3 id="_esmini_embedded_controllers">7.6. esmini embedded controllers</h3>
<div class="paragraph">
<p>Below is a listing of some of the available controllers in esmini. Note that only DefaultController is related to the OpenSCENARIO standard. The other ones are esmini-specific and will not work in other tools (so far there is no standard plugin-architecture for controllers to enable moving between tools). For updated and complete definition of controllers and their parameters, see <a href="https://github.com/esmini/esmini/blob/master/resources/xosc/Catalogs/Controllers/ControllerCatalog.xosc">ControllerCatalog.xosc</a>.</p>
</div>
<div class="sect3">
<h4 id="_defaultcontroller">7.6.1. DefaultController</h4>
<div class="paragraph">
<p>Performs actions exactly as specified in the OpenSCENARIO file. Assigned to entities by default. Can be assigned at any point to "unassign" any currently assigned controller.<br></p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a (will always take over both Lateral and Longitudinal domains)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a (any scenario not explicitly assigning and activating another controller)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_interactivecontroller">7.6.2. InteractiveController</h4>
<div class="paragraph">
<p>A simple vehicle model controlled by the user via keyboard (arrow keys).<br></p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitudinal and/or lateral (independent)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>steeringRate</code>
</td>
<td class="hdlist2">
<p>steering sensitivity</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>speedFactor</code>
</td>
<td class="hdlist2">
<p>scale speed performance (1.0 is default)</p>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/esmini/esmini/blob/master/resources/xosc/cut-in_interactive.xosc">cut-in_interactive.xosc</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_followghost">7.6.3. FollowGhost</h4>
<div class="paragraph">
<p>A simple driver model. A ghost-twin performing the events a few seconds ahead. The entity will then do its best to mimic the motion and speed of the ghost by follow the trajectory. The primary purpose of this controller is to provide an example, but it can be useful to smoothen out the sometimes synthetic feel of pure default controller.<br></p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitudinal and lateral (in combination only).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>headstartTime</code>
</td>
<td class="hdlist2">
<p>seconds</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>followMode</code>
</td>
<td class="hdlist2">
<p><code>time</code> (time offset), <code>position</code> (distance offset)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>lookaheadSpeed</code>
</td>
<td class="hdlist2">
<p>Pick target speed from position at this look-ahead time (<code>time</code> mode) or distance (<code>position</code> mode)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>minLookaheadSpeed</code>
</td>
<td class="hdlist2">
<p>Minimum speed target look-ahead time (<code>time</code> mode) or distance (<code>position</code> mode)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>lookaheadSteering</code>
</td>
<td class="hdlist2">
<p>Pick target steering point from position at this look-ahead time (<code>time</code> mode) or distance (<code>position</code> mode)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>minLookaheadSteering</code>
</td>
<td class="hdlist2">
<p>Minimum steering target look-ahead time (<code>time</code> mode) or distance (<code>position</code> mode)</p>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/esmini/esmini/blob/master/resources/xosc/follow_ghost.xosc">follow_ghost.xosc</a></p></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/ghost_targets.jpg" alt="ghost targets">
</div>
<div class="title">Illustration of separate look-ahead for speed and steering control</div>
</div>
</div>
<div class="sect3">
<h4 id="_externalcontroller">7.6.4. ExternalController</h4>
<div class="paragraph">
<p>The entity will not be moved by the scenario. Instead its state (position, rotation &#8230;&#8203;) is expected to be reported from external simulator via API, e.g. SE_ReportObjectPos. Ghost trajectory can optionally be created for an external driver model to use as reference.<br></p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitudinal and/or lateral (independent).<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>useGhost</code>
</td>
<td class="hdlist2">
<p>launch a ghost fore-runner, e.g. to provide input for any driver model (<code>true</code>/<code>false</code>)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>headstartTime</code>
</td>
<td class="hdlist2">
<p>(for the ghost)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>mode</code>
</td>
<td class="hdlist2">
<p><code>override</code> disable default controller (default), <code>additive</code>: apply default controller before handing over to this controller</p>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/test-driver">test-driver code example</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_sumocontroller">7.6.5. SumoController</h4>
<div class="paragraph">
<p>A way of integrating SUMO controlled vehicles in a scenario. OpenSCENARIO vehicles are reported to SUMO, and SUMO vehicles are reported back to esmini. A reference to a SUMO config file is provided as input to the controller. See cut-in_sumo.xosc for an example.</p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitudinal and lateral (in combination only).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>file</code>
</td>
<td class="hdlist2">
<p>Path to the SUMO configuration file<br></p>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/esmini/esmini/blob/master/resources/xosc/cut-in_sumo.xosc">cut-in_sumo.xosc</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_alks_r157sm">7.6.6. ALKS_R157SM</h4>
<div class="paragraph">
<p>Based and inspired by <a href="https://github.com/ec-jrc/JRC-FSM">Regulation 157 Safety Models</a>. Includes four safety models relating to the (<a href="https://unece.org/transport/documents/2021/03/standards/un-regulation-no-157-automated-lane-keeping-systems-alks">UNECE ALKS regulation #157</a>). The controller includes preliminary and experimental implementation of four models:<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Regulation</code> Characteristics of expected system performance as stated in the <a href="https://unece.org/sites/default/files/2021-03/R157e.pdf">UNECE Reg 157 Paragraph 5.2.5.2</a>.<br></p>
</li>
<li>
<p><code>ReferenceDriver</code> Reference model of a "typical" human driver as specified in <a href="https://unece.org/sites/default/files/2021-03/R157e.pdf">UNECE Reg 157 Annex 4 - Appendix 3</a>.<br></p>
</li>
<li>
<p><code>RSS</code> <em>Responsibility-Sensitive Safety</em> performance model proposed and described in <a href="https://arxiv.org/pdf/1708.06374.pdf">Shalev-Shwartz, Shai, Shaked Shammah, and Amnon Shashua. "On a formal model of safe and scalable self-driving cars." arXiv preprint arXiv:1708.06374 (2017)</a>.<br></p>
</li>
<li>
<p><code>FSM</code> <em>Fuzzy Safety Model</em> proposed and described in <a href="https://www.sciencedirect.com/science/article/pii/S0001457520316146">Mattas, Konstantinos, et al. "Fuzzy Surrogate Safety Metrics for real-time assessment of rear-end collision risk. A study based on empirical observations." Accident Analysis &amp; Prevention 148 (2020): 105794</a>.<br></p>
</li>
</ul>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitudinal and lateral (in combination only). <strong>Note</strong>: No advanced steering, just maintaining current lane offset.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>logLevel</code>
</td>
<td class="hdlist2">
<p>0: No logging, 1: Brief logging of state changes (default), 2: Verbose logging of some internal variables</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>model</code>
</td>
<td class="hdlist2">
<p><code>Regulation</code>, <code>ReferenceDriver</code>, <code>RSS</code>, <code>FSM</code> as described above.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>cruise</code>
</td>
<td class="hdlist2">
<p>Activate longitudinal ACC (comfort adaptive speed control) (<code>true</code>/<code>false</code>)</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Further properties see <code>ALKS_R157SM_Controller</code> in <a href="https://github.com/esmini/esmini/blob/master/resources/xosc/Catalogs/Controllers/ControllerCatalog.xosc">Controllers/ControllerCatalog.xosc</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Examples</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/esmini/esmini/blob/master/resources/xosc/alks_r157_cut_in_quick_brake.xosc">alks_r157_cut_in_quick_brake.xosc</a><br>
<a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Unittest/xosc/alks_r157_quick_stop_test.xosc">alks_r157_quick_stop_test.xosc</a><br>
<a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Unittest/xosc/alks_r157_test.xosc">alks_r157_test.xosc</a><br></p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_example_usage">Example usage</h5>
<div class="paragraph">
<p>Run example alks_r157_cut_in_quick_brake.xosc:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/alks_r157_cut_in_quick_brake.xosc</code></p>
</div>
<div class="paragraph">
<p>Change model:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open <code>resources/xosc/alks_r157_cut_in_quick_brake.xosc</code> in a text editor</p>
</li>
<li>
<p>In the ALKS_R157SM_Controller, change<br>
<code>&lt;Property name="model" value="Regulation"/&gt;</code> to<br>
<code>&lt;Property name="model" value="ReferenceDriver"/&gt;</code></p>
</li>
<li>
<p>Save and run again:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/alks_r157_cut_in_quick_brake.xosc</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can hardly see any difference. Let&#8217;s run the two variants again and record for post analysis.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set model to "ReferenceDriver" (by edit the file as described above)</p>
</li>
<li>
<p>Run:<br>
<code>./bin/esmini --headless --fixed_timestep 0.02 --osc ./resources/xosc/alks_r157_cut_in_quick_brake.xosc --record sim-ref.dat</code></p>
</li>
<li>
<p>Set model to "Regulation"</p>
</li>
<li>
<p>Run:<br>
<code>./bin/esmini --headless --fixed_timestep 0.02 --osc ./resources/xosc/alks_r157_cut_in_quick_brake.xosc --record sim-reg.dat</code></p>
</li>
<li>
<p>View scenarios in parallel:<br>
<code>./bin/replayer --window 60 60 800 400 --res_path ./resources --dir . --file sim- --view_mode boundingbox</code></p>
</li>
<li>
<p>Create a merged .dat file and plot it:<br>
<code>./bin/replayer --file sim- --dir . --save_merged sim_merged.dat</code><br>
<code>./scripts/plot_dat.py --param speed sim_merged.dat</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Something like this should show:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_merged_alks_ex.png" alt="plot merged alks ex">
</div>
</div>
<div class="paragraph">
<p>Of course you can run also FSM and RSS models in similar way and merge all four .dat files. For more information about <code>replayer</code>, see "Plot merged .dat files" example in <a href="#_plot_scenario_data">Plot scenario data</a> section.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_followroute">7.6.7. FollowRoute</h4>
<div class="paragraph">
<p>Implementation of the Lane Independent Routing Model (LIRM) developed as part of the master thesis project <a href="https://hdl.handle.net/20.500.12380/305133">Olsson, Daniel; Rylander, Eric: "A Framework for Verification and
Validation of Simulation Models in esmini"</a>.</p>
</div>
<div class="paragraph">
<p>From the <a href="https://odr.chalmers.se/bitstream/20.500.12380/305133/1/CSE%2022-59%20Olsson%20Rylander.pdf">report</a>: "LIRM has solved the issue with lane dependent routing that esmini had, by implementing a new controller that extends the behavior of the pathfinding and route following to incorporate lane changes."</p>
</div>
<div class="paragraph">
<p>This controller enhance the capabilities for an entity to find a path through the road network according to a specified <a href="https://www.asam.net/static_downloads/ASAM_OpenSCENARIO_V1.2.0_Model_Documentation/modelDocumentation/content/Route.html">route</a> (basically a set of waypoints). The main advantage, compared to the route handler of the default controller, is that lane changes will be injected by the path finding algorithm in search for optimal path. The model will also take route strategy (Shortest, Fastest or Least Intersections) into consideration, which the default controller does not yet support.</p>
</div>
<div class="paragraph">
<p>A good example is found in <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Unittest/xosc/follow_route_with_lane_change.xosc">follow_route_with_lane_change.xosc</a>. The vehicle start out in left-most lane and needs to make three lane changes in order to exit the highway.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/follow_route_highway_exit.png" alt="follow route highway exit">
</div>
<div class="title">Route waypoints and resulting trajectory in yellow</div>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./EnvironmentSimulator/Unittest/xosc/follow_route_with_lane_change.xosc --trail_mode 1</code></p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitudinal and/or lateral (independent).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>minDistForCollision</code>
</td>
<td class="hdlist2">
<p>affects when a lane change will happen</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>laneChangeTime</code>
</td>
<td class="hdlist2">
<p>duration of lane changes</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>testMode</code>
</td>
<td class="hdlist2">
<p>stop at reached destination - mainly for test purpose (<code>true</code>/<code>false</code> (default))</p>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Unittest/xosc/follow_route_with_lane_change.xosc">follow_route_with_lane_change.xosc</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_udpdrivercontroller">7.6.8. UDPDriverController</h4>
<div class="paragraph">
<p>An UDP interface for external driver models or vehicle simulators. The idea is to allow external devices to control entities in an ongoing esmini simulation, over network.</p>
</div>
<div class="paragraph">
<p>Concept:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/udp_driver_controller_concept.png" alt="udp driver controller concept">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Assign the controller to any scenario vehicle (in the OpenSCENARIO file)</p>
</li>
<li>
<p>Send input to esmini controller</p>
</li>
<li>
<p>The vehicle will be updated by the controller accordingly (and bypassing esmini default controller)</p>
</li>
<li>
<p>receive ground-truth (OSI over UDP) from esmini</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are a few input mode options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>DRIVER_INPUT<br>
Control a simple vehicle model in terms of pedals and steering input. Vehicle will apply latest received values until update is received.</p>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Parameters: 
</td>
<td class="hdlist2">
<p><code>throttle</code><br>
<code>brake</code><br>
<code>steeringAngle</code></p>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>VEHICLE_STATE_XYZHPR<br>
Report explicit complete state, ignoring road geometry. Useful when advanced vehicle dynamics is involved and vehicle for example is pitching as result of acceleration and rolling as result of steering. Optional flag to enable dead reckoning on esmini side, in which case esmini will move entity according to latest received heading and speed (basically extrapolating).</p>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Parameters: 
</td>
<td class="hdlist2">
<p><code>x</code><br>
<code>y</code><br>
<code>z</code><br>
<code>h</code>(eading)<br>
<code>p</code>(itch)<br>
<code>r</code>(oll)<br>
<code>speed</code><br>
<code>wheelAngle</code> (wheel yaw/stering angle)<br>
<code>deadReckon</code> (flag)</p>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>VEHICLE_STATE_XYH<br>
Report explicit partial state. <code>z</code>, <code>pitch</code> and <code>roll</code> are aligned to the road geometry.</p>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Parameters: 
</td>
<td class="hdlist2">
<p><code>x</code><br>
<code>y</code><br>
<code>h</code>(eading)<br>
<code>speed</code><br>
<code>wheelAngle</code> (wheel yaw/stering angle)<br>
<code>deadReckon</code> (flag)</p>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>VEHICLE_STATE_H<br>
Minimal explicit state, useful when the driver model output is only heading and speed.</p>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Parameters: 
</td>
<td class="hdlist2">
<p><code>h</code>(eading)<br>
<code>speed</code><br>
<code>wheelAngle</code> (wheel yaw/stering angle)<br>
<code>deadReckon</code> (flag)</p>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more info see: <a href="https://www.dropbox.com/s/qc2n7db0h9k7urt/UDPDriverController.pdf?dl=0">UDPDriverController.pdf</a></p>
</div>
<div class="paragraph">
<p>Demo (running a somewhat outdated <a href="https://github.com/esmini/esmini/blob/master/scripts/udp_driver/testUDPDriver.py">testUDPDriver.py</a>):</p>
</div>
<div class="videoblock">
<div class="content">
<iframe width="854" height="480" src="https://www.youtube.com/embed/IuwuGE3BzKw?rel=0&amp;autoplay=1&amp;loop=1&amp;controls=0&amp;playlist=IuwuGE3BzKw" frameborder="0" allowfullscreen></iframe>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_offroadfollowercontroller">7.6.9. OffroadFollowerController</h4>
<div class="paragraph">
<p>A simple "follow-the-leader" controller which aims to keep a specified distance to a specified leading vehicle. The controller utilizes a simple 2D "bicycle" vehicle model. Each time-step the controller finds out the direction and distance to the lead vehicle. Based on this, the acceleration and steering input is calculated and provided to the vehicle model.</p>
</div>
<div class="paragraph">
<p>The term off-road indicates that the controller does not consider any road network features. Note that it still can run on roads, parking lots, just that it&#8217;s ignoring it in terms of lanes and road-marks.</p>
</div>
<div class="paragraph">
<p>Below is a video clip showing the controller in action on an open paved area. The white lead vehicle is controlled interactively by the user via arrow keys. The controller is assigned to the red car which then strives to follow the lead car at the distance of 20 meters.</p>
</div>
<div class="videoblock">
<div class="content">
<iframe width="854" height="480" src="https://www.youtube.com/embed/uHqdsORPsGE?rel=0&amp;autoplay=1&amp;loop=1&amp;controls=0&amp;playlist=uHqdsORPsGE" frameborder="0" allowfullscreen></iframe>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_naturaldrivercontroller">7.6.10. NaturalDriverController</h4>
<div class="paragraph">
<p>A controller designed to drive naturally on highways and urban roads, with a driver which tries to keep its desired lane, while keeping the distance to a target in front and, if the conditions are correct, will make a lane change to overtake a lead vehicle.</p>
</div>
<div class="paragraph">
<p>The desired lane for the controller vehicle is set with a parameter (named "Route"), the driver will strive to reach and maintain this lane. The driver will follow the car in front following the IDM (Intelligent Driver Model) logic, <a href="https://en.wikipedia.org/wiki/Intelligent_driver_model" class="bare">https://en.wikipedia.org/wiki/Intelligent_driver_model</a>. The driver will change lane according to MOBIL (General Lane-Changing Model for Car-Following Models), <a href="https://mtreiber.de/publications/MOBIL_TRB.pdf" class="bare">https://mtreiber.de/publications/MOBIL_TRB.pdf</a>. The lane changing doesn&#8217;t take traffic density or ramps / junctions into account, and thus the model is only suitable on roads without such geomitries.</p>
</div>
<div class="paragraph">
<p>The model is fully parameterized to suit the desired need of each simulation. For all properties see <code>NaturalDriver</code> in <a href="https://github.com/esmini/esmini/blob/master/resources/xosc/Catalogs/Controllers/ControllerCatalog.xosc">Controllers/ControllerCatalog.xosc</a>.</p>
</div>
<div class="paragraph">
<p>Example usage can be found in <a href="https://github.com/esmini/esmini/blob/master/scripts/scenario_scripts/generate_traffic.py" class="bare">https://github.com/esmini/esmini/blob/master/scripts/scenario_scripts/generate_traffic.py</a></p>
</div>
<div class="paragraph">
<p>Demo (running scenario <a href="https://github.com/esmini/esmini/blob/master/resources/xosc/highway_driver.xosc" class="bare">https://github.com/esmini/esmini/blob/master/resources/xosc/highway_driver.xosc</a>):</p>
</div>
<div class="videoblock">
<div class="content">
<iframe width="854" height="480" src="https://www.youtube.com/embed/JV31gvCCe3Y?rel=0&amp;autoplay=1&amp;loop=1&amp;controls=0&amp;playlist=JV31gvCCe3Y" frameborder="0" allowfullscreen></iframe>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_add_a_new_controller">7.7. How to add a new controller</h3>
<div class="paragraph">
<p>Below are the steps to add new controller in esmini:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a sepreate controller module in the controller folder. Suggestion is to copy one of the existing and use as a starting point.</p>
</li>
<li>
<p>Register the controller in the LoadControllers() fuction in EnvironmentSimulator/Modules/ScenarioEngine/SourceFiles/ScenarioReader.cpp</p>
</li>
<li>
<p>Create Instantiate method in the new controller. The name shall be unique eg InstantiateControllerLooming</p>
</li>
<li>
<p>In the new controller, Type name shall be unique eg, CONTROLLER_LOOMING_TYPE_NAME</p>
</li>
<li>
<p>Add controller type and it shall be unique in EnvironmentSimulator/Modules/Controllers/Controller.hpp</p>
</li>
<li>
<p>Make sure GetTypeStatic() and GetTypeNameStatic() and methods returns the unique type and type name values</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_openscenegraph_and_3d_models">8. OpenSceneGraph and 3D models</h2>
<div class="sectionbody">
<div class="paragraph">
<p>esmini make use of OpenSceneGraph (OSG) for visualization of the scenario. The OpenSCENARIO files can optionally refer to existing 3D models of the static environment (scene graph) and dynamic objects (entities). If the scene graph reference is missing, esmini will try to generate a basic model based on the OpenDRIVE road network description. Currently esmini only supports OSG native .osgb 3D file format. However, there are ways to convert 3D models as described next.</p>
</div>
<div class="paragraph">
<p><a href="http://www.openscenegraph.org/">OpenSceneGraph</a> (osg) includes readers and writers for quite a few 3D file formats. It comes with a demo application, <a href="http://www.openscenegraph.org/index.php/documentation/user-guides/55-osgconv">osgconv</a>, a command line tool that simply takes one file as input and outputs the same content in a different format.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="paragraph">
<p>Convert from fbx to osgb format:<br>
<code>osgconv car.fbx car.osgb</code></p>
</div>
<div class="paragraph">
<p>Convert from osgb to <a href="https://www.autodesk.com/products/fbx/overview">fbx</a> format:<br>
<code>osgconv car.osgb car.fbx</code></p>
</div>
<div class="paragraph">
<p>osgconv has a lot of useful options. Run <code>osgconv -h</code> for more info. Here&#8217;s a few examples:</p>
</div>
<div class="paragraph">
<p><code>osgconv in.fbx out.osgb --compressed</code> will compress and embed textures<br>
<code>osgconv in.fbx out.osgb -t 1,5,7</code> will translate the model (x=1, y=5, z=7)<br>
<code>osgconv in.fbx out.osgb -o -90-1,0,0</code> will rotate the model (rotate -90 deg around X-axis)<br>
<code>osgconv in.fbx out.osgb -o -90-1,0,0 --use-world-frame</code> as above but pivot point world origin<br></p>
</div>
<div class="paragraph">
<p>A useful environment variable is <code>OSG_OPTIMIZER</code> which affects the structure and content of the scene graph. For example, if the osgb file includes cloned sub trees, like motorway railings, these might not be populated in the fbx file. To solve that set:</p>
</div>
<div class="paragraph">
<p><code>OSG_OPTIMIZER = FLATTEN_STATIC_TRANSFORMS_DUPLICATING_SHARED_SUBGRAPHS</code></p>
</div>
<div class="paragraph">
<p>Exact syntax depends on your environment. Examples:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>bash</strong>
</td>
<td class="hdlist2">
<p><code>export OSG_OPTIMIZER=FLATTEN_STATIC_TRANSFORMS_DUPLICATING_SHARED_SUBGRAPHS</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>powershell</strong>
</td>
<td class="hdlist2">
<p><code>$env:OSG_OPTIMIZER = "FLATTEN_STATIC_TRANSFORMS_DUPLICATING_SHARED_SUBGRAPHS"</code></p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then run the <code>osgconv</code> command (in the same terminal where you defined the environment variable).</p>
</div>
<div class="paragraph">
<p>osg native format is <code>osgb</code> which stands for OpenSceneGraph binary format. It&#8217;s a stable and compact (quick to load) format, which also can embed textures and animations. Thanks to the osgconv tool, esmini can get away with only supporting the .osgb format and still indirectly support many other 3D formats.</p>
</div>
<div class="sect2">
<h3 id="_get_osgconv">8.1. Get osgconv</h3>
<div class="paragraph">
<p>There are pre-built binaries available, see below. But for full capabilities, including support for converting from 3D file formats .dae (collada) and .fbx (Autodesk Filmbox) you have to build OpenSceneGraph (osg) yourself.</p>
</div>
<div class="sect3">
<h4 id="_build_yourself">8.1.1. Build yourself</h4>
<div class="sect4">
<h5 id="_prerequisites">Prerequisites</h5>
<div class="paragraph">
<p>The only prerequisite step is for Linux to install some dependecies:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run <code>software-properties-gtk</code><br>
or open the "Software &amp; Updates" application</p>
</li>
<li>
<p>then under the "Ubuntu Software" tab click "Source code" and add a server of your choice, e.g. within your country</p>
</li>
<li>
<p>Run <code>sudo apt-get build-dep openscenegraph</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Reference Step 1 &amp; 2: <a href="https://unix.stackexchange.com/a/614082" class="bare">https://unix.stackexchange.com/a/614082</a></p>
</div>
</div>
<div class="sect4">
<h5 id="_build">Build</h5>
<div class="paragraph">
<p>You can then try this script: <a href="https://github.com/esmini/esmini/blob/master/scripts/compile_osg_apps.sh">compile_osg_apps.sh</a>. It will first fetch and install <a href="https://www.autodesk.com/developer-network/platform-technologies/fbx-sdk-2020-0">FBX SDK</a> and then build OSG with FBX and DAE support. Find more details and instructions in the header of the script.</p>
</div>
<div class="paragraph">
<p>For more info regarding building OSG for Linux, here&#8217;s a great guide:<br>
<a href="https://vicrucann.github.io/tutorials/osg-linux-quick-install/" class="bare">https://vicrucann.github.io/tutorials/osg-linux-quick-install/</a> <br>
But note that it does not consider FBX support.</p>
</div>
<div class="paragraph">
<p>Find more info on COLLADA via this old <a href="http://www.openscenegraph.com/index.php/documentation/guides/user-guides/111-collada">link</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pre_build_binaries">8.1.2. Pre-build binaries</h4>
<div class="paragraph">
<p><strong>Windows</strong><br>
Binaries including FBX but not DAE support, see here:<br>
<a href="https://objexx.com/OpenSceneGraph.html" class="bare">https://objexx.com/OpenSceneGraph.html</a></p>
</div>
<div class="paragraph">
<p><strong>Linux</strong><br></p>
</div>
<div class="paragraph">
<p><code>sudo apt-get update</code><br>
<code>sudo apt-get -y install openscenegraph</code></p>
</div>
<div class="paragraph">
<p>Reference: <a href="https://installati.one/install-openscenegraph-ubuntu-20-04/?expand_article=1" class="bare">https://installati.one/install-openscenegraph-ubuntu-20-04/?expand_article=1</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_convert_osgb_models_for_use_in_unity">8.2. Convert osgb models for use in Unity</h3>
<div class="paragraph">
<p>Here follows an example of how to convert .osgb models into .fbx format for use in the Unity3D framework.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a command prompt in the folder where your model.osgb is</p>
</li>
<li>
<p>Run command:<br>
<code>osgconv model.osgb out/model.fbx -s 100,100,100</code><br>
"-s &#8230;&#8203;" is for scaling which typically is needed for fbx files.
Potentially it also needs to be oriented according to Unity coordinate system. In that case try:<br>
<code>osgconv model.osgb out/model.fbx -s 100,100,100 --use-world-frame -o 120&#8212;&#8203;0.5773503,-0.5773503,-0.5773503</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A folder named "out" should have been created and including the model.fbx plus any texture files</p>
</div>
</div>
<div class="sect2">
<h3 id="_import_into_unity">8.3. Import into Unity</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Drag the resulting fbx file, and all textures, into a unity project, preferably an empty folder</p>
</li>
<li>
<p>Add the model to the Scene hierarchy</p>
</li>
<li>
<p>Select the model and int the "Inspector", select the "Materials" tab</p>
</li>
<li>
<p>Change the "Location" to "Use External Materials (Legacy)" and click "Apply"</p>
</li>
<li>
<p>Open the automatically created "Materials" folder (next to the model file)</p>
</li>
<li>
<p>Select all materials and change<br>
for standard template: "Rendering Mode" to "Cutout" (good default option) <br>
for HDRP template: "Surface type" to "Transparent" and check "alpha clipping"</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>That should basically be it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_colors_textures_and_wheel_rotations">8.4. Colors, textures and wheel rotations</h3>
<div class="paragraph">
<p>See <a href="https://github.com/esmini/esmini/issues/63#issuecomment-742273326">issue 63</a> for brief information on how to create vehicle 3D models with moving wheels.</p>
</div>
<div class="paragraph">
<p>And these two scripts operating on textures and material respectively, can potentially provide some inspiration:<br>
- <a href="https://github.com/esmini/esmini/blob/master/scripts/bake_signs.sh">bake_signs.sh</a><br>
- <a href="https://github.com/esmini/esmini/blob/master/scripts/fix_dae_materials.py">fix_dae_materials.py</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_lighting">8.5. Lighting</h3>
<div class="paragraph">
<p>esmini use a very simple lighting model. Adding a global low ambient plus a stronger directed "sun" light. This is a simplistic model of a bright day where everything is visible but sides facing towards the sun gets brighter than those facing away.</p>
</div>
<div class="paragraph">
<p>The ambient intensity is 0.4. The "sun" x,y,z position is (-7500, 5000, 10000) and intensity 0.8.</p>
</div>
<div class="paragraph">
<p>Now, it has been reported that some custom models looks very dark on sides facing away from the sun. The main reason is often that the material definition do not have any ambient contribution.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/light_original.jpg" alt="light original">
</div>
<div class="title">Example of material lacking ambient component</div>
</div>
<div class="paragraph">
<p>There are two solutions:</p>
</div>
<div class="paragraph">
<p><strong>Solution 1: Fix the material</strong></p>
</div>
<div class="paragraph">
<p>Convert the model to Collada .dae format, example:</p>
</div>
<div class="paragraph">
<p><code>osgconv my_model.fbx my_model.dae</code></p>
</div>
<div class="paragraph">
<p>Then open the .dae file in a text editor. Look for <code>&lt;library_materials&gt;</code> and the material references inside that element. The actual material definitions are (typically?) found under <code>&lt;library_effects&gt;</code>. There might be many types, but two that we encountered are <code>&lt;phong&gt;</code> and <code>&lt;lambert&gt;</code>. They should have a diffuse element, something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;diffuse&gt;</span>
  <span class="tag">&lt;color</span> <span class="attribute-name">sid</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">diffuse</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>0.8 0.8 0.8 1.0<span class="tag">&lt;/color&gt;</span>
<span class="tag">&lt;/diffuse&gt;</span>`</code></pre>
</div>
</div>
<div class="paragraph">
<p>There might be a similar one for ambient. Check color values, if they are low, e.g. 0.2, try increase to max 1.0. If element is missing, just add it. In the end, it should look something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;ambient&gt;</span>
  <span class="tag">&lt;color</span> <span class="attribute-name">sid</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ambient</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>1.0 1.0 1.0 1.0<span class="tag">&lt;/color&gt;</span>
<span class="tag">&lt;/ambient&gt;</span>`</code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the file as my_model_fixed.dae.</p>
</div>
<div class="paragraph">
<p>There is a script that automates this process, but it will only recognize phong and lambert material types: <a href="https://github.com/esmini/esmini/blob/master/scripts/fix_dae_materials.py">fix_dae_materials.py</a>.</p>
</div>
<div class="paragraph">
<p>Finally, convert the patched dae file to osgb:<br>
<code>osgconv my_model.dae my_model.osgb</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/light_patched_material.jpg" alt="light patched material">
</div>
<div class="title">Same model with patched material</div>
</div>
<div class="paragraph">
<p>Different formats have different orientation frames. Hence it may be necessary to fix rotation. In that case, try something like:<br>
<code>osgconv my_model.dae -o 90-1,0,0 --use-world-frame my_model.osgb</code></p>
</div>
<div class="paragraph">
<p><strong>Solution 2: Add light source</strong></p>
</div>
<div class="paragraph">
<p>Users can add up to two custom light sources, specifying position (x, y, z) and intensity. Examples:</p>
</div>
<div class="paragraph">
<p>Add one custom light source:<br>
<code>./bin/esmini --window 60 60 800 400 --osc .\resources\xosc\lane_change_crest.xosc --custom_light 4000,-6000,500,1.0</code></p>
</div>
<div class="paragraph">
<p>Add two custom light sources:<br>
<code>./bin/esmini --window 60 60 800 400 --osc .\resources\xosc\lane_change_crest.xosc --custom_light 4000,-6000,500,0.4  --custom_light 5000,5000,200,0.2</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/light_second_light.jpg" alt="light second light">
</div>
<div class="title">Original model with one light added</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_support_qa">9. Support / Q&amp;A</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_various_issues">9.1. Various issues</h3>
<div class="sect3">
<h4 id="_resources_not_found">9.1.1. Resources not found</h4>
<div class="paragraph">
<p>There are no fixed structure where scenario resources, e.g. vehicle 3D model or controller catalog, needs to be stored. Instead, additional search paths can be added by launch argument <code>--path &lt;path&gt;</code>. For example:<br></p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --path ../../ --path c:/tmp/my_models</code></p>
</div>
<div class="paragraph">
<p>will add the relative path <code>../../</code> and absolute path <code>c:/tmp/my_models</code> to the list of places where to look for resources referred to by the scenario.</p>
</div>
</div>
<div class="sect3">
<h4 id="_blocked_by_windows_defender_smartscreen">9.1.2. Blocked by Windows Defender SmartScreen</h4>
<div class="paragraph">
<p>When esmini is downloaded as a zip file from Internet it might be blocked, i.e. prevented from being started, by Windows to protect your system. This is indicated by the following, or similar, message popping up when attempt to start:</p>
</div>
<div class="paragraph">
<p>"Microsoft Defender SmartScreen prevented an unrecognized app from starting. Running this app might put your PC at risk."</p>
</div>
<div class="paragraph">
<p>As long as the zip was downloaded from esmini official GitHub repository (<a href="https://github.com/esmini/esmini" class="bare">https://github.com/esmini/esmini</a>) it is perfectly safe to use.</p>
</div>
<div class="paragraph">
<p>The simplest solution is to unblock the zip file before unpacking it:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Right click</p>
</li>
<li>
<p>Click Properties</p>
</li>
<li>
<p>At bottom right, check "Unblock"</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/win-unblock.png" alt="win unblock">
</div>
</div>
<div class="paragraph">
<p>Note: This method also works for individual files after unzipping. But it can only be applied for one file at a time, why it&#8217;s simpler to unblock the complete zip before unpacking.</p>
</div>
<div class="paragraph">
<p>It is also possible to unblock from Powershell command line:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Single file:<br>
<code>Unblock-File esmini-demo_Windows.zip</code></p>
</li>
<li>
<p>Multiple files recursively:<br>
<code>Get-ChildItem -Path esmini-demo_Windows -Recurse | Unblock-File</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_mac_issues_and_limitations">9.1.3. Mac issues and limitations</h4>
<div class="paragraph">
<p>From esmini version 2.26.6 mac executables are universal binaries which means they work on both Intel and Apple Silicon based Macs. Following are some known issues and work arounds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Window can&#8217;t be located in the upper part of the screen (some systems). If window won&#8217;t open, try to adjust the y value (second entry) of the window argument. 60 pixels usually works fine, e.g: <code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc</code></p>
</li>
<li>
<p>Issue has been reported that when multiple screens are connected esmini just shows a bland window. Currently only solution is to unplug the additional montitors or unplug Mac from dock station.</p>
</li>
<li>
<p>Graphics can not run in separate thread. Hence the <code>--thread</code> launch flag will have no effect.</p>
</li>
<li>
<p>On Mac the zip-package might be put in quarantine, to release it: <code>xattr -d com.apple.quarantine file.zip</code> or even better: <code>xattr -c file.zip</code></p>
</li>
<li>
<p>esmini executables are not signed with a <a href="https://developer.apple.com/developer-id">developer ID</a> - since we simply don&#8217;t have one. If you got the package directly from <a href="https://github.com/esmini/esmini/releases">esmini release page on GitHub</a> it is safe to unpack and run.
In order to execute the files you need to do one of following from a terminal in the folder the demo package was extracted:</p>
<div class="ulist">
<ul>
<li>
<p>Remove quarantine flags: <code>xattr -c -r esmini-demo/bin</code>, or</p>
</li>
<li>
<p>Sign executables for use on local machine: <code>codesign -f -s - esmini-demo/bin/*</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_openstreetmap_osm_roads_in_esmini">9.1.4. OpenStreetMap (OSM) roads in esmini</h4>
<div class="paragraph">
<p>SUMO comes with a great tool, <a href="https://sumo.dlr.de/docs/netconvert.html">netconvert</a>, that can convert road networks from and to various formats.</p>
</div>
<div class="paragraph">
<p>Prerequisite: Download and install SUMO from <a href="https://sumo.dlr.de/docs/Downloads.php">here</a>.</p>
</div>
<div class="paragraph">
<p>Example: Convert an OSM map to OpenDRIVE for use in esmini:</p>
</div>
<div class="paragraph">
<p><code>netconvert --osm-files city.osm --opendrive-output city.xodr --no-turnarounds</code></p>
</div>
<div class="paragraph">
<p>Preview in odrviewer:</p>
</div>
<div class="paragraph">
<p><code>./bin/odrviewer --window 60 60 800 400 --odr city.xodr</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_update_3d_model_pack">9.1.5. Update 3D model pack</h4>
<div class="paragraph">
<p>Do either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>remove any <code>resources/models</code> folder</p>
</li>
<li>
<p>from <code>./build</code> folder, run <code>cmake ..</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>get the package from <a href="https://dl.dropboxusercontent.com/s/5gk8bvgzqiaaoco/models.7z?dl=1">here</a> and unpack files into <code>./resources/models</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_update_3rd_party_prebuilt_libraries">9.1.6. Update 3rd party prebuilt libraries</h4>
<div class="paragraph">
<p>There are a few external dependencies that takes long time to build from scratch. Instead they are provided in compressed packages including needed headerfiles and prebuilt libraries. The packages are available for Win, Mac and Linux. For Windows and Linux they include Debug mode binaries, in addition to the Release variant.</p>
</div>
<div class="paragraph">
<p>The cmake script will check for the availability of these libraries, by simply checking for existence of corresponding folders, e.g. osg, osi, sumo, under esmini/externals. If missing, compressed packages will be downloaded and extracted.</p>
</div>
<div class="paragraph">
<p>Not often, but at some points the prebuilt libraries needs to be updated. In most cases it affects the esmini build configuration and/or code. Hence, sometimes an update of esmini comes with a need to update the external libraries as well. Lack of automatic handling, such update needs to be done manually. One way is to delete the specific folder(s) and run ordinary cmake command again. But the simplest way is to enforce redownload of all packages:</p>
</div>
<div class="paragraph">
<p><code>cmake .. -D  FORCE_DOWNLOAD_BINARIES=TRUE</code></p>
</div>
<div class="paragraph">
<p>The FORCE_DOWNLOAD_BINARIES flag will be checked by the cmake script for enforced download of all packages. Upon successful download, the libraries will be replaced, one by one.</p>
</div>
<div class="paragraph">
<p>Library updates are not detected by the esmini build dependencies, why a clean rebuild of esmini should be performed manually afterwards.</p>
</div>
</div>
<div class="sect3">
<h4 id="_entity_does_not_appear">9.1.7. Entity does not appear</h4>
<div class="paragraph">
<p>In order to appear in the scenario, without need for AddEntity action, an entity must be represented in the Init section of the Storyboard. Common is to add actions to establish inital position and speed.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;PrivateAction&gt;</span>
   <span class="tag">&lt;TeleportAction&gt;</span>
      <span class="tag">&lt;Position&gt;</span>
         <span class="tag">&lt;LanePosition</span> <span class="attribute-name">roadId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">laneId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">s</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">50</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/Position&gt;</span>
   <span class="tag">&lt;/TeleportAction&gt;</span>
<span class="tag">&lt;/PrivateAction&gt;</span>
<span class="tag">&lt;PrivateAction&gt;</span>
   <span class="tag">&lt;LongitudinalAction&gt;</span>
      <span class="tag">&lt;SpeedAction&gt;</span>
         <span class="tag">&lt;SpeedActionDynamics</span> <span class="attribute-name">dynamicsShape</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">step</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">dynamicsDimension</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">time</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;SpeedActionTarget&gt;</span>
            <span class="tag">&lt;AbsoluteTargetSpeed</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">30.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/SpeedActionTarget&gt;</span>
      <span class="tag">&lt;/SpeedAction&gt;</span>
   <span class="tag">&lt;/LongitudinalAction&gt;</span>
<span class="tag">&lt;/PrivateAction&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_heading_behavior_in_road_vs_lane_position">9.1.8. Heading behavior in Road vs Lane Position</h4>
<div class="paragraph">
<p>In esmini, the behavior of the two position types <a href="https://www.asam.net/static_downloads/ASAM_OpenSCENARIO_V1.2.0_Model_Documentation/modelDocumentation/content/RoadPosition.html"><code>RoadPosition</code></a> and <a href="https://www.asam.net/static_downloads/ASAM_OpenSCENARIO_V1.2.0_Model_Documentation/modelDocumentation/content/LanePosition.html"><code>LanePosition</code></a> differ in terms of heading.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>RoadPosition</code>: When not specified, the heading will align to the direction of the road (s-axis)</p>
</li>
<li>
<p><code>LanePosition</code>: When not specified, the heading will align to the driving direction of the lane</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the image below, the white cars are positioned by <code>RoadPosition</code> with <code>t=-1.5</code> and <code>t=1.5</code> respectively while the red cars are positioned by <code>LanePosition</code> with <code>laneId="-1"</code> and <code>laneId="1"</code> respectively.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/no-heading.jpg" alt="no heading">
</div>
<div class="title">Positioning with RoadPosition (white) and LanePosition (red) - heading omitted</div>
</div>
<div class="paragraph">
<p>Explicitly specified heading (in <code>Orientation</code> sub-element):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Absolute heading will be respected and treated in the same way for both position cases</p>
</li>
<li>
<p>Relative heading will be based on the default heading, i.e. road or driving direction respectively.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In next image, an <code>Orientation</code> element was added with <strong>absolute</strong> heading = 0.4 for all four cars.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/absolute-heading.jpg" alt="absolute heading">
</div>
<div class="title">Positioning with RoadPosition (white) and LanePosition (red) - absolute heading=0.4</div>
</div>
<div class="paragraph">
<p>In next image, an <code>Orientation</code> element was added with <strong>relative</strong> heading = 0.4 for all four cars.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/relative-heading.jpg" alt="relative heading">
</div>
<div class="title">Positioning with RoadPosition (white) and LanePosition (red) - relative heading=0.4</div>
</div>
<div class="paragraph">
<p>Corresponding behavior applies also to <code>RelativeRoadPosition</code> and <code>RelativeLanePosition</code>.</p>
</div>
<div class="sect4">
<h5 id="_motivation">Motivation</h5>
<div class="paragraph">
<p>In some (maybe most) use cases it&#8217;s preferred that vehicles align to the driving direction of the lane. But in other cases not, example: In an overtake maneuver, the overtaking car may start in the neighbor lane. The driving direction of the lane should not affect the heading of the car.</p>
</div>
<div class="paragraph">
<p>So the different strategies for <code>RoadPosition</code> and <code>LanePosition</code> was decided upon to support as many use cases as possible. For more background, see issues <a href="https://github.com/esmini/esmini/issues/385">#385</a> and <a href="https://github.com/esmini/esmini/issues/228">#228</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_osi_for_python_on_windows">9.1.9. OSI for Python on Windows</h4>
<div class="paragraph">
<p>Follow the following steps to install OSI (and dependent Google Protobuf) for use by some esmini scripts, e.g. <a href="https://github.com/esmini/esmini/blob/master/scripts/osi2csv.py">osi2csv.py</a>.</p>
</div>
<div class="paragraph">
<p><strong>Protobuf for Python</strong> (skip if already installed)</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a Powershell</p>
</li>
<li>
<p><code>pip install protobuf==3.20.2</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>protoc</strong> (Protobuf compiler)</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Download <a href="https://github.com/protocolbuffers/protobuf/releases/download/v3.20.2/protoc-3.20.2-win64.zip">protoc-3.20.2-win64.zip</a><br>
(release page: <a href="https://github.com/protocolbuffers/protobuf/releases/tag/v3.20.2" class="bare">https://github.com/protocolbuffers/protobuf/releases/tag/v3.20.2</a>)</p>
</li>
<li>
<p>Unzip (at least protoc.exe) to some location</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>OSI for Python</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>Open a Powershell in the to-be-parent folder of OSI</p>
</li>
<li>
<p><code>git clone <a href="https://github.com/OpenSimulationInterface/open-simulation-interface" class="bare">https://github.com/OpenSimulationInterface/open-simulation-interface</a></code></p>
</li>
<li>
<p><code>cd open-simulation-interface</code></p>
</li>
<li>
<p><code>git checkout v3.5.0</code></p>
</li>
<li>
<p><code>./convert-to-proto3.sh</code></p>
</li>
<li>
<p><code>$env:PROTOC=&lt;location of protoc.exe&gt;</code><br>
for example: <code>$env:PROTOC="C:/tmp/protoc-3.20.2-win64/bin/protoc.exe"</code></p>
</li>
<li>
<p><code>pip install .</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This should be it.</p>
</div>
<div class="paragraph">
<p><strong>How to remove old versions</strong> (if needed)</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>pip uninstall protobuf</code></p>
</li>
<li>
<p><code>pip uninstall open-simulation-interface</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_the_scenario_runs_too_fast_or_too_slow">9.1.10. The scenario runs too fast or too slow</h4>
<div class="paragraph">
<p>esmini can run in two different time modes: 1. Real-time and 2. Fixed-time. Default is real-time.</p>
</div>
<div class="paragraph">
<p>The following command, from esmini root, will run real-time:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc</code><br></p>
</div>
<div class="paragraph">
<p>This one fixed-time:<br>
<code>./bin/esmini --window 60 60 800 400 --fixed_timestep 0.05 --osc ./resources/xosc/cut-in.xosc</code></p>
</div>
<div class="paragraph">
<p>The difference is basically that real-time will run with as small time-steps as possible (actually limit at 1 ms to avoid unnecessary CPU load), maxim
zing precision but constrained by system clock. In other words, the scenario will play out in "natural" speed, good for previewing or demonstrating sc
narios. Each timestep is calculated by esmini based on passed system-time since last frame.</p>
</div>
<div class="paragraph">
<p>The fixed-time is simpler, esmini will simply execute the scenario as fast as possible applying the specified delta-time for each step. Good for runni
g tests for later post processing of resulting logs, data or OSI files.</p>
</div>
<div class="paragraph">
<p>A common use-case is to run esmini quick/headless and then utilize the replayer for viewing the result. See more info here: <a href="#_replay_scenario">Replay scenario</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_road_and_junction_string_ids">9.1.11. Road and junction string IDs</h4>
<div class="paragraph">
<p>OpenDRIVE allows for non integer string IDs. Although commonly unsigned integer is used. The standard <a href="https://publications.pages.asam.net/standards/ASAM_OpenDRIVE/ASAM_OpenDRIVE_Specification/latest/specification/16_annexes/classes/road/top_cla_t_road.html">OpenDRIVE 1.8</a> states that IF the ID represents an integer number, it should comply to uint32_t and stay within the given range.</p>
</div>
<div class="paragraph">
<p>esmini partly supports* string IDs, by mapping to internal integer IDs. The way it works:</p>
</div>
<div class="paragraph">
<p>If the ID is a number in the range of 0..0xfffffffe (4 294 967 294), then:<br>
map it to the same internal ID<br>
Else, if the number is a string or a number out of range:<br>
map it to a unique internal ID</p>
</div>
<div class="paragraph">
<p><strong>Note</strong>: 0xffffffff (4 294 967 295) is reserved for ID_UNDEFINED which is the default value and also used for error indication<br></p>
</div>
<div class="paragraph">
<p>Example: Assume an OpenDRIVE includes the following road (or junction) IDs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">&quot;0&quot;
&quot;1&quot;
&quot;124&quot;
&quot;Kalle&quot;
&quot;12k4&quot;
&quot;4294967296&quot;
&quot;4294967295&quot;
&quot;4294967294&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The IDs will be mapped as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">&quot;0&quot; -&gt; 0
&quot;1&quot; -&gt; 1
&quot;124&quot; -&gt; 124
&quot;Kalle&quot; -&gt; 125
&quot;4294967296&quot; -&gt; 126 (too large)
&quot;4294967295&quot; -&gt; 127 (conflict with ID_UNDEFINED)
&quot;4294967294&quot; -&gt; 4294967294 (Ok, largest acceptable number)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, why not make use of available numbers between 1 and 124? It&#8217;s because esmini is lazy, not spending effort (performance) to book-keep sorted list of IDs. Instead, only the largest number in use will be monitored.</p>
</div>
<div class="paragraph">
<p>In addition, there are esmini lib API functions to lookup string and internal IDs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">const</span> <span class="predefined-type">char</span> *SE_GetRoadIdString(id_t road_id);
id_t SE_GetRoadIdFromString(<span class="directive">const</span> <span class="predefined-type">char</span> *road_id_str);

<span class="directive">const</span> <span class="predefined-type">char</span> *SE_GetJunctionIdString(id_t junction_id);
id_t SE_GetJunctionIdFromString(<span class="directive">const</span> <span class="predefined-type">char</span> *junction_id_str);</code></pre>
</div>
</div>
<div class="paragraph">
<p>That way, a custom application can find out what internal IDs esmini has assigned to any non-number string IDs.</p>
</div>
<div class="paragraph">
<p>Corresponding functions exist in esmini roadmanager lib.</p>
</div>
<div class="paragraph">
<p>* String ID support was introduced in v2.37.15. By v2.39.0 internal representation changed from 32 bit signed int to unsigned int. At that point also undefined ID changed from -1 to 0xffffffff.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_further_issues_at_esmini_github_page">9.2. Further issues at esmini GitHub page</h3>
<div class="paragraph">
<p>The <a href="https://github.com/esmini/esmini/issues">Issues tab at esmini GitHub page</a> is a valuable source of questions and answers. To search in all issues, make sure to set filter: <code>is:issue</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_command_reference">10. Command reference</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_esmini">10.1. esmini</h3>
<div class="sect3">
<h4 id="_launch_commands">10.1.1. Launch commands</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Usage: esmini [options]
Options:
  --osc &lt;filename&gt;
      OpenSCENARIO filename (required) - if path includes spaces, enclose with &quot;&quot;
  --aa_mode [mode]  (default if value omitted: 4)
      Anti-alias mode=number of multisamples (subsamples, 0=off)
  --align_routepositions
      Align t-axis of route positions to the direction of the route
  --bounding_boxes
      Show entities as bounding boxes. Toggle key ','
  --capture_screen
      Continuous screen capture. Warning: Many jpeg files will be created
  --camera_mode [mode]  (default if option or value omitted: orbit)
      Initial camera mode (&quot;orbit&quot;, &quot;fixed&quot;, &quot;flex&quot;, &quot;flex-orbit&quot;, &quot;top&quot;, &quot;driver&quot;, &quot;custom&quot;). Toggle key 'k'
  --csv_logger [csv_filename]  (default if value omitted: log.csv)
      Log data for each vehicle in ASCII csv format
  --collision
      Enable global collision detection, potentially reducing performance
  --custom_camera &lt;position&gt;
      Additional custom camera position &lt;x,y,z&gt;[,h,p] (multiple occurrences supported)
  --custom_fixed_camera &lt;position and optional orientation&gt;
      Additional custom fixed camera position &lt;x,y,z&gt;[,h,p] (multiple occurrences supported)
  --custom_fixed_top_camera &lt;position and rotation&gt;
      Additional custom top camera &lt;x,y,z,rot&gt; (multiple occurrences supported)
  --custom_light &lt;position and intensity&gt;
      Additional custom light source &lt;x,y,z,intensity&gt; intensity range 0..1 (multiple occurrences supported)
  --disable_controllers
      Disable controllers
  --disable_pline_interpolation
      Do not apply orientation interpolation of polyline trajectories
  --disable_log
      Prevent logfile from being created
  --disable_stdout
      Prevent messages to stdout
  --enforce_generate_model
      Generate road 3D model even if SceneGraphFile is specified
  --fixed_timestep &lt;timestep&gt;
      Run simulation decoupled from realtime, with specified timesteps
  --follow_object [index]  (default if option or value omitted: 0)
      Set index of initial object for camera to follow (change with Tab/shift-Tab)
  --generate_no_road_objects
      Do not generate any OpenDRIVE road objects (e.g. when part of referred 3D model)
  --generate_without_textures
      Do not apply textures on any generated road model (set colors instead as for missing textures)
  --ground_plane
      Add a large flat ground surface
  --headless
      Run without viewer window
  --help
      Show this help message
  --hide_route_waypoints
      Disable route waypoint visualization. Toggle key 'R'
  --hide_trajectories
      Hide trajectories from start. Toggle key 'n'
  --ignore_odr_offset
      Ignore any offset specified in the OpenDRIVE file header
  --ignore_z
      Ignore provided z values from OSC file and place vehicle relative to road
  --ignore_p
      Ignore provided pitch values from OSC file and place vehicle relative to road
  --ignore_r
      Ignore provided roll values from OSC file and place vehicle relative to road
  --info_text [mode]  (default if option or value omitted: 1)
      Show on-screen info text. Modes: 0=None 1=current 2=per_object 3=both. Toggle key 'i'
  --log_append
      Log all scenarios in the same txt file
  --logfile_path [path]  (default if option or value omitted: log.txt)
      Logfile path/filename, e.g. &quot;../my_log.txt&quot;
  --log_meta_data
      Log file name, function name and line number
  --log_level [mode]  (default if option or value omitted: info)
      Log level debug, info, warn, error
  --log_only_modules &lt;modulename(s)&gt;
      Log from only these modules. Overrides log_skip_modules. See User guide for more info
  --log_skip_modules &lt;modulename(s)&gt;
      Skip log from these modules, all remaining modules will be logged. See User guide for more info
  --osc_str &lt;string&gt;
      OpenSCENARIO XML string
  --osg_screenshot_event_handler
      Revert to OSG default jpg images ('c'/'C' keys handler)
  --osi_file [filename]  (default if value omitted: ground_truth.osi)
      Save osi trace file
  --osi_freq &lt;frequency&gt;
      Decrease OSI file entries, e.g. --osi_freq 2 -&gt; OSI written every two simulation steps
  --osi_lines
      Show OSI road lines. Toggle key 'u'
  --osi_points
      Show OSI road points. Toggle key 'y'
  --osi_receiver_ip [IP address]  (default if value omitted: 127.0.0.1)
      IP address where to send OSI UDP packages
  --param_dist &lt;filename&gt;
      Run variations of the scenario according to specified parameter distribution file
  --param_permutation &lt;index&gt;
      Run specific permutation of parameter distribution, index in range (0 .. NumberOfPermutations-1)
  --pause
      Pause simulation after initialization
  --path &lt;path&gt;
      Search path prefix for assets, e.g. OpenDRIVE files. Multiple occurrences of option supported
  --player_server
      Launch UDP server for action/command injection
  --plot [mode]  (default if value omitted: asynchronous)
      Show window with line-plots of interesting data. Modes: asynchronous, synchronous
  --record [filename]  (default if value omitted: sim.dat)
      Record position data into a file for later replay
  --road_features [mode]  (default if value omitted: on)
      Show OpenDRIVE road features. Modes: on, off. Toggle key 'o'
  --return_nr_permutations
      Return number of permutations without executing the scenario (-1 = error)
  --save_generated_model
      Save generated 3D model (n/a when a scenegraph is loaded)
  --save_xosc [mode]  (default if value omitted: continue)
      Save OpenSCENARIO file with any populated parameter values (from distribution). Modes: quit, continue.
  --seed &lt;number&gt;
      Specify seed number for random generator
  --sensors
      Show sensor frustums. Toggle key 'r'
  --server
      Launch server to receive state of external Ego simulator
  --text_scale [size factor]  (default if option or value omitted: 1.0)
      Scale screen overlay text
  --threads
      Run viewer in a separate thread, parallel to scenario engine
  --trail_mode [mode]  (default if value omitted: 0)
      Show trail lines and/or dots. Modes: 0=None 1=lines 2=dots 3=both. Toggle key 'j'
  --traj_filter [radius]  (default if option or value omitted: 0.1)
      Simple filter merging close points. Set 0.0 to disable
  --use_signs_in_external_model
      When external scenegraph 3D model is loaded, skip creating signs from OpenDRIVE
  --version
      Show version and quit

Additional OSG graphics options:
  --clear-color &lt;color&gt;                      Set the background color of the viewer in the form &quot;r,g,b[,a]&quot;
  --screen &lt;num&gt;                             Set the screen to use when multiple screens are present
  --window &lt;x y w h&gt;                         Set the position x, y and size w, h of the viewer window. -1 -1 -1 -1 for fullscreen.
  --borderless-window &lt;x y w h&gt;              Set the position x, y and size w, h of a borderless viewer window. -1 -1 -1 -1 for fullscreen.
  --SingleThreaded                           Run application and all graphics tasks in one single thread.
  --lodScale &lt;LOD scalefactor&gt;               Adjust Level Of Detail 1=default &gt;1 decrease fidelity &lt;1 increase fidelity

For a complete list of OSG options and environment variables, see here:
https://github.com/esmini/esmini/blob/master/docs/osg_options_and_env_variables.txt</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_runtime_key_shortcut_commands">10.1.2. Runtime key shortcut commands</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Key shortcuts

    H (shift + h): Print this help text to console
    Space:         Toggle pause/play simulation
    Return:        Step simulation (one timestep) then pause
    TAB:           Move camera to next vehicle
    Shift + TAB:   Move camera to previoius vehicle
    Delete:        Same as above (Shift + TAB)
    o:             Toggle show / hide OpenDRIVE road feature lines
    O:             Toggle show / hide odr signal bounding boxes
    u:             Toggle show / hide OSI road lines
    y:             Toggle show / hide OSI road points
    p:             Toggle show / hide environment 3D model
    r:             Toggle show / hide sensor view frustums
    R:             Toggle route waypoint visualization
    i:             Toggle on-screen info text modes
    j:             Toggle show trails after vehicles(4 modes: none / dots / lines / both)
    n:             Toggle show active trajectories
    , (comma):     Switch entity view : Model only / Bounding box / Model + Bounding box / None
    K:             Print current camera position and orientation to console
    ESC:           quit

    Arrow keys is used to drive externally controlled Ego vehicle:
        Up:    Accelerate
        Down:  Brake
        Left:  Steer left
        Right: Steer right

    1 - 9: Camera models acording to :
        1: Custom camera model
        2: Flight
        3: Drive
        4: Terrain
        5: Orbit
        6: FirstPerson
        7: Spherical
        8: NodeTracker
        9: Trackball

    When custom camera model(1) is activated
        k: Switch between the following sub models:
           - Orbit        (camera facing vehicle, rotating around it)
           - Fixed        (fix rotation, always straight behind vehicle)
           - Flex         (imagine the camera attached to vehicle via an elastic string)
           - Flex - orbit (Like flex but allows for roatation around vehicle)
           - Top          (top view, fixed rotation, always straight above vehicle)
           - Driver       (&quot;driver&quot; view, fixed at center of vehicle)

    Viewer options
        f: Toggle full screen mode
        t: Toggle textures
        s: Rendering statistics
        l: Toggle light
        w: Toggle geometry mode(shading, wireframe, dots)
        c: Save screenshot in JPEG format - in the folder where the application was started from
        C: Toggle continuous screen capture (e.g for video creation)
        h: Help

Mouse control

    Left:   Rotate
    Right:  Zoom
    Middle: Pan

    This is typical, exact behaviour depends on active camera model.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_replayer">10.2. replayer</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Usage: replayer [options]
Options:
  --file &lt;filename&gt;
      Simulation recording data file (.dat)
  --aa_mode [mode]  (default if value omitted: 4)
      Anti-alias mode=number of multisamples (subsamples, 0=off)
  --camera_mode [mode]  (default if option or value omitted: orbit)
      Initial camera mode (&quot;orbit&quot;, &quot;fixed&quot;, &quot;flex&quot;, &quot;flex-orbit&quot;, &quot;top&quot;, &quot;driver&quot;, &quot;custom&quot;). Toggle key 'k'
  --capture_screen
      Continuous screen capture. Warning: Many jpeg files will be created
  --collision [mode]  (default if value omitted: pause)
      Detect collisions and optionally pauses the replay &lt;pause/continue&gt; (pause is default)
  --custom_camera &lt;position&gt;
      Additional custom camera position &lt;x,y,z&gt;[,h,p] (multiple occurrences supported)
  --custom_fixed_camera &lt;position and optional orientation&gt;
      Additional custom fixed camera position &lt;x,y,z&gt;[,h,p] (multiple occurrences supported)
  --custom_fixed_top_camera &lt;position and rotation&gt;
      Additional custom top camera &lt;x,y,z,rot&gt; (multiple occurrences supported)
  --dir &lt;path&gt;
      Directory containing replays to overlay, pair with &quot;file&quot; argument, where &quot;file&quot; is .dat filename match substring
  --ground_plane
      Add a large flat ground surface
  --generate_without_textures
      Do not apply textures on any generated road model (set colors instead as for missing textures)
  --headless
      Run without viewer window
  --hide_trajectories
      Hide trajectories from start (toggle with key 'n')
  --info_text [mode]  (default if option or value omitted: 1)
      Show on-screen info text. Modes: 0=None 1=current 2=per_object 3=both. Toggle key 'i'
  --logfile_path [path]  (default if value omitted: replayer_log.txt)
      Logfile path/filename, e.g. &quot;../my_log.txt&quot;
  --no_ghost
      Remove ghost entities
  --no_ghost_model
      Remove only ghost model, show trajectory (toggle with key 'g')
  --osg_screenshot_event_handler
      Revert to OSG default jpg images ('c'/'C' keys handler)
  --path &lt;path&gt;
      Search path prefix for assets, e.g. OpenDRIVE files. Multiple occurrences of option supported
  --quit_at_end
      Quit application when reaching end of scenario
  --remove_object &lt;id&gt;
      Remove object(s). Multiple ids separated by comma, e.g. 2,3,4.
  --repeat
      loop scenario
  --res_path &lt;path&gt;
      Path to resources root folder - relative or absolut
  --road_features [mode]  (default if value omitted: on)
      Show OpenDRIVE road features. Modes: on, off. Toggle key 'o'
  --save_merged &lt;filename&gt;
      Save merged data into one dat file, instead of viewing
  --start_time &lt;ms&gt;
      Start playing at timestamp
  --stop_time &lt;ms&gt;
      Stop playing at timestamp (set equal to time_start for single frame)
  --text_scale [size factor]  (default if option or value omitted: 1.0)
      Scale screen overlay text
  --time_scale &lt;factor&gt;
      Playback speed scale factor (1.0 == normal)
  --view_mode &lt;view_mode&gt;
      Entity visualization: &quot;model&quot;(default)/&quot;boundingbox&quot;/&quot;both&quot;
  --use_signs_in_external_model
      When external scenegraph 3D model is loaded, skip creating signs from OpenDRIVE

Additional OSG graphics options:
  --clear-color &lt;color&gt;                      Set the background color of the viewer in the form &quot;r,g,b[,a]&quot;
  --screen &lt;num&gt;                             Set the screen to use when multiple screens are present
  --window &lt;x y w h&gt;                         Set the position x, y and size w, h of the viewer window. -1 -1 -1 -1 for fullscreen.
  --borderless-window &lt;x y w h&gt;              Set the position x, y and size w, h of a borderless viewer window. -1 -1 -1 -1 for fullscreen.
  --SingleThreaded                           Run application and all graphics tasks in one single thread.
  --lodScale &lt;LOD scalefactor&gt;               Adjust Level Of Detail 1=default &gt;1 decrease fidelity &lt;1 increase fidelity

Key shortcuts

    H (shift + h): Print this help text to console
    TAB:           Move camera to next vehicle
    Shift + TAB:   Move camera to previoius vehicle
    Delete:        Same as above (Shift + TAB)
    Space:         Toggle pause / play
    g:             Toggle show / hide ghost models
    o:             Toggle show / hide OpenDRIVE road feature lines
    u:             Toggle show / hide OSI road lines
    y:             Toggle show / hide OSI road points
    p:             Toggle show / hide environment 3D model
    i:             Toggle on-screen info text modes
    n:             Toggle show active trajectories
    , (comma):     Switch entity view : Model only / Bounding box / Model + Bounding box / None
    K:             Print current camera position and orientation to console
    ESC:           quit

    Arrow keys
        Left:               Pause and move to previous frame(+Shift to skip 10 frames)
        Right:              Pause and move to next frame(+Shift to skip 10 frames)
        Shift + Left:       Pause and jump 0.1s back
        Shift + Right:      Pause and jump 0.1s forward
        Shift + Ctrl Left:  Pause and jump 1.0s back
        Shift + Ctrl Right: Pause and jump 1.0s forward
        Ctrl + Left:        Pause and jump to beginning
        Ctrl + Right:       Pause and jump to end
        Up:                 Increase timeScale(play faster)
        Down:               Decrease timeScale(play slower)

    1 - 9: Camera models acording to :
        1: Custom camera model
        2: Flight
        3: Drive
        4: Terrain
        5: Orbit
        6: FirstPerson
        7: Spherical
        8: NodeTracker
        9: Trackball

    When custom camera model(1) is activated
        k: Switch between the following sub models:
           - Orbit        (camera facing vehicle, rotating around it)
           - Fixed        (fix rotation, always straight behind vehicle)
           - Flex         (imagine the camera attached to vehicle via an elastic string)
           - Flex - orbit (Like flex but allows for roatation around vehicle)
           - Top          (top view, fixed rotation, always straight above vehicle)
           - Driver       (&quot;driver&quot; view, fixed at center of vehicle)

    Viewer options
        f: Toggle full screen mode
        t: Toggle textures
        s: Rendering statistics
        l: Toggle light
        w: Toggle geometry mode(shading, wireframe, dots)
        c: Save screenshot in JPEG format - in the folder where the application was started from
        C: Toggle continuous screen capture (e.g for video creation)
        h: Help

Mouse control

    Left:   Rotate
    Right:  Zoom
    Middle: Pan

    This is typical, exact behaviour depends on active camera model.

Recommended usage:
    Run esmini headless (fast without viewer) and produce a .dat file. Then launch replayer to view it. Example in Windows PowerShell, starting from esmini/bin folder:

    .\esmini --osc ..\resources\xosc\cut-in.xosc --record sim.dat --headless --fixed_timestep 0.01 ; .\replayer --file sim.dat --window 60 60 800 400 --res_path ..\resources --repeat</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_odrviewer">10.3. odrviewer</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Usage: odrviewer [options]
Options:
  --help
      Show this help message
  --odr &lt;odr_filename&gt;
      OpenDRIVE filename (required)
  --aa_mode [mode]  (default if value omitted: 4)
      Anti-alias mode=number of multisamples (subsamples, 0=off)
  --capture_screen
      Continuous screen capture. Warning: Many .tga files will be created
  --custom_fixed_camera &lt;position and optional orientation&gt;
      Additional custom camera position &lt;x,y,z&gt;[,h,p] (multiple occurrences supported)
  --custom_fixed_top_camera &lt;position and rotation&gt;
      Additional custom top camera &lt;x,y,z,rot&gt; (multiple occurrences supported)
  --density [density]  (default if value omitted: 1.000000)
      density (cars / 100 m)
  --enforce_generate_model
      Generate road 3D model even if --model is specified
  --disable_log
      Prevent logfile from being created
  --disable_off_screen
      Disable esmini off-screen rendering, revert to OSG viewer default handling
  --disable_stdout
      Prevent messages to stdout
  --duration &lt;duration&gt;
      Quit automatically after specified time (seconds, floating point)
  --fixed_timestep &lt;timestep&gt;
      Run simulation decoupled from realtime, with specified timesteps
  --generate_no_road_objects
      Do not generate any OpenDRIVE road objects (e.g. when part of referred 3D model)
  --generate_without_textures
      Do not apply textures on any generated road model (set colors instead as for missing textures)
  --ground_plane
      Add a large flat ground surface
  --headless
      Run without viewer window
  --log_append
      Log all scenarios in the same txt file
  --logfile_path [path]  (default if value omitted: odrviewer_log.txt)
      Logfile path/filename, e.g. &quot;../my_log.txt&quot;
  --log_meta_data
      Log file name, function name and line number
  --log_level [mode]  (default if option or value omitted: info)
      Log level debug, info, warn, error
  --log_only_modules &lt;modulename(s)&gt;
      Log from only these modules. Overrides log_skip_modules. See User guide for more info
  --log_skip_modules &lt;modulename(s)&gt;
      Skip log from these modules, all remaining modules will be logged. See User guide for more info
  --model &lt;model_filename&gt;
      3D Model filename
  --osg_screenshot_event_handler
      Revert to OSG default jpg images ('c'/'C' keys handler)
  --osi_lines
      Show OSI road lines. Toggle key 'u'
  --osi_points
      Show OSI road points. Toggle key 'y'
  --path &lt;path&gt;
      Search path prefix for assets, e.g. OpenDRIVE files. Multiple occurrences of option supported
  --road_features [mode]  (default if value omitted: on)
      Show OpenDRIVE road features. Modes: on, off. Toggle key 'o'
  --save_generated_model
      Save generated 3D model (n/a when a scenegraph is loaded)
  --seed &lt;number&gt;
      Specify seed number for random generator
  --speed_factor [speed_factor]  (default if value omitted: 1.000000)
      speed_factor &lt;number&gt;
  --stop_at_end_of_road
      Instead of respawning elsewhere, stop when no connection exists
  --text_scale [size factor]  (default if option or value omitted: 1.0)
      Scale screen overlay text
  --traffic_rule &lt;rule (right/left)&gt;
      Enforce left or right hand traffic, regardless OpenDRIVE rule attribute (default: right)
  --use_signs_in_external_model
      When external scenegraph 3D model is loaded, skip creating signs from OpenDRIVE
  --version
      Show version and quit

Additional OSG graphics options:
  --clear-color &lt;color&gt;                      Set the background color of the viewer in the form &quot;r,g,b[,a]&quot;
  --screen &lt;num&gt;                             Set the screen to use when multiple screens are present
  --window &lt;x y w h&gt;                         Set the position x, y and size w, h of the viewer window. -1 -1 -1 -1 for fullscreen.
  --borderless-window &lt;x y w h&gt;              Set the position x, y and size w, h of a borderless viewer window. -1 -1 -1 -1 for fullscreen.
  --SingleThreaded                           Run application and all graphics tasks in one single thread.
  --lodScale &lt;LOD scalefactor&gt;               Adjust Level Of Detail 1=default &gt;1 decrease fidelity &lt;1 increase fidelity

Examples:

1. View the ODR file and some random traffic on a 3D model, window mode 1000 x 500:
   odrviewer --odr xodr\e6mini.xodr --model models\e6mini.osgb --window 60 60 1000 500

2. Just ODR, fullscreen
   odrviewer --odr xodr\e6mini.xodr

3. Remove traffic
   odrviewer --odr xodr\e6mini.xodr --model models\e6mini.osgb --density 0 --window 60 60 1000 500

4. Sparse traffic (about 0.5 vehicle per 100 meter = 1 per 200 m)
   odrviewer --odr xodr\e6mini.xodr --model models\e6mini.osgb --density 0.5 --window 60 60 1000 500


Key shortcuts

    H (shift + h): Print this help text to console
    Space:         Toggle pause/play simulation
    Return:        Step simulation(one timestep) then pause
    TAB:           Move camera to next vehicle
    Shift + TAB:   Move camera to previoius vehicle
    Delete:        Same as above (Shift + TAB)
    o:             Toggle show / hide OpenDRIVE road feature lines
    u:             Toggle show / hide OSI road lines
    y:             Toggle show / hide OSI road points
    p:             Toggle show / hide environment 3D model
    i:             Toggle info text showing time and speed
    , (comma):     Switch entity view : Model only / Bounding box / Model + Bounding box / None
    K:             Print current camera position and orientation to console
    ESC:           quit

    1 - 9: Camera models acording to :
        1: Custom camera model
        2: Flight
        3: Drive
        4: Terrain
        5: Orbit
        6: FirstPerson
        7: Spherical
        8: NodeTracker
        9: Trackball

    When custom camera model(1) is activated
        k: Switch between the following sub models:
           - Orbit        (camera facing vehicle, rotating around it)
           - Fixed        (fix rotation, always straight behind vehicle)
           - Flex         (imagine the camera attached to vehicle via an elastic string)
           - Flex - orbit (Like flex but allows for roatation around vehicle)
           - Top          (top view, fixed rotation, always straight above vehicle)
           - Driver       (&quot;driver&quot; view, fixed at center of vehicle)

    Viewer options
        f: Toggle full screen mode
        t: Toggle textures
        s: Rendering statistics
        l: Toggle light
        w: Toggle geometry mode(shading, wireframe, dots)
        c: Save screenshot in JPEG format - in the folder where the application was started from
        C: Toggle continuous screen capture
        h: Help

Mouse control

    Left:   Rotate
    Right:  Zoom
    Middle: Pan

    This is typical, exact behaviour depends on active camera model.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_plot_dat_py">10.4. plot_dat.py</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>usage: plot_dat.py [-h] [--x_axis X_AXIS] [--equal_axis_aspect] [--derive] [--dots] (--list_params | --param PARAM) &lt;filename&gt;

positional arguments:
  filename             dat filename

optional arguments:
  -h, --help           show this help message and exit
  --x_axis X_AXIS      x-axis parameter
  --equal_axis_aspect  lock aspect ratio = 1:1
  --derive             derive values wrt x, i.e. dy/dx
  --dots               add dots
  --list_params        list available parameters in given file
  --param PARAM        parameter to plot (can be specified multiple times)

Note: In addition to &lt;filename&gt; one of the arguments --list_params and --param &lt;PARAM&gt; is required</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_guide">11. Build guide</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_build_configurations_in_visual_studio_and_visual_studio_code">11.1. Build configurations in Visual Studio and Visual Studio Code</h3>
<div class="paragraph">
<p>From esmini version 2.29.0 a set of cmake presets are provided. These can be utilized from Visual Studio Code and Visual Studio (from 2019 version 16.10 onwards, see more info <a href="https://learn.microsoft.com/en-us/cpp/build/cmake-presets-vs?view=msvc-170">here</a>) with the CMake Tools extension.</p>
</div>
</div>
<div class="sect2">
<h3 id="_build_configurations_from_command_line">11.2. Build configurations from command line</h3>
<div class="paragraph">
<p><a href="https://cmake.org/">CMake</a> tool is used to create standard make configurations. A few example "create&#8230;&#8203;" batch scripts are supplied (in <code>scripts</code> folder) as examples how to generate desired build setup from command line.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>VisualStudio / win64 / Windows SDK v10 / Release and Debug</p>
</li>
<li>
<p>Ubuntu and Kubuntu (tested on 18.04) / gcc / Release and Debug</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, it should be possible to configure custom variants using cmake. For example to use Visual Studio 2019 run the following commands from command prompt (CMD or PowerShell), assuming starting point is esmini root folder:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mkdir build
cd build
cmake .. -G "Visual Studio 16 2019"
cmake --build . --config Release --target install</pre>
</div>
</div>
<div class="paragraph">
<p>This will first generate Visual Studio solution and then compile esmini using MSVC toolset v142 (default with Visual Studio 2019). Default architecture should be x64.</p>
</div>
<div class="paragraph">
<p>If you want to compile with MSVC 2017 toolset just add directive to the generator as follows:</p>
</div>
<div class="paragraph">
<p><code>
cmake .. -G "Visual Studio 16 2019" -T v141
</code></p>
</div>
<div class="paragraph">
<p>A complete list of supported toolsets are available <a href="https://cmake.org/cmake/help/v3.17/variable/MSVC_TOOLSET_VERSION.html">here</a>.</p>
</div>
<div class="paragraph">
<p>Provided 3rd party lib binaries are only provided for Windows x64 architecture. To make sure you build for x64 add <code>-A x64</code>, For example:</p>
</div>
<div class="paragraph">
<p><code>
cmake .. -G "Visual Studio 16 2019" -T v141 -A x64
</code></p>
</div>
<div class="paragraph">
<p>If you want to compile with MSVC 2015 (v140) toolset and for win32 use the following generator command:</p>
</div>
<div class="paragraph">
<p><code>
cmake -G "Visual Studio 16 2019" -T v140 -A Win32 ..
</code></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Note:</strong></p>
</div>
<div class="paragraph">
<p>Provided 3rd party libs only available for x64 builds. If you need to build full esmini for Win32 (32bit), you need to compile the 3rd party libraries yourself. Perhaps the "scripts/generate_*_libs.sh" scripts can be a starting point for such an endeavor.</p>
</div>
<div class="paragraph">
<p>Another possibility for Win32 is to build a slim esmini with a minimum of dependencies. See <a href="#_slim_esmini_customize_configration">Slim esmini - customize configration</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Of course, building with a specific toolset requires it to be installed. Use <a href="https://docs.microsoft.com/en-us/visualstudio/install/install-visual-studio?view=vs-2019">Visual Studio Installer</a>. Steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>choose "Modify"</p>
</li>
<li>
<p>make sure Desktop Development with C++ is checked</p>
</li>
<li>
<p>go to tab "Individual components"</p>
</li>
<li>
<p>scroll down to "Compilers, build tools, and runtimes"</p>
</li>
<li>
<p>check the MSVC versions you need, e.g. "MSVC v140 - VS 2015 C++ build tools (v14.00)" and "MSVC v141 - VS 2017 C++ x64/x86 build tools (v14.16)"</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All configurations defines an "Install" build target that compiles (if needed) and copies relevant binaries into a common "esmini/bin" folder recognized by the example scripts under the "esmini/run" folder.</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>For automatic downloading of external dependencies (OSG binaries) and 3D models, CMake version 3.11.4 or above is required (FetchContent_MakeAvailable was introduced).<br></p>
</li>
<li>
<p>In Windows, if you get an error like "the c compiler identification is unknown", then please make sure to install "Windows Universal CRT SDK" from the Visual Studio Installer tool.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_external_dependencies">11.3. External dependencies</h3>
<div class="paragraph">
<p>esmini is designed to link all dependencies statically. Main reason is to have a all-inclusive library for easy integration either as a shared library/DLL (e.g. plugin in Unity, or S-function in Simulink) or statically linked into a native application.</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> Nothing stops you from going with all dynamic linking, it&#8217;s just that provided build scripts are not prepared for it.</p>
</div>
<div class="paragraph">
<p>CMake scripts will download several pre-compiled 3rd party packages and 3D model resource files.</p>
</div>
<div class="paragraph">
<p>Default location for these resources is Google drive. If there is an issue, try switch to the backup location at Dropbox by changing the following line in <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/CMakeLists.txt">EnvironmentSimulator/CMakeLists.txt</a>:</p>
</div>
<div class="paragraph">
<p><code>set ( FILE_STORAGE "google" )</code><br>
to<br>
<code>set ( FILE_STORAGE "dropbox" )</code><br></p>
</div>
<div class="paragraph">
<p>Links to all packages can be found in <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/CMakeLists.txt">EnvironmentSimulator/CMakeLists.txt</a>.</p>
</div>
<div class="paragraph">
<p>If you need to (re)build a 3rd party lib for some reason, e.g. for an yet unsupported system or need for a specific version, these build scripts might be a starting point:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/esmini/esmini/blob/master/scripts/generate_osg_libs.sh">scripts/generate_osg_libs.sh</a></p>
</li>
<li>
<p><a href="https://github.com/esmini/esmini/blob/master/scripts/generate_osi_libs.sh">scripts/generate_osi_libs.sh</a></p>
</li>
<li>
<p><a href="https://github.com/esmini/esmini/blob/master/scripts/generate_sumo_libs.sh">scripts/generate_sumo_libs.sh</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or this script that builds all three libs, combining the above ones:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/esmini/esmini/blob/master/scripts/generate_osi_sumo_osg_libs.sh">scripts/generate_osi_sumo_osg_libs.sh</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_additional_platform_dependencies">11.4. Additional platform dependencies</h3>
<div class="paragraph">
<p>Linux Ubuntu</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>sudo apt install build-essential gdb ninja-build git pkg-config libgl1-mesa-dev libpthread-stubs0-dev libjpeg-dev libxml2-dev libpng-dev libtiff5-dev libgdal-dev libpoppler-dev libdcmtk-dev libgstreamer1.0-dev libgtk2.0-dev libcairo2-dev libpoppler-glib-dev libxrandr-dev libxinerama-dev curl cmake black</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, g++ version &gt;= 5 is needed for c++14 code support.</p>
</div>
<div class="paragraph">
<p>Windows and Mac: Install the <a href="https://cmake.org/">cmake</a> application</p>
</div>
</div>
<div class="sect2">
<h3 id="_run_and_debug_with_linux_and_visual_studio_code">11.5. Run and Debug with Linux and visual studio code</h3>
<div class="paragraph">
<p>To run from the visual studio, the steps below might help with setup configuration.</p>
</div>
<div class="sect3">
<h4 id="_with_preset">11.5.1. With preset</h4>
<div class="paragraph">
<p><strong>Note:</strong> Make sure cmake.preset set to auto to recognize the presets (defined in the <code>CMakePresets.json</code> file). Open setting (Ctrl + ,) type <code>cmake.preset</code>, set <code>auto</code> in drop down box. This is a global setting.</p>
</div>
<div class="paragraph">
<p>To run:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the Command Palette (Ctrl+Shift+P) and run CMake: Configure. Select <code>ubuntu_release</code></p>
</li>
<li>
<p>Shift + F7 to select and build specific target</p>
<div class="ulist">
<ul>
<li>
<p>e.g. <code>install</code> to build and copy all targets to bin folder</p>
</li>
</ul>
</div>
</li>
<li>
<p>Configure custom run arguments (create launch.json)</p>
<div class="ulist">
<ul>
<li>
<p>Open the run and debug window (Ctrl+Shift+D)</p>
</li>
<li>
<p>Select <code>create a launch.json file</code></p>
</li>
<li>
<p>In the drop down list, select <code>C++ (GDB/LLDB)</code></p>
</li>
<li>
<p>Select <code>Add Configuration&#8230;&#8203;</code> (in the lower right corner of the sub window)</p>
</li>
<li>
<p>Select <code>C/C++: (gdb) Launch</code></p>
</li>
<li>
<p>Change <code>program</code> setting as <code>"${workspaceFolder}/build/EnvironmentSimulator/Applications/esmini/esmini"</code></p>
</li>
<li>
<p>Change <code>args</code> as <code>["--window", "60", "60", "800", "400", "--osc", "../resources/xosc/cut-in.xosc"]</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Press F5</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For Debug,
Repeat step 1 and select <code>ubuntu_debug</code>. Repeat step 2 to build debug binaries and then step 4. Breakpoints can be added to the program specified in the <code>launch.json</code> file (do step 3 if not already done).</p>
</div>
<div class="paragraph">
<p>Build target can also be changed in the status bar, click <code>Set the default build target</code>. If not cmake commands are visible in status bar, check global settings: Ctrl + ,  then write "cmake status bar" to find <code>Status Bar Visibility</code> setting. Set to <code>visible</code>.</p>
</div>
<div class="paragraph">
<p>Another way to set build target is via Ctrl+Shift+P, then write "set build target" to find <code>CMake: Set Build Target</code> setting. Select it and choose build target in the drop down list that should appear.</p>
</div>
</div>
<div class="sect3">
<h4 id="_without_preset">11.5.2. Without preset</h4>
<div class="paragraph">
<p>Make sure <code>cmake.preset</code> set to never to ignore the preset file (<code>CMakePresets.json</code>):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open setting (Ctrl+,) type cmake.preset, select <code>never</code> in drop down box</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Note:</strong> This is a global setting, i.e. will affect other VSCode instances. Reset to <code>auto</code> if needed. Another way to ignore the presets is simply to remove the <code>CMakePresets.json</code> file and restart VSCode.</p>
</div>
<div class="paragraph">
<p>To run:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the Command Palette (Ctrl+Shift+P) and run <code>CMake: Select a Kit</code>. Select the compiler you want to use. For example GCC 11.3.0</p>
</li>
<li>
<p>Open the Command Palette (Ctrl+Shift+P) run the <code>CMake: Select Variant</code> command. Select <code>Release</code></p>
</li>
<li>
<p>Open the Command Palette (Ctrl+Shift+P) run the <code>CMake: Set Build Target</code>. Select <code>install</code></p>
</li>
<li>
<p>Open the Command Palette (Ctrl+Shift+P) and run the <code>CMake: Build</code> command, or select the Build button from the Status bar. (If cmake commands are not visible in status bar, check global settings: Ctrl + ,  then write "cmake status bar" to find <code>Status Bar Visibility</code> setting. Set to <code>visible</code>.)</p>
</li>
<li>
<p>To configure launch arguments, see step 3 in <a href="#_with_preset">With preset</a>.</p>
</li>
<li>
<p>Press F5</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For debug:</p>
</div>
<div class="paragraph">
<p>Repeat step 2 and select <code>Debug</code>. Repeat step 3 to 6. Breakpoints can be added to the program specified in the <code>launch.json</code>.</p>
</div>
<div class="paragraph">
<p>For more info see: <a href="https://code.visualstudio.com/docs/cpp/CMake-linux" class="bare">https://code.visualstudio.com/docs/cpp/CMake-linux</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dynamic_protobuf_linking">11.6. Dynamic protobuf linking</h3>
<div class="paragraph">
<p>When linking esmini with software already dependent on Google protobuf there might be need for dynamic linking of shared protobuf library. This can be achieved by defining cmake symbol DYN_PROTOBUF as following example:</p>
</div>
<div class="paragraph">
<p><code>cmake .. -D DYN_PROTOBUF=True</code></p>
</div>
<div class="paragraph">
<p>Then build as usual. It will link with protobuf shared library instead of linking with a static library.</p>
</div>
<div class="paragraph">
<p>When running esmini, the protobuf shared library needs to be found. Set dynamic library path environment variable to the folder where the library is. Example:</p>
</div>
<div class="paragraph">
<p>Linux:<br>
<code>export LD_LIBRARY_PATH=./externals/OSI/linux/lib-dyn</code></p>
</div>
<div class="paragraph">
<p>macOS:<br>
<code>export DYLD_LIBRARY_PATH=./externals/OSI/linux/lib-dyn</code></p>
</div>
<div class="paragraph">
<p><strong>Note:</strong><br>
The dynamic versions of protobuf were added Aug 31 2021. So you might need to update the OSI library package. Get the latest from following links:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://dl.dropboxusercontent.com/s/an58ckp2qfx5069/osi_v10.7z?dl=0">OSI Windows</a></p>
</li>
<li>
<p><a href="https://dl.dropboxusercontent.com/s/kwtdg0c1c8pawa1/osi_linux.7z?dl=0">OSI Linux</a></p>
</li>
<li>
<p><a href="https://dl.dropboxusercontent.com/s/m62v19gp0m73dte/osi_mac.7z?dl=0">OSI Mac</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_slim_esmini_customize_configration">11.7. Slim esmini - customize configration</h3>
<div class="paragraph">
<p>The external dependencies OSG, OSI, SUMO and implot are optional. Also the unit test suite is optional, in effect making the dependecy to googletest framework optional as well. All these options are simply controlled by the following cmake options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>USE_OSG</p>
</li>
<li>
<p>USE_OSI</p>
</li>
<li>
<p>USE_SUMO</p>
</li>
<li>
<p>USE_GTEST</p>
</li>
<li>
<p>USE_IMPLOT</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So, for example, to cut dependency to OSG and SUMO, run: <br>
<code>cmake .. -D USE_OSG=False -D USE_SUMO=False</code></p>
</div>
<div class="paragraph">
<p>To disable OSG, SUMO, OSI and googletest, run: <br>
<code>cmake .. -D USE_OSG=False -D USE_SUMO=False -D USE_OSI=False -D USE_GTEST=False -D USE_IMPLOT=False</code></p>
</div>
<div class="paragraph">
<p>All options are enabled/True as default.</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong><br>
Disabling an external dependency will disable corresponding functionality. So, for example, disabling OSI means that no OSI data can be created by esmini. Disabling OSG means that esmini can&#8217;t visualize the scenario. However it can still run the scenario and create a .dat file, which can be played and visualized later in another esmini build in which OSG is enabled (even on another platform).</p>
</div>
</div>
<div class="sect2">
<h3 id="_msys2_mingw_w64_support">11.8. MSYS2 / MinGW-w64 support</h3>
<div class="paragraph">
<p>esmini slim can be compiled and executed in the MSYS2 environment. Try following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Download MSYS2 from: <a href="https://www.msys2.org" class="bare">https://www.msys2.org</a></p>
</li>
<li>
<p>Install with default options</p>
</li>
<li>
<p>Start MSYS2 MinGW x64 (e.g. from start menu)</p>
</li>
<li>
<p>Update MSYS2 packages, run:<br>
<code>
pacman -Syu --disable-download-timeout --noconfirm
</code><br>
(MSYS2 should close automatically)</p>
</li>
<li>
<p>Restart MSYS2</p>
</li>
<li>
<p>Finalize update and install needed packages, run:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>pacman -Su --disable-download-timeout --noconfirm
pacman -S --needed base-devel mingw-w64-x86_64-toolchain --disable-download-timeout --noconfirm
pacman -S mingw-w64-x86_64-cmake --disable-download-timeout --noconfirm</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Optional (not needed to compile or run esmini):<br>
<code>pacman -S git --disable-download-timeout --noconfirm</code></p>
</li>
<li>
<p>Build esmini (from MSYS2 MinGW x64 command line):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cmake -G &quot;MSYS Makefiles&quot; -D USE_OSG=False -D USE_SUMO=False -D USE_OSI=False -D USE_GTEST=False ..
cmake --build . --config Release --target install</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_esmini_project">11.9. Build esmini project</h3>
<div class="paragraph">
<p>First generate build configuration (see above)</p>
</div>
<div class="paragraph">
<p>Then it should work on all platform to build using cmake as follows:<br>
<code>cmake --build . --config Release --target install</code></p>
</div>
<div class="paragraph">
<p>Or you can go with platform specific ways of building:</p>
</div>
<div class="paragraph">
<p><strong>Windows/Visual Studio</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open generated solution, build*/EnvironmentSimulator.sln</p>
</li>
<li>
<p>Select configuration, Debug or Release</p>
</li>
<li>
<p>Build CMakePredefinedTargets/INSTALL (right-click and select build)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>macOS</strong></p>
</div>
<div class="paragraph">
<p>To generate a Xcode project file, run the initial cmake command as follows:<br>
<code>cmake -G Xcode ..</code></p>
</div>
<div class="paragraph">
<p>Then build as usual:<br>
<code>cmake --build . --config Release --target install</code></p>
</div>
<div class="paragraph">
<p>or using Xcode directly:<br>
<code>xcodebuild -scheme install -configuration Release build</code></p>
</div>
<div class="paragraph">
<p>or open the generated project file in Xcode, and build from there.</p>
</div>
<div class="paragraph">
<p>To create bundles (shared library container), do from esmini root folder:<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>lipo -create bin/libesminiRMLib.dylib -output bin/esminiRMLib.bundle
lipo -create bin/libesminiLib.dylib -output bin/esminiLib.bundle</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Linux</strong></p>
</div>
<div class="paragraph">
<p>Once <code>cmake ..</code> has created the build configuration, of course you can build by calling the gnu <code>make</code> applciation directly instead of going via <code>cmake --build</code> as described above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd build
make -j4 install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will build all projects, in four parallel jobs, and copy the binaries into a dedicated folder found by the demo batch scripts.</p>
</div>
</div>
<div class="sect2">
<h3 id="_centos_7_linux">11.10. CentOS 7 (Linux)</h3>
<div class="paragraph">
<p>CentOS 7 has some limitations, e.g. old versions of C/C++ compiler toolkits and runtimes. So it&#8217;s not possible to link with provided 3rd party binary libraries targeting Ubuntu 18++.
However, by disabling some featuers in esmini, e.g. OSI and SUMO, it can still be used for previewing scenarios.</p>
</div>
<div class="paragraph">
<p>VirtualBox image for Windows host here:<br>
<a href="https://www.linuxvmimages.com/images/centos-7/" class="bare">https://www.linuxvmimages.com/images/centos-7/</a></p>
</div>
<div class="paragraph">
<p>Follow steps below to build and run esmini on CentOS 7.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>sudo yum install git
sudo yum install cmake
sudo yum install gcc-c++

sudo yum install freeglut-devel
sudo yum install fontconfig-devel
sudo yum install libXrandr-devel
sudo yum install libXinerama-devel

sudo yum install epel-release
sudo yum install p7zip

git clone https://github.com/esmini/esmini

cd esmini

cd externals
mkdir OpenSceneGraph
cd OpenSceneGraph
curl -L &quot;https://www.dropbox.com/s/mxztf6zbgojyntp/osg_centos.7z?dl=1&quot; -o osg_centos.7z
7za x osg_centos.7z
rm osg_centos.7z

cd ../..
mkdir build
cd build
cmake -D USE_OSG=True -D USE_SUMO=False -D USE_OSI=False -D USE_GTEST=False ..
cmake --build . --target install --config Release
cd ..
./bin/esmini.exe --headless --fixed_timestep 0.01 --record sim.dat --osc ./resources/xosc/cut-in.xosc</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_for_esmini_developers_and_contributors">12. For esmini developers and contributors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Brief info on how to contribute is found here: <a href="https://github.com/esmini/esmini/blob/master/CONTRIBUTING.md" class="bare">https://github.com/esmini/esmini/blob/master/CONTRIBUTING.md</a></p>
</div>
<div class="paragraph">
<p>Complementing the <a href="#_build_guide">Build guide</a> this section contains additional information regarding branch strategy, formatting and test.</p>
</div>
<div class="sect2">
<h3 id="_branch_strategy">12.1. Branch strategy</h3>
<div class="paragraph">
<p>From v2.30.0 the <a href="https://github.com/esmini/esmini/tree/dev"><code>dev</code></a> branch was introduced as the new top branch for continuous integration of features and bug fixes.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/branch-strategy.jpg" alt="branch strategy">
</div>
</div>
<div class="paragraph">
<p><code>dev</code> branch contains the latest integrated features and bug fixes. New features should be developed in branches created from <code>dev</code>. <a href="https://github.com/esmini/esmini/tree/master"><code>master</code></a> is the default branch and primarily reserved for official releases.</p>
</div>
<div class="paragraph">
<p>Continuous integration job will be launched for pushed commits on the following branches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>master</code></p>
</li>
<li>
<p><code>dev</code></p>
</li>
<li>
<p>any other branch starting with <code>feature/</code>, e.g. <code>feature/support_emergency_vehicles</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pull requests should be targeting the <code>dev</code> branch.</p>
</div>
<div class="paragraph">
<p>Master branch represent the latest released software. It should be in synch with dev.</p>
</div>
<div class="sect3">
<h4 id="_branch_out_of_synch">12.1.1. Branch out of synch</h4>
<div class="paragraph">
<p><code>dev</code> and <code>master</code> branches should be in perfect sync, i.e. based on common history. Unfortunately, to keep this true and to avoid messy history and lost tags, branch history might be changed in rare cases. That can lead to local branch clones out of synch. If that is the case, follow these steps to restore sync of your local branch:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>git branch backup</code>  (only needed if you have local commits you want to preserve for later cherry-picking)</p>
</li>
<li>
<p><code>git fetch origin</code></p>
</li>
<li>
<p><code>git reset --hard origin/&lt;branch name&gt;</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>&lt;branch name&gt;</code> might be <code>master</code> or <code>dev</code>, or whatever branch to be restored.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_formatting">12.2. Formatting</h3>
<div class="paragraph">
<p>From esmini v2.30.0 the CI will include formatting checks, in addition to static analysis and tests. The code styles are defined by following schemes:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>C++</strong> 
</td>
<td class="hdlist2">
<p><a href="https://github.com/esmini/esmini/blob/master/.clang-format">.clang-format</a></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Python</strong> 
</td>
<td class="hdlist2">
<p><a href="https://github.com/esmini/esmini/blob/master/.black-format">.black-format</a></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>cmake</strong> 
</td>
<td class="hdlist2">
<p><a href="https://github.com/esmini/esmini/blob/master/.cmake-format">.cmake-format</a></p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To run formatting (both check and apply) locally, follow steps below:</p>
</div>
<div class="sect3">
<h4 id="_dependencies">Dependencies</h4>
<div class="sect4">
<h5 id="_clang_format">clang-format</h5>
<div class="paragraph">
<p>esmini makes use of version 15, avoiding some known bugs in v14<br></p>
</div>
<div class="paragraph">
<p>Windows:<br>
Download and install LLVM-15.0.7-win64.exe found here:<br>
<a href="https://github.com/llvm/llvm-project/releases/tag/llvmorg-15.0.7" class="bare">https://github.com/llvm/llvm-project/releases/tag/llvmorg-15.0.7</a></p>
</div>
<div class="paragraph">
<p>Linux:<br></p>
</div>
<div class="paragraph">
<p>Check if clang-format version 15 is installed:</p>
</div>
<div class="paragraph">
<p><code>clang-format-15</code></p>
</div>
<div class="paragraph">
<p>If you get the following message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Command 'clang-format-15' not found, but can be installed with:
sudo apt install clang-format-15</code></pre>
</div>
</div>
<div class="paragraph">
<p>then clang 15 must be installed.</p>
</div>
<div class="paragraph">
<p>On Ubuntu systems prior to 22.04, first install llvm version 15:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>wget https://apt.llvm.org/llvm.sh
chmod +x llvm.sh
sudo ./llvm.sh 15</code></pre>
</div>
</div>
<div class="paragraph">
<p>Source: <a href="https://apt.llvm.org">apt.llvm.org</a></p>
</div>
<div class="paragraph">
<p>Then, clang v15 can be installed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>sudo apt install clang-format-15</code></pre>
</div>
</div>
<div class="paragraph">
<p>see also: <a href="https://github.com/esmini/esmini/blob/dev/.github/workflows/ci.yml#L26">ci.yml</a></p>
</div>
</div>
<div class="sect4">
<h5 id="_install_dependent_python_packages">Install dependent Python packages</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt">pip install -r ./support/python/requirements.txt</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_check_format">Check format</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt">./support/python/src/main.py run format --clang_format_checker
./support/python/src/main.py run format --cmake_format_checker
./support/python/src/main.py run format --black_format_checker</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_apply_formatting">12.2.1. Apply formatting</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt">./support/python/src/main.py run format</code></pre>
</div>
</div>
<div class="paragraph">
<p>or specifics:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="txt">./support/python/src/main.py run format --clang_format
./support/python/src/main.py run format --cmake_format
./support/python/src/main.py run format --black_format</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test">12.3. Test</h3>
<div class="sect3">
<h4 id="_test_frameworks">12.3.1. Test frameworks</h4>
<div class="paragraph">
<p>There are two sets of tests on different frameworks:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Unit tests (white box)</p>
</li>
<li>
<p>Smoke tests (black box)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The unit tests suites are basically C++ code modules of test cases based on the <a href="https://github.com/google/googletest">Google Test</a> framework. They range from true unit tests (testing individual classes or functions) to system level tests reading a scenario and inspecting output, e.g. log files or visualization pixel data. The key feature of the unit tests is the possibility to inspect internal objects and variables.</p>
</div>
<div class="paragraph">
<p>Example: <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Unittest/RoadManager_test.cpp">Unittest/RoadManager_test.cpp</a></p>
</div>
<div class="paragraph">
<p>The smoke test suite is basically execution of a selection of scenarios with some strategic inspections of the result. Scenario elements and timing can be checked against log file while object info such as position, rotation and speed can be checked against dat file entries. A Python framework handles the execution and gathering of result for convenient checking.</p>
</div>
<div class="paragraph">
<p>The smoke test script is found here: <a href="https://github.com/esmini/esmini/blob/master/test/smoke_test.py">test/smoke_test.py</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_run_tests">12.3.2. Run tests</h4>
<div class="paragraph">
<p>For easy execution of all tests, both unit tests and smoke tests, run this main test script: <a href="https://github.com/esmini/esmini/blob/master/scripts/run_tests.sh">scripts/run_tests.sh</a>, from esmini root folder:</p>
</div>
<div class="paragraph">
<p><code>./scripts/run_tests.sh</code></p>
</div>
<div class="paragraph">
<p>Tip: On Windows, run it from GIT bash.</p>
</div>
</div>
<div class="sect3">
<h4 id="_run_xml_schema_validation_tests">12.3.3. Run XML schema validation tests</h4>
<div class="paragraph">
<p>XML schema validation ensures scenario files (xosc and xodr) complies with the OpenSCENARIO and OpenDrive XSD schemas. The checks are done by the Python script <code>run_schema_comply.py</code> located in the <code>scripts</code> directory. The schema files are located in the <code>resources/schema</code> directory. From release v2.40, all esmini scenario files are validated against the schemas as part of CI.</p>
</div>
<div class="paragraph">
<p>The script depends on the <code>xmlschema</code> and <code>lxml</code> Python packages. To install required packages, run:</p>
</div>
<div class="paragraph">
<p><code>pip install -r support/python/requirements.txt</code></p>
</div>
<div class="paragraph">
<p>Run the XML validation tests:</p>
</div>
<div class="paragraph">
<p><code>python3 ./scripts/run_schema_comply.py &lt;path1&gt; [path2] [path3] &#8230;&#8203;</code></p>
</div>
<div class="paragraph">
<p>where path can be an XML file or a directory. Any directory subfolders will be included recursively.</p>
</div>
<div class="paragraph">
<p>Example 1, check single file:</p>
</div>
<div class="paragraph">
<p><code>python3 scripts/run_schema_comply.py resources/xosc/cut-in.xosc</code></p>
</div>
<div class="paragraph">
<p>Example 2, check two files:</p>
</div>
<div class="paragraph">
<p><code>python3 scripts/run_schema_comply.py resources/xosc/cut-in.xosc resources/xodr/two_plus_one.xodr</code></p>
</div>
<div class="paragraph">
<p>Example 3, check two directories:</p>
</div>
<div class="paragraph">
<p><code>python3 scripts/run_schema_comply.py resources EnvironmentSimulator</code></p>
</div>
<div class="paragraph">
<p>Example 4, check one file and one directory:</p>
</div>
<div class="paragraph">
<p><code>python3 scripts/run_schema_comply.py EnvironmentSimulator/Unittest/xosc/conflicting-domains.xosc resources</code></p>
</div>
<div class="paragraph">
<p>Tip: Use bash <code>find</code> command to apply finer filtering. Example:</p>
</div>
<div class="paragraph">
<p><code>python3 scripts/run_schema_comply.py $(find ./resources ./EnvironmentSimulator -name "follow_route*.xosc" -or -name "*500*.xodr" -or -name "*signs.xodr")</code></p>
</div>
<div class="paragraph">
<p>validates all OpenSCENARIO files starting with "follow_route" and all OpenDRIVE files containing "500" or ending basename with "signs" or containing "500", in and under the <code>resource</code> and <code>EnvironmentSimulator</code> folders.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sanitizers">12.4. Sanitizers</h3>
<div class="paragraph">
<p>Google sanitizers framework is utilized to detect memory related errors, for example memory leaks. It&#8217;s executed nighly as a GitHub CI actions job on dev branch. The job can also be trigged manually, but will only run checks on dev branch. Sanitizers is currently only applied to Linux builds.</p>
</div>
<div class="paragraph">
<p>You can also run the sanitizer checks locally (on any branch, even uncommitted code) on Ubuntu:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set the following environment variables, run from esmini root:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">export LSAN_OPTIONS=&quot;print_suppressions=false:suppressions=$(pwd)/scripts/LSAN.supp&quot;
export ASAN_OPTIONS=&quot;detect_invalid_pointer_pairs=1:strict_string_checks=1:detect_stack_use_after_return=1:check_initialization_order=1:strict_init_order=1:fast_unwind_on_malloc=0:suppressions=$(pwd)/scripts/ASAN.supp&quot;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Configure and build esmini with sanitizers enabled</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">cd build
cmake -G Ninja -DUSE_OSG=FALSE -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_SANITIZERS=TRUE ..
ninja install
cd ..</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Run the test suites, including both unit- and smoke tests, from esmini root:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">./scripts/run_tests.sh</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_troubleshooting">12.4.1. Troubleshooting</h4>
<div class="paragraph">
<p>On Ubuntu some combination of gcc and sanitizer randomly cause sanitizer run failure with error message: AddressSanitizer:DEADLYSIGNAL.</p>
</div>
<div class="paragraph">
<p>If this happens, try the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">setarch $(uname -m) -R
bash</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>setarch</code> will affect reported architecture from system to sanitizer. <code>bash</code> is to restore shell environment, it can of course be replaced by any shell program, e.g. tcsh.</p>
</div>
<div class="paragraph">
<p>To revert settings, simply run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">exit
exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>First exit will escape the latter bash environment, the second reverts effect of the setarch command.</p>
</div>
<div class="paragraph">
<p>Source of setarch tip: <a href="https://stackoverflow.com/questions/77894856/possible-bug-in-gcc-sanitizers" class="bare">https://stackoverflow.com/questions/77894856/possible-bug-in-gcc-sanitizers</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_esmini_lib_programming">13. esmini lib programming</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_about_the_lib_itself">13.1. About the lib itself</h3>
<div class="paragraph">
<p>The main idea with esmini lib is to provide a limited, simplifed but useful API to the complex world of esmini, OpenSCENARIO and traffic simulation. By making use of only standard C types it has been possible to wrap and use the library in numerous environments, like for example MATLAB, Simulink and Unity (C#).</p>
</div>
<div class="paragraph">
<p>esmini lib is a, so called, shared library which is linked dynamically with a custom application. This means that it&#8217;s not linked statically with the application, instead it&#8217;s loaded whenever the application is launched. An obvious advantage with shared libraries is that they can be shared between multiple applications, reducing size and potentially simplify maintenance.</p>
</div>
<div class="paragraph">
<p>An additional important advantage with dynamic linking is that the library can be updated without need to recompile the custom application making use of the library (however it can&#8217;t be updated during runtime, only in between launches). An obvious requirement is that the API is compatible when replacing a library with a different version, since the API is established at link-time. On the other side of the "same coin", a disadvantage with dynamic linking is that you need to have the shared library present at run-time.</p>
</div>
<div class="paragraph">
<p>Although esmini lib is a shared library itself, it includes everything needed in terms of 3rd party functionality. It&#8217;s actally linking all dependencies statically. Think about it as a single container including everything needed, e.g. support for 3D graphics, XML, expressions, and SUMO traffic simulation. There are two advantages with this approach: 1. Getting rid of dependency to hundreds of 3rd party shared libraries and 2. The linker makes sure to only include relevant functions which reduce the size by extreme (compared to bundle individual and complete shared libraries).</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Note:</strong> esmini utilizes, in accordance with C++ standard, default values on some function parameters in the API. Those default values will work at least in any C++ context. For other environments like pure C, C# or Python it might be required to explicitly supply argument values.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_interact_with_esmini_lib_api">13.2. How to interact with esmini lib API</h3>
<div class="paragraph">
<p>Below is a typical interaction between a custom application (e.g. vehicle simulator) and esmini (providing simulation of the environment, like road and traffic).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 7.1428%;">
<col style="width: 35.7142%;">
<col style="width: 7.1428%;">
<col style="width: 35.7145%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Frame</th>
<th class="tableblock halign-left valign-top">app time</th>
<th class="tableblock halign-left valign-top">app events</th>
<th class="tableblock halign-left valign-top">esmini time</th>
<th class="tableblock halign-left valign-top">esmini events</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 (t=0.0)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Init esmini("scenario.xosc") &#8658;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step(dt=0.0)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>check conditions</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>update actions</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>step default controller (establish initial positions and speed)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>save to dat, send OSI</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Draw()</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get Ego state (initial position, speed&#8230;&#8203;) &#8658;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8656; Return Ego initial state</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 (t=0.0&#8594;0.1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update Ego(dt=0.1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Do internal stuff, like vehicle dynamics</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Report Ego state(state) &#8658;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register state of Ego, protect it from default controller (but do not apply state yet)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step esmini(dt=0.1) &#8658;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step(dt=0.1)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>check conditions</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>update actions</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>step default controller (move entities, except Ego)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>update simulation time</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>apply states from external entities (Ego)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>save to dat, send OSI</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Draw()</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 (t=0.1&#8594;0.2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update Ego(dt=0.1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Do internal stuff, like vehicle dynamics</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Report Ego state(state) &#8658;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register state of Ego, protect it from default controller (but do not apply state yet)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step esmini(dt=0.1) &#8658;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step(dt=0.1)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>check conditions</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>update actions</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>step default controller (move entities, except Ego)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>update simulation time</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>apply states from external entities (Ego)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>save to dat, send OSI</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Draw()</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">and so on&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_functionality">13.3. Functionality</h3>
<div class="paragraph">
<p>No systematic documentation available. See header files <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp">esminiLib.hpp</a> and <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Libraries/esminiRMLib/esminiRMLib.hpp">esminiRMLib.hpp</a> for API details.</p>
</div>
<div class="paragraph">
<p>The following section covers some specific use cases of the library.</p>
</div>
<div class="sect3">
<h4 id="_save_or_grab_images">13.3.1. Save or grab images</h4>
<div class="paragraph">
<p>Screenshots can be controlled via the API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">int</span> SE_SaveImagesToFile(<span class="predefined-type">int</span> nrOfFrames);</code></pre>
</div>
</div>
<div class="paragraph">
<p>nrOfFrames: -1 &#8658; continuously, 0 &#8658; stop, &gt; 0 &#8658; number of frames, e.g. 1=next frame only, 2=next two frames</p>
</div>
<div class="paragraph">
<p>Images will be stored in current folder with name <code>screen_shot_*.tga</code> (* = counter) for post processing.</p>
</div>
<div class="paragraph">
<p>Images can also be saved to memory for instant processing. Control the feature with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">int</span> SE_SaveImagesToRAM(<span class="predefined-type">bool</span> state);</code></pre>
</div>
</div>
<div class="paragraph">
<p>state: true &#8658; capture images, false &#8658; don&#8217;t capture (default, might improve performance on some systems)</p>
</div>
<div class="paragraph">
<p>Grab image with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">int</span> SE_FetchImage(SE_Image *image);</code></pre>
</div>
</div>
<div class="paragraph">
<p>image is a reference to a SE_Image struct which will contain the image meta and image data</p>
</div>
<div class="paragraph">
<p>See <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/image-capture">image-capture</a> code example.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Note:</strong> In order to grab a rendered frame image, it must have been saved to RAM during the post rendering phase. First frame will be saved to RAM by default. The SE_SaveImagesToRAM() function must be used to enable the feature for frames &gt; 0.</p>
</div>
<div class="paragraph">
<p>The reason for not enable always by default is performance savings. On some system the operation to read back rendered pixels from graphics frame buffer to application RAM memory is not neglectable (depending on whether color coding or byte order transformation is needed). So a compromize is to have the feature enabled for the first init frame, and then activate by user when needed.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Finally, to disable esmini image handling altogether and revert to OSG default handling, make the following call before SE_Init():</p>
</div>
<div class="paragraph">
<p><code>SE_SetOffScreenRendering(false);</code></p>
</div>
<div class="paragraph">
<p>Note that disabling the this will permanently disable the callback mechanism for the complete esmini session (overriding any SE_SaveImagesToRAM() call).</p>
</div>
</div>
<div class="sect3">
<h4 id="_custom_camera_positions">13.3.2. Custom camera positions</h4>
<div class="paragraph">
<p>Similarly as with camera related launch arguments, <a href="#_camera_control">camera positioning</a> can be controlled via esmini lib API.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SE_AddCustomCamera()</code><br>
Add a camera with relative position and orientation (heading and pitch)</p>
</li>
<li>
<p><code>SE_AddCustomFixedCamera()</code><br>
Add a fixed camera at custom global position and orientation (heading and pitch)</p>
</li>
<li>
<p><code>SE_AddCustomAimingCamera()</code><br>
Add a camera with relative position looking at current entity</p>
</li>
<li>
<p><code>SE_AddCustomFixedAimingCamera()</code><br>
Add a camera at fixed location but always looking at current entity</p>
</li>
<li>
<p><code>SE_AddCustomFixedTopCamera()</code><br>
Add a top view camera with fixed position and rotation</p>
</li>
<li>
<p><code>SE_SetCameraObjectFocus</code><br>
Set/change object to focus on</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More info, see <a href="https://github.com/esmini/esmini/blob/91c82fb78deb4355f736f87510069f52cc0e6be5/EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp#L1519C1-L1582C59">headerfile</a>.</p>
</div>
<div class="paragraph">
<p>Any number of cameras can be defined. These cameras can then be activated via function: <code>SE_SetCameraMode()</code>.</p>
</div>
<div class="paragraph">
<p>Applications can even loop through the camera modes to produce images from several cameras. See code example <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/code-examples/image-capture/multiple-cameras.cpp">multiple-cameras.cpp</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_osi_data">13.3.3. OSI data</h4>
<div class="paragraph">
<p>OSI data can be retrieved in three ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Storing OSI tracefile</p>
</li>
<li>
<p>Receive in UDP packages</p>
</li>
<li>
<p>Receive via API call</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_osi_tracefile">OSI tracefile</h5>
<div class="paragraph">
<p>Call <code>SE_EnableOSIFile(filename)</code> in order to create a OSI tracefile. Specify custom filename or set 0 or "" to use default filename (currently "ground_truth.osi").</p>
</div>
</div>
<div class="sect4">
<h5 id="_osi_via_udp">OSI via UDP</h5>
<div class="paragraph">
<p>By launch argument <code>--osi_receiver_ip &lt;ip addr&gt;</code> you can have esmini sending OSI packeges in UDP frames. The socket port is hardcoded but can of course be changed in the code (OSI_OUT_PORT in <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/Modules/ScenarioEngine/SourceFiles/OSIReporter.cpp)">OSIReporter.cpp</a>).</p>
</div>
<div class="paragraph">
<p>See receiver side code example <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/Applications/replayer/osi_receiver.cpp">osi_receiver.cpp</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_osi_data_via_api_call">OSI data via API call</h5>
<div class="paragraph">
<p>Fetch OSI data by either one of the API calls:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SE_GetOSIGroundTruthRaw()</code></p>
</li>
<li>
<p><code>SE_GetOSIGroundTruth(int* size)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The "raw" version will simply return a pointer to the already existing OSI data structure. No additional data copying will be performed. This is the preferered option if:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The application is coded in C++, making the Protobuf data structures fully compatible</p>
</li>
<li>
<p>The data is read before next call to <code>SE_UpdateOSIGroundTruth(bool refetchStaticGt)</code>, which will update the data</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>See code example: <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/code-examples/osi-groundtrut">osi-groundtruth</a>, also covered in User guide - Hello world tutorial <a href="https://esmini.github.io/#_osi_groundtruth">OSI groundtruth</a>.</p>
</div>
<div class="paragraph">
<p>The second function will fetch the OSI data serialized into a string. This will be a true copy and also generic format which can be parsed in any environment, independent of OS and programming language. The backside is additional resources needed for the copying and serialization.</p>
</div>
<div class="paragraph">
<p>See code examples in ScenarioEngineDLL test cases, e.g: <a href="https://github.com/esmini/esmini/blob/7d1249dc65883cb9eebb4a611ea401434b2b0e49/EnvironmentSimulator/Unittest/ScenarioEngineDll_test.cpp#L741-L786">receive_GroundTruth</a>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Note:</strong></p>
</div>
<div class="paragraph">
<p><code>SE_UpdateOSIGroundTruth(bool refetchStaticGt)</code> needs to be called after each <code>SE_Step*</code> in order to prepare and populate OSI data. This function will also save the OSI frame to file and send over UDP, if requested. Only after this preparation the <code>SE_GetOSIGroundTruth*</code> functions will get updated OSI data.</p>
</div>
<div class="paragraph">
<p>An exception is when OSI file or UDP receiver is specified by corresponding launch arguments <code>--osi_file [filename]</code> and <code>--osi_receiver_ip &lt;ip addr&gt;</code>. Then, OSI groundtruth will automatically be updated by esmini according to specified multiplier <code>--osi_freq &lt;number&gt;</code>. For example, <code>--osi_freq 3</code> will update OSI every third step.</p>
</div>
<div class="paragraph">
<p>The purpose of this explicit OSI update control is to support use cases where esmini is running at much higher frequency than needed for OSI data (e.g. for vehicle dynamics purposes). To optimize performance, OSI update can then be skipped most frames and only run when needed.</p>
</div>
<div class="paragraph">
<p>The bool argument <code>refetchStaticGt</code> affects the data received from the next <code>SE_GetOSIGroundTruth*</code> functions as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SE_UpdateOSIGroundTruth(false)</code>: OSI groundtruth will not contain static data, except the first frame (after <code>SE_Init()</code> and before first call to <code>SE_Step*</code>) which always does.</p>
</li>
<li>
<p><code>SE_UpdateOSIGroundTruth(true)</code>: OSI groundtruth will contain static data.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>refetchStaticGt = false</code> is default and should be good for most use cases.</p>
</div>
<div class="paragraph">
<p>OSI log file is not affected by the <code>refetchStaticGt</code> flag. It will always contain static data and only in first frame.</p>
</div>
<div class="paragraph">
<p>Also, just for information: If OSI frequency option is set, the SE_Step* function will internally update OSI in accordance with <code>SE_UpdateOSIGroundTruth(false)</code>, as described above. For example, setting osi_freq to 1, will update OSI each frame. Hence, there is no need to call <code>SE_UpdateOSIGroundTruth*</code>, unless static data is desired.</p>
</div>
<div class="paragraph">
<p>BTW: Any additional explicit calls to <code>SE_UpdateOSIGroundTruth*</code> in the same frame will be ignored. Which means that the programmer does not have to worry about additional performance penalty introduced by multiple calls to this function.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_program_options">13.3.4. Program Options</h4>
<div class="paragraph">
<p>On top of setting options from command line, esmini (from v2.41.0) supports setting options from esminiLib and esminiRMLib as well. This new functionality is added to set and unset options during runtime. This is useful, for example, to enable or disable logging to console, or to change log level etc between scenario runs via API. In addition, it is now possible to make option settings persistent over multiple runs of scenarios. There are two variants of the API functions i.e. one to set option value with persistence and one without. The API functions are:</p>
</div>
<div class="paragraph">
<p>SE_DLL_API int SE_SetOption(const char *name);</p>
</div>
<div class="paragraph">
<p>SE_DLL_API int SE_SetOptionPersistent(const char *name);</p>
</div>
<div class="paragraph">
<p>SE_DLL_API int SE_SetOptionValue(const char *name, const char *value);</p>
</div>
<div class="paragraph">
<p>SE_DLL_API int SE_SetOptionValuePersistent(const char *name, const char *value);</p>
</div>
<div class="paragraph">
<p>SE_DLL_API int SE_UnsetOption(const char *name);</p>
</div>
<div class="paragraph">
<p>SE_DLL_API const char *SE_GetOptionValue(const char *name);</p>
</div>
<div class="paragraph">
<p>Any setting done in between runs, i.e. after any SE_Close() and before SE_Init(), will apply to the next run, at least. The persistent variant will apply for all future runs until unset or other setting overrides it. The effect of settings done during a scenario run will depend on the option itself. For example, anti-aliasing mode for the rendering will not change during a scenario, while logfile path can change during a scenario run (which will close current and open a new file with specified path and name). So, to be sure, set options before SE_Init() and after any SE_Close().</p>
</div>
</div>
<div class="sect3">
<h4 id="_simple_ideal_sensors">13.3.5. Simple ideal sensors</h4>
<div class="paragraph">
<p>OSI provides information needed for sensor models at bounding box level for both moving and stationary objects, including ones defined in OpenDRIVE. Sensor models can then detect overlap, occlusion and collisions between those bounding boxes. Although sensor models are not within scope of esmini, there is a code example on how to retrieve and extract OSI data. It can perhaps be a starting point: <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/code-examples/osi-groundtruth/osi-groundtruth.cpp">osi-groundtruth.cpp</a></p>
</div>
<div class="paragraph">
<p>For even simpler use cases esmini provides a sensor mechanism, basically collecting scenario objects which reference point is within a sensor view frustum. This is too rough for collision detection, but can be useful for low-pass features like adaptive cruse control (ACC) or just optimizing CPU load by filtering objects for some processing.</p>
</div>
<div class="paragraph">
<p>The view frustum is defined by a horizontal <code>field of view</code> combined with <code>near</code> and <code>far</code> limits. Basically an object is detected by a ideal sensor if the object reference point is within the view frustum, i.e:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>angle from sensor mounting point is within the <code>field of view</code></p>
</li>
<li>
<p>distance from sensor mounting point is larger than <code>near</code> and less than <code>far</code></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/ideal_sensors.jpg" alt="ideal sensors">
</div>
<div class="title">A few ideal sensors mounted at various positions and orientations</div>
</div>
<div class="paragraph">
<p>The sensors are added from the code, see the <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/Applications/esmini-dyn">esmini-dyn</a> code example. API is found <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp#L1082-L1095">here</a>.</p>
</div>
<div class="paragraph">
<p>Limitations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OpenDRIVE stationary objects not considered</p>
</li>
<li>
<p>Only reference point checking (part of the object can be inside frustum and still not detected)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_logging_2">13.3.6. Logging</h4>
<div class="paragraph">
<p>By default, both file and console logging are enabled. Default log filename is <code>log.txt</code>. Default location is current folder, normally the folder from which the application was started.</p>
</div>
<div class="paragraph">
<p>All this can be controlled and modified through the API. Full details see log related functions in <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp">esminiLib.hpp</a>. Following is a brief overview:</p>
</div>
<div class="sect4">
<h5 id="_enable_or_disable_logging_to_console">Enable or disable logging to console</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> SE_LogToConsole(<span class="predefined-type">bool</span> mode);</code></pre>
</div>
</div>
<div class="paragraph">
<p>An additional way to control console logging is to set or unset the launch option <code>--disable_stdout</code> using the API functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">int</span> SE_SetOption(<span class="directive">const</span> <span class="predefined-type">char</span> *name);
<span class="predefined-type">int</span> SE_UnsetOption(<span class="directive">const</span> <span class="predefined-type">char</span> *name);</code></pre>
</div>
</div>
<div class="paragraph">
<p>with <code>--disable_stdout</code> as argument.</p>
</div>
</div>
<div class="sect4">
<h5 id="_change_log_filename_andor_location">Change log filename and/or location</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> SE_SetLogFilePath(<span class="directive">const</span> <span class="predefined-type">char</span> *logFilePath);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Full path (relative or absolute) can be provided, e.g. <code>"../myresult/scenario_2.txt"</code>.</p>
</li>
<li>
<p>If only directory provided, default filename will be used.</p>
</li>
<li>
<p>If only filename provided, default location will be used.</p>
</li>
<li>
<p>if empty string <code>""</code> is provided, log file will not be created.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It should be called before SE_Init(). If called during the run of a scenario, the current log file will be closed and a new with the specified name and/or location will be created, unless <code>--log_append</code> option has been set.</p>
</div>
</div>
<div class="sect4">
<h5 id="_log_single_message">Log single message</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">void</span> SE_LogMessage(<span class="directive">const</span> <span class="predefined-type">char</span> *message);</code></pre>
</div>
</div>
<div class="paragraph">
<p>the provided string will be posted to console and file according to settings.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_simplest_example">13.4. Simplest example</h3>
<div class="paragraph">
<p>Below example is just to show the simplicity of using esmini library. For more information and realistic examples, e.g. involving cmake, please go ahead to <a href="#_hello_world_programming_tutorial">Hello World programming tutorial</a>.</p>
</div>
<div class="paragraph">
<p>If not already done, download and unpack <a href="https://github.com/esmini/esmini/releases/latest">latest esmini demo</a>. Make sure to pick demo, not bin, for your platform.</p>
</div>
<div class="paragraph">
<p>In esmini root folder, create a file named <code>main.cpp</code> and add the following lines:</p>
</div>
<div class="paragraph">
<p><strong>Code:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;./EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp&quot;</span>

<span class="predefined-type">int</span> main()
{
    SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">./resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);

    <span class="keyword">while</span> (SE_GetQuitFlag() == <span class="integer">0</span>)
        SE_Step();

    SE_Close();
    <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Compile:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux:<br>
<code>gcc main.cpp ./bin/libesminiLib.so -Wl,-rpath,\$ORIGIN -o bin/my_player</code></p>
</li>
<li>
<p>Windows (x64 Native Tools Command Prompt for Visual Studio):<br>
<code>cl main.cpp ./bin/esminiLib.lib /Fe:bin/my_player</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Run:</strong></p>
</div>
<div class="paragraph">
<p>from Linux terminal or Windows PowerShell:<br>
<code>./bin/my_player</code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hello_world_programming_tutorial">14. Hello World programming tutorial</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial shows how to utilize esmini as a shared (dynamically loaded) library for use in a custom application. It can be used with or without esmini embedded viewer.</p>
</div>
<div class="sect2">
<h3 id="preparations">14.1. Preparations</h3>
<div class="paragraph">
<p>The simplest preparation is to get the demo package from <a href="https://github.com/esmini/esmini/releases/latest">the latest relase</a> and then head on to the steps below.</p>
</div>
<div class="paragraph">
<p>But, of course, if you already have checked out the esmini project from GitHub and compiled it you should already be set.</p>
</div>
<div class="paragraph">
<p>Just make sure that the shared library is available in the <code>bin</code> or <code>lib</code> folder, which should be available directly under esmini root. Exact filename depends on the platform as follows:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>Windows:</strong>
</td>
<td class="hdlist2">
<p>esminiLib.dll</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Linux:</strong>
</td>
<td class="hdlist2">
<p>libesminiLib.so</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Mac:</strong>
</td>
<td class="hdlist2">
<p>libesminiLib.dylib</p>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_build_run_and_debug_hello_world">14.2. How to build, run and debug "Hello World"</h3>
<div class="sect3">
<h4 id="_windowsvisual_studio">14.2.1. Windows/Visual Studio</h4>
<div class="sect4">
<h5 id="_first_step_create_the_solution_file">First step: Create the solution file</h5>
<div class="paragraph">
<p>Run from <code>Hello-World_coding-example</code> root folder:<br>
<code>mkdir build</code><br>
<code>cd build</code><br>
<code>cmake ..</code> (will generate solution for multiple variants, including Release and Debug)</p>
</div>
</div>
<div class="sect4">
<h5 id="_build_and_run_the_application_from_command_line">Build and run the application from command line</h5>
<div class="sect5">
<h6 id="_build_2">Build</h6>
<div class="paragraph">
<p><code>cmake --build . --config Release</code> (release variant), or<br>
<code>cmake --build . --config Debug</code> (debug variant)<br></p>
</div>
</div>
<div class="sect5">
<h6 id="_run">Run</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>open a command shell and put yourself in <code>Hello-World_coding-example/build</code> folder</p>
</li>
<li>
<p>add shared library location to the environment path variable, e.g:<br>
CMD: <code>set path=../../bin;%path%</code><br>
PowerShell: <code>$env:path+=";../../bin"</code><br>
bash: <code>PATH=$PATH:../../bin</code><br></p>
</li>
<li>
<p>Launch application<br>
 CMD:<br>
<code>.\Debug\esmini-player.exe</code> or<br>
<code>.\Release\esmini-player.exe</code> (depending on variant)<br>
PowerShell or bash:<br>
<code>./Debug/esmini-player.exe</code> or<br>
<code>./Release/esmini-player.exe</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_build_run_and_debug_the_application_from_visual_studio">Build, run and debug the application from Visual Studio</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open <code>esmini-player.sln</code> in Visual Studio</p>
</li>
<li>
<p>Build as usual (Ctrl-F7 or <code>Build</code> &#8594; <code>Build Solution</code>)</p>
</li>
<li>
<p>Set as startup project</p>
<div class="ulist">
<ul>
<li>
<p>Right click on esmini-player in Solution Explorer</p>
</li>
<li>
<p>Click on <code>Set as Startup Project</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Tell the system where to find the shared library</p>
<div class="ulist">
<ul>
<li>
<p>Right click on esmini-player in Solution Explorer</p>
</li>
<li>
<p>Click on <code>Properties</code></p>
</li>
<li>
<p>Select Configuration &#8594; <code>All Configurations</code></p>
</li>
<li>
<p>In <code>Configuration Properties</code> &#8594; <code>Debugging</code> &#8594; <code>Environment</code> write:
<code>path=$(ProjectDir)/../../bin</code><br>
or any other folder containing the esmini library</p>
</li>
</ul>
</div>
</li>
<li>
<p>Run</p>
<div class="ulist">
<ul>
<li>
<p><code>Ctrl-F5</code> to run without debug</p>
</li>
<li>
<p><code>F5</code> to debug</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_linux">14.2.2. Linux</h4>
<div class="sect4">
<h5 id="_first_step_create_the_makefile">First step: Create the Makefile</h5>
<div class="paragraph">
<p>Run from <code>Hello-World_coding-example</code> root folder:<br>
  <code>mkdir build</code><br>
  <code>cd build</code><br>
then:<br>
  <code>cmake .. -DCMAKE_BUILD_TYPE=Release</code> for Release variant, or<br>
  <code>cmake .. -DCMAKE_BUILD_TYPE=Debug</code> for Debug variant<br></p>
</div>
</div>
<div class="sect4">
<h5 id="_build_and_run_from_command_line">Build and run from command line</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build<br>
<code>cmake --build .</code> or just<br>
<code>make</code><br></p>
</li>
<li>
<p>Tell system where to look for esmini shared library (maybe not necessary)<br>
<code>export LD_LIBRARY_PATH=../../bin</code>  (on macOS: DYLD_LIBRARY_PATH)</p>
</li>
<li>
<p>Launch application<br>
<code>./esmini-player</code></p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_build_run_and_debug_from_visual_studio_code">Build, run and debug from Visual Studio Code</h5>
<div class="paragraph">
<p>Prerequisites: Install the following VS Code extensions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>C/C++</p>
</li>
<li>
<p>CMake Tools</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="_build_3">Build</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open visual studio as Hello-World_coding-example as root folder</p>
</li>
<li>
<p>Open the Command Palette (Ctrl+Shift+P) and run <code>CMake: Select a Kit</code>. Select the compiler you want to use. For example GCC 11.3.0</p>
</li>
<li>
<p>Open the Command Palette (Ctrl+Shift+P) run the <code>CMake: Select Variant</code> command. Select Debug.</p>
</li>
<li>
<p>Open the Command Palette (Ctrl+Shift+P) run the <code>CMake:Set Build Target</code>. Select esmini-player.</p>
</li>
<li>
<p>Open the Command Palette (Ctrl+Shift+P) and run the <code>CMake: Build</code> command, or select the build button from the Status bar.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Open main.cpp file in the Hello-World_coding-example folder and optionally introduce break points.</p>
</div>
</div>
<div class="sect5">
<h6 id="_run_2">Run</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the Command Palette (Ctrl+Shift+P) and run the <code>CMake: Run Without Debugging</code> command, or</p>
</li>
<li>
<p>Use play button in the status bar, or</p>
</li>
<li>
<p>Shift-F5</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="_debug">Debug</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the Command Palette (Ctrl+Shift+P) and run the <code>CMake: Debug</code> command, or</p>
</li>
<li>
<p>Use debug button in the status bar, or</p>
</li>
<li>
<p>Ctrl-F5</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_next_step">14.2.3. Next step</h4>
<div class="paragraph">
<p>Now that you can build and run Hello World, it&#8217;s time to explore some functionality of esmini. Next section presents a few code examples to try out, e.g. by modifying main.cpp.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_examples_2">14.3. Examples</h3>
<div class="sect3">
<h4 id="_hello_world_load_and_play_a_scenario">14.3.1. Hello world - load and play a scenario</h4>
<div class="listingblock">
<div class="title">Example 1. <a href="https://github.com/esmini/esmini/tree/master/Hello-World_coding-example/main.cpp">Hello-World_coding-example/main.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
        SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);

        <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">500</span>; i++)
        {
                SE_Step();
        }

        SE_Close();

        <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exercise: Change scenario to pedestrian.xosc, then compile and run the program again.</p>
</div>
</div>
<div class="sect3">
<h4 id="_add_optional_argument_to_load_any_scenario">14.3.2. Add optional argument to load any scenario</h4>
<div class="listingblock">
<div class="title">Example 2. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/hw2_arguments.cpp">EnvironmentSimulator/code-examples/hello_world/hw2_arguments.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
    <span class="keyword">if</span> (argc &gt; <span class="integer">1</span>)
    {
        SE_InitWithArgs(argc, <span class="keyword">const_cast</span>&lt;<span class="directive">const</span> <span class="predefined-type">char</span>**&gt;(argv));
    }
    <span class="keyword">else</span>
    {
        SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);
    }

    <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">500</span>; i++)
    {
        SE_Step();
    }

    SE_Close();

    <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now specify esmini arguments according to <a href="https://github.com/esmini/esmini/blob/master/docs/commands.txt">esmini launch commands</a>.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./esmini-player --window 60 60 1000 500 --osc ../resources/xosc/pedestrian.xosc --trails</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fetch_state_of_scenario_objects">14.3.3. Fetch state of scenario objects</h4>
<div class="paragraph">
<p>This example shows how to retrieve the state of scenario objects.</p>
</div>
<div class="paragraph">
<p>We also check the return code from the initialization and react on any error.</p>
</div>
<div class="listingblock">
<div class="title">Example 3. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/hw3_fetch_states.cpp">EnvironmentSimulator/code-examples/hello_world/hw3_fetch_states.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;stdio.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
    (<span class="directive">void</span>)argc;
    (<span class="directive">void</span>)argv;

    <span class="keyword">if</span> (SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>) != <span class="integer">0</span>)
    {
        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to initialize scenario</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> -<span class="integer">1</span>;
    }

    <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">500</span>; i++)
    {
        SE_Step();

        <span class="keyword">for</span> (<span class="predefined-type">int</span> j = <span class="integer">0</span>; j &lt; SE_GetNumberOfObjects(); j++)
        {
            SE_ScenarioObjectState state;

            SE_GetObjectState(SE_GetId(j), &amp;state);
            printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">time [%.2f] object[%d] id %d pos[%.2f, %.2f] %.2f %.2f </span><span class="char">\n</span><span class="delimiter">&quot;</span></span>,
                   <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(state.timestamp),
                   j,
                   SE_GetId(j),
                   <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(state.x),
                   <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(state.y),
                   <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(state.wheel_angle),
                   <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(state.wheel_rot));
        }
    }

    SE_Close();

    <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_external_control_of_ego">14.3.4. External control of Ego</h4>
<div class="paragraph">
<p>A silly example showing how you can just take control over vehicle state via the API. The Ego car will move one meter along the Y-axis for each frame while rotating&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Now we will also introduce the quit_flag, which lets you quit by pressing 'Esc' key.</p>
</div>
<div class="paragraph">
<p>In addition we&#8217;ll try out the alignment feature. By default objects will be aligned to road surface. This behavior can be controlled with alignment settings. In below example, the Ego vehicle will be aligned to road surface except during iterations 100-200 where it will obey the reported Z coordinate and move accordingly to elevation/Z = 10 meter.</p>
</div>
<div class="listingblock">
<div class="title">Example 4. <a href="https://github.com/esmini/esmini/tree/master//EnvironmentSimulator/code-examples/hello_world/hw4_external_ego_control.cpp">EnvironmentSimulator/code-examples/hello_world/hw4_external_ego_control.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;stdio.h&gt;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
    <span class="directive">const</span> <span class="predefined-type">char</span>*            filename = argc &gt; <span class="integer">1</span> ? argv[<span class="integer">1</span>] : <span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in_external.xosc</span><span class="delimiter">&quot;</span></span>;
    SE_ScenarioObjectState state;
    <span class="predefined-type">double</span>                 z = <span class="float">0</span><span class="float">.0f</span>;

    <span class="keyword">if</span> (SE_Init(filename, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>) != <span class="integer">0</span>)
    {
        <span class="keyword">return</span> -<span class="integer">1</span>;
    }

    <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">500</span> &amp;&amp; SE_GetQuitFlag() != <span class="integer">1</span>; i++)
    {
        SE_ReportObjectPos(SE_GetId(<span class="integer">0</span>), <span class="float">0</span><span class="float">.0f</span>, <span class="float">8</span><span class="float">.0f</span>, <span class="keyword">static_cast</span>&lt;<span class="predefined-type">float</span>&gt;(i), <span class="keyword">static_cast</span>&lt;<span class="predefined-type">float</span>&gt;(z), <span class="predefined-type">float</span>(<span class="float">1</span><span class="float">.57</span> + <span class="float">0</span><span class="float">.01</span> * i), <span class="float">0</span><span class="float">.0f</span>, <span class="float">0</span><span class="float">.0f</span>);

        SE_Step();

        <span class="comment">// fetch position in terms of road coordinates</span>
        SE_GetObjectState(SE_GetId(<span class="integer">0</span>), &amp;state);

        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">road_id: %d s: %.3f lane_id %d lane_offset: %.3f z: %.2f</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>,
               state.roadId,
               <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(state.s),
               state.laneId,
               <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(state.laneOffset),
               <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(state.z));

        <span class="keyword">if</span> (i == <span class="integer">100</span>)
        {
            z = <span class="integer">1</span><span class="float">0</span><span class="float">.0</span>;
            printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Release relative road alignment, set absolute z = %.2f</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, z);
            SE_SetObjectPositionMode(SE_GetId(<span class="integer">0</span>),
                                     SE_PositionModeType::SE_SET,
                                     SE_PositionMode::SE_Z_ABS);  <span class="comment">// release relative alignment to road surface</span>
        }

        <span class="keyword">if</span> (i == <span class="integer">200</span>)
        {
            z = <span class="float">0</span><span class="float">.0</span>;
            printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Restore relative road alignment, set relative z = %.2f</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, z);
            SE_SetObjectPositionMode(SE_GetId(<span class="integer">0</span>),
                                     SE_PositionModeType::SE_SET,
                                     SE_PositionMode::SE_Z_REL);  <span class="comment">// enforce relative alignment to road surface</span>
        }
    }

    SE_Close();

    <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exercise: Change heading with i, e.g:</p>
</div>
<div class="paragraph">
<p><code>SE_ReportObjectPos(0, 0.0f, 8.0f, (float)i, 0.0f, 1.57f + 0.01f*i, 0.0f, 0.0f);</code></p>
</div>
<div class="paragraph">
<p>Yes, it looks crazy! But it demonstrates how an application totally can take control of a vehicle.</p>
</div>
</div>
<div class="sect3">
<h4 id="_control_controllers">14.3.5. Control controllers</h4>
<div class="paragraph">
<p>Try to run cut-in_interactive.xosc, as below.</p>
</div>
<div class="listingblock">
<div class="title">Example 5. <a href="https://github.com/esmini/esmini/tree/master//EnvironmentSimulator/code-examples/hello_world/hw5_control_controllers_enabled.cpp">EnvironmentSimulator/code-examples/hello_world/hw5_control_controllers_enabled.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
    (<span class="directive">void</span>)argc;
    (<span class="directive">void</span>)argv;

    SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in_interactive.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);

    <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">2000</span> &amp;&amp; SE_GetQuitFlag() != <span class="integer">1</span>; i++)
    {
        SE_Step();
    }

    SE_Close();

    <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Control the Ego vehicle with arrow keys.</p>
</div>
<div class="paragraph">
<p>To disable controllers and hand over to default scenario behavior set first argument flag (see <a href="https://github.com/esmini/esmini/blob/45ef22ed04867f6e6630bb73461e5d4a3fcd7d93/EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp#L259">headerfile esminiLib.hpp</a>):</p>
</div>
<div class="listingblock">
<div class="title">Example 6. <a href="https://github.com/esmini/esmini/tree/master//EnvironmentSimulator/code-examples/hello_world/hw6_control_controllers_disabled.cpp">EnvironmentSimulator/code-examples/hello_world/hw6_control_controllers_disabled.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span>, <span class="predefined-type">char</span>**)
{
    SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in_interactive.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);

    <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">2000</span> &amp;&amp; SE_GetQuitFlag() != <span class="integer">1</span>; i++)
    {
        SE_Step();
    }

    SE_Close();

    <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ideal_sensors">14.3.6. Ideal sensors</h4>
<div class="listingblock">
<div class="title">Example 7. <a href="https://github.com/esmini/esmini/tree/master//EnvironmentSimulator/code-examples/hello_world/hw7_ideal_sensors.cpp">EnvironmentSimulator/code-examples/hello_world/hw7_ideal_sensors.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;stdio.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="preprocessor">#define</span> MAX_HITS <span class="integer">10</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span>, <span class="predefined-type">char</span>**)
{
    SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);

    SE_AddObjectSensor(<span class="integer">0</span>, <span class="float">2</span><span class="float">.0f</span>, <span class="float">1</span><span class="float">.0f</span>, <span class="float">0</span><span class="float">.5f</span>, <span class="float">1</span><span class="float">.57f</span>, <span class="float">1</span><span class="float">.0f</span>, <span class="integer">5</span><span class="float">0</span><span class="float">.0f</span>, <span class="float">1</span><span class="float">.57f</span>, MAX_HITS);
    SE_AddObjectSensor(<span class="integer">0</span>, -<span class="float">1</span><span class="float">.0f</span>, <span class="float">0</span><span class="float">.0f</span>, <span class="float">0</span><span class="float">.5f</span>, <span class="float">3</span><span class="float">.14f</span>, <span class="float">0</span><span class="float">.5f</span>, <span class="integer">2</span><span class="float">0</span><span class="float">.0f</span>, <span class="float">1</span><span class="float">.57f</span>, MAX_HITS);

    <span class="comment">// Turn on visualization of object sensors, toggle key 'r'</span>
    SE_ViewerShowFeature(<span class="integer">1</span>, <span class="predefined-constant">true</span>);

    <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">2000</span> &amp;&amp; !(SE_GetQuitFlag() == <span class="integer">1</span>); i++)
    {
        SE_Step();

        <span class="predefined-type">int</span> objList[MAX_HITS];
        <span class="keyword">for</span> (<span class="predefined-type">int</span> j = <span class="integer">0</span>; j &lt; <span class="integer">2</span>; j++)  <span class="comment">// iterate over added sensors</span>
        {
            <span class="predefined-type">int</span> nHits = SE_FetchSensorObjectList(j, objList);
            <span class="keyword">for</span> (<span class="predefined-type">int</span> k = <span class="integer">0</span>; k &lt; nHits; k++)
            {
                printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Sensor[%d] detected obj: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, j, objList[k]);

                <span class="comment">// Get some info of that detected object</span>
                SE_ScenarioObjectState state;

                SE_GetObjectState(objList[k], &amp;state);
                printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">object[%d] pos: (%.2f, %.2f) heading: %.2f</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>,
                       objList[k],
                       <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(state.x),
                       <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(state.y),
                       <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(state.h));
            }
        }
    }

    SE_Close();

    <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note</strong>: If you want M_PI, add on top (before includes): <code>#define _USE_MATH_DEFINES</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_collision_detection">14.3.7. Collision detection</h4>
<div class="paragraph">
<p>There are two approaches to collision detection that fit different use cases:</p>
</div>
<div class="sect4">
<h5 id="_1_by_scenario">1. By scenario</h5>
<div class="paragraph">
<p>Making use of the OpenSCENARIO <a href="https://www.asam.net/static_downloads/ASAM_OpenSCENARIO_V1.2.0_Model_Documentation/modelDocumentation/content/CollisionCondition.html">CollisionCondition</a> a collision can be detected and act upon. This can be useful for example if a scenario or test case should end in case of Ego vehicle gets involved in a collision.</p>
</div>
<div class="paragraph">
<p>See example <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Unittest/xosc/test-collision-detection.xosc">EnvironmentSimulator/Unittest/xosc/test-collision-detection.xosc</a>. To run it from command line:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./EnvironmentSimulator/Unittest/xosc/test-collision-detection.xosc</code></p>
</div>
<div class="paragraph">
<p>Control the Ego car with keyboard arrow keys. Press "up" to accelerate, and "left" or "right" to steer. See output in console when colliding with the two other cars.</p>
</div>
<div class="paragraph">
<p>The interactive controller can be disabled. Then the Ego car will get the speed from the scenario. Run:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./EnvironmentSimulator/Unittest/xosc/test-collision-detection.xosc --disable_controllers</code></p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> In this example the action is empty, i.e. the event is triggered on collision but nothing really happens, other than logging the trigger result. In a real use case there could be an actual action, e.g. immediate stop by setting speed to zero in a single step. Another usage is to use the condition in a scenario stop trigger, e.g. to quit the test case as soon as collision happens.</p>
</div>
</div>
<div class="sect4">
<h5 id="_2_by_api">2. By API</h5>
<div class="paragraph">
<p>In addition, or as alternative, to detect collisions via OpenSCENARIO condition esmini can check for collisions between any objects regardless of the scenario. This is a feature that must be enabled (<code>SE_CollisionDetection(true)</code>) since it&#8217;s off by default to avoid unnecessary performance penalties.</p>
</div>
<div class="paragraph">
<p>See code example:</p>
</div>
<div class="listingblock">
<div class="title">Example 8. <a href="https://github.com/esmini/esmini/tree/master//EnvironmentSimulator/code-examples/hello_world/hw8_collision_detection.cpp">EnvironmentSimulator/code-examples/hello_world/hw8_collision_detection.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;stdio.h&quot;</span>

<span class="predefined-type">int</span> main(<span class="directive">void</span>)
{
    SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../EnvironmentSimulator/Unittest/xosc/test-collision-detection.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);
    SE_CollisionDetection(<span class="predefined-constant">true</span>);

    <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">500</span>; i++)
    {
        SE_Step();

        <span class="keyword">for</span> (<span class="predefined-type">int</span> j = <span class="integer">0</span>; j &lt; SE_GetNumberOfObjects(); j++)
        {
            <span class="keyword">for</span> (<span class="predefined-type">int</span> k = <span class="integer">0</span>; k &lt; SE_GetObjectNumberOfCollisions(j); k++)
            {
                printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Collision[%d]: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, j, SE_GetObjectCollision(j, k));
            }
        }
    }

    <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong> It uses the same scenario file as the above (<a href="#_1_by_scenario">1. By scenario</a>) but the complete "CollisionManeuver" could be removed since no CollisionCondition is needed for API based collision detection. Actually, if maneuver is present the console will show log info from both the condition and the API driven collision detections.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_simple_speed_control">14.3.8. Simple speed control</h4>
<div class="paragraph">
<p>As an alternative to the external control examples above, you can control the speed of an object directly. Just note that any triggered scenario actions involving the object might conflict with speed settings via lib API. Recommendation is control an object either via API or scenario file. That said, the combination can be useful for some use cases.</p>
</div>
<div class="paragraph">
<p>The code will modulate speed of Ego (first vehicle) between 2 and 20 mps.</p>
</div>
<div class="listingblock">
<div class="title">Example 9. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/speed_controller.cpp">EnvironmentSimulator/code-examples/hello_world/speed_controller.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;iostream&gt;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span> **argv)
{
    <span class="predefined-type">float</span> acc   = <span class="integer">10</span>;    <span class="comment">// initial acceleration</span>
    <span class="predefined-type">float</span> speed = <span class="float">2</span><span class="float">.0f</span>;  <span class="comment">// initial speed</span>

    <span class="keyword">if</span> (argc &gt; <span class="integer">1</span>)
    {
        SE_Init(argv[<span class="integer">1</span>], <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);
    }
    <span class="keyword">else</span>
    {
        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Usage: %s &lt;path to xosc file&gt;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, argv[<span class="integer">0</span>]);
        <span class="keyword">return</span> -<span class="integer">1</span>;
    }

    <span class="keyword">while</span> (SE_GetQuitFlag() != <span class="integer">1</span>)
    {
        speed += acc * SE_GetSimTimeStep();  <span class="comment">// get latest time step from simulation</span>

        <span class="comment">// modulate speed by changing sign of acceleration now and then</span>
        <span class="keyword">if</span> (speed &lt; <span class="float">2</span><span class="float">.0f</span>)
        {
            acc = <span class="integer">10</span>;
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (speed &gt; <span class="integer">2</span><span class="float">0</span><span class="float">.0f</span>)
        {
            acc = -<span class="integer">10</span>;
        }

        <span class="comment">// report updated speed</span>
        SE_ReportObjectSpeed(<span class="integer">0</span>, speed);

        <span class="comment">// step the simulation in natural speed, change to SE_Step(&lt;time-step&gt;) for fixed timestep</span>
        SE_Step();
    }

    SE_Close();

    <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example run command, from <code>esmini/code-examples-bin</code> folder:<br>
<code>./speed_controller ../resources/xosc/cut-in.xosc</code></p>
</div>
<div class="paragraph">
<p>There is also a Python version of this example:<br>
<a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/speed_controller.py">EnvironmentSimulator/code-examples/hello_world/speed_controller.py</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_inject_actions">14.3.9. Inject actions</h4>
<div class="paragraph">
<p>This example demonstrates how you can control longitudinal and lateral motion by applying the following actions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SpeedAction</p>
</li>
<li>
<p>LaneChangeAction</p>
</li>
<li>
<p>LaneOffsetAction</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Currently (v2.37.0) the action injection feature is limited to these three actions, but it&#8217;s rather easy to extend if needed.</p>
</div>
<div class="paragraph">
<p>The code will apply three actions according as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>after 2 seconds, make a slight movement (lane offset) of 0.45m to the right</p>
</li>
<li>
<p>after 7 seconds, make a lane change to the left</p>
</li>
<li>
<p>after 8 seconds, consider to do another lane change, but skip since another is already ongoing</p>
</li>
<li>
<p>after 9.5 seconds, brake softly (braking will start before lane change is done)</p>
</li>
<li>
<p>after 11.0 seconds, brake harder to a stop (will cancel the ongoing soft brake action)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example 10. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/action_injection.cpp">EnvironmentSimulator/code-examples/hello_world/action_injection.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;string.h&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;iostream&gt;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span> **argv)
{
    <span class="predefined-type">float</span> dt = -<span class="float">1</span><span class="float">.0f</span>;  <span class="comment">// default to variable timestep</span>

    <span class="keyword">if</span> (argc &gt; <span class="integer">2</span>)
    {
        <span class="keyword">if</span> (SE_InitWithArgs(argc, <span class="keyword">const_cast</span>&lt;<span class="directive">const</span> <span class="predefined-type">char</span> **&gt;(argv)) != <span class="integer">0</span>)
        {
            printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Error: Could not initialize scenario %s</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, argv[<span class="integer">1</span>]);
            <span class="keyword">return</span> -<span class="integer">1</span>;
        }
        <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">2</span>; i &lt; argc; i++)
        {
            <span class="keyword">if</span> (strcmp(argv[i], <span class="string"><span class="delimiter">&quot;</span><span class="content">--fixed_timestep</span><span class="delimiter">&quot;</span></span>) == <span class="integer">0</span> &amp;&amp; i &lt; argc - <span class="integer">1</span>)
            {
                dt = <span class="keyword">static_cast</span>&lt;<span class="predefined-type">float</span>&gt;(atof(argv[i + <span class="integer">1</span>]));  <span class="comment">// use any provided fixed timestep</span>
            }
        }
    }
    <span class="keyword">else</span> <span class="keyword">if</span> (argc &gt; <span class="integer">1</span>)
    {
        <span class="keyword">if</span> (SE_Init(argv[<span class="integer">1</span>], <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>) != <span class="integer">0</span>)
        {
            printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Error: Could not initialize scenario %s</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, argv[<span class="integer">1</span>]);
            <span class="keyword">return</span> -<span class="integer">1</span>;
        }
    }
    <span class="keyword">else</span>
    {
        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Usage: %s &lt;path to xosc file&gt;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, argv[<span class="integer">0</span>]);
        <span class="keyword">return</span> -<span class="integer">1</span>;
    }

    <span class="predefined-type">int</span> state = <span class="integer">0</span>;
    <span class="keyword">while</span> (SE_GetQuitFlag() == <span class="integer">0</span> &amp;&amp; SE_GetSimulationTime() &lt; <span class="integer">1</span><span class="float">7</span><span class="float">.0f</span>)
    {
        <span class="keyword">if</span> (state == <span class="integer">0</span> &amp;&amp; SE_GetSimulationTime() &gt; <span class="float">2</span><span class="float">.0f</span>)
        {
            printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Injecting lane offset action</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
            SE_LaneOffsetActionStruct lane_offset;
            lane_offset.id               = <span class="integer">0</span>;       <span class="comment">// id of object to perform action</span>
            lane_offset.offset           = -<span class="float">0</span><span class="float">.45f</span>;  <span class="comment">// target offset in m</span>
            lane_offset.maxLateralAcc    = <span class="float">0</span><span class="float">.5f</span>;    <span class="comment">// max lateral acceleration in m/s^2</span>
            lane_offset.transition_shape = <span class="integer">0</span>;       <span class="comment">// cubic</span>
            SE_InjectLaneOffsetAction(&amp;lane_offset);
            state++;
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (state == <span class="integer">1</span> &amp;&amp; SE_GetSimulationTime() &gt; <span class="float">7</span><span class="float">.0f</span>)
        {
            printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Injecting lane change action</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
            SE_LaneChangeActionStruct lane_change;
            lane_change.id               = <span class="integer">0</span>;     <span class="comment">// id of object to perform action</span>
            lane_change.mode             = <span class="integer">1</span>;     <span class="comment">// relative (own vehicle)</span>
            lane_change.target           = <span class="integer">1</span>;     <span class="comment">// target lane id (relative)</span>
            lane_change.transition_shape = <span class="integer">2</span>;     <span class="comment">// sinusoidal</span>
            lane_change.transition_dim   = <span class="integer">2</span>;     <span class="comment">// time</span>
            lane_change.transition_value = <span class="float">3</span><span class="float">.0f</span>;  <span class="comment">// s</span>
            SE_InjectLaneChangeAction(&amp;lane_change);
            state++;
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (state == <span class="integer">2</span> &amp;&amp; SE_GetSimulationTime() &gt; <span class="float">8</span><span class="float">.0f</span>)
        {
            <span class="keyword">if</span> (SE_InjectedActionOngoing(<span class="integer">5</span>))  <span class="comment">// 5 = LAT_LANE_CHANGE</span>
            {
                printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Lane change already ongoing, skipping second lane change</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
            }
            <span class="keyword">else</span>
            {
                printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Injecting lane change action 2</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
                SE_LaneChangeActionStruct lane_change;
                lane_change.id               = <span class="integer">0</span>;     <span class="comment">// id of object to perform action</span>
                lane_change.mode             = <span class="integer">1</span>;     <span class="comment">// relative (own vehicle)</span>
                lane_change.target           = -<span class="integer">1</span>;    <span class="comment">// target lane id (relative)</span>
                lane_change.transition_shape = <span class="integer">2</span>;     <span class="comment">// sinusoidal</span>
                lane_change.transition_dim   = <span class="integer">2</span>;     <span class="comment">// time</span>
                lane_change.transition_value = <span class="float">3</span><span class="float">.0f</span>;  <span class="comment">// s</span>
                SE_InjectLaneChangeAction(&amp;lane_change);
            }
            state++;
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (state == <span class="integer">3</span> &amp;&amp; SE_GetSimulationTime() &gt; <span class="float">9</span><span class="float">.5f</span>)  <span class="comment">// slightly overlapping lane change action</span>
        {
            printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Injecting speed action - soft brake</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
            SE_SpeedActionStruct speed;
            speed.id               = <span class="integer">0</span>;     <span class="comment">// id of object to perform action</span>
            speed.speed            = <span class="float">0</span><span class="float">.0f</span>;  <span class="comment">// target speed in m/s</span>
            speed.transition_shape = <span class="integer">0</span>;     <span class="comment">// cubic</span>
            speed.transition_dim   = <span class="integer">1</span>;     <span class="comment">// rate</span>
            speed.transition_value = <span class="float">3</span><span class="float">.0f</span>;  <span class="comment">// m/s^2</span>
            SE_InjectSpeedAction(&amp;speed);
            state++;
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (state == <span class="integer">4</span> &amp;&amp; SE_GetSimulationTime() &gt; <span class="integer">1</span><span class="float">1</span><span class="float">.0f</span>)  <span class="comment">// slightly overlapping lane change action</span>
        {
            printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Injecting speed action - hard brake</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
            SE_SpeedActionStruct speed;
            speed.id               = <span class="integer">0</span>;     <span class="comment">// id of object to perform action</span>
            speed.speed            = <span class="float">0</span><span class="float">.0f</span>;  <span class="comment">// target speed in m/s</span>
            speed.transition_shape = <span class="integer">1</span>;     <span class="comment">// cubic</span>
            speed.transition_dim   = <span class="integer">1</span>;     <span class="comment">// rate</span>
            speed.transition_value = <span class="float">8</span><span class="float">.0f</span>;  <span class="comment">// m/s^2</span>
            SE_InjectSpeedAction(&amp;speed);
            state++;
        }

        <span class="keyword">if</span> (dt &lt; <span class="float">0</span><span class="float">.0f</span>)
        {
            SE_Step();
        }
        <span class="keyword">else</span>
        {
            SE_StepDT(dt);
        }
    }

    SE_Close();

    <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example run command, from <code>esmini/code-examples-bin</code> folder:<br>
<code>./action_injection ../resources/xosc/cut-in.xosc</code></p>
</div>
<div class="paragraph">
<p>There is also a Python version of this example:<br>
<a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/action_injection.py">EnvironmentSimulator/code-examples/hello_world/action_injection.py</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_driver_model">14.3.10. Driver model</h4>
<div class="paragraph">
<p>Using a simple vehicle model this example demonstrates how a driver model can interact with the scenario in terms of pedal and steering input. This time we use the <code>ExternalController</code> again to ensure any scenario actions is not conflicting with the driver model.</p>
</div>
<div class="paragraph">
<p>To show different variants we also show how to set scenario parameters during intialization, via callbacks. In effect this is a way to achieve runtime variants of the same basic scenario.</p>
</div>
<div class="paragraph">
<p>Before heading into the application code we will look into the scenario file <a href="../EnvironmentSimulator/code-examples/test-driver/test-driver.xosc">EnvironmentSimulator/code-examples/test-driver/test-driver.xosc</a>.</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s have a look inside it to see how to activate the ExternalController, which will prevent the DefaultController to interfere with the Ego vehicle and instead hand over exclusive control to our application. You can skip this and go to the C++ code example below if you&#8217;re not interested in the controller setup.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open test-driver.xosc</p>
</li>
<li>
<p>Look in the Entities section, under the <code>&lt;ScenarioObject name="Ego"\&gt;</code> element. Here the controller is defined and assigned to the Ego vehicle.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">          <span class="tag">&lt;ObjectController&gt;</span>
                <span class="tag">&lt;Controller</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MyExternalControllerWithGhost</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;Properties&gt;</span>
                        <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">esminiController</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ExternalController</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                        <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">useGhost</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">$GhostMode</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                        <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headstartTime</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                    <span class="tag">&lt;/Properties&gt;</span>
                <span class="tag">&lt;/Controller&gt;</span>
          <span class="tag">&lt;/ObjectController&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong> The GhostMode parameter is set to true or false in the ParameterDeclarations section in the top of the scenario file.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Then the initial position is set. This could instead be done by the application, but it&#8217;s convenient to specify it in the scenario file.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">                <span class="tag">&lt;PrivateAction&gt;</span>
                    <span class="tag">&lt;TeleportAction&gt;</span>
                        <span class="tag">&lt;Position&gt;</span>
                            <span class="tag">&lt;LanePosition</span> <span class="attribute-name">roadId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">laneId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">s</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">50</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                        <span class="tag">&lt;/Position&gt;</span>
                    <span class="tag">&lt;/TeleportAction&gt;</span>
                <span class="tag">&lt;/PrivateAction&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Finally we need to activate the controller on both lateral and longitudinal domains.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">                <span class="tag">&lt;PrivateAction&gt;</span>
                      <span class="tag">&lt;ActivateControllerAction</span> <span class="attribute-name">longitudinal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lateral</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                <span class="tag">&lt;/PrivateAction&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The reason for putting it AFTER the positioning is that oterwise the position action would have no effect, since once the controller is activated all scenario actions will be ignored. The controller then having exclusive control.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s head into the code example. It will run the scenario three times:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>External controller without ghost mode</p>
<div class="ulist">
<ul>
<li>
<p>just look ahead and follow along current lane. Find point along the lane and steer towards it.</p>
</li>
</ul>
</div>
</li>
<li>
<p>External controller with ghost mode and time based lookahead</p>
<div class="ulist">
<ul>
<li>
<p>find the state of ghost at given time offset. Use it for steering and speed target.</p>
</li>
</ul>
</div>
</li>
<li>
<p>External controller with ghost mode and position based lookahead</p>
<div class="ulist">
<ul>
<li>
<p>given the current Ego position, find ghost state at some look ahead distance along its trail. Use it for steering and speed target.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now, study the code and perhaps play around mainpulating some values.</p>
</div>
<div class="listingblock">
<div class="title">Example 11. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/test-driver/test-driver.cpp">EnvironmentSimulator/code-examples/test-driver/test-driver.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;stdio.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;math.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;string&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="directive">void</span> paramDeclCB(<span class="directive">void</span>* user_arg)
{
    <span class="predefined-type">bool</span> ghostMode = *(<span class="keyword">static_cast</span>&lt;<span class="predefined-type">bool</span>*&gt;(user_arg));

    SE_LogMessage((std::<span class="predefined-type">string</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Running with ghostMode = </span><span class="delimiter">&quot;</span></span>).append(ghostMode == <span class="predefined-constant">true</span> ? <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>)).c_str());
    SE_SetParameterBool(<span class="string"><span class="delimiter">&quot;</span><span class="content">GhostMode</span><span class="delimiter">&quot;</span></span>, ghostMode);
}

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
    (<span class="directive">void</span>)argc;
    (<span class="directive">void</span>)argv;

    <span class="directive">const</span> <span class="predefined-type">double</span> defaultTargetSpeed = <span class="integer">5</span><span class="float">0</span><span class="float">.0</span>;
    <span class="directive">const</span> <span class="predefined-type">double</span> curveWeight        = <span class="integer">3</span><span class="float">0</span><span class="float">.0</span>;
    <span class="directive">const</span> <span class="predefined-type">double</span> throttleWeight     = <span class="float">0</span><span class="float">.1</span>;
    <span class="directive">const</span> <span class="predefined-type">float</span>  duration           = <span class="integer">3</span><span class="float">5</span><span class="float">.0f</span>;
    <span class="predefined-type">bool</span>         ghostMode[<span class="integer">3</span>]       = {<span class="predefined-constant">false</span>, <span class="predefined-constant">true</span>, <span class="predefined-constant">true</span>};

    <span class="directive">void</span>*                  vehicleHandle = <span class="integer">0</span>;
    SE_SimpleVehicleState  vehicleState  = {<span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>};
    SE_ScenarioObjectState objectState;
    SE_RoadInfo            roadInfo;

    <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">3</span>; i++)
    {
        <span class="predefined-type">float</span> dt = <span class="float">0</span><span class="float">.0f</span>;

        SE_RegisterParameterDeclarationCallback(paramDeclCB, &amp;ghostMode[i]);

        <span class="keyword">if</span> (SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../EnvironmentSimulator/code-examples/test-driver/test-driver.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>) != <span class="integer">0</span>)
        {
            SE_LogMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to initialize the scenario, quit</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">return</span> -<span class="integer">1</span>;
        }

        <span class="comment">// Lock object to the original lane</span>
        <span class="comment">// If setting to false, the object road position will snap to closest lane</span>
        SE_SetLockOnLane(<span class="integer">0</span>, <span class="predefined-constant">true</span>);

        <span class="comment">// Initialize the vehicle model, fetch initial state from the scenario</span>
        SE_GetObjectState(<span class="integer">0</span>, &amp;objectState);
        vehicleHandle = SE_SimpleVehicleCreate(objectState.x, objectState.y, objectState.h, <span class="float">4</span><span class="float">.0</span>, <span class="float">0</span><span class="float">.0</span>);
        SE_SimpleVehicleSteeringRate(vehicleHandle, <span class="float">6</span><span class="float">.0f</span>);

        <span class="comment">// show some road features, including road sensor</span>
        SE_ViewerShowFeature(<span class="integer">4</span> + <span class="integer">8</span>, <span class="predefined-constant">true</span>);  <span class="comment">// NODE_MASK_TRAIL_DOTS (1 &lt;&lt; 2) &amp; NODE_MASK_ODR_FEATURES (1 &lt;&lt; 3),</span>

        <span class="comment">// Run for specified duration or until 'Esc' button is pressed</span>
        <span class="keyword">while</span> (SE_GetSimulationTime() &lt; duration &amp;&amp; SE_GetQuitFlag() != <span class="integer">1</span>)
        {
            <span class="comment">// Get simulation delta time since last call (first will be minimum timestep)</span>
            dt = SE_GetSimTimeStep();

            <span class="comment">// Get road information at a point some speed dependent distance ahead</span>
            <span class="predefined-type">double</span> targetSpeed;
            <span class="keyword">if</span> (ghostMode[i] == <span class="predefined-constant">true</span>)
            {
                <span class="comment">// ghost version</span>
                <span class="predefined-type">float</span> ghost_speed = <span class="float">0</span><span class="float">.0f</span>;
                <span class="predefined-type">float</span> timestamp   = <span class="float">0</span><span class="float">.0f</span>;

                <span class="keyword">if</span> (i % <span class="integer">2</span> == <span class="integer">0</span>)  <span class="comment">// alternate between time based and position based look ahead modes</span>
                {
                    <span class="comment">// Time based look ahead</span>
                    SE_GetRoadInfoGhostTrailTime(<span class="integer">0</span>, SE_GetSimulationTime() + <span class="float">0</span><span class="float">.25f</span>, &amp;roadInfo, &amp;ghost_speed);
                }
                <span class="keyword">else</span>
                {
                    <span class="comment">// Position based Time based look ahead</span>
                    SE_GetRoadInfoAlongGhostTrail(<span class="integer">0</span>, <span class="integer">5</span> + <span class="float">0</span><span class="float">.75f</span> * vehicleState.speed, &amp;roadInfo, &amp;ghost_speed, &amp;timestamp);
                }
                targetSpeed = ghost_speed;
            }
            <span class="keyword">else</span>
            {
                <span class="comment">// Look ahead along the road, to establish target info for the driver model</span>
                SE_GetRoadInfoAtDistance(<span class="integer">0</span>, <span class="integer">5</span> + <span class="float">0</span><span class="float">.75f</span> * vehicleState.speed, &amp;roadInfo, <span class="integer">0</span>, <span class="predefined-constant">true</span>);

                <span class="comment">// Slow down when curve ahead - CURVE_WEIGHT is the tuning parameter</span>
                targetSpeed = defaultTargetSpeed / (<span class="integer">1</span> + curveWeight * <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(fabs(roadInfo.angle)));
            }

            <span class="comment">// Steer towards where the point</span>
            <span class="predefined-type">double</span> steerAngle = roadInfo.angle;

            <span class="comment">// Accelerate or decelerate towards target speed - THROTTLE_WEIGHT tunes magnitude</span>
            <span class="predefined-type">double</span> throttle = throttleWeight * (targetSpeed - <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(vehicleState.speed));

            <span class="comment">// Step vehicle model with driver input, but wait until time &gt; 0</span>
            <span class="keyword">if</span> (SE_GetSimulationTime() &gt; <span class="integer">0</span> &amp;&amp; !SE_GetPauseFlag())
            {
                SE_SimpleVehicleControlAnalog(vehicleHandle, dt, throttle, steerAngle);
            }

            <span class="comment">// Fetch updated state and report to scenario engine</span>
            SE_SimpleVehicleGetState(vehicleHandle, &amp;vehicleState);

            <span class="comment">// Report updated vehicle position and heading. z, pitch and roll will be aligned to the road</span>
            SE_ReportObjectPosXYH(<span class="integer">0</span>, <span class="integer">0</span>, vehicleState.x, vehicleState.y, vehicleState.h);

            <span class="comment">// The following values are not necessary to report.</span>
            <span class="comment">// If not reported, esmini will calculate based on motion over time</span>
            <span class="comment">// but for accuracy it's recommendeded to report if available.</span>

            <span class="comment">// wheel status (revolution and steering angles)</span>
            SE_ReportObjectWheelStatus(<span class="integer">0</span>, vehicleState.wheel_rotation, vehicleState.wheel_angle);

            <span class="comment">// speed (along vehicle longitudinal (x) axis)</span>
            SE_ReportObjectSpeed(<span class="integer">0</span>, vehicleState.speed);

            <span class="comment">// Finally, update scenario using same time step as for vehicle model</span>
            SE_StepDT(dt);
        }
        SE_Close();
    }
    <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Don&#8217;t worry about the stationary red car on the road, you&#8217;ll just drive through it.</p>
</div>
<div class="paragraph">
<p>Try experimenting with the driver settings, e.g. increase lookahead distance factor from 0.75 to 1.75.</p>
</div>
<div class="paragraph">
<p>When running the application, press key 'j' to toggle ghost trail dots and lines visualization.</p>
</div>
<div class="paragraph">
<p><strong>Challenge</strong>: Attach a front looking sensor to detect it and have the driver to brake to avoid collision&#8230;&#8203;</p>
</div>
<div class="sect4">
<h5 id="_ghost_concept_in_brief">Ghost concept in brief</h5>
<div class="paragraph">
<p>In the first loop the driver model is just capable of driving along the specified lane. It&#8217;s totally detached from any scenario events.</p>
</div>
<div class="paragraph">
<p>The ghost concept is a solution for a driver model to perform scenario actions. Basically it will launch a fore-runner to perform the scenario actions. The trajectory, including speed, is registered into a "trail" which can then be used as reference for steering and speed target.</p>
</div>
<div class="paragraph">
<p>Ghost mode is a parameter of the external controller. Normally this is set in the scenario, for example in test-driver.xosc, change line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;ParameterDeclaration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">GhostMode</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">boolean</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;ParameterDeclaration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">GhostMode</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">boolean</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, in the example code this parameter is controlled by the <code>paramDeclCB()</code> callback. Once it&#8217;s registered with <code>SE_RegisterParameterDeclarationCallback()</code> it will be called each time esmini is initialized (<code>SE_Init()</code>).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_osi_groundtruth">14.3.11. OSI groundtruth</h4>
<div class="paragraph">
<p>To access OSI data we first need to complement the build script (CMakeLists.txt) with OSI include and library info. For example:</p>
</div>
<div class="paragraph">
<p>Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>include_directories(. ../include ../EnvironmentSimulator/Libraries/esminiLib ../externals/osi/v10/include)

link_directories(. ../bin ../externals/osi/v10/lib)

target_link_libraries(${TARGET} esminiLib libprotobuf open_simulation_interface_pic)</pre>
</div>
</div>
<div class="paragraph">
<p>Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>include_directories(. ../include ../EnvironmentSimulator/Libraries/esminiLib ../externals/osi/linux/include)

link_directories(. ../bin ../externals/osi/linux/lib)

target_link_libraries(${TARGET} esminiLib protobuf open_simulation_interface_pic)</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace foldername "v10" with linux or mac depending on your platform.</p>
</li>
<li>
<p>If linking with custom applications or libraries: OSI and Google Protobuf versions needs to be consistent (at least major version nr), also with the versions used in esmini (see <a href="https://github.com/esmini/esmini#osi-support">here</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then run <code>cmake ..</code> from the build folder to apply the changes in CMakeFiles.cxx.</p>
</div>
<div class="paragraph">
<p>The following code will update, fetch and print some OSI data each frame.</p>
</div>
<div class="listingblock">
<div class="title">Example 12. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/osi-groundtruth/osi-groundtruth.cpp">EnvironmentSimulator/code-examples/osi-groundtruth/osi-groundtruth.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="preprocessor">#include</span> <span class="include">&quot;osi_common.pb.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;osi_object.pb.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;osi_groundtruth.pb.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;osi_version.pb.h&quot;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
    (<span class="directive">void</span>)argc;
    (<span class="directive">void</span>)argv;
    <span class="directive">const</span> osi3::GroundTruth* gt;

    SE_EnableOSIFile(<span class="integer">0</span>);  <span class="comment">// 0 or &quot;&quot; will result in default filename, ground_truth.osi</span>

    SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in_simple.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);

    <span class="comment">// You could now retrieve the initial state of all objects before stepping the scenario</span>

    <span class="comment">// Initial update of complete Ground Truth, including static things</span>
    SE_UpdateOSIGroundTruth(<span class="predefined-constant">false</span>);

    <span class="comment">// Fetch initial OSI struct</span>
    gt = <span class="keyword">reinterpret_cast</span>&lt;<span class="directive">const</span> osi3::GroundTruth*&gt;(SE_GetOSIGroundTruthRaw());

    <span class="comment">// Lane boundaries (static road info only available in first OSI frame</span>
    printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">lane boundaries: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, gt-&gt;lane_boundary_size());
    <span class="keyword">for</span> (<span class="predefined-type">int</span> j = <span class="integer">0</span>; j &lt; gt-&gt;lane_boundary_size(); j++)
    {
        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">  lane boundary %d, nr of boundary points: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, j, gt-&gt;lane_boundary(j).boundary_line_size());

<span class="comment">#if 0  // change to 1 in order to print all boundary points
                        for (int k = 0; k &lt; gt-&gt;lane_boundary(j).boundary_line_size(); k++)
                        {
                                printf(&quot;    (%.2f, %.2f)\n&quot;,
                                        gt-&gt;lane_boundary(j).boundary_line(k).position().x(),
                                        gt-&gt;lane_boundary(j).boundary_line(k).position().y());
                        }
#endif</span>
    }

    <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">4</span>; i++)
    {
        SE_StepDT(<span class="float">0</span><span class="float">.01f</span>);

        <span class="comment">// Further updates will only affect dynamic OSI stuff</span>
        SE_UpdateOSIGroundTruth(<span class="predefined-constant">false</span>);

        <span class="comment">// Fetch OSI struct</span>
        gt = <span class="keyword">reinterpret_cast</span>&lt;<span class="directive">const</span> osi3::GroundTruth*&gt;(SE_GetOSIGroundTruthRaw());

        <span class="comment">// Print timestamp</span>
        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Frame %d timestamp: %.2f</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>,
               i + <span class="integer">1</span>,
               <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(gt-&gt;timestamp().seconds()) + <span class="float">1</span>E-<span class="integer">9</span> * <span class="keyword">static_cast</span>&lt;<span class="predefined-type">double</span>&gt;(gt-&gt;timestamp().nanos()));

        <span class="comment">// Static content such as lane boundaries should be 0 at this point</span>
        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">lane boundaries: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, gt-&gt;lane_boundary_size());

        <span class="comment">// Road markings, e.g. zebra lines</span>
        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">road markings: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, gt-&gt;road_marking_size());

        <span class="comment">// Moving objects</span>
        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">moving objects: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, gt-&gt;moving_object_size());

<span class="preprocessor">#if</span> <span class="integer">1</span>  <span class="comment">// change to 1 in order to print some moving object state info</span>
       <span class="comment">// Print object id, position, orientation and velocity</span>
        <span class="keyword">for</span> (<span class="predefined-type">int</span> j = <span class="integer">0</span>; j &lt; gt-&gt;moving_object().size(); j++)
        {
            printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">  obj id %u pos (%.2f, %.2f, %.2f) orientation (%.2f, %.2f, %.2f) vel (%.2f, %.2f, %.2f) acc (%.2f, %.2f, %.2f)</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>,
                   <span class="keyword">static_cast</span>&lt;<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span>&gt;(gt-&gt;moving_object(j).id().value()),
                   gt-&gt;moving_object(j).base().position().x(),
                   gt-&gt;moving_object(j).base().position().y(),
                   gt-&gt;moving_object(j).base().position().z(),
                   gt-&gt;moving_object(j).base().orientation().yaw(),
                   gt-&gt;moving_object(j).base().orientation().pitch(),
                   gt-&gt;moving_object(j).base().orientation().roll(),
                   gt-&gt;moving_object(j).base().velocity().x(),
                   gt-&gt;moving_object(j).base().velocity().y(),
                   gt-&gt;moving_object(j).base().velocity().z(),
                   gt-&gt;moving_object(j).base().acceleration().x(),
                   gt-&gt;moving_object(j).base().acceleration().y(),
                   gt-&gt;moving_object(j).base().acceleration().z());
        }
<span class="preprocessor">#endif</span>

        <span class="comment">// Moving objects</span>
        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">stationary objects: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, gt-&gt;stationary_object_size());
    }

    SE_Close();

    <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_python_binding">14.4. Python binding</h3>
<div class="paragraph">
<p>A Python wrapper for esmini can easily be created using "ctypes" (thanks David Kaplan for the tip!). This section presents a few examples to get you started.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure the esminiLib is present in <code>esmini/bin</code> folder</p>
</li>
<li>
<p>Run the script examples from the <code>esmini/Hello-World_coding-example</code> folder</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_minimalistic_esmini_python_player">14.4.1. Minimalistic esmini Python player</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Python"><span class="keyword">import</span> <span class="include">ctypes</span>

se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/esminiLib.dll</span><span class="delimiter">&quot;</span></span>)
se.SE_Init(<span class="binary"><span class="modifier">b</span><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">2</span>)

<span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">range</span> (<span class="integer">500</span>):
    se.SE_Step()</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong> Library name varies with the platform as mentioned above (see <a href="#preparations">Preparations</a>)</p>
</div>
<div class="paragraph">
<p>Below is a bit more flexible variant:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Portable: Works on all supported platforms</p>
</li>
<li>
<p>Provide scenario via argument</p>
</li>
<li>
<p>Quit at press Escape or end of scenario</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example 13. <a href="https://github.com/esmini/esmini/tree/master/Hello-World_coding-example/esmini-player.py">Hello-World_coding-example/esmini-player.py</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">ctypes</span>
<span class="keyword">import</span> <span class="include">sys</span>

<span class="keyword">if</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux</span><span class="delimiter">&quot;</span></span> <span class="keyword">or</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux2</span><span class="delimiter">&quot;</span></span>:
    se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/libesminiLib.so</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">darwin</span><span class="delimiter">&quot;</span></span>:
    se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/libesminiLib.dylib</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">win32</span><span class="delimiter">&quot;</span></span>:
    se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/esminiLib.dll</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">else</span>:
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unsupported platform: {}</span><span class="delimiter">&quot;</span></span>.format(sys.platform))
    quit()

<span class="keyword">if</span> (<span class="predefined">len</span>(sys.argv) &lt; <span class="integer">2</span>):
    print(<span class="string"><span class="delimiter">'</span><span class="content">Usage: {} &lt;xosc file&gt;</span><span class="delimiter">'</span></span>.format(sys.argv[<span class="integer">0</span>]))
    <span class="predefined">exit</span>(-<span class="integer">1</span>)

se.SE_Init(sys.argv[<span class="integer">1</span>].encode(<span class="string"><span class="delimiter">'</span><span class="content">ascii</span><span class="delimiter">'</span></span>), <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>)

<span class="keyword">while</span> <span class="keyword">not</span> se.SE_GetQuitFlag():
    se.SE_Step()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_initialize_esmini_by_flexible_argument_list">14.4.2. Initialize esmini by flexible argument list</h4>
<div class="paragraph">
<p>Instead of using the limited <code>SE_Init()</code> function you can pass any arguments using <code>SE_InitWithArgs()</code></p>
</div>
<div class="listingblock">
<div class="title">Example 14. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/init_by_args.py">EnvironmentSimulator/code-examples/hello_world/init_by_args.py</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># initialize esmini with arguments instead of a few limited arguments</span>
<span class="comment"># using ideas from: https://comp.lang.python.narkive.com/RUdYlz64/trying-to-pass-sys-argv-as-int-argc-char-argv-using-ctypes</span>

<span class="keyword">import</span> <span class="include">ctypes</span> <span class="keyword">as</span> ct
<span class="keyword">import</span> <span class="include">sys</span>

<span class="keyword">if</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux</span><span class="delimiter">&quot;</span></span> <span class="keyword">or</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux2</span><span class="delimiter">&quot;</span></span>:
    se = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/libesminiLib.so</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">darwin</span><span class="delimiter">&quot;</span></span>:
    se = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/libesminiLib.dylib</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">win32</span><span class="delimiter">&quot;</span></span>:
    se = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/esminiLib.dll</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">else</span>:
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unsupported platform: {}</span><span class="delimiter">&quot;</span></span>.format(platform))
    quit()

<span class="comment"># specify arguments types of esmini function</span>
se.SE_InitWithArgs.argtypes = [ct.c_int, ct.POINTER(ct.POINTER(ct.c_char))]

<span class="comment"># create the list of arguments</span>
args = [
    <span class="string"><span class="delimiter">&quot;</span><span class="content">--window</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">60</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">60</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">800</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">400</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">--osc</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>,
    ]

<span class="comment"># prepare argument list for ctypes use</span>
argv = (ct.POINTER(ct.c_char) * <span class="predefined">len</span>(args))()
argc = <span class="predefined">len</span>(argv)
<span class="keyword">for</span> i, arg <span class="keyword">in</span> <span class="predefined">enumerate</span>(args):
    argv[i] = ct.create_string_buffer(arg.encode())

<span class="comment"># init esmini</span>
<span class="keyword">if</span> se.SE_InitWithArgs(argc, argv) != <span class="integer">0</span>:
    <span class="predefined">exit</span>(-<span class="integer">1</span>)

<span class="comment"># execute esmini until end of scenario or user requested quit by ESC key</span>
<span class="keyword">while</span> se.SE_GetQuitFlag() == <span class="integer">0</span>:
    se.SE_Step()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_forward_command_line_arguments">14.4.3. Forward command line arguments</h4>
<div class="paragraph">
<p>How to just forward any argument provided from command line:</p>
</div>
<div class="listingblock">
<div class="title">Example 15. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/forward_cmd_args.py">EnvironmentSimulator/code-examples/hello_world/forward_cmd_args.py</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># forward command line arguments to esmini</span>
<span class="comment"># using ideas from: https://comp.lang.python.narkive.com/RUdYlz64/trying-to-pass-sys-argv-as-int-argc-char-argv-using-ctypes</span>

<span class="keyword">import</span> <span class="include">ctypes</span> <span class="keyword">as</span> ct
<span class="keyword">import</span> <span class="include">sys</span>

<span class="keyword">if</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux</span><span class="delimiter">&quot;</span></span> <span class="keyword">or</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux2</span><span class="delimiter">&quot;</span></span>:
    se = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/libesminiLib.so</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">darwin</span><span class="delimiter">&quot;</span></span>:
    se = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/libesminiLib.dylib</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">win32</span><span class="delimiter">&quot;</span></span>:
    se = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/esminiLib.dll</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">else</span>:
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unsupported platform: {}</span><span class="delimiter">&quot;</span></span>.format(platform))
    quit()

<span class="comment"># specify arguments types of esmini function</span>
se.SE_InitWithArgs.argtypes = [ct.c_int, ct.POINTER(ct.POINTER(ct.c_char))]

<span class="comment"># fetch command line arguments</span>
argc = <span class="predefined">len</span>(sys.argv)
argv = (ct.POINTER(ct.c_char) * (argc + <span class="integer">1</span>))()
<span class="keyword">for</span> i, arg <span class="keyword">in</span> <span class="predefined">enumerate</span>(sys.argv):
    argv[i] = ct.create_string_buffer(arg.encode(<span class="string"><span class="delimiter">'</span><span class="content">utf-8</span><span class="delimiter">'</span></span>))

<span class="comment"># init esmini</span>
<span class="keyword">if</span> se.SE_InitWithArgs(argc, argv) != <span class="integer">0</span>:
    <span class="predefined">exit</span>(-<span class="integer">1</span>)

<span class="comment"># execute esmini until end of scenario or user requested quit by ESC key</span>
<span class="keyword">while</span> se.SE_GetQuitFlag() == <span class="integer">0</span>:
    se.SE_Step()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_get_object_states">14.4.4. Get object states</h4>
<div class="paragraph">
<p>How to retrieve the state of all scenario objects:</p>
</div>
<div class="listingblock">
<div class="title">Example 16. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/get_states.py">EnvironmentSimulator/code-examples/hello_world/get_states.py</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">ctypes</span>
<span class="keyword">from</span> <span class="include">sys</span> <span class="keyword">import</span> <span class="include">platform</span>

<span class="keyword">if</span> platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux</span><span class="delimiter">&quot;</span></span> <span class="keyword">or</span> platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux2</span><span class="delimiter">&quot;</span></span>:
    se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/libesminiLib.so</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">darwin</span><span class="delimiter">&quot;</span></span>:
    se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/libesminiLib.dylib</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">win32</span><span class="delimiter">&quot;</span></span>:
    se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/esminiLib.dll</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">else</span>:
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unsupported platform: {}</span><span class="delimiter">&quot;</span></span>.format(platform))
    quit()

<span class="comment"># Definition of SE_ScenarioObjectState struct</span>
<span class="keyword">class</span> <span class="class">SEScenarioObjectState</span>(ctypes.Structure):
    _fields_ = [
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">model_id</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">control</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">timestamp</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">z</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">h</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">roadId</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">junctionId</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">laneId</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">laneOffset</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">s</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">speed</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">centerOffsetX</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">centerOffsetY</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">centerOffsetZ</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">width</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">length</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">height</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">objectType</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">objectCategory</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">wheelAngle</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">wheelRot</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
    ]

se.SE_Init(<span class="binary"><span class="modifier">b</span><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>)

obj_state = SEScenarioObjectState()  <span class="comment"># object that will be passed and filled in with object state info</span>

<span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">range</span>(<span class="integer">500</span>):
    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="predefined">range</span>(se.SE_GetNumberOfObjects()):
        se.SE_GetObjectState(se.SE_GetId(j), ctypes.byref(obj_state))
        print(<span class="string"><span class="delimiter">'</span><span class="content">Frame {} Time {:.2f} ObjId {} roadId {} laneId {} laneOffset {:.2f} s {:.2f} x {:.2f} y {:.2f} heading {:.2f} speed {:.2f} wheelAngle {:.2f} wheelRot {:.2f}</span><span class="delimiter">'</span></span>.format(
            i, obj_state.timestamp, obj_state.id, obj_state.roadId, obj_state.laneId, obj_state.laneOffset,
            obj_state.s, obj_state.x, obj_state.y, obj_state.h, obj_state.speed * <span class="float">3.6</span>, obj_state.wheelAngle, obj_state.wheelRot))
    se.SE_Step()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_use_of_esminirmlib_roadmanager">14.4.5. Example use of esminiRMLib (RoadManager)</h4>
<div class="ulist">
<ul>
<li>
<p>Make sure the esminiRMLib is present in <code>esmini/bin</code> folder</p>
</li>
<li>
<p>In the code, check filepath to the OpenDRIVE file to load (current search path should work when script is copied to and run from the esmini/Hello-World_coding-example folder)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example 17. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/use_roadmanager.py">EnvironmentSimulator/code-examples/hello_world/use_roadmanager.py</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">ctypes</span> <span class="keyword">as</span> ct
<span class="keyword">import</span> <span class="include">sys</span>

<span class="keyword">if</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux</span><span class="delimiter">&quot;</span></span> <span class="keyword">or</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux2</span><span class="delimiter">&quot;</span></span>:
    rm = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/libesminiRMLib.so</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">darwin</span><span class="delimiter">&quot;</span></span>:
    rm = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/libesminiRMLib.dylib</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">win32</span><span class="delimiter">&quot;</span></span>:
    rm = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/esminiRMLib.dll</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">else</span>:
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unsupported platform: {}</span><span class="delimiter">&quot;</span></span>.format(sys.platform))
    sys.exit(-<span class="integer">1</span>)

<span class="comment"># Definition of RM_PositionData struct - should match esminiRMLib::RM_PositionData struct</span>
<span class="keyword">class</span> <span class="class">RM_PositionData</span>(ct.Structure):
    _fields_ = [
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">z</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">h</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">h_relative</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">road_id</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">junction_id</span><span class="delimiter">&quot;</span></span>, ct.c_int),  <span class="comment"># -1 if not in a junction</span>
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">lane_id</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">lane_offset</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">s</span><span class="delimiter">&quot;</span></span>, ct.c_float),
    ]

<span class="comment"># Specify argument types to a few functions</span>
rm.RM_SetWorldPosition.argtypes = [ct.c_int, ct.c_float, ct.c_float, ct.c_float, ct.c_float, ct.c_float, ct.c_float]
rm.RM_SetLanePosition.argtypes = [ct.c_int, ct.c_int, ct.c_int, ct.c_float, ct.c_float]


<span class="comment"># Initialize esmini RoadManger with given OpenDRIVE file</span>
odr = <span class="string"><span class="delimiter">'</span><span class="content">../resources/xodr/straight_500m.xodr</span><span class="delimiter">'</span></span>
<span class="keyword">if</span> rm.RM_Init(odr.encode()) == -<span class="integer">1</span>:   <span class="comment"># encode() converts string to pure byte array</span>
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to load OpenDRIVE file </span><span class="delimiter">&quot;</span></span>, )
    sys.exit(-<span class="integer">1</span>)

rm_pos = rm.RM_CreatePosition()  <span class="comment"># create a position object, returns a handle</span>
rm_pos_data = RM_PositionData()  <span class="comment"># object that will be passed and filled in with position info</span>

<span class="comment"># test a few positions</span>
x = <span class="integer">65</span>
y = -<span class="float">1.7</span>
rm.RM_SetWorldPosition(rm_pos, x, y, <span class="float">0.0</span>, <span class="float">0.0</span>, <span class="float">0.0</span>, <span class="float">0.0</span>)
rm.RM_GetPositionData(rm_pos, ct.byref(rm_pos_data))
print(<span class="string"><span class="delimiter">'</span><span class="content">road_id {} lane_id {} lane_offset {:.2f} s {:.2f}</span><span class="delimiter">'</span></span>.format(
    rm_pos_data.road_id, rm_pos_data.lane_id, rm_pos_data.lane_offset, rm_pos_data.s))

road_id = <span class="integer">1</span>
lane_id = <span class="integer">1</span>
lane_offset = -<span class="float">0.2</span>
s = <span class="integer">40</span>
rm.RM_SetLanePosition(rm_pos, road_id, lane_id, lane_offset, s)
rm.RM_GetPositionData(rm_pos, ct.byref(rm_pos_data))
print(<span class="string"><span class="delimiter">'</span><span class="content">x {:.2f} y {:.2f} h (yaw) {:.2f}</span><span class="delimiter">'</span></span>.format(
    rm_pos_data.x, rm_pos_data.y, rm_pos_data.h))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_storyboard_element_state_callback">14.4.6. Storyboard element state callback</h4>
<div class="paragraph">
<p>The following code shows how to get notification of storyboard events using StoryBoardElementStateChangeCallback.</p>
</div>
<div class="listingblock">
<div class="title">Example 18. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/storyboard_state_callback.py">EnvironmentSimulator/code-examples/hello_world/storyboard_state_callback.py</a> (complete code)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Storyboard element types (see OSCTypeDefs/OSCAction.hpp)</span>
sbe_type = {
    <span class="integer">0</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">UNDEFINED_ELEMENT_TYPE</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">1</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">STORY_BOARD</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">2</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">STORY</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">3</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">ACT</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">4</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">MANEUVER_GROUP</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">5</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">MANEUVER</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">6</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">EVENT</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">7</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">ACTION</span><span class="delimiter">&quot;</span></span>
}

<span class="comment"># Storyboard element states (see OSCTypeDefs/OSCAction.hpp)</span>
sbe_state = {
    <span class="integer">0</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">UNDEFINED_ELEMENT_STATE</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">1</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">STANDBY</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">2</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">RUNNING</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">3</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETE</span><span class="delimiter">&quot;</span></span>
}

<span class="comment"># Define callback for scenario storyboard element state changes</span>
<span class="comment"># according to function type: void (*fnPtr)(const char* name, int type, int state)</span>
<span class="comment"># required by SE_RegisterStoryBoardElementStateChangeCallback()</span>
<span class="keyword">def</span> <span class="function">callback</span>(name, <span class="predefined">type</span>, state, full_path):
    <span class="comment"># just print the received info</span>
    print(<span class="predefined">type</span>)
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">callback: {} ({}) state: {} full path: {}</span><span class="delimiter">&quot;</span></span>.format(codecs.decode(name), sbe_type[<span class="predefined">type</span>], sbe_state[state], codecs.decode(full_path), ))

callback_type = ct.CFUNCTYPE(<span class="predefined-constant">None</span>, ct.c_char_p, ct.c_int, ct.c_int, ct.c_char_p)
callback_func = callback_type(callback)

<span class="comment"># Initialize esmini before register the callback</span>
se.SE_AddPath(<span class="binary"><span class="modifier">b</span><span class="delimiter">&quot;</span><span class="content">../../../resources/xosc</span><span class="delimiter">&quot;</span></span>)  <span class="comment"># search path if run from original location</span>
se.SE_Init(<span class="binary"><span class="modifier">b</span><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">1</span>)

<span class="comment"># register the callback function</span>
se.SE_RegisterStoryBoardElementStateChangeCallback(callback_func)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_osi_groundtruth_2">14.4.7. OSI groundtruth</h4>
<div class="paragraph">
<p>OSI groundtruth can also be retrieved and processed via Python. The following code shows one way of doing it. This example also shows how the simulation can be encapsulated in a class.</p>
</div>
<div class="listingblock">
<div class="title">Example 19. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/osi_groundtruth.py">EnvironmentSimulator/code-examples/hello_world/osi_groundtruth.py</a> (complete code)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="docstring"><span class="delimiter">'''</span><span class="content">
</span><span class="content">   Python dependencies:</span><span class="content">
</span><span class="content">      pip install protobuf==3.20.2</span><span class="content">
</span><span class="content">
</span><span class="content">   Note: No need to install OSI as long as</span><span class="content">
</span><span class="content">   esmini/scripts/osi3 folder is available</span><span class="content">
</span><span class="delimiter">'''</span></span>

<span class="keyword">import</span> <span class="include">os</span>
<span class="keyword">import</span> <span class="include">sys</span>
<span class="keyword">import</span> <span class="include">ctypes</span> <span class="keyword">as</span> ct

<span class="comment"># Add scripts root directory to module search path in order to find osi3</span>
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), <span class="string"><span class="delimiter">'</span><span class="content">../../../</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">scripts</span><span class="delimiter">'</span></span>)))
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), <span class="string"><span class="delimiter">'</span><span class="content">..</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">scripts</span><span class="delimiter">'</span></span>)))  <span class="comment"># if script moved to Hello World folder</span>

<span class="keyword">from</span> <span class="include">osi3.osi_groundtruth_pb2</span> <span class="keyword">import</span> <span class="include">GroundTruth</span>

<span class="comment"># Import esmini lib</span>
<span class="keyword">if</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux</span><span class="delimiter">&quot;</span></span> <span class="keyword">or</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux2</span><span class="delimiter">&quot;</span></span>:
    se = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/libesminiLib.so</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">darwin</span><span class="delimiter">&quot;</span></span>:
    se = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/libesminiLib.dylib</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">win32</span><span class="delimiter">&quot;</span></span>:
    se = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">../bin/esminiLib.dll</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">else</span>:
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unsupported platform: {}</span><span class="delimiter">&quot;</span></span>.format(platform))
    quit()


<span class="comment"># Specify argument and return types of some esmini functions</span>
se.SE_GetOSIGroundTruth.restype = ct.c_void_p
se.SE_GetOSIGroundTruth.argtypes = [ct.c_void_p]
se.SE_StepDT.argtypes = [ct.c_float]

<span class="keyword">class</span> <span class="class">Sim</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="predefined-constant">self</span>, scenario):
        <span class="predefined-constant">self</span>.msg = GroundTruth()  <span class="comment"># OSI groundtruth message</span>
        <span class="predefined-constant">self</span>.msg_size = ct.c_int()
        <span class="keyword">if</span> se.SE_Init(scenario, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>) != <span class="integer">0</span>:
            print(<span class="string"><span class="delimiter">'</span><span class="content">Failed to open </span><span class="delimiter">'</span></span>, scenario)
            <span class="predefined">exit</span>(-<span class="integer">1</span>)

        <span class="predefined-constant">self</span>.GetAndPrintOSIInfo()  <span class="comment"># Initial state</span>

    <span class="comment"># Retrieve OSI message and print some info</span>
    <span class="keyword">def</span> <span class="function">GetAndPrintOSIInfo</span>(<span class="predefined-constant">self</span>):
        se.SE_UpdateOSIGroundTruth()

        msg_string = se.SE_GetOSIGroundTruth(ct.byref(<span class="predefined-constant">self</span>.msg_size))
        <span class="predefined-constant">self</span>.msg.ParseFromString(ct.string_at(msg_string, <span class="predefined-constant">self</span>.msg_size))

        <span class="comment"># Print some info</span>
        print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Timestamp: {:.2f}</span><span class="delimiter">&quot;</span></span>.format(<span class="predefined-constant">self</span>.msg.timestamp.seconds + <span class="float">1e-9</span> * <span class="predefined-constant">self</span>.msg.timestamp.nanos))
        <span class="keyword">for</span> j, o <span class="keyword">in</span> <span class="predefined">enumerate</span>(<span class="predefined-constant">self</span>.msg.moving_object):
            print(<span class="string"><span class="delimiter">'</span><span class="content">   Object[{}] id {}</span><span class="delimiter">'</span></span>.format(j, o.id.value))
            print(<span class="string"><span class="delimiter">'</span><span class="content">      pos.x {:.2f} pos.y {:.2f} rot.h {:.2f}</span><span class="delimiter">'</span></span>.format(\
                o.base.position.x,\
                o.base.position.y,\
                o.base.orientation.yaw))
            print(<span class="string"><span class="delimiter">'</span><span class="content">      vel.x {:.2f} vel.y {:.2f} rot_rate.h {:.2f}</span><span class="delimiter">'</span></span>.format(\
                o.base.velocity.x,\
                o.base.velocity.y,\
                o.base.orientation_rate.yaw))
            print(<span class="string"><span class="delimiter">'</span><span class="content">      acc.x {:.2f} acc.y {:.2f} rot_acc.h {:.2f}</span><span class="delimiter">'</span></span>.format(\
                o.base.acceleration.x,\
                o.base.acceleration.y,\
                o.base.orientation_acceleration.yaw))


    <span class="keyword">def</span> <span class="function">Run</span>(<span class="predefined-constant">self</span>):
        <span class="keyword">while</span> se.SE_GetQuitFlag() != <span class="integer">1</span>:
            se.SE_StepDT(<span class="float">0.05</span>)
            <span class="predefined-constant">self</span>.GetAndPrintOSIInfo()  <span class="comment"># Updated state</span>

        se.SE_Close()

<span class="keyword">if</span> __name__ == <span class="string"><span class="delimiter">'</span><span class="content">__main__</span><span class="delimiter">'</span></span>:
    <span class="comment"># Execute when the module is not initialized from an import statement.</span>

    sim = Sim(<span class="binary"><span class="modifier">b</span><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>)
    sim.Run()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_object_state_callback">14.4.8. Object state callback</h4>
<div class="paragraph">
<p><mark>Advanced</mark></p>
</div>
<div class="paragraph">
<p>Controllers and callbacks can also be utilized via Python. Following code drafts how to grab state of the first scenario object and then, in a callback, manipulate it and report back. If used in combination with ExternalController in mode=additive the scenario action are applied first. On the contrary, if used with mode=override, the scenario actions will not be applied giving exclusive control to the external callback function.</p>
</div>
<div class="listingblock">
<div class="title">Example 20. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/object_callback.py">EnvironmentSimulator/code-examples/hello_world/object_callback.py</a> (complete code)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Definition of SE_ScenarioObjectState struct</span>
<span class="keyword">class</span> <span class="class">SEScenarioObjectState</span>(ct.Structure):
    _fields_ = [
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">model_id</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">control</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">timestamp</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">z</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">h</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">roadId</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">junctionId</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">laneId</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">laneOffset</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">s</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">speed</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">centerOffsetX</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">centerOffsetY</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">centerOffsetZ</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">width</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">length</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">height</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">objectType</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">objectCategory</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">wheel_angle</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">wheel_rot</span><span class="delimiter">&quot;</span></span>, ct.c_float),
    ]


<span class="comment"># Define callback for scenario object enabling manipulating the state AFTER scenario step but BEFORE OSI output</span>
<span class="comment"># Use in combination with ExternalController in mode=additive in order for scenario actions to be applied first</span>
<span class="keyword">def</span> <span class="function">callback</span>(state_ptr, b):
    state = state_ptr.contents
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">callback for obj {}: x={:.2f} y={:.2f} h={:.2f}</span><span class="delimiter">&quot;</span></span>.format(state.id, state.x, state.y, state.h))
    se.SE_ReportObjectPosXYH(ct.c_int(state.id), ct.c_float(state.timestamp), ct.c_float(state.x + <span class="float">0.02</span>), ct.c_float(state.y), ct.c_float(state.h + <span class="float">0.001</span>))

callback_type = ct.CFUNCTYPE(<span class="predefined-constant">None</span>, ct.POINTER(SEScenarioObjectState), ct.c_void_p)
callback_func = callback_type(callback)

<span class="comment"># Initialize esmini before register the callback</span>
se.SE_AddPath(<span class="binary"><span class="modifier">b</span><span class="delimiter">&quot;</span><span class="content">../../../resources/xosc</span><span class="delimiter">&quot;</span></span>)  <span class="comment"># search path if run from original location</span>
se.SE_Init(<span class="binary"><span class="modifier">b</span><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">1</span>)

<span class="comment"># register callback for first object (id=0)</span>
se.SE_RegisterObjectCallback(<span class="integer">0</span>, callback_func, <span class="integer">0</span>)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_c_binding">14.5. C# binding</h3>
<div class="paragraph">
<p>A C# wrapper for the esminiLib is provided (<a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Libraries/esminiLib/ESMiniWrapper.cs">ESMiniWrapper.cs</a>). Coverage is limited, but it might serve as a good starting point.</p>
</div>
<div class="sect3">
<h4 id="_osi_groundtruth_with_c">14.5.1. OSI groundtruth with C#</h4>
<div class="listingblock">
<div class="title">Example 21. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/osi-groundtruth-cs/osi-gt.cs">EnvironmentSimulator/code-examples/osi-groundtruth-cs/osi-gt.cs</a> (complete code)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="directive">using</span> System;
<span class="directive">using</span> System.Runtime.InteropServices;
<span class="directive">using</span> ESMini;

<span class="directive">using</span> Google.Protobuf;

<span class="directive">using</span> <span class="directive">static</span> Osi3.GroundTruth;

<span class="keyword">namespace</span> esmini_csharp
{
    <span class="keyword">class</span> <span class="class">Program</span>
    {
        <span class="directive">static</span> <span class="directive">void</span> Main(<span class="predefined-type">string</span>[] args)
        {
            <span class="comment">// intitialize esmini</span>
            <span class="keyword">if</span> (ESMiniLib.SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>) != <span class="integer">0</span>)
            {
                Console.WriteLine(<span class="string"><span class="delimiter">&quot;</span><span class="content">failed to load scenario</span><span class="delimiter">&quot;</span></span>);
                <span class="keyword">return</span>;
            }
            ESMiniLib.SE_UpdateOSIGroundTruth();

            <span class="predefined-type">int</span> size = <span class="integer">0</span>;
            <span class="keyword">while</span> (ESMiniLib.SE_GetQuitFlag() != <span class="integer">1</span>)
            {
                <span class="comment">// Step esmini</span>
                ESMiniLib.SE_Step();
                ESMiniLib.SE_UpdateOSIGroundTruth();

                <span class="comment">// Get OSI message</span>
                IntPtr int_ptr = ESMiniLib.SE_GetOSIGroundTruth(ref size);
                Byte[] byte_array = <span class="keyword">new</span> Byte[size];
                Marshal.Copy(int_ptr, byte_array, <span class="integer">0</span>, size);
                Osi3.GroundTruth gt_msg = Osi3.GroundTruth.Parser.ParseFrom(byte_array);

                <span class="comment">// Write some info from OSI message</span>
                Console.WriteLine(<span class="string"><span class="delimiter">&quot;</span><span class="content">Time: {0:N3}</span><span class="delimiter">&quot;</span></span>, gt_msg.Timestamp.Seconds + <span class="float">1</span>e-<span class="integer">9</span> * gt_msg.Timestamp.Nanos);
                foreach (Osi3.MovingObject o in gt_msg.MovingObject)
                {
                    Console.WriteLine(<span class="string"><span class="delimiter">&quot;</span><span class="content">  Object[{0}], Pos: {1:N2}, {2:N2}, {3:N2}</span><span class="delimiter">&quot;</span></span>,
                        o.Id.Value, o.Base.Position.X, o.Base.Position.Y, o.Base.Position.Z);
                }
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows, one way, how to access OSI data in a C# environment.</p>
</div>
<div class="paragraph">
<p>It&#8217;s dependent on the <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Libraries/esminiLib/ESMiniWrapper.cs">ESMiniWrapper.cs</a>, and targeting Windows environment. If the wrapper is modified to work on Linux (referring .so instead of DLL) it might work there as well, but it&#8217;s not been tested.</p>
</div>
<div class="sect4">
<h5 id="_build_4">Build</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>mkdir build
cd build
cmake ..
cmake --build . --config Release</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_run_3">Run</h5>
<div class="paragraph">
<p>To have the correct relative path to the scenario file and also access to esminiLib we move into <code>esmini/bin</code> folder for running the example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd ..\..\..\..\bin
..\EnvironmentSimulator\code-examples\osi-groundtruth-cs\build\Release\osi-groundtruth.exe</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_how_to_create_the_osi3_c_files">How to create the osi3 C# files</h5>
<div class="paragraph">
<p>For this example the osi3 C# files were provided. If you need or want to compile them yourself:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get protoc compiler<br>
Suggested version: 3.15.2<br>
Either build it yourself or get <code>protoc-3.15.2-win64.zip</code> from release:<br>
<a href="https://github.com/protocolbuffers/protobuf/releases/tag/v3.15.2" class="bare">https://github.com/protocolbuffers/protobuf/releases/tag/v3.15.2</a></p>
</li>
<li>
<p>Get OSI<br>
<a href="https://github.com/OpenSimulationInterface/open-simulation-interface/releases/tag/v3.5.0" class="bare">https://github.com/OpenSimulationInterface/open-simulation-interface/releases/tag/v3.5.0</a><br></p>
</li>
<li>
<p>OSI proto files need to be converted for protobuf v3. This is easily done with the provided script:<br>
<code>./convert-to-proto3.sh</code></p>
</li>
<li>
<p>Compile for C#</p>
<div class="ulist">
<ul>
<li>
<p>open a command line in <code>open-simulation-interface</code> root folder</p>
</li>
<li>
<p><code>c:\my_path_to_protoc\protoc.exe *.proto --csharp_out=.</code><br>
will create C# versions of all proto files</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scenario_construction_tips">15. Scenario construction tips</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We often get questions regarding construction of scenarios. We also have seen many scenarios that could be improved in various ways.</p>
</div>
<div class="paragraph">
<p>As long as a scenario validates (try <a href="https://github.com/esmini/esmini/blob/dev/scripts/run_schema_comply.py">run_schema_comply.py</a>) and runs as expected, the scenario does the job. One beauty of OpenSCENARIO XML and OpenDRIVE is the low threshold to get started.</p>
</div>
<div class="paragraph">
<p>For example, consider recorded scenarios: Roads can be represented in OpenDRIVE by a sequence of line segments, connecting measure points. Similarly, recorded driving data can easily be converted into OpenSCENARIO XML polyline trajectories.</p>
</div>
<div class="paragraph">
<p>Although the above approach is easy, it results in inefficient (large data), non precise (line segments approximating the real world scenario). Also, the line-segments approach results in gaps and/or discontinuities which might cause trouble for sensor models.</p>
</div>
<div class="paragraph">
<p>In this section we present a few learnings and ideas on how scenarios can be designed in a way unlocking the full potential of the standards in terms of quality, flexibility, efficiency, and control.</p>
</div>
<div class="sect2">
<h3 id="_opendrive">15.1. OpenDRIVE</h3>
<div class="ulist">
<ul>
<li>
<p>The tangent of the road geometry should be continuous. So, curves should not be implemented as piecewise linear segments. For inspiration how to create curves from linear segments, see script example <a href="https://github.com/esmini/esmini/blob/dev/scripts/xodr_lines2curves.py">xodr_lines2curves.py</a>.</p>
</li>
<li>
<p>For constructed roads it works well with line and/or arc segments, connected by clothoid segments ensuring continuous curvature change-rate. See steering wheel figure in
<a href="https://publications.pages.asam.net/standards/ASAM_OpenDRIVE/ASAM_OpenDRIVE_Specification/latest/specification/09_geometries/09_01_introduction.html">OpenDRIVE geometry section</a>.</p>
</li>
<li>
<p>For measured roads it&#8217;s typically better to use parametric curves, <a href="https://publications.pages.asam.net/standards/ASAM_OpenDRIVE/ASAM_OpenDRIVE_Specification/latest/specification/09_geometries/09_06_param_poly3.html">paramPoly3</a>.</p>
</li>
<li>
<p>Connected roads needs to be without gaps and overlaps. See <a href="https://publications.pages.asam.net/standards/ASAM_OpenDRIVE/ASAM_OpenDRIVE_Specification/latest/specification/10_roads/10_03_road_linkage.html">Road Linkage</a>.</p>
</li>
<li>
<p>Longer geometries, lane sections and road elements are preferred. Variations along the road, for example adding or removing lanes, can be done with <a href="https://publications.pages.asam.net/standards/ASAM_OpenDRIVE/ASAM_OpenDRIVE_Specification/latest/specification/11_lanes/11_03_lane_sections.html">lane sections</a> rather than separate road segments.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_openscenario_xml">15.2. OpenSCENARIO XML</h3>
<div class="ulist">
<ul>
<li>
<p>Whenever possible, make use of OpenSCENARIO XML <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/LongitudinalAction.html">longitudinal</a> and <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/LateralAction.html">lateral</a> actions. When that&#8217;s not feasible, its useful to define <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/FollowTrajectoryAction.html">trajectories</a>.</p>
</li>
<li>
<p>The shape within the trajectory element should be selected with care. For smooth trajectories, e.g. lane changes, we recommend <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/Nurbs.html">NURBS</a>, with as sparse control points as feasible.</p>
</li>
<li>
<p>In general, we encourage to use <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/LanePosition.html">LanePosition</a> (road, lane, s, laneOffset), or when plausible, <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/RoadPosition.html">RoadPosition</a> (road, s, t) in favor of <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/WorldPosition.html">WorldPosition</a> (X, Y). Then actions and trajectories can be parameterized more easily and adapted to various roads, including various curvatures. For inspiration how X, Y positions can be converted into LanePositions, see script example <a href="https://github.com/esmini/esmini/blob/dev/EnvironmentSimulator/code-examples/convert_position_type/manipulate_positions.py">manipulate_positions.py</a>.</p>
</li>
<li>
<p>Make sure the reference point for vehicles is mid rear axle, projected on ground, as defined <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/06_general_concepts/06_03_coordinate_systems.html#_vehicle_coordinate_system_xv_yv_zv">here</a> by the standard.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We also get questions what are the most important actions and conditions. It&#8217;s hard to rank, but here follows a few ones we found useful.</p>
</div>
<div class="sect3">
<h4 id="_actions">15.2.1. Actions</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/TeleportAction.html">TeleportAction</a> (most often used to establish entity initial position)</p>
</li>
<li>
<p>All basic <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/LongitudinalAction.html">longitudinal</a> and <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/LateralAction.html">lateral</a> actions</p>
</li>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/AssignRouteAction.html">AssignRouteAction</a> (to ensure expected and deterministic choices in junctions)</p>
</li>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/FollowTrajectoryAction.html">FollowTrajectoryAction</a></p>
</li>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/SpeedProfileAction.html">SpeedProfileAction</a> (sometimes useful for defining speed while follow trajectory, provides detailed control of speed)</p>
</li>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/SynchronizeAction.html">SynchronizeAction</a> (useful in NCAP scenarios, for example. See <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/07_components_scenario/07_04_actions.html#_types_of_private_action">here</a> for further description)</p>
</li>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/EntityAction.html">EntityAction</a> (Useful for recorded scenarios where road users enters and exits the scene)</p>
</li>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/ControllerAction.html">ControllerAction</a> (hand over control to  external function, driver model, driver-in-the-loop&#8230;&#8203;)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_conditions">15.2.2. Conditions</h4>
<div class="paragraph">
<p>Make use of the AND/OR logics based on combination of conditions and condition groups as described <a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/07_components_scenario/07_06_conditions_triggers.html#_triggers_and_condition_groups">here</a>.</p>
</div>
<div class="paragraph">
<p>Commonly used conditions are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/RelativeDistanceCondition.html">RelativeDistanceCondition</a></p>
</li>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/DistanceCondition.html">DistanceCondition</a></p>
</li>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/TimeHeadwayCondition.html">TimeHeadwayCondition</a></p>
</li>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/TimeToCollisionCondition.html">TimeToCollisionCondition</a></p>
</li>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/TraveledDistanceCondition.html">TraveledDistanceCondition</a></p>
</li>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/SimulationTimeCondition.html">SimulationTimeCondition</a></p>
</li>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/StoryboardElementStateCondition.html">StoryboardElementStateCondition</a></p>
</li>
<li>
<p><a href="https://publications.pages.asam.net/standards/ASAM_OpenSCENARIO/ASAM_OpenSCENARIO_XML/latest/generated/content/VariableCondition.html">VariableCondition</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scenario_creation_tips_examples">15.3. Examples</h3>
<div class="paragraph">
<p>Here follows a few scenario examples highlighting various useful features.</p>
</div>
<div class="paragraph">
<p>To run the examples, grab and unzip the latest esmini <strong>demo</strong> (not bin) package, from <a href="https://github.com/esmini/esmini/releases/latest">here</a>. The run instructions assume youre located in esmini root folder.</p>
</div>
<div class="sect3">
<h4 id="_example_1_scenario_nurb_straight_road">15.3.1. Example 1: scenario_nurb_straight_road</h4>
<div class="paragraph">
<p>Scenariofile: <a href="https://github.com/esmini/esmini/blob/dev/resources/scenario_construct_examples/scenario_nurb_straight_road.xosc">scenario_nurb_straight_road.xosc</a></p>
</div>
<div class="paragraph">
<p>Target car (blue) cutting in, in front of Ego</p>
</div>
<div class="videoblock">
<div class="content">
<iframe width="800" height="450" src="https://www.youtube.com/embed/BnlQYsGqP-k?rel=0&amp;autoplay=1&amp;loop=1&amp;controls=0&amp;playlist=BnlQYsGqP-k" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="sect4">
<h5 id="_about_the_lane_change_action">About the lane change action</h5>
<div class="paragraph">
<p>Based on NURBS curve makes it smooth in multiple degrees, and cheap in terms of storage (just a few control points compared to polylines, which typically results in non-continuous tangent and large files due to many vertices).</p>
</div>
<div class="paragraph">
<p>Position of each control points is defined in terms of road coordinates (s, t), which makes it adapt to whatever road geometry. In other words, it works for any curvature. Further the <code>s</code> and <code>t</code> coordinates are parametric which makes it easy to customize the characteristics of the lane chance, e.g. duration and adapt to various lane widths.</p>
</div>
</div>
<div class="sect4">
<h5 id="_about_the_speed_profile">About the speed profile</h5>
<div class="paragraph">
<p>Compared to a sequence of individual SpeedActions, the SpeedProfile allows for any number of timestamped speed targets within one single action. Additionally, it offers much better control of the resulting profile curve (speed over time). E.g. user can specify max acceleration and jerk avoiding discontinuities.</p>
</div>
<div class="paragraph">
<p>Run as:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/scenario_construct_examples/scenario_nurb_straight_road.xosc</code></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_2_scenario_nurb_curved_road">15.3.2. Example 2: scenario_nurb_curved_road</h4>
<div class="paragraph">
<p>Scenariofile: <a href="https://github.com/esmini/esmini/blob/dev/resources/scenario_construct_examples/scenario_nurb_curved_road.xosc">scenario_nurb_curved_road.xosc</a></p>
</div>
<div class="paragraph">
<p>Same as above, but now with a curved road, demonstrating the adaptiveness of the lane change trajectory.</p>
</div>
<div class="videoblock">
<div class="content">
<iframe width="800" height="450" src="https://www.youtube.com/embed/p8YqZmDfLbM?rel=0&amp;autoplay=1&amp;loop=1&amp;controls=0&amp;playlist=p8YqZmDfLbM" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>Run as:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/scenario_construct_examples/scenario_nurb_curved_road.xosc</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_example_3_scenario_runner_with_acts">15.3.3. Example 3: scenario_runner_with_acts</h4>
<div class="paragraph">
<p>Scenariofile: <a href="https://github.com/esmini/esmini/blob/dev/resources/scenario_construct_examples/scenario_runner_with_acts.xosc">scenario_runner_with_acts.xosc</a></p>
</div>
<div class="paragraph">
<p>Another cut-in scenario. This example demonstrates how scenarios can refer to maneuvers in external catalogs.</p>
</div>
<div class="videoblock">
<div class="content">
<iframe width="800" height="450" src="https://www.youtube.com/embed/vpmcrKPz5eU?rel=0&amp;autoplay=1&amp;loop=1&amp;controls=0&amp;playlist=vpmcrKPz5eU" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>This scenario also makes use of headway time and relative distance conditions to create a combined condition that trigger only when target is ahead of Ego (distance measurements are absolute in OpenSCENARIO). The measurements are performed in road longitudinal coordinates, taking any curvature into account hence making the scenario fit any road geometry.</p>
</div>
<div class="paragraph">
<p>Run as:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/scenario_construct_examples/scenario_runner_with_acts.xosc</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_example_4_ltap_od">15.3.4. Example 4: ltap-od</h4>
<div class="paragraph">
<p>Scenariofile: <a href="https://github.com/esmini/esmini/blob/dev/resources/xosc/ltap-od.xosc">ltap-od.xosc</a></p>
</div>
<div class="paragraph">
<p>Ego and target approaching intersection from opposites directions. Ego plan to go straight, target plan to turn left. To enforce a critical situation target is assigned a SynchronizeAction which will adapt its speed so that it arrives at the intersection whenever Ego is.</p>
</div>
<div class="videoblock">
<div class="content">
<iframe width="800" height="450" src="https://www.youtube.com/embed/PQ3dZJ8wpuI?rel=0&amp;autoplay=1&amp;loop=1&amp;controls=0&amp;playlist=PQ3dZJ8wpuI" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>In this example an interactive controller is assigned to Ego, allowing the user to control it with the arrow keys. The controller can be removed or disabled.</p>
</div>
<div class="paragraph">
<p>Run as:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/ltap-od.xosc</code></p>
</div>
<div class="paragraph">
<p>Drive Ego with arrow keys.</p>
</div>
<div class="paragraph">
<p>Disable controller:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/ltap-od.xosc --disable_controllers</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_example_5_cut_in">15.3.5. Example 5: cut-in</h4>
<div class="paragraph">
<p>Scenariofile: <a href="https://github.com/esmini/esmini/blob/dev/resources/xosc/cut-in.xosc">cut-in.xosc</a></p>
</div>
<div class="videoblock">
<div class="content">
<iframe width="800" height="450" src="https://www.youtube.com/embed/9qvDUpq7XM4?rel=0&amp;autoplay=1&amp;loop=1&amp;controls=0&amp;playlist=9qvDUpq7XM4" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>Red target car drives 20% faster than Ego, so the overtake is inevitable. Target will then perform lane change and brake maneuvers triggered by different HWT conditions.</p>
</div>
<div class="paragraph">
<p>This scenario demonstrates how SpeedAction can operate in a continuous mode, maintaining a relative speed specified either as offset or factor.</p>
</div>
<div class="paragraph">
<p>Run as:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc</code></p>
</div>
<div class="paragraph">
<p>Interactive variant:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in_interactive.xosc</code></p>
</div>
<div class="paragraph">
<p>Drive with arrow keys, notice how the red car adapts to Ego speed.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_run_asam_openscenario_examples">16. Run ASAM OpenSCENARIO examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With some limitations (see details <a href="https://github.com/esmini/esmini/blob/master/osc_coverage.txt">here</a>) esmini can play the example scenarios provided with the ASAM OpenSCENARIO v1.1 release bundle.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you don&#8217;t have esmini already, download latest demo package for your platform from <a href="https://github.com/esmini/esmini/releases/latest">here</a>.</p>
</li>
<li>
<p>Download the standard from ASAM <a href="https://www.asam.net/standards/detail/openscenario">here</a> (register and download is free of charge).</p>
</li>
<li>
<p>Extract to any folder.</p>
</li>
<li>
<p>Run the examples from command line in esmini root folder, for example: <br>
<code>./bin/esmini --window 60 60 800 400 --osc ../../openscenario-v1.1.0/Examples/DoubleLaneChanger.xosc</code><br>
  or with absolute path: <br>
<code>./bin/esmini --window 60 60 800 400 --osc c:/stuff/openscenario-v1.1.0/Examples/DoubleLaneChanger.xosc</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_about_this_document">17. About this document</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://github.com/esmini/esmini/blob/master/docs/user_guide.adoc">source</a> of this document is written in the <a href="https://asciidoc-py.github.io/index.html">asciidoc</a> format.</p>
</div>
<div class="sect2">
<h3 id="_how_to_generate_html_from_asciidoc">17.1. How to generate HTML from AsciiDoc</h3>
<div class="paragraph">
<p>The html is generated with <a href="https://asciidoctor.org/">asciidoctor</a>. Code snippets, images and other resources are included in the process. Also the version numbers are automatically inserted to avoid "human errors".</p>
</div>
<div class="paragraph">
<p>The final HTML document is published in this repo: <a href="https://github.com/esmini/esmini.github.io" class="bare">https://github.com/esmini/esmini.github.io</a></p>
</div>
<div class="paragraph">
<p>Access URL: <a href="https://esmini.github.io/" class="bare">https://esmini.github.io/</a></p>
</div>
<div class="paragraph">
<p>Install tools:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>Linux</strong>
</td>
<td class="hdlist2">
<p><code>sudo apt install asciidoctor</code><br>
<code>sudo apt install ruby-coderay</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Windows</strong>
</td>
<td class="hdlist2">
<div class="ulist">
<ul>
<li>
<p>First, if not already done, install ruby:<br></p>
<div class="ulist">
<ul>
<li>
<p>Pick latest Ruby x64 package, without devkit, here: <a href="https://rubyinstaller.org/downloads/" class="bare">https://rubyinstaller.org/downloads/</a><br></p>
</li>
<li>
<p>Install it. In the end you can leave "Run 'rid install' to setup MSYS2 and development toolchain" un-checked<br></p>
</li>
</ul>
</div>
</li>
<li>
<p>Then run:<br>
<code>gem install asciidoctor</code><br>
<code>gem install coderay</code><br></p>
<div class="paragraph">
<p>Troubleshooting: If you get an error like<br>
<code>Unable to download data from <a href="https://rubygems.org/" class="bare">https://rubygems.org/</a> - SSL_connect &#8230;&#8203;</code><br>
try update RubyGems as follows:<br>
<code>gem update --system</code></p>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Generate html: <code>asciidoctor user_guide.adoc -o index.html</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_view_previous_versions">17.2. How to view previous versions</h3>
<div class="paragraph">
<p>Full commit history is found <a href="https://github.com/esmini/esmini.github.io/commits/main">here</a></p>
</div>
<div class="paragraph">
<p>To view a previous version, utilizing <a href="https://htmlpreview.github.io/">htmlpreview.github.io</a>, either refer to a <a href="https://github.com/esmini/esmini.github.io/tags">tag</a>, like this:</p>
</div>
<div class="paragraph">
<p><code><a href="https://htmlpreview.github.io/?https://raw.githubusercontent.com/esmini/esmini.github.io/refs/tags/v2.42.0/index.html" class="bare">https://htmlpreview.github.io/?https://raw.githubusercontent.com/esmini/esmini.github.io/refs/tags/v2.42.0/index.html</a></code></p>
</div>
<div class="paragraph">
<p>or refer to any commit, like this:</p>
</div>
<div class="paragraph">
<p><code><a href="https://htmlpreview.github.io/?https://raw.githubusercontent.com/esmini/esmini.github.io/47a9267a5935d0bd2648950e4d9d3e23f1e8ff3a/index.html" class="bare">https://htmlpreview.github.io/?https://raw.githubusercontent.com/esmini/esmini.github.io/47a9267a5935d0bd2648950e4d9d3e23f1e8ff3a/index.html</a></code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_version">18. Version</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ESMINI_GIT_TAG="v2.45.1"<br>
ESMINI_GIT_REV="v2.45.1-0-e9032d96"</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-01-30 13:06:46 +0100
</div>
</div>
</body>
</html>