<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>esmini user guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>esmini user guide</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a></li>
<li><a href="#_getting_started">2. Getting started</a>
<ul class="sectlevel2">
<li><a href="#_run_esmini">2.1. Run esmini</a></li>
<li><a href="#_get_complete_esmini">2.2. Get complete esmini</a></li>
<li><a href="#_build_esmini_quick_guide">2.3. Build esmini - quick guide</a></li>
</ul>
</li>
<li><a href="#_tools_overview">3. Tools overview</a></li>
<li><a href="#_use_cases">4. Use cases</a>
<ul class="sectlevel2">
<li><a href="#_view_a_scenario">4.1. View a scenario</a>
<ul class="sectlevel3">
<li><a href="#_basic_features">4.1.1. Basic features</a></li>
<li><a href="#_camera_control">4.1.2. Camera control</a></li>
<li><a href="#_some_key_shortcut_commands">4.1.3. Some key shortcut commands</a></li>
<li><a href="#_road_network_visualization">4.1.4. Road network visualization</a></li>
<li><a href="#_background_color">4.1.5. Background color</a></li>
<li><a href="#_anti_alias">4.1.6. Anti-alias</a></li>
</ul>
</li>
<li><a href="#_screenshots_and_video_clips">4.2. Screenshots and video clips</a>
<ul class="sectlevel3">
<li><a href="#_save_screenshots">4.2.1. Save screenshots</a></li>
<li><a href="#_create_video_clip_of_a_scenario">4.2.2. Create video clip of a scenario</a></li>
<li><a href="#_off_screen_rendering">4.2.3. Off-screen rendering</a></li>
<li><a href="#_software_rendering_no_gfx_hw">4.2.4. Software rendering (no gfx hw)</a></li>
</ul>
</li>
<li><a href="#_logging">4.3. Logging</a>
<ul class="sectlevel3">
<li><a href="#_the_basic_text_log_file">4.3.1. The basic text log file</a></li>
<li><a href="#_scenario_recording_dat">4.3.2. Scenario recording (.dat)</a></li>
<li><a href="#_csv_logger">4.3.3. CSV logger</a></li>
</ul>
</li>
<li><a href="#_replay_scenario">4.4. Replay scenario</a>
<ul class="sectlevel3">
<li><a href="#_multiple_scenarios_in_parallel">4.4.1. Multiple scenarios in parallel</a></li>
<li><a href="#_save_merged_dat_files">4.4.2. Save merged .dat files</a></li>
</ul>
</li>
<li><a href="#_view_road_network">4.5. View road network</a>
<ul class="sectlevel3">
<li><a href="#_visualize_opendrive_geometry">4.5.1. Visualize OpenDRIVE geometry</a></li>
<li><a href="#_evaluate_opendrive_connectivity">4.5.2. Evaluate OpenDRIVE connectivity</a></li>
<li><a href="#_inspect_opendrive_geometry_and_road_ids">4.5.3. Inspect OpenDRIVE geometry and road IDs</a></li>
</ul>
</li>
<li><a href="#_plot_scenario_data">4.6. Plot scenario data</a></li>
<li><a href="#_save_osi_data">4.7. Save OSI data</a></li>
</ul>
</li>
<li><a href="#_scenario_features">5. Scenario features</a>
<ul class="sectlevel2">
<li><a href="#_speed_profile">5.1. Speed profile</a>
<ul class="sectlevel3">
<li><a href="#_special_case_single_entry">5.1.1. Special case: Single entry</a></li>
<li><a href="#_what_if_current_speed_differ_from_the_first_entry">5.1.2. What if current speed differ from the first entry?</a></li>
<li><a href="#_what_if_time_is_missing_in_entry">5.1.3. What if time is missing in entry?</a></li>
<li><a href="#_initial_acceleration_taken_into_account">5.1.4. Initial acceleration taken into account</a></li>
<li><a href="#_sharp_brake_to_stop_profile">5.1.5. Sharp brake-to-stop profile</a></li>
<li><a href="#_more_info">5.1.6. More info</a></li>
</ul>
</li>
<li><a href="#_road_signs">5.2. Road signs</a>
<ul class="sectlevel3">
<li><a href="#_the_system">5.2.1. The system</a></li>
<li><a href="#_esmini_sign_catalogs">5.2.2. esmini sign catalogs</a></li>
<li><a href="#_sign_3d_models">5.2.3. Sign 3D models</a></li>
<li><a href="#_example">5.2.4. Example</a></li>
</ul>
</li>
<li><a href="#_expressions">5.3. Expressions</a></li>
</ul>
</li>
<li><a href="#_controllers">6. Controllers</a>
<ul class="sectlevel2">
<li><a href="#_controller_concept">6.1. Controller concept</a></li>
<li><a href="#_background_and_motivation">6.2. Background and motivation</a></li>
<li><a href="#_brief_on_implementation">6.3. Brief on implementation</a></li>
<li><a href="#_how_it_works_for_the_user">6.4. How it works for the user</a></li>
<li><a href="#_the_ghost_concept">6.5. The ghost concept</a></li>
<li><a href="#_esmini_embedded_controllers">6.6. esmini embedded controllers</a>
<ul class="sectlevel3">
<li><a href="#_defaultcontroller">6.6.1. DefaultController</a></li>
<li><a href="#_interactivecontroller">6.6.2. InteractiveController</a></li>
<li><a href="#_followghost">6.6.3. FollowGhost</a></li>
<li><a href="#_externalcontroller">6.6.4. ExternalController</a></li>
<li><a href="#_sumocontroller">6.6.5. SumoController</a></li>
<li><a href="#_alks_r157sm">6.6.6. ALKS_R157SM</a></li>
<li><a href="#_followroute">6.6.7. FollowRoute</a></li>
<li><a href="#_udpdrivercontroller">6.6.8. UDPDriverController</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_openscenegraph_and_3d_models">7. OpenSceneGraph and 3D models</a>
<ul class="sectlevel2">
<li><a href="#_get_osgconv">7.1. Get osgconv</a></li>
<li><a href="#_convert_osgb_models_for_use_in_unity">7.2. Convert osgb models for use in Unity</a></li>
<li><a href="#_import_into_unity">7.3. Import into Unity</a></li>
<li><a href="#_colors_textures_and_wheel_rotations">7.4. Colors, textures and wheel rotations</a></li>
</ul>
</li>
<li><a href="#_support_qa">8. Support / Q&amp;A</a>
<ul class="sectlevel2">
<li><a href="#_resources_not_found">8.1. Resources not found</a></li>
<li><a href="#_mac_issues_and_limitations">8.2. Mac issues and limitations</a></li>
<li><a href="#_openstreetmap_osm_roads_in_esmini">8.3. OpenStreetMap (OSM) roads in esmini</a></li>
<li><a href="#_update_3d_model_pack">8.4. Update 3D model pack</a></li>
<li><a href="#_issues_at_esmini_github_page">8.5. Issues at esmini GitHub page</a></li>
</ul>
</li>
<li><a href="#_build_guide">9. Build guide</a>
<ul class="sectlevel2">
<li><a href="#_build_configurations">9.1. Build configurations</a></li>
<li><a href="#_external_dependencies">9.2. External dependencies</a></li>
<li><a href="#_additional_platform_dependencies">9.3. Additional platform dependencies</a></li>
<li><a href="#_dynamic_protobuf_linking">9.4. Dynamic protobuf linking</a></li>
<li><a href="#_slim_esmini_customize_configration">9.5. Slim esmini - customize configration</a></li>
<li><a href="#_msys2_mingw_w64_support">9.6. MSYS2 / MinGW-w64 support</a></li>
<li><a href="#_build_esmini_project">9.7. Build esmini project</a></li>
<li><a href="#_centos_7_linux">9.8. CentOS 7 (Linux)</a></li>
</ul>
</li>
<li><a href="#_command_reference">10. Command reference</a>
<ul class="sectlevel2">
<li><a href="#_esmini">10.1. esmini</a>
<ul class="sectlevel3">
<li><a href="#_launch_commands">10.1.1. Launch commands</a></li>
<li><a href="#_runtime_key_shortcut_commands">10.1.2. Runtime key shortcut commands</a></li>
</ul>
</li>
<li><a href="#_replayer">10.2. replayer</a></li>
<li><a href="#_odrviewer">10.3. odrviewer</a></li>
<li><a href="#_plot_dat_py">10.4. plot_dat.py</a></li>
</ul>
</li>
<li><a href="#_esmini_lib_programming">11. esmini lib programming</a>
<ul class="sectlevel2">
<li><a href="#_about_the_lib_itself">11.1. About the lib itself</a></li>
<li><a href="#_how_to_interact_with_esmini_lib_api">11.2. How to interact with esmini lib API</a></li>
<li><a href="#_functionality">11.3. Functionality</a>
<ul class="sectlevel3">
<li><a href="#_save_or_grab_images">11.3.1. Save or grab images</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_hello_world_programming_tutorial">12. Hello World programming tutorial</a>
<ul class="sectlevel2">
<li><a href="#_steps_to_build_esmini_hello_world">12.1. Steps to build esmini "Hello World"</a></li>
<li><a href="#_examples">12.2. Examples</a>
<ul class="sectlevel3">
<li><a href="#_hello_world_load_and_play_a_scenario">12.2.1. Hello world - load and play a scenario</a></li>
<li><a href="#_add_optional_argument_to_load_any_scenario">12.2.2. Add optional argument to load any scenario</a></li>
<li><a href="#_fetch_state_of_scenario_objects">12.2.3. Fetch state of scenario objects</a></li>
<li><a href="#_external_control_of_ego">12.2.4. External control of Ego</a></li>
<li><a href="#_control_controllers">12.2.5. Control controllers</a></li>
<li><a href="#_ideal_sensors">12.2.6. Ideal sensors</a></li>
<li><a href="#_driver_model">12.2.7. Driver model</a></li>
<li><a href="#_osi_groundtruth">12.2.8. OSI groundtruth</a></li>
</ul>
</li>
<li><a href="#_python_binding">12.3. Python binding</a>
<ul class="sectlevel3">
<li><a href="#_get_object_states">12.3.1. Get object states</a></li>
<li><a href="#_example_use_of_esminirmlib_roadmanager">12.3.2. Example use of esminiRMLib (RoadManager)</a></li>
<li><a href="#_storyboard_element_state_callback">12.3.3. Storyboard element state callback</a></li>
<li><a href="#_object_state_callback">12.3.4. Object state callback</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_run_asam_openscenario_examples">13. Run ASAM OpenSCENARIO examples</a></li>
<li><a href="#_about_this_document">14. About this document</a></li>
<li><a href="#_version">15. Version</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><span class="image"><img src="https://avatars.githubusercontent.com/u/49203938" alt="160" width="160"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>esmini is a software tool to play OpenSCENARIO files. It&#8217;s provided both as a stand alone application and as a shared library for linking with custom applications. In addition some tools have been developed to support design and analysis of traffic scenarios.</p>
</div>
<div class="paragraph">
<p>The scope of this user guide is to provide examples on how to use the tools. It also includes a programming tutorial on how to use esmini in custom applications.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started">2. Getting started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Download latest release from here: <a href="https://github.com/esmini/esmini/releases/latest" class="bare">https://github.com/esmini/esmini/releases/latest</a></p>
</div>
<div class="paragraph">
<p>First time make sure to pick the demo package for your platform (Windows, Linux or Mac). In addition to application binaries it also includes some content like example scenarios and basic 3D models. The binary (bin) packages includes only executables and libraries.</p>
</div>
<div class="paragraph">
<p>To install the package, just unzip it anywhere. A single subfolder named <code>esmini</code> is created. This is the root folder for esmini. No files are stored outside this folder structure and no system files or registry is modified in any way.</p>
</div>
<div class="sect2">
<h3 id="_run_esmini">2.1. Run esmini</h3>
<div class="paragraph">
<p>Try to run one of the examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>go to folder esmini/run/esmini</p>
</li>
<li>
<p>double click on a .bat file, e.g. <code>run_cut-in.bat</code> or run it from a command line.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These scripts should work on all platforms (in spite extension ".bat").</p>
</div>
<div class="paragraph">
<p>You can also run the examples explicitly from a command line:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc</code></p>
</div>
<div class="paragraph">
<p>For common Mac issues, please see <a href="#_mac_issues_and_limitations">Mac issues and limitations</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_get_complete_esmini">2.2. Get complete esmini</h3>
<div class="paragraph">
<p>The demo package contains only a subset of esmini tools and content (e.g. scenario examples, scripts and models).</p>
</div>
<div class="paragraph">
<p>To get the complete content, first download or clone the project from GitHub: <a href="https://github.com/esmini/esmini" class="bare">https://github.com/esmini/esmini</a>. E.g:<br>
<code>git clone https://github.com/esmini/esmini.git</code></p>
</div>
<div class="paragraph">
<p>Then either build yourself, see step 2 in next chapter <a href="#_build_esmini_quick_guide">Build esmini - quick guide</a>, or:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download pre-built binary package for your system (e.g. esmini-bin_win_x64.zip) from latest release:
<a href="https://github.com/esmini/esmini/releases" class="bare">https://github.com/esmini/esmini/releases</a>. Copy the content into the esmini-demo folder.</p>
</li>
<li>
<p>Download the complete 3D model package from <a href="https://dl.dropboxusercontent.com/s/5gk8bvgzqiaaoco/models.7z?dl=1">here</a>. Unpack into esmini/resources (it should end up in a <code>models</code> subfolder). These assets work on all platforms. The environment models (roads, landscape, buildings&#8230;&#8203;) have been created using <a href="https://vires.mscsoftware.com/solutions/3d-environment-road-network">VIRES Road Network Editor</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_build_esmini_quick_guide">2.3. Build esmini - quick guide</h3>
<div class="paragraph">
<p>Supported systems: Windows, Linux and Mac.</p>
</div>
<div class="paragraph">
<p>Make sure you have a C++ compiler and <a href="https://cmake.org/">CMake</a> installed.</p>
</div>
<div class="paragraph">
<p>On Windows <a href="https://visualstudio.microsoft.com/">Visual Studio</a> is recommended (Community/free version is good enough for building esmini). Make sure to check the "Desktop development with C++" package for installation, no more is needed.</p>
</div>
<div class="paragraph">
<p>On Linux, e.g. Ubuntu, some additional system tools and libraries are needed. Run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>sudo apt install build-essential git pkg-config libgl1-mesa-dev libpthread-stubs0-dev libjpeg-dev libxml2-dev libpng-dev libtiff5-dev libgdal-dev libpoppler-dev libdcmtk-dev libgstreamer1.0-dev libgtk2.0-dev libcairo2-dev libpoppler-glib-dev libxrandr-dev libxinerama-dev curl cmake</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;re ready to build esmini. From esmini root folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>mkdir build
cd build
cmake ..
cmake --build . --config Release --target install</code></pre>
</div>
</div>
<div class="paragraph">
<p>The build process automatically downloads 3rd party library binaries and the complete 3D model package.</p>
</div>
<div class="paragraph">
<p>After successful build, the binaries will be copied into <code>esmini/bin</code> folder. Try from command line:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc</code></p>
</div>
<div class="paragraph">
<p>That&#8217;s all. Details and variants, see <a href="#_build_guide">Build guide</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tools_overview">3. Tools overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Applications:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>esmini</strong>
</td>
<td class="hdlist2">
<p>Play OpenSCENARIO file. Many options, e.g. view on screen, save images to file or just save log data for post processing.<br>
Example:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc</code><br></p>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/cut-in.png" alt="cut in">
</div>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>replayer</strong>
</td>
<td class="hdlist2">
<p>Replay recorded esmini scenarios. Main difference from esmini is the ability to freely move forward and backward in the scenario at various speeds.<br>
Example:<br>
<code>./bin/replayer --window 60 60 800 400 --file sim.dat</code><br></p>
<div class="paragraph">
<p>See <a href="#_use_cases">Use cases</a> how to create recordings (<code>.dat</code> files) from esmini.</p>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>odrviewer</strong>
</td>
<td class="hdlist2">
<p>Visualize and verify OpenDRIVE road networks. Draw road features, like reference line and lanes, on top of a 3D model (provided or generated). Optionally populate with random traffic that will randomly find its way through the road network.<br>
Example:<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr</code></p>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/odrviewer.png" alt="odrviewer">
</div>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>odrplot</strong>
</td>
<td class="hdlist2">
<p>Simple 2D plot of OpenDRIVE road lanes with indicated road IDs, in a two step process.<br>
Prerequisites: Python + <a href="https://matplotlib.org/">matplotlib</a><br>
Example:<br>
<code>./bin/odrplot ./resources/xodr/fabriksgatan.xodr</code> (will create a track.csv file)<br>
<code>python ./EnvironmentSimulator/Applications/odrplot/xodr.py track.csv</code></p>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/odrplot.png" alt="odrplot">
</div>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>plot_dat</strong>
</td>
<td class="hdlist2">
<p>Simple 2D plot of scenario data<br>
Prerequisites: Python + <a href="https://matplotlib.org/">matplotlib</a><br>
Example:<br>
<code>./bin/esmini --headless --osc ./resources/xosc/acc-test.xosc --record sim.dat</code> (will create the .dat file)<br>
<code>./scripts/plot_dat.py sim.dat --param speed</code></p>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_dat.png" alt="plot dat">
</div>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>dat2csv</strong>
</td>
<td class="hdlist2">
<p>Convert esmini recording (.dat) file to standard .csv format<br>
Example:<br>
<code>./scripts/dat2csv sim.dat</code><br>
will create sim.csv.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>osi2csv.py</strong>
</td>
<td class="hdlist2">
<p>Convert OSI trace file (from esmini) to .csv format<br>
Example:<br>
<code>./scripts/osi2csv.py ./ground_truth.osi</code><br>
will create ground_truth.csv</p>
<div class="paragraph">
<p>See <a href="#_save_osi_data">Save OSI data</a> how to create OSI groundtruth trace (<code>.osi</code> file) from esmini.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Shared libraries:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>esminiLib</strong>
</td>
<td class="hdlist2">
<p>High level API for running, controlling and monitoring scenarios<br></p>
<div class="paragraph">
<p>See headerfile <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp">esminiLib.hpp</a>
and <a href="#_hello_world_programming_tutorial">Hello World programming tutorial</a></p>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>esminiRMLib</strong>
</td>
<td class="hdlist2">
<p>High level API for parsing and query road networks (only road manager)<br></p>
<div class="paragraph">
<p>See headerfile <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/Libraries/esminiRMLib/esminiRMLib.hpp">esminiRMLib.hpp</a>
and code example <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/rm-basic">rm-basic</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_cases">4. Use cases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here follows basic examples showing some, but not all, features in esmini and companion tools. It should give an idea of the possibilities and limitations. For a full list of features and functions, see <a href="#_command_reference">Command reference</a>.</p>
</div>
<div class="paragraph">
<p>To quickly see available launch options, simply run the corresponding application with no arguments, for example:</p>
</div>
<div class="paragraph">
<p><code>./bin/odrviewer</code></p>
</div>
<div class="sect2">
<h3 id="_view_a_scenario">4.1. View a scenario</h3>
<div class="sect3">
<h4 id="_basic_features">4.1.1. Basic features</h4>
<div class="paragraph">
<p>Specify a window and scenario file. Example:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc</code></p>
</div>
<div class="paragraph">
<p>Visualize trails from moving entities:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --trail_mode 3</code></p>
</div>
<div class="paragraph">
<p>Show entities as bounding boxes:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --bounding_boxes</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/cut-in_trail_and_bb.png" alt="cut in trail and bb">
</div>
<div class="title">Trail and bounding box in combination</div>
</div>
</div>
<div class="sect3">
<h4 id="_camera_control">4.1.2. Camera control</h4>
<div class="paragraph">
<p>In addition to several OSG standard camera models esmini adds a set of special purpose camera modes that follows following scenario entities in various ways. Further, the user can add custom cameras via API or launch arguments.</p>
</div>
<div class="paragraph">
<p>Top level camera mode is selected on keys '1' to '8'. Mode 2-8 are OpenSceneGraph standard cameras. Mode 1 hands over camera control to esmini. In this mode, switch camera model by pressing 'k' which will toggle between all available esmini camera model.</p>
</div>
<div class="paragraph">
<p>The default camera model is esmini "orbit" which allows for rotating (left-mouse button), zooming (right-mouse button) and panning (scroll wheel / middle mouse button) while following the first entity.</p>
</div>
<div class="paragraph">
<p>To follow another vehicle press <code>Tab</code> (next vehicle) or <code>Shift TAB</code> (previous vehicle). Also <code>Backspace</code> is mapped to previous vehicle, since shift-TAB do not work on all platforms.</p>
</div>
<div class="paragraph">
<p>For a complete list of cameras and functions, see <a href="#_command_reference">Command reference</a>.</p>
</div>
<div class="paragraph">
<p>esmini camera mode can be selected by launch argument. Here are a few common use cases:</p>
</div>
<div class="paragraph">
<p>Follow exact behind vehicle:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --camera_mode fixed</code></p>
</div>
<div class="paragraph">
<p>Orthogonal (no perspective) top view follow vehicle:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --camera_mode top</code></p>
</div>
<div class="paragraph">
<p>Follow vehicle from inside "driver" point of view:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --camera_mode driver</code></p>
</div>
<div class="paragraph">
<p>Follow vehicle with some flex and allow rotate, pan and zoom:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --camera_mode flex-orbit</code></p>
</div>
<div class="paragraph">
<p>In addition to pre-defined camera modes, the user can add custom cameras from API or via launch argument. Custom cameras can be fixed, semi-fixed (fixed position but unconstrained orientation) or relative current vehicle. Here is a few examples:</p>
</div>
<div class="paragraph">
<p>Custom camera in front of vehicle, e.g. sensor mount position:
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --custom_camera 3,0,0.6,0,0</code></p>
</div>
<div class="paragraph">
<p>Custom camera with fixed position but dynamic orientation, always pointing at current vehicle:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --custom_fixed_camera 170,10,5</code></p>
</div>
<div class="videoblock">
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/custom_camera_fixed_pos.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Custom fixed camera:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --custom_fixed_camera 240,15,10,3.5,0.2</code></p>
</div>
<div class="videoblock">
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/custom_camera_fixed_pos_and_rot.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Custom fixed top view camera:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --custom_fixed_top_camera 180,-1.54,2301,4.71239</code></p>
</div>
<div class="videoblock">
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/custom_camera_fixed_top_view.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_some_key_shortcut_commands">4.1.3. Some key shortcut commands</h4>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>Space</strong>
</td>
<td class="hdlist2">
<p>Toggle pause/play simulation</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Enter</strong>
</td>
<td class="hdlist2">
<p>Step simulation one frame forward</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Tab</strong>
</td>
<td class="hdlist2">
<p>Move camera to next vehicle</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Shift-Tab or Backspace</strong>
</td>
<td class="hdlist2">
<p>Move camera to previous vehicle</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>'j'</strong>
</td>
<td class="hdlist2">
<p>Toggle show entity trail points and lines (press mulitpe times to switch modes)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>','</strong>
</td>
<td class="hdlist2">
<p>Toggle bounding box modes</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Esc</strong>
</td>
<td class="hdlist2">
<p>Quit</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See <a href="#_command_reference">Command reference</a> for a complete list of key shortcut commands.</p>
</div>
</div>
<div class="sect3">
<h4 id="_road_network_visualization">4.1.4. Road network visualization</h4>
<div class="paragraph">
<p>Visualize OpenDRIVE road features:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --road_features on</code></p>
</div>
<div class="paragraph">
<p>If a 3D model representation of the road network is missing (i.e. empty or missing SceneGraphFile element of the <a href="https://www.asam.net/static_downloads/ASAM_OpenSCENARIO_V1.1.1_Model_Documentation/modelDocumentation/content/RoadNetwork.html">OpenSCENARIO RoadNetwork class</a>), then esmini will generate a <em>very</em> simple model.</p>
</div>
<div class="paragraph">
<p>Example:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc</code></p>
</div>
<div class="paragraph">
<p>Add optional flat ground plane:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --ground_plane</code></p>
</div>
<div class="paragraph">
<p>The generated model can be saved:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --save_generated_model</code><br>
Then look for <code>generated_road.osgb</code> in the current directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="_background_color">4.1.5. Background color</h4>
<div class="paragraph">
<p>esmini default background color is skyish, light blue. Change by launch argument --clear-color &lt;r,g,b&gt;, where r, g, b are the red, green, blue components as floating numbers in the range (0:1). Some examples:</p>
</div>
<div class="paragraph">
<p>Black background:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --clear-color 0,0,0</code></p>
</div>
<div class="paragraph">
<p>White background:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --clear-color 1,1,1</code></p>
</div>
<div class="paragraph">
<p>Gray background:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --clear-color 0.3,0.3,0.3</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_anti_alias">4.1.6. Anti-alias</h4>
<div class="paragraph">
<p>esmini make use of OpenSceneGraph sub-sampling method for anti-alias. Default setting is 4 (samples). This can be controlled by the launch argument <code>--aa_mode &lt;samples&gt;</code>. To disable anti-alias:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --aa_mode 0</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_screenshots_and_video_clips">4.2. Screenshots and video clips</h3>
<div class="paragraph">
<p>esmini can save screenshots in uncompressed <a href="https://en.wikipedia.org/wiki/Truevision_TGA">TGA</a> format. These images can be converted into other image formats or even video clips in a post process.</p>
</div>
<div class="paragraph">
<p>esminiLib also supports grabbing screenshots via API, also from a pure off-screen rendering setup (requiring neither monitor nor graphics hardware). See <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/image-capture">image-capture</a> code example.</p>
</div>
<div class="paragraph">
<p>Here follows a few examples using launch arguments and runtime key commands.</p>
</div>
<div class="sect3">
<h4 id="_save_screenshots">4.2.1. Save screenshots</h4>
<div class="paragraph">
<p>Press 'c' at any time to store a single screenshot.</p>
</div>
<div class="paragraph">
<p>Press 'C' at any time to start storing screen shot for every frame onward. Press 'C' again to stop.</p>
</div>
</div>
<div class="sect3">
<h4 id="_create_video_clip_of_a_scenario">4.2.2. Create video clip of a scenario</h4>
<div class="paragraph">
<p>First, run the scenario and automatically save screenshots for all frames:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --fixed_timestep 0.033 --capture_screen</code></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Note</strong> We added the --fixed_timestep argument to make sure we get a smooth video with constant delta-time for a smooth and continuous video clip. If --fixed_timestep is skipped esmini will progress time between frames according to actual system time passed since last frame, which can vary over time for many reasons (e.g. due to esmini or other processes CPU load).</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Then, create a video clip using ffmpeg:<br>
<code>ffmpeg -f image2 -framerate 30 -i screen_shot_%5d.tga -c:v libx264 -vf format=yuv420p -crf 20 out.mp4</code></p>
</div>
<div class="paragraph">
<p>The above ffmpeg command will create a MPEG4 video with reasonable compression (crf 20). To create a lossless, but still compressed, video e.g. for further post processing:</p>
</div>
<div class="paragraph">
<p><code>ffmpeg -f image2 -framerate 30 -i screen_shot_%5d.tga -c:v libx264 -qp 0 out.mp4</code></p>
</div>
<div class="paragraph">
<p>Get ffmpeg: <a href="http://ffmpeg.org/download.html" class="bare">http://ffmpeg.org/download.html</a></p>
</div>
<div class="paragraph">
<p>Some details regarding H.264 encoding can be found <a href="https://trac.ffmpeg.org/wiki/Encode/H.264">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_off_screen_rendering">4.2.3. Off-screen rendering</h4>
<div class="paragraph">
<p>Whenever esmini is launched with the <code>--window &lt;x-pos&gt; &lt;y-pos&gt; &lt;width&gt; &lt;height&gt;</code> argument a viewer will be created with specified window. The <code>--headless</code> flag controls whether any window will be "on screen" or only off-screen. Of course, <code>--headless</code> in combination with no window (no --window argument) will skip rendering altogether, which is a very performance-saving mode to use when possible.</p>
</div>
<div class="paragraph">
<p>Example:<br>
<code>./bin/esmini.exe --window 60 60 4000 2000 --headless --capture_screen --osc .\resources\xosc\cut-in.xosc</code><br>
will render images into a virtual frame buffer of size 4k x 2k pixels and then store to file. Note: The size of the virtual frame buffer is not limited by size of any connected display.</p>
</div>
<div class="paragraph">
<p>To run esmini completely without rendering, just omit the --window argument:<br>
<code>./bin/esmini.exe --osc .\resources\xosc\cut-in.xosc</code> --fixed_timestep 0.01 --record sim.dat<br>
will run the specified scenario quickly and store a .dat file for later analysis or viewing (with replayer).</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> If --fixed_timestep is omitted esmini will adapt timesteps to actual frametime, so a 30 seconds scenario will take 30 seconds - i.e. no performance gain.</p>
</div>
</div>
<div class="sect3">
<h4 id="_software_rendering_no_gfx_hw">4.2.4. Software rendering (no gfx hw)</h4>
<div class="paragraph">
<p>By default any available 3D graphics hardware will be utilized. As fallback esmini (via OSG) will utilize <a href="https://www.mesa3d.org">Mesa3D</a> which is a software implementation of the OpenGL graphics stack including parts normally hosted in the graphics hardware system. The Mesa3D approach is useful when running on cloud/cluster machines lacking graphics hardware, perhaps even lacking a window system (like slimmed and headless Ubuntu without X11 support).</p>
</div>
<div class="paragraph">
<p><strong>Mesa3D on Linux</strong><br>
Mesa3D is normally installed with Linux distributions. Check OpenGL support with the following command:<br>
<code>glxinfo -B</code></p>
</div>
<div class="paragraph">
<p>If the command is not available, then Mesa3D utility package is probably missing. Install as:<br>
<code>sudo apt install mesa-utils</code></p>
</div>
<div class="paragraph">
<p>To run headless with a virtual frame buffer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Activate <a href="https://en.wikipedia.org/wiki/Xvfb">xvfb</a>:<br>
<code>Xvfb :99 -screen 0 1920x1080x24+32 &amp; export DISPLAY=:99</code><br></p>
</li>
<li>
<p>Then run esmini as usual</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For troubleshooting, the following command might give information about the graphics system:<br>
<code>lspci -vnn | grep VGA -A 12</code></p>
</div>
<div class="paragraph">
<p><strong>Mesa3D on Windows</strong><br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Grab the Mesa3D binary from <a href="https://downloads.fdossena.com/geth.php?r=mesa64-latest">here</a>.</p>
</li>
<li>
<p>Unpack and place opengl32.dll in the same folder as esmini executable.</p>
</li>
<li>
<p>Then run esmini as usual</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logging">4.3. Logging</h3>
<div class="paragraph">
<p>esmini can produce log files in different formats and for different purposes, explained next.</p>
</div>
<div class="sect3">
<h4 id="_the_basic_text_log_file">4.3.1. The basic text log file</h4>
<div class="paragraph">
<p>By default esmini is creating a <code>log.txt</code> in the folder from which esmini is launched. In case of esminiLib it will end up in the folder that the application linking esminiLib was launched from.</p>
</div>
<div class="paragraph">
<p>The log.txt includes the same information normally seen in the terminal window (stdout).</p>
</div>
<div class="paragraph">
<p>To disable output to terminal:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --disable_stdout</code></p>
</div>
<div class="paragraph">
<p>To disable creation of the logfile (<code>log.txt</code>):<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --disable_log</code></p>
</div>
<div class="paragraph">
<p>Developer info: Define the symbol DEBUG_TRACE (either as compile flag or by uncomment <a href="https://github.com/esmini/esmini/blob/73390cc2c1b8cbb8403950c905515e304c861b8c/EnvironmentSimulator/Modules/CommonMini/CommonMini.cpp#L34">this code line</a>) to log more details, like what code module and line number is the origin of the log entry.</p>
</div>
</div>
<div class="sect3">
<h4 id="_scenario_recording_dat">4.3.2. Scenario recording (.dat)</h4>
<div class="paragraph">
<p>In addition esmini can save a <code>.dat</code> file which captures the state of all entities. This file can later be used either to replay (see <a href="#_replay_scenario">Replay scenario</a>) the scenario or converted to <code>.csv</code> for further analysis, e.g. in Excel.</p>
</div>
<div class="paragraph">
<p>To create a recording with regular timesteps:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --fixed_timestep 0.05 --record sim.dat</code></p>
</div>
<div class="paragraph">
<p>To convert the .dat file into .csv, do either of:<br>
<code>./bin/dat2csv sim.dat</code><br>
or<br>
<code>python ./scripts/dat2csv.py sim.dat</code></p>
</div>
<div class="paragraph">
<p>Only a subset of the .dat file information is extracted. To extract some more info, e.g. road coordinates, run:
<code>./scripts/dat2csv --extended sim.dat</code><br></p>
</div>
</div>
<div class="sect3">
<h4 id="_csv_logger">4.3.3. CSV logger</h4>
<div class="paragraph">
<p>To create a more complete csv logfile, compared to the content of the .dat file, activate the CSV_Logger:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --fixed_timestep 0.05 --csv_logger full_log.csv</code></p>
</div>
<div class="paragraph">
<p>full_log.csv will contain more detailed states for all scenario entities. To also include collision detection:<br></p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --fixed_timestep 0.05 --csv_logger full_log.csv --collision</code></p>
</div>
<div class="paragraph">
<p>All collisions (overlap) between entity bounding boxes will be registered in the <code>collision_ids</code> column of each entity. It will contain the IDs of any entities overlapping at given frame.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_replay_scenario">4.4. Replay scenario</h3>
<div class="paragraph">
<p>Replay a scenario recording (.dat file):<br>
<code>./bin/replayer --window 60 60 800 400 --res_path ./resources --file sim.dat</code></p>
</div>
<div class="paragraph">
<p>The <code>--res_path</code> is a special path directive should normally point to esmini/resources folder, where it will look for the OpenDRIVE file, 3D models and model_ids table (model_ids.txt). It also works to add one or multiple --path &lt;path&gt; directives, like for esmini.</p>
</div>
<div class="paragraph">
<p>Once loaded the scenario recording will start playing in normal speed. Here are a few key commands:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>Space</strong>
</td>
<td class="hdlist2">
<p>Toggle pause/play simulation</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Tab</strong>
</td>
<td class="hdlist2">
<p>Move camera to next vehicle</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Shift-Tab or Backspace</strong>
</td>
<td class="hdlist2">
<p>Move camera to previous vehicle</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>'n'</strong>
</td>
<td class="hdlist2">
<p>Toggle show active trajectories</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>','</strong>
</td>
<td class="hdlist2">
<p>Toggle bounding box modes</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Esc</strong>
</td>
<td class="hdlist2">
<p>Quit</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Arrow keys:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>Left</strong>
</td>
<td class="hdlist2">
<p>Pause and move to previous frame</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Right</strong>
</td>
<td class="hdlist2">
<p>Pause and move to next frame</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Shift + Left</strong>
</td>
<td class="hdlist2">
<p>Pause and jump 10 frames back</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Shift + Right</strong>
</td>
<td class="hdlist2">
<p>Pause and jump 10 frames forward</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Ctrl + Left</strong>
</td>
<td class="hdlist2">
<p>Jump to beginning</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Ctrl + Right</strong>
</td>
<td class="hdlist2">
<p>Jump to end</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See <a href="#_command_reference">Command reference</a> for a complete list of key shortcut commands.</p>
</div>
<div class="paragraph">
<p>Some launch arguments:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>--collision</strong>
</td>
<td class="hdlist2">
<p>Pause and move to previous frame</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>--quit_at_end</strong>
</td>
<td class="hdlist2">
<p>Quit application when reaching end of scenario</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>--repeat</strong>
</td>
<td class="hdlist2">
<p>Loop scenario</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>--dir &lt;path&gt;</strong>
</td>
<td class="hdlist2">
<p>Directory containing replays to overlay, pair with "file" argument, where "file" is .dat filename match substring</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="paragraph">
<p>Enable collision detection and pause playing at every occasion of collision: <br>
<code>./bin/replayer --window 60 60 800 400 --file sim.dat --res_path ./resources --collision</code></p>
</div>
<div class="videoblock">
<div class="title">Video clip demonstrating some features in replayer</div>
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/ltap-od_collision.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>The .dat file in the clip above was created with the command:<br>
<code>./bin/esmini --headless --osc ./resources/xosc/ltap-od.xosc --disable_controllers --fixed_timestep 0.033 --record sim.dat </code></p>
</div>
<div class="paragraph">
<p>and then launched in replayer:</p>
</div>
<div class="paragraph">
<p><code>./bin/replayer --window 60 60 800 400 --file sim.dat --res_path ./resources --collision</code></p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> The --disable_controllers flag is just specified to disable the interactive controller that normally is activated in that specific scenario. For more information about controllers, see <a href="https://github.com/esmini/esmini/blob/master/docs/Controllers.md">Controllers in esmini</a>.</p>
</div>
<div class="paragraph">
<p>Combine esmini and replayer in a one-liner command:
<code>./bin/esmini --headless --fixed_timestep 0.05 --record sim.dat --osc ./resources/xosc/cut-in.xosc;./bin/replayer --window 60 60 800 400 --res_path ./resources --file sim.dat</code></p>
</div>
<div class="sect3">
<h4 id="_multiple_scenarios_in_parallel">4.4.1. Multiple scenarios in parallel</h4>
<div class="paragraph">
<p>Next example, play multiple variants of a scenario in parallel:<br>
<code>./bin/replayer --window 60 60 800 400 --file sim --res_path ./resources --capture_screen --dir tmp</code></p>
</div>
<div class="paragraph">
<p>The <code>--dir</code> argument points to a folder containing sim1.dat, sim2.dat and sim3.dat.<br>
The <code>--capture_screen</code> argument will save each frame as an image file on disk.</p>
</div>
<div class="videoblock">
<div class="title">Video clip demonstrating parallel scenarios in replayer</div>
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/replay_multiple_scenario_variants.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_save_merged_dat_files">4.4.2. Save merged .dat files</h4>
<div class="paragraph">
<p>Merged data from multiple .dat files can be saved into one single .dat file, e.g. for plotting:<br>
<code>./bin/replayer --file sim_ --dir . --save_merged sim_merged.dat</code></p>
</div>
<div class="paragraph">
<p>replayer will look in current folder (".") for any .dat file starting with "sim_", i.e. "sim_*.dat". The files will be merged and saved as sim_merged.dat.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_view_road_network">4.5. View road network</h3>
<div class="sect3">
<h4 id="_visualize_opendrive_geometry">4.5.1. Visualize OpenDRIVE geometry</h4>
<div class="paragraph">
<p>By default odrviewer will create a simple 3D model of the OpenDRIVE description and populate it with sparse traffic:<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr</code></p>
</div>
<div class="paragraph">
<p>Add OpenDRIVE features, like reference line and lanes, on top (toggle on 'o'):<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr --road_features</code></p>
</div>
<div class="paragraph">
<p>Remove all traffic, just visualize the road geometry:<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr --density 0</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_evaluate_opendrive_connectivity">4.5.2. Evaluate OpenDRIVE connectivity</h4>
<div class="paragraph">
<p>Increase traffic to exercise all junctions and lanes of the road network:<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr --density 7 --road_features</code></p>
</div>
<div class="paragraph">
<p>Use custom 3D model:<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr --model ./resources/models/fabriksgatan.osgb --density 5</code></p>
</div>
<div class="paragraph">
<p>Slow down traffic:<br>
<code>./bin/odrviewer --window 60 60 800 400 --odr ./resources/xodr/fabriksgatan.xodr --model ./resources/models/fabriksgatan.osgb --density 3 --speed_factor 0.6</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_inspect_opendrive_geometry_and_road_ids">4.5.3. Inspect OpenDRIVE geometry and road IDs</h4>
<div class="paragraph">
<p>esmini odrplot is a small application that creates a track.csv file that can be plotted with another small Python script xodr.py:<br>
<code>./bin/odrplot ./resources/xodr/fabriksgatan.xodr</code><br>
<code>./EnvironmentSimulator/Applications/odrplot/xodr.py track.csv</code></p>
</div>
<div class="paragraph">
<p>Combine in a one-liner:<br>
<code>./bin/odrplot ./resources/xodr/fabriksgatan.xodr;./EnvironmentSimulator/Applications/odrplot/xodr.py track.csv</code></p>
</div>
<div class="paragraph">
<p>To navigate in the plot, click the four-arrow icon (see image below) and then use mouse according to:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>Left button</strong>
</td>
<td class="hdlist2">
<p>Pan (move left, right, up, down)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Right button</strong>
</td>
<td class="hdlist2">
<p>Zoom</p>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/odrplot_help.png" alt="odrplot help">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_plot_scenario_data">4.6. Plot scenario data</h3>
<div class="paragraph">
<p>esmini provides a Python based script, plot_dat.py, to plot information in .dat files.</p>
</div>
<div class="paragraph">
<p>First, create a .dat file. For that we don&#8217;t need a window. Run esmini headless:<br>
<code>./bin/esmini --headless --fixed_timestep 0.05 --osc ./resources/xosc/acc-test.xosc --record sim.dat</code></p>
</div>
<div class="paragraph">
<p>The scenario looks like this:<br></p>
</div>
<div class="videoblock">
<div class="content">
<video src="https://github.com/esmini/esmini.github.io/raw/main/images/acc-test.mp4?raw=true" autoplay controls loop>
Your browser does not support the video tag.
</video>
</div>
</div>
<div class="paragraph">
<p>Next, plot speed over time:<br>
<code>./scripts/plot_dat.py sim.dat --param speed</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_dat.png" alt="plot dat">
</div>
</div>
<div class="paragraph">
<p>To see what parameters are available for plot:<br>
<code>./scripts/plot_dat.py sim.dat --list_params</code></p>
</div>
<div class="paragraph">
<p>will output a list similar to:<br>
<code>
Plottable parameters:<br>
id, model_id, obj_type, obj_category, ctrl_type, time, speed, wheel_angle, wheel_rot, centerOffsetX, centerOffsetY, centerOffsetZ, width, length, height, scaleMode, visibilityMask, x, y, z, h, p, r, roadId, laneId, offset, t, s
</code></p>
</div>
<div class="paragraph">
<p>Most parameters does normally not make sense to plot, but it depends on the test case. Maybe it&#8217;s interesting to see when a car makes a lane change. Plot laneId over time:<br>
<code>./scripts/plot_dat.py sim.dat --param laneId</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_dat_lane_id.png" alt="plot dat lane id">
</div>
</div>
<div class="paragraph">
<p>A plot can show multiple parameters:<br>
<code>./scripts/plot_dat.py sim.dat --param laneId --param speed</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_dat_lane_speed.png" alt="plot dat lane speed">
</div>
</div>
<div class="paragraph">
<p>To plot trajectories, change X-axis parameter from <code>time</code> to <code>x</code> and plot <code>y</code> parameter (over x):<br>
<code>./scripts/plot_dat.py sim.dat --x_axis x --param y</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_dat_x_y.png" alt="plot dat x y">
</div>
</div>
<div class="paragraph">
<p>Lock axis aspect ratio, i.e. make axis scale equal:<br>
<code>./scripts/plot_dat.py sim.dat --x_axis x --param y --equal_axis_aspect</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_dat_x_y_eq_axis.png" alt="plot dat x y eq axis">
</div>
</div>
<div class="paragraph">
<p>Plot merged .dat files (created as described in <a href="#_save_merged_dat_files">Save merged .dat files</a>)<br></p>
</div>
<div class="paragraph">
<p><code>./scripts/plot_dat.py --param speed sim_merged.dat</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_merged_dat_files.png" alt="plot merged dat files">
</div>
</div>
<div class="paragraph">
<p>Entity IDs will get an offset multiplier of 100, corresponding to the order of which the dat files were read by replayer. The mapping between ID range and dat file is printed to the console by replayer when the merged dat file is created, as the following example of four input files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Scenarios corresponding to IDs (0:99): sim_fsm.dat
Scenarios corresponding to IDs (100:199): sim_ref.dat
Scenarios corresponding to IDs (200:299): sim_reg.dat
Scenarios corresponding to IDs (300:399): sim_rss.dat</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_save_osi_data">4.7. Save OSI data</h3>
<div class="paragraph">
<p>esmini can provide OSI groundtruth data in three ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Send over UDP</p>
</li>
<li>
<p>API to fetch via function call from a custom application</p>
</li>
<li>
<p>Save to OSI trace file</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Only trace file way is described here. To save OSI data, add argument <code>--osi_file [filename]</code>. The filename is optional. If omitted it will be named <code>ground_truth.osi</code>. Example:</p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc --osi_file</code></p>
</div>
<div class="paragraph">
<p>will create <code>ground_truth.osi`</code> in the current folder. The format is according to the OSI standard "Binary trace file", see OSI documentation <a href="https://opensimulationinterface.github.io/osi-documentation/index.html#_osi_trace_files">2.2.6 OSI trace files</a>.</p>
</div>
<div class="paragraph">
<p>esmini provides a script, osi2csv.py, that converts an OSI trace file into .csv format. The script can also serve as example how to parse and extract data from an OSI trace file:</p>
</div>
<div class="paragraph">
<p><code>./scripts/osi2csv.py ground_truth.osi</code></p>
</div>
<div class="paragraph">
<p>will create ground_truth.csv.<br>
(if file type association is not setup, try: <code>python ./scripts/osi2csv.py ground_truth.osi</code>)</p>
</div>
<div class="paragraph">
<p>However the .csv file created with osi2csv will not contain all OSI information. To get a readable text file including the complete content of a OSI trace file you can make use of this Python script from the OSI project:<br></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/OpenSimulationInterface/open-simulation-interface/blob/master/format/osi2read.py" class="bare">https://github.com/OpenSimulationInterface/open-simulation-interface/blob/master/format/osi2read.py</a><br></p>
</div>
<div class="paragraph">
<p>Use as following example:</p>
</div>
<div class="paragraph">
<p><code>../open-simulation-interface/format/osi2read.py --data ./ground_truth.osi --output ground_truth --type GroundTruth</code></p>
</div>
<div class="paragraph">
<p>it should create <code>ground_truth.txth</code> which is readable in a text editor.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scenario_features">5. Scenario features</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_speed_profile">5.1. Speed profile</h3>
<div class="paragraph">
<p>(introduced in esmini v2.23.0)</p>
</div>
<div class="paragraph">
<p>The OpenSCENARIO <a href="https://www.asam.net/static_downloads/ASAM_OpenSCENARIO_V1.1.1_Model_Documentation/modelDocumentation/content/SpeedAction.html">SpeedAction</a> will reach a specified speed in a way described by additional attributes, e.g. shape and duration. To achieve multiple speed target over time you would need to add multiple SpeedAction events to the scenario. Moreover, there is no way to explicitly control the jerk (acceleration/deceleration rates).</p>
</div>
<div class="paragraph">
<p>However with the SpeedProfileAction (introduced in OpenSCENARIO v1.2) you can specify a series of speed targets over time, in one action. Optionally you can also specify dynamic constraints for jerk (gradually changing acceleration and deceleration), acceleration and speed.</p>
</div>
<div class="paragraph">
<p>If you run the example scenario <a href="https://github.com/esmini/esmini/blob/master/resources/xosc/speed-profile.xosc">speed-profile.xosc</a> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>./bin/esmini.exe --window 60 60 800 400 --osc ./resources/xosc/speed-profile.xosc --fixed_timestep 0.01 --record sim.dat
./scripts/plot_dat.py sim.dat --param speed</code></pre>
</div>
</div>
<div class="paragraph">
<p>you should get the following plotted speed curves:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile1.png" alt="speed profile1">
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong> You might need to add <code>python</code> or <code>python2</code> in front of the python command. And matplotlib is needed, see odrplot in <a href="#_tools_overview">Tools overview</a>.</p>
</div>
<div class="paragraph">
<p><strong>Tip:</strong> For quick experiments, skip the visualization and bring the plot asap by replacing the two commands with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>./bin/esmini.exe --headless --osc ./resources/xosc/speed-profile.xosc --fixed_timestep 0.01 --record sim.dat;./scripts/plot_dat.py sim.dat --param speed</code></pre>
</div>
</div>
<div class="paragraph">
<p>The scenario includes two cars with identical speed profiles with one exception: The white Car1 use activate dynamic constraints by setting FollowingMode="follow" while the red Car2 will apply constant acceleration (linear interpolation) between speed targets by setting FollowingMode="position".</p>
</div>
<div class="paragraph">
<p>The action for white car:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;SpeedProfileAction</span> <span class="attribute-name">followingMode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">follow</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;DynamicConstraints</span>
        <span class="attribute-name">maxAcceleration</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">5.0</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">maxDeceleration</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">maxAccelerationRate</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">maxDecelerationRate</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">maxSpeed</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">50</span><span class="delimiter">&quot;</span></span>
    <span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/SpeedProfileAction&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The time values are relative each other and start of the action. In this case the action is triggered at simulation time = 2 seconds. Initial speed for both cars is 0. First entry has therefor no effect since it applies speed = 0 at time = 2 (2 + 0). After additional 4 seconds (sim time = 6s) the speed target is 10 m/s. At sim time 10s the speed target is 4 m/s and finally after 2 more seconds the final speed target value is 8.0 m/s.</p>
</div>
<div class="paragraph">
<p>The "follow" mode deserves some additional explanation. As shown in the figure, it start and ends with zero acceleration. Then is basically will try to match the acceleration "lines" but cutting the corners according to acceleration and deceleration rate constraints. This way the intermediate speed values will not always be reached. However, the final speed value will be reached.</p>
</div>
<div class="paragraph">
<p>If the target speed or accelerations can&#8217;t be reached with given constraints the action will revert to linear mode (FollowingMode="position") for the remainder of the profile. This "failure" is logged.</p>
</div>
<div class="paragraph">
<p>Another approach would be to try to perform a best effort, but that would require additional input to decide whether to prioritize reaching specified speed targets or respect time stamps&#8230;&#8203;</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Note</strong>: The implementation of this feature is preliminary and experimental. Behavior and details might change.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s manipulate the scenario in different ways to illustrate some special cases of the speed-profile feature.</p>
</div>
<div class="sect3">
<h4 id="_special_case_single_entry">5.1.1. Special case: Single entry</h4>
<div class="paragraph">
<p>(Special case implementation introduced in esmini v2.23.1)</p>
</div>
<div class="paragraph">
<p>Compared to SpeedAction, the SpeedProfileAction offers more tools in terms of dynamic constraints. Hence it can be actually be useful also for single entry, i.e. reach a single target speed.</p>
</div>
<div class="paragraph">
<p>The implementation differs for the single entry case. Target speed will be reached if constraints allows for it. If not, the speed will still be reached, but later than specified.</p>
</div>
<div class="paragraph">
<p>There are three sub cases:</p>
</div>
<div class="paragraph">
<p><strong>1. Speed can be reached within time</strong></p>
</div>
<div class="paragraph">
<p>The speed profile will contain three phases: Jerk, constant acceleration, jerk.</p>
</div>
<div class="paragraph">
<p>Example:<br>
Replace the four entries in speed-profile.xosc with the following ones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile5.png" alt="speed profile5">
</div>
</div>
<div class="paragraph">
<p>Initial positive jerk will be applied until necessary acceleration is reached. Keep constant acceleration (linear segment in the speed profile) until negative jerk needs to be applied in order to reach target speed on time and at zero acceleration.</p>
</div>
<div class="paragraph">
<p><strong>2. Speed can&#8217;t be reached in time due to acceleration constraints</strong></p>
</div>
<div class="paragraph">
<p>This speed profile will also contain three phases: Jerk, constant acceleration, jerk.</p>
</div>
<div class="paragraph">
<p>Example:<br>
Replace the four entries in speed-profile.xosc with the following ones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile6.png" alt="speed profile6">
</div>
</div>
<div class="paragraph">
<p>Initial positive jerk will be applied until maximum acceleration is reached (or maximum deceleration). Keep constant acceleration (linear segment in the speed profile) until negative jerk needs to be applied in order to reach target speed at zero acceleration. Due to the acceleration limitation there will be a delay as well. The log file will include something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>SpeedProfile: Constraining acceleration from 5.86 to 5.00
SpeedProfile: Extend 0.46 s</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>3. Speed can&#8217;t be reached in time due to jerk constraints</strong></p>
</div>
<div class="paragraph">
<p>This speed profile will contain only two jerk phases.</p>
</div>
<div class="paragraph">
<p>Example:<br>
Keep entries from last case, but change jerk settings as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">  maxAccelerationRate=&quot;3.0&quot;
  maxDecelerationRate=&quot;2.0&quot;</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile7.png" alt="speed profile7">
</div>
</div>
<div class="paragraph">
<p>In this case the jerk settings are too weak to reach target speed in time. Not enough acceleration can be achieved in the given time window.</p>
</div>
<div class="paragraph">
<p>Positive jerk will be applied until negative jerk has to be applied in order to reach target speed at zero acceleration. Hence there is no room for a phase of constant acceleration. Due to the jerk limitation there will be a delay. The log file will include something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>SpeedProfile: Can't reach target speed 10.00 on target time 3.00s with given jerk constraints, extend to 4.08s</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_what_if_current_speed_differ_from_the_first_entry">5.1.2. What if current speed differ from the first entry?</h4>
<div class="paragraph">
<p>Replace the four entries with the following ones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile2.png" alt="speed profile2">
</div>
</div>
<div class="paragraph">
<p>What we see here is that for linear mode (FollowingMode="position") the speed of the first entry will apply immediately regardless of the current speed at the time of the action being triggered. For constrained mode (FollowingMode="follow") we see that the initial speed value (3.0) is overridden by the current speed (0.0). From there it will strive for the second entry, obeying the constraints.</p>
</div>
<div class="paragraph">
<p>The overall idea with the "follow" mode is to maintain continuity in the speed profile, up to jerk degree.</p>
</div>
</div>
<div class="sect3">
<h4 id="_what_if_time_is_missing_in_entry">5.1.3. What if time is missing in entry?</h4>
<div class="paragraph">
<p>Replace any entries with the following ones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile3.png" alt="speed profile3">
</div>
</div>
<div class="paragraph">
<p>Specified max acceleration will be applied until target speed is reached. Note: In the non-linear case and with multiple entries, the function will fail if the specified acceleration can&#8217;t be reached with given jerk constraints (maxAcceleration and maxDeceleration). Try to lower the maxAcceleration/deceleration in this case.</p>
</div>
<div class="paragraph">
<p>You can also combine entries with and without time constraint, like in following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">15.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile4.png" alt="speed profile4">
</div>
</div>
<div class="paragraph">
<p>Car will accelerate until speed 10 m/s is reached, then spend 3 seconds to reach 15 m/s.</p>
</div>
</div>
<div class="sect3">
<h4 id="_initial_acceleration_taken_into_account">5.1.4. Initial acceleration taken into account</h4>
<div class="paragraph">
<p>(from release v2.23.2)</p>
</div>
<div class="paragraph">
<p>What if the acceleration is not zero when the SpeedProfileAction is started, for example interrupting an ongoing SpeedAction in Follow mode?</p>
</div>
<div class="paragraph">
<p>To maintain a continuous acceleration profile the action will use current acceleration as initial value. The standard states that the acceleration is expected to be zero at start and end of the action. The esmini interpretation is that the CHANGE is zero at start while the ACTUAL value is zero at end (since the action can only control acceleration while being active, not before).</p>
</div>
<div class="paragraph">
<p>Example:
Once again starting from <a href="https://github.com/esmini/esmini/blob/master/resources/xosc/speed-profile.xosc">speed-profile.xosc</a>, instead of setting an instant initial speed make it ramp up from 0 to 5 m/s over a duration of 4 seconds by tweaking the initial speed actions, for both entities, as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedActionDynamics</span> <span class="attribute-name">dynamicsShape</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">linear</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">dynamicsDimension</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">time</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;SpeedActionTarget&gt;</span>
        <span class="tag">&lt;AbsoluteTargetSpeed</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/SpeedActionTarget&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile8.png" alt="speed profile8">
</div>
</div>
<div class="paragraph">
<p>The initial speed action will apply constant acceleration until time = 2.0 seconds, when the SpeedProfileAction is triggered. While the linear profile will jump to 0 m/s (as specified in first entry) the follow mode profile will just apply necessary jerk to reach target acceleration with respect to following entries.</p>
</div>
<div class="paragraph">
<p>Initial acceleration is also respected for the special case of a single entry, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>the result becomes:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile9.png" alt="speed profile9">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sharp_brake_to_stop_profile">5.1.5. Sharp brake-to-stop profile</h4>
<div class="paragraph">
<p>To skip jerk phase, e.g. as in emergency brake with an abrupt stop, just set AccelerationRate to a large number.</p>
</div>
<div class="paragraph">
<p>Example:
Once again starting from <a href="https://github.com/esmini/esmini/blob/master/resources/xosc/speed-profile.xosc">speed-profile.xosc</a>, change speed in the Init speed actions to 10.0 and replace the speed profile actions as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;SpeedProfileAction</span> <span class="attribute-name">followingMode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">follow</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;DynamicConstraints</span>
            <span class="attribute-name">maxAcceleration</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">5.0</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">maxDeceleration</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">maxAccelerationRate</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">1E10</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">maxDecelerationRate</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">maxSpeed</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">50</span><span class="delimiter">&quot;</span></span>
        <span class="tag">/&gt;</span>
        <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;SpeedProfileEntry</span> <span class="attribute-name">time</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4.0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">speed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0.0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/SpeedProfileAction&gt;</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed-profile10.png" alt="speed profile10">
</div>
</div>
<div class="paragraph">
<p><strong>Note</strong>: A drawback is that the setting will affect any acceleration phase in the complete profile. In other words, a limitation is that entries can&#8217;t have individual settings. In the example above it&#8217;s not problem since the first jerk phase is a deceleration while the second is an acceleration. If different rate values of same type are needed, it can be achieved by defining multiple SpeedProfile actions in a sequence, with individual performance settings.</p>
</div>
</div>
<div class="sect3">
<h4 id="_more_info">5.1.6. More info</h4>
<div class="paragraph">
<p>To get more understanding of the implementation, see a few slides <a href="https://drive.google.com/file/d/1DmjVHftcsbU71Ce_GASZ6IArcPA6teNF/view?usp=sharing">here</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_road_signs">5.2. Road signs</h3>
<div class="paragraph">
<p>(framework updated in esmini v2.25.0)</p>
</div>
<div class="sect3">
<h4 id="_the_system">5.2.1. The system</h4>
<div class="paragraph">
<p>Road signs are specified in the <a href="https://www.asam.net/index.php?eID=dumpFile&amp;t=f&amp;f=4422&amp;token=e590561f3c39aa2260e5442e29e93f6693d1cccd#top-016f925e-bfe2-481d-b603-da4524d7491f">OpenDRIVE</a> road network description file. A road sign is identified by up to four parameters:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>country code</p>
</li>
<li>
<p>type</p>
</li>
<li>
<p>subtype</p>
</li>
<li>
<p>value</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Country code is a two letter word according to the <a href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2">ISO 3166-1 alpha-2 system</a>. Examples: Sweden = se, Germany = de.</p>
</div>
<div class="paragraph">
<p>Type and subtype defines the semantic meaning of the sign. The value is used when applicable to further specify information, e.g. speed or weight. Data type and meaning of the parameters may differ between countries. However a mapping to each country&#8217;s system is often feasible.</p>
</div>
<div class="paragraph">
<p>Examples:
In <a href="https://www.transportstyrelsen.se/sv/vagtrafik/Vagmarken/">Sweden a speed sign</a> belongs to the category prohibition signs named "c". Within that category speed signs is a sub group with index 31. Within that group each sign has a value of speed/10, e.g. 5=50km/h, 10=100km/h. So the parameters for a Swedish speed limit 90 km/h sign becomes: se, c, 31, 9.</p>
</div>
<div class="paragraph">
<p>In <a href="https://en.wikipedia.org/wiki/Road_signs_in_Germany">Germany</a> there are no similar categories. Instead all signs have a unique group or type number, e.g. speed signs make up group 274. Then the value defines the speed. No need for subtype. So the parameters for a German  speed limit 90 km/h sign becomes: de, 274, -, 90.</p>
</div>
</div>
<div class="sect3">
<h4 id="_esmini_sign_catalogs">5.2.2. esmini sign catalogs</h4>
<div class="paragraph">
<p>Instead of hard-coding road sign support esmini will lookup the <a href="https://opensimulationinterface.github.io/open-simulation-interface/structosi3_1_1TrafficSign_1_1MainSign_1_1Classification.html">OSI code</a> from a separate sign definition file, which is unique for each country. Name convention for the file is: <code>country code</code> + "_traffic_signals.txt". Example: Swedish catalog is named "se_traffic_signals.txt".</p>
</div>
<div class="paragraph">
<p>The file is a simple text format each line defining a sign ID and corresponding OSI type.</p>
</div>
<div class="paragraph">
<p>Swedish example: <code>c.31-7=TYPE_SPEED_LIMIT_BEGIN</code><br>
German example: <code>274=TYPE_SPEED_LIMIT_BEGIN</code></p>
</div>
<div class="paragraph">
<p>Type is mandatory. For esmini to distinguish between subtype and value different separators are used: "." before subtype and "-" before value. For some signs the value is optional, e.g. for speed signs it simply specify the speed limit. But for some signs it is used as a subtype to identify a variant of a sign, as in the German 101 type category.</p>
</div>
<div class="paragraph">
<p>Example files can be found in <a href="https://github.com/esmini/esmini/tree/master/resources/traffic_signals">esmini/resources/traffic_signals</a>.</p>
</div>
<div class="paragraph">
<p>Currently (v2.25.0) the esmini sign support is very limited. However, it should be fairly straight forward to add signs into existing catalogs and even catalogs (for more countries).</p>
</div>
</div>
<div class="sect3">
<h4 id="_sign_3d_models">5.2.3. Sign 3D models</h4>
<div class="paragraph">
<p>esmini road signs are created as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A basic 3D geometry is modeled in Blender, e.g. round face for speed signs</p>
</li>
<li>
<p>Assign a material with any texture image mapped on the sign face</p>
</li>
<li>
<p>The 3D model is exported in <code>.dae</code> format (example <a href="https://drive.google.com/uc?export=download&amp;id=11v7xz9Mqw_Vx4An_FoLfKVlwcWJc-mnE">here</a>)</p>
</li>
<li>
<p>Find textures of the needed sign(s) and convert them into some common format, e.g. <code>.png</code>. Recommended size is 256, but larger is OK. If possible make it size 2^n x 2^m to avoid performance penalty on low spec/old systems.</p>
</li>
<li>
<p>Rename image to the same name as the texture image in the dae file (sign_image.png in the example dae)</p>
</li>
<li>
<p>Convert the .dae file into .osgb using osgconv. The texture will be embedded in the.osgb file by default.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed_sign_blender.png" alt="speed sign blender">
</div>
<div class="title">Speed sign in Blender</div>
</div>
<div class="paragraph">
<p>A <a href="https://github.com/esmini/esmini/blob/master/scripts/bake_signs.sh">script</a> is available as a starting point for automating the two last steps in the process above.</p>
</div>
</div>
<div class="sect3">
<h4 id="_example">5.2.4. Example</h4>
<div class="paragraph">
<p>The OpenDRIVE file <a href="https://github.com/esmini/esmini/blob/master/resources/xodr/straight_500m_signs.xodr">straight_500m_signs.xodr</a> includes a bunch of speed signs, some Swedish and some German ones. It shows how the signs are specified in terms of the country code, type, subtype and value attributes.</p>
</div>
<div class="paragraph">
<p>It also shows how to specify the 3D model using the <code>name</code> attribute: If filename composed by country, type, subtype and value is not found, the <code>name</code> attribute + ".osgb" will be used for a second and final attempt.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed_sign1.png" alt="speed sign1">
</div>
<div class="title">Swedish speed sign</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/speed_sign2.png" alt="speed sign2">
</div>
<div class="title">German speed sign</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_expressions">5.3. Expressions</h3>
<div class="paragraph">
<p>From OpenSCENARIO v1.1 <a href="https://www.asam.net/index.php?eID=dumpFile&amp;t=f&amp;f=4908&amp;token=ae9d9b44ab9257e817072a653b5d5e98ee0babf8#_expressions">expressions</a> including mathematical operations are supported in assignment of value to OpenSCENARIO <a href="https://www.asam.net/index.php?eID=dumpFile&amp;t=f&amp;f=4908&amp;token=ae9d9b44ab9257e817072a653b5d5e98ee0babf8#_parameters">parameters</a> and XML element attributes. Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;ParameterDeclaration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">PI</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">double</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.14159</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;ParameterDeclaration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">KPH2MPS</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">double</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1/3.6</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

...

<span class="tag">&lt;Position&gt;</span>
    <span class="tag">&lt;LanePosition</span> <span class="attribute-name">roadId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">laneId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">s</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">40</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;Orientation</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">absolute</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">h</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${sin(0.25*$PI)}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/LanePosition&gt;</span>
<span class="tag">&lt;/Position&gt;</span>

...

<span class="tag">&lt;SpeedActionTarget&gt;</span>
    <span class="tag">&lt;AbsoluteTargetSpeed</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${110 * $KPH2MPS}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/SpeedActionTarget&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>h and (speed value) evaluates to 0.707106 and 30.55558 respectively</p>
</div>
<h4 id="_expression_operators_and_functions_supported_as_per_2022_09_12" class="discrete">Expression operators and functions supported, as per 2022-09-12</h4>
<div class="paragraph">
<p><strong>Operators</strong></p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>+</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>-</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>*</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">multiply</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>/</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>%</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">modulo/remainder, see <a href="https://cplusplus.com/reference/cmath/fmod/">C++ fmod</a> (might deviate from IEEE 754)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>**</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">power</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&lt;</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&lt;=</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&gt;</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&gt;=</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>==</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">equal</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>!=</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not equal</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>&amp;&amp;</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">logical AND</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>||</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">logical OR</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>See <a href="https://github.com/esmini/esmini/blob/a53f09d85194509aa9d0c12971b1c73963c21d34/externals/expr/expr.h#L169">expr.h</a> for complete and updated list.</p>
</div>
<div class="paragraph">
<p><strong>Functions</strong></p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>round</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">see <a href="https://cplusplus.com/reference/cmath/round/">C++ round</a> (might deviate from IEEE 754)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>floor</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">see <a href="https://cplusplus.com/reference/cmath/floor/">C++ floor</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>ceil</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">see <a href="https://cplusplus.com/reference/cmath/ceil/">C++ ceil</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>sqrt</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">square root</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>pow</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">see <a href="https://cplusplus.com/reference/cmath/pow/">C++ pow</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Following functions are supported by esmini, but not specified in OpenSCENARIO &lt;= 1.2, hence use with care since they may not work in other tools</p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>sin</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>cos</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>tan</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>asin</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>acos</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>atan</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>sign</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>abs</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>max</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>min</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>See <a href="https://github.com/esmini/esmini/blob/c9dc63c45be0dc479c22b78be74d047fc4449e7c/EnvironmentSimulator/Modules/ScenarioEngine/SourceFiles/simple_expr.c#L101">simple_expr.c</a> for complete and updated list.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_controllers">6. Controllers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_controller_concept">6.1. Controller concept</h3>
<div class="paragraph">
<p>OpenSCENARIO provides the controller concept as a way to outsource control the motion and appearance of scenario entities. For the OpenSCENARIO description of the controller concept, see <a href="https://www.asam.net/index.php?eID=dumpFile&amp;t=f&amp;f=4908&amp;token=ae9d9b44ab9257e817072a653b5d5e98ee0babf8#_controllers">OpenSCENARIO User Guide</a>.</p>
</div>
<div class="paragraph">
<p>Controllers can be assigned to object of type Vehicle or Pedestrian. Once assigned, controllers are activated for a given domain (e.g longitudinal, lateral, Lighting, Animation) using the ActivateControllerAction. It&#8217;s also possible to activate immediately as part of the AssignControllerAction.</p>
</div>
<div class="paragraph">
<p>While the ActivateControllerAction is executing, the Controller assigned to that object will manage specified domain(s). Controllers may be internal (part of the simulator) or external (defined in another file).</p>
</div>
<div class="paragraph">
<p>Intended use cases for Controllers include:<br>
- Specifying that a vehicle is controlled by the system under test.
- Defining smart actor behavior, where a controller takes intelligent decisions in response to the road network or other actors. Hence, controllers can be used, for example, to make agents in a scenario behave in a human-like way.
- Assigning a vehicle to direct human control.</p>
</div>
<div class="paragraph">
<p>The Controller element contains Properties, which can be used to specify controller behavior either directly or by a file reference.</p>
</div>
<div class="paragraph">
<p>Although OpenSCENARIO from v1.2 supports assignment of multiple controllers to an object, esmini is currently only supporting one controller to be assigned (and hence activated) to an object at the time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_background_and_motivation">6.2. Background and motivation</h3>
<div class="paragraph">
<p>esmini version &lt; 2.0 totally lacked support for controllers. Instead some similar functionality were implemented as part of different example-applications. For example, EgoSimulator provided interactive control of one vehicle. There was also an "external" mode which allowed for an external vehicle simulator to report current position for the typical Ego (VUT/SUT&#8230;&#8203;) vehicle.</p>
</div>
<div class="paragraph">
<p>First, this approach made the example code of simple applications complex. Secondly, it limited the use cases of esmini since functionality was tightly embedded in the applications.</p>
</div>
<div class="paragraph">
<p>Controllers provides a much more flexible way of adding functionality to esmini, in a way harmonizing with the standard (OpenSCENARIO 1.X). A side effect of this "outsourcing" of functionality is that the former demo applications could be reduced to a minimum both in number and size.</p>
</div>
</div>
<div class="sect2">
<h3 id="_brief_on_implementation">6.3. Brief on implementation</h3>
<div class="paragraph">
<p>Controllers was introduced in esmini v2.0. Briefly it works as follows:</p>
</div>
<div class="paragraph">
<p>There is a collection of embedded controllers coming with esmini. Each controller inherit from the base class Controller (Controller.h/cpp). In order for esmini to be aware of the existence of a controller it has to be registered. This is done through the ScenarioReader method <a href="https://github.com/esmini/esmini/blob/3d1abcd6b3e3855707dc424f7c25477bbf136078/EnvironmentSimulator/Modules/ScenarioEngine/SourceFiles/ScenarioReader.hpp#L132"><code>RegisterController</code></a>. It will put the controller into a collection to have available when the scenario is being parsed. So all controllers need to be registered prior to loading the scenario.</p>
</div>
<div class="paragraph">
<p>A controller is registered with the following information:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Its static name which is used as identifier.</p>
</li>
<li>
<p>A pointer to a function instantiating the controller.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This architecture makes it possible for an external module to create a controller and registering it without modifying any of esmini modules. In that way it is a semi-plugin concept, you can say.</p>
</div>
<div class="paragraph">
<p><strong>Note</strong>: Even though ScenarioReader have a helper function for registering all the embedded controllers the RegisterController can be called from any module directly, at any time prior to scenario initialization.</p>
</div>
<div class="paragraph">
<p>esmini catalog framework supports controllers as well, so controllers can be defined in catalogs as presets, just like vehicles and routes for example.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_it_works_for_the_user">6.4. How it works for the user</h3>
<div class="paragraph">
<p>Controllers are completely handled in the OpenSCENARIO file. With one exception: esmini provides the --disable-controllers option which totally ignore any controllers, just performing the scenario with DefaultControllers, which can be handy when previewing and debugging scenarios.</p>
</div>
<div class="paragraph">
<p>In terms of OpenSCENARIO a controller is assigned to an entity (object) in any of two ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>As part of the Entities section and ScenarioObject definition, using the ObjectController element.</p>
</li>
<li>
<p>The AssignControllerAction which can be triggered as any action at any time during the simulation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once assigned the controller must finally be activated using the ActivateControllerAction which can be triggered at any time. It provides an attribute to specify which domain(s) to control: Lateral, Longitudinal or both.</p>
</div>
<div class="paragraph">
<p>Example 1: Implicit assignment of controller using the <code>ObjectController</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;Entities&gt;</span>
   <span class="tag">&lt;ScenarioObject</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Ego</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;CatalogReference</span> <span class="attribute-name">catalogName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VehicleCatalog</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">entryName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">$HostVehicle</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;ObjectController&gt;</span>
          <span class="tag">&lt;Controller</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MyController</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
             <span class="tag">&lt;Properties&gt;</span>
                 <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">esminiController</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">InteractiveController</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                 <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">speedFactor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1.5</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
             <span class="tag">&lt;/Properties&gt;</span>
          <span class="tag">&lt;/Controller&gt;</span>
      <span class="tag">&lt;/ObjectController&gt;</span>
   <span class="tag">&lt;/ScenarioObject&gt;</span>
<span class="tag">&lt;/Entities&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example 2: As above, but using catalog reference:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;Entities&gt;</span>
   <span class="tag">&lt;ScenarioObject</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Ego</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;CatalogReference</span> <span class="attribute-name">catalogName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VehicleCatalog</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">entryName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">$HostVehicle</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;ObjectController&gt;</span>
            <span class="tag">&lt;CatalogReference</span> <span class="attribute-name">catalogName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ControllerCatalog</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">entryName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">interactiveDriver</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/ObjectController&gt;</span>
   <span class="tag">&lt;/ScenarioObject&gt;</span>
<span class="tag">&lt;/Entities&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example 3: Activate controller in the <code>Init</code> section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;Init&gt;</span>
   <span class="tag">&lt;Actions&gt;</span>
      <span class="tag">&lt;Private</span> <span class="attribute-name">entityRef</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Ego</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;PrivateAction&gt;</span>
            <span class="tag">&lt;TeleportAction&gt;</span>
               <span class="tag">&lt;Position&gt;</span>
                  <span class="tag">&lt;LanePosition</span> <span class="attribute-name">roadId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">laneId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">s</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">$EgoStartS</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
               <span class="tag">&lt;/Position&gt;</span>
            <span class="tag">&lt;/TeleportAction&gt;</span>
         <span class="tag">&lt;/PrivateAction&gt;</span>
         <span class="tag">&lt;PrivateAction&gt;</span>
              <span class="tag">&lt;ActivateControllerAction</span> <span class="attribute-name">longitudinal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lateral</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
         <span class="tag">&lt;/PrivateAction&gt;</span>
      <span class="tag">&lt;/Private&gt;</span>
   <span class="tag">&lt;/Actions&gt;</span>
<span class="tag">&lt;/Init&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example 4: Assign and activate the controller in the <code>Storyboard</code> section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;Event</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">InteractiveEvent</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">maximumExecutionCount</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">priority</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">overwrite</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;Action</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AssignControllerAction</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;PrivateAction&gt;</span>
          <span class="tag">&lt;ControllerAction&gt;</span>
              <span class="tag">&lt;AssignControllerAction&gt;</span>
                  <span class="tag">&lt;CatalogReference</span> <span class="attribute-name">catalogName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ControllerCatalog</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">entryName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">interactiveDriver</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
              <span class="tag">&lt;/AssignControllerAction&gt;</span>
          <span class="tag">&lt;/ControllerAction&gt;</span>
      <span class="tag">&lt;/PrivateAction&gt;</span>
   <span class="tag">&lt;/Action&gt;</span>
   <span class="tag">&lt;Action</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ActivateControllerAction</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;PrivateAction&gt;</span>
          <span class="tag">&lt;ControllerAction&gt;</span>
              <span class="tag">&lt;ActivateControllerAction</span> <span class="attribute-name">longitudinal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lateral</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
          <span class="tag">&lt;/ControllerAction&gt;</span>
      <span class="tag">&lt;/PrivateAction&gt;</span>
   <span class="tag">&lt;/Action&gt;</span>
   <span class="tag">&lt;StartTrigger&gt;</span>
      <span class="tag">&lt;ConditionGroup&gt;</span>
         <span class="tag">&lt;Condition</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">delay</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">conditionEdge</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">none</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;ByValueCondition&gt;</span>
               <span class="tag">&lt;SimulationTimeCondition</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">20</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">rule</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">greaterThan</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/ByValueCondition&gt;</span>
         <span class="tag">&lt;/Condition&gt;</span>
      <span class="tag">&lt;/ConditionGroup&gt;</span>
   <span class="tag">&lt;/StartTrigger&gt;</span>
<span class="tag">&lt;/Event&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To disable any controller simply apply ActivateControllerAction on no domain, like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;ActivateControllerAction</span> <span class="attribute-name">longitudinal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lateral</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That should work in all OpenSCENARIO supporting tools. In esmini you can also assign <code>DefaultController</code> which will disconnect any assigned controller.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_ghost_concept">6.5. The ghost concept</h3>
<div class="paragraph">
<p>The purpose of the ghost concept is to support external driver models. The idea is to launch a forerunner, which performs the maneuvers in the OSC file. The resulting trajectory (also called trail), including speed and heading info, is registered. The driver model can then use the ghost trail as guidance. More specifically, the driver model can probe the trail at any timestamp or distance from its current pos and use the result for both steering and speed target.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/ghost_concept1.png" alt="ghost concept1">
</div>
</div>
<div class="paragraph">
<p>A typical use case is having an external Ego vehicle simulator, including System Under test (SUT) and a driver model. Instead of the driver model (in the external simulator) being aware of and execute scenario maneuvers it can hand over to esmini to play the maneuvers and then simply try to mimic it, following in ghost&#8217;s trail. This way the external simulator can benefit from esmini scenario engine and just concentrate on following the ghost.</p>
</div>
<div class="paragraph">
<p>The ghost feature is available in the following esmini embedded controllers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_followghost">FollowGhost</a></p>
</li>
<li>
<p><a href="#_externalcontroller">ExternalController</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are two different methods to probe the ghost trail:
By time: Ask for ghost state (pos, heading, speed&#8230;&#8203;) at specific timestamp
By distance: Ask for ghost state at a specific distance, from a position (typically current Ego position)</p>
</div>
<div class="paragraph">
<p>Both methods will return a RoadInfo structure including position details e.g. world position (absolute and relative Ego), road coordinates, road pitch, trail heading, heading angle to the target point and ghost speed at that point.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">typedef struct
{
    float global_pos_x;  // target position, in global coordinate system
    float global_pos_y;  // target position, in global coordinate system
    float global_pos_z;  // target position, in global coordinate system
    float local_pos_x;   // target position, relative vehicle (pivot position object) coordinate system
    float local_pos_y;   // target position, relative vehicle (pivot position object) coordinate system
    float local_pos_z;   // target position, relative vehicle (pivot position object) coordinate system
    float angle;         // heading angle to target from and relative vehicle (pivot position object) coordinate system
    float road_heading;  // road heading at steering target point
    float road_pitch;    // road pitch (inclination) at steering target point
    float road_roll;     // road roll (camber) at target point
    float trail_heading; // trail heading (only when used for trail lookups, else equals road_heading)
    float curvature;     // road curvature at steering target point
    float speed_limit;   // speed limit given by OpenDRIVE type entry
    int roadId;          // target position, road ID
    int junctionId;      // target position, junction ID (-1 if not in a junction)
    int laneId;          // target position, lane ID
    float laneOffset;    // target position, lane offset (lateral distance from lane center)
    float s;             // target position, s (longitudinal distance along reference line)
    float t;             // target position, t (lateral distance from reference line)
} SE_RoadInfo;</code></pre>
</div>
</div>
<h4 id="_time_method" class="discrete">Time method</h4>
<div class="paragraph">
<p>This approach is trivial, it will give the state of ghost at the specified timestamp using the API call:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/esmini/esmini/blob/362bcae28253f4eef2778e6f11b7a8393e6a3cd4/EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp#L815">int SE_GetRoadInfoGhostTrailTime(int object_id, float time, SE_RoadInfo* data, float* speed_ghost);</a></p>
</div>
<h4 id="_distance_method" class="discrete">Distance method</h4>
<div class="paragraph">
<p>The API call is:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/esmini/esmini/blob/362bcae28253f4eef2778e6f11b7a8393e6a3cd4/EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp#L805">int SE_GetRoadInfoAlongGhostTrail(int object_id, float lookahead_distance, SE_RoadInfo *data, float *speed_ghost);</a></p>
</div>
<div class="paragraph">
<p>The method needs some further explanation. The basic idea is to look specified distance along the ghost trail and receive information at that target point. The tricky part is where to start measuring the distance from. This is how it works:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/ghost_concept2.png" alt="ghost concept2">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From Ego, find closest point on trail (blue point)</p>
</li>
<li>
<p>From that point, look forward x meters along trail (red dot)</p>
</li>
<li>
<p>Get info from that target point</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Tuning parameters:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Lookahead distance along trail</p>
<div class="ulist">
<ul>
<li>
<p>Typically speed dependent (look further at higher speeds)</p>
</li>
<li>
<p>Potentially decrease distance with increased curvature (to stay on road)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Headstart time</p>
<div class="ulist">
<ul>
<li>
<p>As small as possible, but enough for required lookahead distance</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Note:</strong>
If lookahead distance is too large, the steering target angle becomes irrelevant, leading to driving off road</p>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/ghost_concept3.png" alt="ghost concept3">
</div>
<div class="title">Too large lookahead distance</div>
</div>
<h4 id="_actions_and_triggers" class="discrete">Actions and triggers</h4>
<div class="paragraph">
<p>Most actions that affects motion will be transferred from the original entity (Ego) to its ghost, for example: <code>SpeedAction</code>, <code>LaneChangeAction</code> and <code>TeleportAction</code>. In addition, triggers will be affected in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Entity triggers: Replace any occurrence of original entity with ghost in the list of <code>TriggeringEntities</code>. For example, if the vehicle should brake when reaching a specified position, then it&#8217;s the ghost that should trigger the action - not the original entity.</p>
</li>
<li>
<p>Other triggers: Restart ghost from where the Ego is now, in effect rewind ghost <code>headStartTime</code> seconds and recreate trajectory from there. The purpose is to enable ghost to react on triggers that happens in the "real" scenario (which plays out <code>headStartTime</code> seconds behind the ghost)</p>
</li>
<li>
<p><code>SimulationTime</code> trigger conditions for events where Ego is the actor will be adjusted wrt ghost <code>headStartTime</code> time. For example, if vehicle should brake after 20 seconds of driving (simulationTime = 20), then it will be changed to simulationTime = 17 (for headstart 3s), since the ghost has been driving for 20 seconds at that point.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the strategy results in desired behavior in probably the majority of cases, but not all. There might be exceptions where another behavior is expected or required. The manipulation described above is handled by the method <a href="https://github.com/esmini/esmini/blob/362bcae28253f4eef2778e6f11b7a8393e6a3cd4/EnvironmentSimulator/Modules/ScenarioEngine/SourceFiles/ScenarioEngine.cpp#L1103">ScenarioEngine::SetupGhost()</a> which in best case can be modified to fit custom needs.</p>
</div>
<h4 id="_additional_notes_on_using_the_ghost_feature" class="discrete">Additional notes on using the ghost feature</h4>
<div class="paragraph">
<p>Timestamps in log are always of same reference. Whenever a ghost is involved the time will start at -<code>headStartTime</code>, in order for the actual scenario to start at simulationTime = 0. Example: Assuming <code>headStartTime = 3s</code>, a log message for an Ego action like:</p>
</div>
<div class="paragraph">
<p><code>-2.100: SpeedChange standbyState &#8594; startTransition &#8594; runningState</code></p>
</div>
<div class="paragraph">
<p>means that action SpeedChange (Ego action that has been moved to ghost) is performed 0.9 (-2.1 + 3) seconds after ghost was launched. This would, for example, be the case for a <code>simulationTime = 0.9</code> condition.</p>
</div>
</div>
<div class="sect2">
<h3 id="_esmini_embedded_controllers">6.6. esmini embedded controllers</h3>
<div class="paragraph">
<p>Below is a listing of some of the available controllers in esmini. Note that only DefaultController is related to the OpenSCENARIO standard. The other ones are esmini-specific and will not work in other tools (so far there is no standard plugin-architecture for controllers to enable moving between tools). For updated and complete definition of controllers and their parameters, see <a href="https://github.com/esmini/esmini/blob/master/resources/xosc/Catalogs/Controllers/ControllerCatalog.xosc">ControllerCatalog.xosc</a>.</p>
</div>
<div class="sect3">
<h4 id="_defaultcontroller">6.6.1. DefaultController</h4>
<div class="paragraph">
<p>Performs actions exactly as specified in the OpenSCENARIO file. Assigned to entities by default. Can be assigned at any point to "unassign" any currently assigned controller.<br></p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a (will always take over both Lateral and Longitudinal domains)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a (any scenario not explicitly assigning and activating another controller)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_interactivecontroller">6.6.2. InteractiveController</h4>
<div class="paragraph">
<p>A simple vehicle model controlled by the user via keyboard (arrow keys).<br></p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitudinal and/or lateral (independent)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>steeringRate</code>
</td>
<td class="hdlist2">
<p>steering sensitivity</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>speedFactor</code>
</td>
<td class="hdlist2">
<p>scale speed performance (1.0 is default)</p>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/esmini/esmini/blob/master/resources/xosc/cut-in_interactive.xosc">cut-in_interactive.xosc</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_followghost">6.6.3. FollowGhost</h4>
<div class="paragraph">
<p>A simple driver model. A ghost-twin performing the events a few seconds ahead. The entity will then do its best to mimic the motion and speed of the ghost by follow the trajectory. The primary purpose of this controller is to provide an example, but it can be useful to smoothen out the sometimes synthetic feel of pure default controller.<br></p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitudinal and lateral (in combination only).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>headstartTime</code>
</td>
<td class="hdlist2">
<p>seconds</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>followMode</code>
</td>
<td class="hdlist2">
<p><code>time</code> (time offset), <code>position</code> (distance offset)</p>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/esmini/esmini/blob/master/resources/xosc/follow_ghost.xosc">follow_ghost.xosc</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_externalcontroller">6.6.4. ExternalController</h4>
<div class="paragraph">
<p>The entity will not be moved by the scenario. Instead its state (position, rotation &#8230;&#8203;) is expected to be reported from external simulator via API, e.g. SE_ReportObjectPos. Ghost trajectory can optionally be created for an external driver model to use as reference.<br></p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitudinal and/or lateral (independent).<br></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>useGhost</code>
</td>
<td class="hdlist2">
<p>launch a ghost fore-runner, e.g. to provide input for any driver model (<code>true</code>/<code>false</code>)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>headstartTime</code>
</td>
<td class="hdlist2">
<p>(for the ghost)</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>mode</code>
</td>
<td class="hdlist2">
<p><code>override</code> disable default controller (default), <code>additive</code>: apply default controller before handing over to this controller</p>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/test-driver">test-driver code example</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_sumocontroller">6.6.5. SumoController</h4>
<div class="paragraph">
<p>A way of integrating SUMO controlled vehicles in a scenario. OpenSCENARIO vehicles are reported to SUMO, and SUMO vehicles are reported back to esmini. A reference to a SUMO config file is provided as input to the controller. See cut-in_sumo.xosc for an example.</p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitudinal and lateral (in combination only).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>file</code>
</td>
<td class="hdlist2">
<p>Path to the SUMO configuration file<br></p>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/esmini/esmini/blob/master/resources/xosc/cut-in_sumo.xosc">cut-in_sumo.xosc</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_alks_r157sm">6.6.6. ALKS_R157SM</h4>
<div class="paragraph">
<p>Based and inspired by <a href="https://github.com/ec-jrc/JRC-FSM">Regulation 157 Safety Models</a>. Includes four safety models relating to the (<a href="https://unece.org/transport/documents/2021/03/standards/un-regulation-no-157-automated-lane-keeping-systems-alks">UNECE ALKS regulation #157</a>). The controller includes preliminary and experimental implementation of four models:<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Regulation</code> Characteristics of expected system performance as stated in the <a href="https://unece.org/sites/default/files/2021-03/R157e.pdf">UNECE Reg 157 Paragraph 5.2.5.2</a>.<br></p>
</li>
<li>
<p><code>ReferenceDriver</code> Reference model of a "typical" human driver as specified in <a href="https://unece.org/sites/default/files/2021-03/R157e.pdf">UNECE Reg 157 Annex 4 - Appendix 3</a>.<br></p>
</li>
<li>
<p><code>RSS</code> <em>Responsibility-Sensitive Safety</em> performance model proposed and described in <a href="https://arxiv.org/pdf/1708.06374.pdf">Shalev-Shwartz, Shai, Shaked Shammah, and Amnon Shashua. "On a formal model of safe and scalable self-driving cars." arXiv preprint arXiv:1708.06374 (2017)</a>.<br></p>
</li>
<li>
<p><code>FSM</code> <em>Fuzzy Safety Model</em> proposed and described in <a href="https://www.sciencedirect.com/science/article/pii/S0001457520316146">Mattas, Konstantinos, et al. "Fuzzy Surrogate Safety Metrics for real-time assessment of rear-end collision risk. A study based on empirical observations." Accident Analysis &amp; Prevention 148 (2020): 105794</a>.<br></p>
</li>
</ul>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitudinal and lateral (in combination only). <strong>Note</strong>: No advanced steering, just maintaining current lane offset.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>logLevel</code>
</td>
<td class="hdlist2">
<p>0: No logging, 1: Brief logging of state changes (default), 2: Verbose logging of some internal variables</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>model</code>
</td>
<td class="hdlist2">
<p><code>Regulation</code>, <code>ReferenceDriver</code>, <code>RSS</code>, <code>FSM</code> as described above.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>cruise</code>
</td>
<td class="hdlist2">
<p>Activate longitudinal ACC (comfort adaptive speed control) (<code>true</code>/<code>false</code>)</p>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Examples</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/esmini/esmini/blob/master/resources/xosc/alks_r157_cut_in_quick_brake.xosc">alks_r157_cut_in_quick_brake.xosc</a><br>
<a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Unittest/xosc/alks_r157_quick_stop_test.xosc">alks_r157_quick_stop_test.xosc</a><br>
<a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Unittest/xosc/alks_r157_test.xosc">alks_r157_test.xosc</a><br></p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_example_usage">Example usage</h5>
<div class="paragraph">
<p>Run example alks_r157_cut_in_quick_brake.xosc:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/alks_r157_cut_in_quick_brake.xosc</code></p>
</div>
<div class="paragraph">
<p>Change model:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open <code>resources/xosc/alks_r157_cut_in_quick_brake.xosc</code> in a text editor</p>
</li>
<li>
<p>In the ALKS_R157SM_Controller, change<br>
<code>&lt;Property name="model" value="Regulation"/&gt;</code> to<br>
<code>&lt;Property name="model" value="ReferenceDriver"/&gt;</code></p>
</li>
<li>
<p>Save and run again:<br>
<code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/alks_r157_cut_in_quick_brake.xosc</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can hardly see any difference. Let&#8217;s run the two variants again and record for post analysis.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set model to "ReferenceDriver" (by edit the file as described above)</p>
</li>
<li>
<p>Run:<br>
<code>./bin/esmini --headless --fixed_timestep 0.02 --osc ./resources/xosc/alks_r157_cut_in_quick_brake.xosc --record sim-ref.dat</code></p>
</li>
<li>
<p>Set model to "Regulation"</p>
</li>
<li>
<p>Run:<br>
<code>./bin/esmini --headless --fixed_timestep 0.02 --osc ./resources/xosc/alks_r157_cut_in_quick_brake.xosc --record sim-reg.dat</code></p>
</li>
<li>
<p>View scenarios in parallel:<br>
<code>./bin/replayer --window 60 60 800 400 --res_path ./resources --dir . --file sim- --view_mode boundingbox</code></p>
</li>
<li>
<p>Create a merged .dat file and plot it:<br>
<code>./bin/replayer --file sim- --dir . --save_merged sim_merged.dat</code><br>
<code>./scripts/plot_dat.py --param speed sim_merged.dat</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Something like this should show:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/plot_merged_alks_ex.png" alt="plot merged alks ex">
</div>
</div>
<div class="paragraph">
<p>Of course you can run also FSM and RSS models in similar way and merge all four .dat files. For more information about <code>replayer</code>, see "Plot merged .dat files" example in <a href="#_plot_scenario_data">Plot scenario data</a> section.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_followroute">6.6.7. FollowRoute</h4>
<div class="paragraph">
<p>Implementation of the Lane Independent Routing Model (LIRM) developed as part of the master thesis project <a href="https://hdl.handle.net/20.500.12380/305133">Olsson, Daniel; Rylander, Eric: "A Framework for Verification and
Validation of Simulation Models in esmini"</a>.</p>
</div>
<div class="paragraph">
<p>From the <a href="https://odr.chalmers.se/bitstream/20.500.12380/305133/1/CSE%2022-59%20Olsson%20Rylander.pdf">report</a>: "LIRM has solved the issue with lane dependent routing that esmini had, by implementing a new controller that extends the behavior of the pathfinding and route following to incorporate lane changes."</p>
</div>
<div class="paragraph">
<p>This controller enhance the capabilities for an entity to find a path through the road network according to a specified <a href="https://www.asam.net/static_downloads/ASAM_OpenSCENARIO_V1.2.0_Model_Documentation/modelDocumentation/content/Route.html">route</a> (basically a set of waypoints). The main advantage, compared to the route handler of the default controller, is that lane changes will be injected by the path finding algorithm in search for optimal path. The model will also take route strategy (Shortest, Fastest or Least Intersections) into consideration, which the default controller does not yet support.</p>
</div>
<div class="paragraph">
<p>A good example is found in <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Unittest/xosc/follow_route_with_lane_change.xosc">follow_route_with_lane_change.xosc</a>. The vehicle start out in left-most lane and needs to make three lane changes in order to exit the highway.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/follow_route_highway_exit.png" alt="follow route highway exit">
</div>
<div class="title">Route waypoints and resulting trajectory in yellow</div>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./EnvironmentSimulator/Unittest/xosc/follow_route_with_lane_change.xosc --trail_mode 1</code></p>
</div>
<table class="tableblock frame-none grid-none fit-content">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Domain</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">longitudinal and/or lateral (independent).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Properties</strong>:</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>minDistForCollision</code>
</td>
<td class="hdlist2">
<p>affects when a lane change will happen</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>laneChangeTime</code>
</td>
<td class="hdlist2">
<p>duration of lane changes</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>testMode</code>
</td>
<td class="hdlist2">
<p>stop at reached destination - mainly for test purpose (<code>true</code>/<code>false</code> (default))</p>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong>:</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Unittest/xosc/follow_route_with_lane_change.xosc">follow_route_with_lane_change.xosc</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_udpdrivercontroller">6.6.8. UDPDriverController</h4>
<div class="paragraph">
<p>An UDP interface for external driver models or vehicle simulators. The idea is to allow external devices to control entities in an ongoing esmini simulation, over network.</p>
</div>
<div class="paragraph">
<p>Concept:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/esmini/esmini.github.io/raw/main/images/udp_driver_controller_concept.png" alt="udp driver controller concept">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Assign the controller to any scenario vehicle (in the OpenSCENARIO file)</p>
</li>
<li>
<p>Send input to esmini controller</p>
</li>
<li>
<p>The vehicle will be updated by the controller accordingly (and bypassing esmini default controller)</p>
</li>
<li>
<p>receive ground-truth (OSI over UDP) from esmini</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are a few input mode options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>DRIVER_INPUT<br>
Control a simple vehicle model in terms of pedals and steering input. Vehicle will apply latest received values until update is received.</p>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Parameters: 
</td>
<td class="hdlist2">
<p><code>throttle</code><br>
<code>brake</code><br>
<code>steeringAngle</code></p>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>VEHICLE_STATE_XYZHPR<br>
Report explicit complete state, ignoring road geometry. Useful when advanced vehicle dynamics is involved and vehicle for example is pitching as result of acceleration and rolling as result of steering. Optional flag to enable dead reckoning on esmini side, in which case esmini will move entity according to latest received heading and speed (basically extrapolating).</p>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Parameters: 
</td>
<td class="hdlist2">
<p><code>x</code><br>
<code>y</code><br>
<code>z</code><br>
<code>h</code>(eading)<br>
<code>p</code>(itch)<br>
<code>r</code>(oll)<br>
<code>speed</code><br>
<code>wheelAngle</code> (wheel yaw/stering angle)<br>
<code>deadReckon</code> (flag)</p>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>VEHICLE_STATE_XYH<br>
Report explicit partial state. <code>z</code>, <code>pitch</code> and <code>roll</code> are aligned to the road geometry.</p>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Parameters: 
</td>
<td class="hdlist2">
<p><code>x</code><br>
<code>y</code><br>
<code>h</code>(eading)<br>
<code>speed</code><br>
<code>wheelAngle</code> (wheel yaw/stering angle)<br>
<code>deadReckon</code> (flag)</p>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>VEHICLE_STATE_H<br>
Minimal explicit state, useful when the driver model output is only heading and speed.</p>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
Parameters: 
</td>
<td class="hdlist2">
<p><code>h</code>(eading)<br>
<code>speed</code><br>
<code>wheelAngle</code> (wheel yaw/stering angle)<br>
<code>deadReckon</code> (flag)</p>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more info see: <a href="https://www.dropbox.com/s/qc2n7db0h9k7urt/UDPDriverController.pdf?dl=0">UDPDriverController.pdf</a></p>
</div>
<div class="paragraph">
<p>Demo (running a somewhat outdated <a href="https://github.com/esmini/esmini/blob/master/scripts/udp_driver/testUDPDriver.py">testUDPDriver.py</a>):</p>
</div>
<div class="videoblock">
<div class="content">
<iframe width="854" height="480" src="https://www.youtube.com/embed/IuwuGE3BzKw?rel=0&amp;autoplay=1&amp;loop=1&amp;controls=0&amp;playlist=IuwuGE3BzKw" frameborder="0" allowfullscreen></iframe>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_openscenegraph_and_3d_models">7. OpenSceneGraph and 3D models</h2>
<div class="sectionbody">
<div class="paragraph">
<p>esmini make use of OpenSceneGraph (OSG) for visualization of the scenario. The OpenSCENARIO files can optionally refer to existing 3D models of the static environment (scene graph) and dynamic objects (entities). If the scene graph reference is missing, esmini will try to generate a basic model based on the OpenDRIVE road network description. Currently esmini only supports OSG native .osgb 3D file format. However, there are ways to convert 3D models as described next.</p>
</div>
<div class="paragraph">
<p><a href="http://www.openscenegraph.org/">OpenSceneGraph</a> (osg) includes readers and writers for quite a few 3D file formats. It comes with a demo application, <a href="http://www.openscenegraph.org/index.php/documentation/user-guides/55-osgconv">osgconv</a>, a command line tool that simply takes one file as input and outputs the same content in a different format.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="paragraph">
<p>Convert from fbx to osgb format:<br>
<code>osgconv car.fbx car.osgb</code></p>
</div>
<div class="paragraph">
<p>Convert from osgb to <a href="https://www.autodesk.com/products/fbx/overview">fbx</a> format:<br>
<code>osgconv car.osgb car.fbx</code></p>
</div>
<div class="paragraph">
<p>osgconv has a lot of useful options. Run <code>osgconv -h</code> for more info. Here&#8217;s a few examples:</p>
</div>
<div class="paragraph">
<p><code>osgconv in.fbx out.osgb --compressed</code> will compress and embed textures<br>
<code>osgconv in.fbx out.osgb -t 1,5,7</code> will translate the model (x=1, y=5, z=7)<br>
<code>osgconv in.fbx out.osgb -o -90-1,0,0</code> will rotate the model (rotate -90 deg around X-axis)<br>
<code>osgconv in.fbx out.osgb -o -90-1,0,0 --use-world-frame</code> as above but pivot point world origin<br></p>
</div>
<div class="paragraph">
<p>A useful environment variable is <code>OSG_OPTIMIZER</code> which affects the structure and content of the scene graph. For example, if the osgb file includes cloned sub trees, like motorway railings, these might not be populated in the fbx file. To solve that set:</p>
</div>
<div class="paragraph">
<p><code>OSG_OPTIMIZER = FLATTEN_STATIC_TRANSFORMS_DUPLICATING_SHARED_SUBGRAPHS</code></p>
</div>
<div class="paragraph">
<p>Exact syntax depends on your environment. Examples:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>bash</strong>
</td>
<td class="hdlist2">
<p><code>export OSG_OPTIMIZER=FLATTEN_STATIC_TRANSFORMS_DUPLICATING_SHARED_SUBGRAPHS</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>powershell</strong>
</td>
<td class="hdlist2">
<p><code>$env:OSG_OPTIMIZER = "FLATTEN_STATIC_TRANSFORMS_DUPLICATING_SHARED_SUBGRAPHS"</code></p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then run the <code>osgconv</code> command (in the same terminal where you defined the environment variable).</p>
</div>
<div class="paragraph">
<p>osg native format is <code>osgb</code> which stands for OpenSceneGraph binary format. It&#8217;s a stable and compact (quick to load) format, which also can embed textures and animations. Thanks to the osgconv tool, esmini can get away with only supporting the .osgb format and still indirectly support many other 3D formats.</p>
</div>
<div class="sect2">
<h3 id="_get_osgconv">7.1. Get osgconv</h3>
<div class="paragraph">
<p>On Linux and Mac its recommended to build osg yourself. You can try this script: <a href="https://github.com/esmini/esmini/blob/master/scripts/compile_osg_apps_linux.sh">compile_osg_apps_linux.sh</a>. It will first fetch and install <a href="https://www.autodesk.com/developer-network/platform-technologies/fbx-sdk-2020-0">FBX SDK</a> and then build OSG with FBX support. Find more details and instructions in the header of the script.</p>
</div>
<div class="paragraph">
<p>For more info regarding building OSG for Linux, here&#8217;s a great guide:<br>
<a href="https://vicrucann.github.io/tutorials/osg-linux-quick-install/" class="bare">https://vicrucann.github.io/tutorials/osg-linux-quick-install/</a> <br>
But note that it does not consider FBX support.</p>
</div>
<div class="paragraph">
<p>For Windows there&#8217;s an option to grab pre-built binaries including FBX support from here:<br>
<a href="https://objexx.com/OpenSceneGraph.html" class="bare">https://objexx.com/OpenSceneGraph.html</a></p>
</div>
<div class="paragraph">
<p>Here follows an example of how to convert .osgb models into .fbx format for use in the Unity3D framework.</p>
</div>
</div>
<div class="sect2">
<h3 id="_convert_osgb_models_for_use_in_unity">7.2. Convert osgb models for use in Unity</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a command prompt in the folder where your model.osgb is</p>
</li>
<li>
<p>Run command:<br>
<code>osgconv model.osgb out/model.fbx -s 100,100,100</code><br>
"-s &#8230;&#8203;" is for scaling which typically is needed for fbx files.
Potentially it also needs to be oriented according to Unity coordinate system. In that case try:<br>
<code>osgconv model.osgb out/model.fbx -s 100,100,100 --use-world-frame -o 120&#8212;&#8203;0.5773503,-0.5773503,-0.5773503</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A folder named "out" should have been created and including the model.fbx plus any texture files</p>
</div>
</div>
<div class="sect2">
<h3 id="_import_into_unity">7.3. Import into Unity</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Drag the resulting fbx file, and all textures, into a unity project, preferably an empty folder</p>
</li>
<li>
<p>Add the model to the Scene hierarchy</p>
</li>
<li>
<p>Select the model and int the "Inspector", select the "Materials" tab</p>
</li>
<li>
<p>Change the "Location" to "Use External Materials (Legacy)" and click "Apply"</p>
</li>
<li>
<p>Open the automatically created "Materials" folder (next to the model file)</p>
</li>
<li>
<p>Select all materials and change<br>
for standard template: "Rendering Mode" to "Cutout" (good default option) <br>
for HDRP template: "Surface type" to "Transparent" and check "alpha clipping"</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>That should basically be it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_colors_textures_and_wheel_rotations">7.4. Colors, textures and wheel rotations</h3>
<div class="paragraph">
<p>See <a href="https://github.com/esmini/esmini/issues/63#issuecomment-742273326">issue 63</a> for brief info.</p>
</div>
<div class="paragraph">
<p>And these two scripts operating on textures and material respectively, can potentially provide some inspiration:<br>
- <a href="https://github.com/esmini/esmini/blob/master/scripts/bake_signs.sh">bake_signs.sh</a><br>
- <a href="https://github.com/esmini/esmini/blob/master/scripts/fix_dae_materials.py">fix_dae_materials.py</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_support_qa">8. Support / Q&amp;A</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_resources_not_found">8.1. Resources not found</h3>
<div class="paragraph">
<p>There are no fixed structure where scenario resources, e.g. vehicle 3D model or controller catalog, needs to be stored. Instead, additional search paths can be added by launch argument <code>--path &lt;path&gt;</code>. For example:<br></p>
</div>
<div class="paragraph">
<p><code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/slow-lead-vehicle.xosc --path ../../ --path c:/tmp/my_models</code></p>
</div>
<div class="paragraph">
<p>will add the relative path <code>../../</code> and absolute path <code>c:/tmp/my_models</code> to the list of places where to look for resources referred to by the scenario.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mac_issues_and_limitations">8.2. Mac issues and limitations</h3>
<div class="paragraph">
<p>From esmini version 2.26.6 mac executables are universal binaries which means they work on both Intel and Apple Silicon based Macs. Following are some known issues and work arounds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Window can&#8217;t be located in the upper part of the screen (some systems). If window won&#8217;t open, try to adjust the y value (second entry) of the window argument. 60 pixels usually works fine, e.g: <code>./bin/esmini --window 60 60 800 400 --osc ./resources/xosc/cut-in.xosc</code></p>
</li>
<li>
<p>Issue has been reported that when multiple screens are connected esmini just shows a bland window. Currently only solution is to unplug the additional montitors or unplug Mac from dock station.</p>
</li>
<li>
<p>Graphics can not run in separate thread. Hence the <code>--thread</code> launch flag will have no effect.</p>
</li>
<li>
<p>On Mac the zip-package might be put in quarantine, to release it: <code>xattr -d com.apple.quarantine file.zip</code> or even better: <code>xattr -c file.zip</code></p>
</li>
<li>
<p>esmini executables are not signed with a <a href="https://developer.apple.com/developer-id">developer ID</a> - since we simply don&#8217;t have one. If you got the package directly from <a href="https://github.com/esmini/esmini/releases">esmini release page on GitHub</a> it is safe to unpack and run.
In order to execute the files you need to do one of following from a terminal in the folder the demo package was extracted:</p>
<div class="ulist">
<ul>
<li>
<p>Remove quarantine flags: <code>xattr -c -r esmini-demo/bin</code>, or</p>
</li>
<li>
<p>Sign executables for use on local machine: <code>codesign -f -s - esmini-demo/bin/*</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_openstreetmap_osm_roads_in_esmini">8.3. OpenStreetMap (OSM) roads in esmini</h3>
<div class="paragraph">
<p>SUMO comes with a great tool, <a href="https://sumo.dlr.de/docs/netconvert.html">netconvert</a>, that can convert road networks from and to various formats.</p>
</div>
<div class="paragraph">
<p>Prerequisite: Download and install SUMO from <a href="https://sumo.dlr.de/docs/Downloads.php">here</a>.</p>
</div>
<div class="paragraph">
<p>Example: Convert an OSM map to OpenDRIVE for use in esmini:</p>
</div>
<div class="paragraph">
<p><code>netconvert --osm-files city.osm --opendrive-output city.xodr --no-turnarounds</code></p>
</div>
<div class="paragraph">
<p>Preview in odrviewer:</p>
</div>
<div class="paragraph">
<p><code>./bin/odrviewer --window 60 60 800 400 --odr city.xodr</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_update_3d_model_pack">8.4. Update 3D model pack</h3>
<div class="paragraph">
<p>Do either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>remove any <code>resources/models</code> folder</p>
</li>
<li>
<p>from <code>./build</code> folder, run <code>cmake ..</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>get the package from <a href="https://dl.dropboxusercontent.com/s/5gk8bvgzqiaaoco/models.7z?dl=1">here</a> and unpack files into <code>./resources/models</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_issues_at_esmini_github_page">8.5. Issues at esmini GitHub page</h3>
<div class="paragraph">
<p>The <a href="https://github.com/esmini/esmini/issues">Issues tab at esmini GitHub page</a> is a valuable source of questions and answers. To search in all issues, make sure to set filter: <code>is:issue</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_guide">9. Build guide</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_build_configurations">9.1. Build configurations</h3>
<div class="paragraph">
<p><a href="https://cmake.org/">CMake</a> tool is used to create standard make configurations. A few example "create&#8230;&#8203;" batch scripts are supplied as examples how to generate desired build setup.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>VisualStudio / win64 / Windows SDK v10 / Release and Debug</p>
</li>
<li>
<p>Ubuntu and Kubuntu (tested on 18.04) / gcc / Release and Debug</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, it should be possible to configure custom variants using cmake. For example to use Visual Studio 2019 run the following commands from command prompt (CMD or PowerShell), assuming starting point is esmini root folder:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mkdir build
cd build
cmake -G "Visual Studio 16 2019" ..
cmake --build . --config Release --target install</pre>
</div>
</div>
<div class="paragraph">
<p>This will first generate Visual Studio solution and then compile esmini using MSVC toolset v142 (default with Visual Studio 2019). Default architecture is x64.</p>
</div>
<div class="paragraph">
<p>If you want to compile with MSVC 2017 toolset just add directive to the generator as follows:</p>
</div>
<div class="paragraph">
<p><code>
cmake -G "Visual Studio 16 2019" -T v141 ..
</code></p>
</div>
<div class="paragraph">
<p>A complete list of supported toolsets are available <a href="https://cmake.org/cmake/help/v3.17/variable/MSVC_TOOLSET_VERSION.html">here</a>.</p>
</div>
<div class="paragraph">
<p>If you want to specify architecture you simply add -A x64 or -A Win32. So for example, if you want to compile with MSVC 2015 toolset and for win32 use the following generator command:</p>
</div>
<div class="paragraph">
<p><code>
cmake -G "Visual Studio 16 2019" -T v140 -A Win32 ..
</code></p>
</div>
<div class="paragraph">
<p>Of course, building with a specific toolset requires it to be installed. Use <a href="https://docs.microsoft.com/en-us/visualstudio/install/install-visual-studio?view=vs-2019">Visual Studio Installer</a>. Steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>choose "Modify"</p>
</li>
<li>
<p>make sure Desktop Development with C++ is checked</p>
</li>
<li>
<p>go to tab "Individual components"</p>
</li>
<li>
<p>scroll down to "Compilers, build tools, and runtimes"</p>
</li>
<li>
<p>check the MSVC versions you need, e.g. "MSVC v140 - VS 2015 C build tools (v14.00)" and "MSVC v141 - VS 2017 C x64/x86 build tools (v14.16)"</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All configurations defines an "Install" build target that compiles (if needed) and copies relevant binaries into a common "esmini/bin" folder recognized by the example scripts under the "esmini/run" folder.</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>For automatic downloading of external dependencies (OSG binaries) and 3D models, CMake version 3.11.4 or above is required (FetchContent_MakeAvailable was introduced).<br></p>
</li>
<li>
<p>In Windows, if you get an error like "the c compiler identification is unknown", then please make sure to install "Windows Universal CRT SDK" from the Visual Studio Installer tool.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_external_dependencies">9.2. External dependencies</h3>
<div class="paragraph">
<p>esmini is designed to link all dependencies statically. Main reason is to have a all-inclusive library for easy integration either as a shared library/DLL (e.g. plugin in Unity, or S-function in Simulink) or statically linked into a native application.</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> Nothing stops you from going with all dynamic linking, it&#8217;s just that provided build scripts are not prepared for it.</p>
</div>
<div class="paragraph">
<p>CMake scripts will download several pre-compiled 3rd party packages and 3D model resource files.</p>
</div>
<div class="paragraph">
<p>Default location for these resources is Google drive. If there is an issue, try switch to the backup location at Dropbox by changing the following line in <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/CMakeLists.txt">EnvironmentSimulator/CMakeLists.txt</a>:</p>
</div>
<div class="paragraph">
<p><code>set ( FILE_STORAGE "google" )</code><br>
to<br>
<code>set ( FILE_STORAGE "dropbox" )</code><br></p>
</div>
<div class="paragraph">
<p>Links to all packages can be found in <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/CMakeLists.txt">EnvironmentSimulator/CMakeLists.txt</a>.</p>
</div>
<div class="paragraph">
<p>If you need to (re)build a 3rd party lib for some reason, e.g. for an yet unsupported system or need for a specific version, these build scripts might be a starting point:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/esmini/esmini/blob/master/scripts/generate_osg_libs.sh">scripts/generate_osg_libs.sh</a></p>
</li>
<li>
<p><a href="https://github.com/esmini/esmini/blob/master/scripts/generate_osi_libs.sh">scripts/generate_osi_libs.sh</a></p>
</li>
<li>
<p><a href="https://github.com/esmini/esmini/blob/master/scripts/generate_sumo_libs.sh">scripts/generate_sumo_libs.sh</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or this script that builds all three libs, combining the above ones:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/esmini/esmini/blob/master/scripts/generate_osi_sumo_osg_libs.sh">scripts/generate_osi_sumo_osg_libs.sh</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_additional_platform_dependencies">9.3. Additional platform dependencies</h3>
<div class="paragraph">
<p>Linux Ubuntu 18.04</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>sudo apt install build-essential git pkg-config libgl1-mesa-dev libpthread-stubs0-dev libjpeg-dev libxml2-dev libpng-dev libtiff5-dev libgdal-dev libpoppler-dev libdcmtk-dev libgstreamer1.0-dev libgtk2.0-dev libcairo2-dev libpoppler-glib-dev libxrandr-dev libxinerama-dev curl cmake</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, g++ version &gt;= 5 is needed for c++14 code support.</p>
</div>
<div class="paragraph">
<p>Windows and Mac: Install the <a href="https://cmake.org/">cmake</a> application</p>
</div>
</div>
<div class="sect2">
<h3 id="_dynamic_protobuf_linking">9.4. Dynamic protobuf linking</h3>
<div class="paragraph">
<p>When linking esmini with software already dependent on Google protobuf there might be need for dynamic linking of shared protobuf library. This can be achieved by defining cmake symbol DYN_PROTOBUF as following example:</p>
</div>
<div class="paragraph">
<p><code>cmake -D DYN_PROTOBUF=True ..</code></p>
</div>
<div class="paragraph">
<p>Then build as usual. It will link with protobuf shared library instead of linking with a static library.</p>
</div>
<div class="paragraph">
<p>When running esmini protobuf shared library need to be available. Set LD_LIBRARY_PATH to point to the folder where the library is, example:</p>
</div>
<div class="paragraph">
<p><code>export LD_LIBRARY_PATH=./externals/OSI/linux/lib-dyn</code></p>
</div>
<div class="paragraph">
<p><strong>Note:</strong><br>
The dynamic versions of protobuf were added Aug 31 2021. So you might need to update the OSI library package. Get the latest from following links:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://dl.dropboxusercontent.com/s/an58ckp2qfx5069/osi_v10.7z?dl=0">OSI Windows</a></p>
</li>
<li>
<p><a href="https://dl.dropboxusercontent.com/s/kwtdg0c1c8pawa1/osi_linux.7z?dl=0">OSI Linux</a></p>
</li>
<li>
<p><a href="https://dl.dropboxusercontent.com/s/m62v19gp0m73dte/osi_mac.7z?dl=0">OSI Mac</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_slim_esmini_customize_configration">9.5. Slim esmini - customize configration</h3>
<div class="paragraph">
<p>The external dependencies OSG, OSI and SUMO are optional. Also the unit test suite is optional, in effect making the dependecy to googletest framework optional as well. All these options are simply controlled by the following cmake options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>USE_OSG</p>
</li>
<li>
<p>USE_OSI</p>
</li>
<li>
<p>USE_SUMO</p>
</li>
<li>
<p>USE_GTEST</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So, for example, to cut dependency to OSG and SUMO, run: <br>
<code>cmake -D USE_OSG=False -D USE_SUMO=False ..</code></p>
</div>
<div class="paragraph">
<p>To disable OSG, SUMO, OSI and googletest, run: <br>
<code>cmake -D USE_OSG=False -D USE_SUMO=False -D USE_OSI=False -D USE_GTEST=False ..</code></p>
</div>
<div class="paragraph">
<p>All options are enabled/True as default.</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong><br>
Disabling an external dependency will disable corresponding functionality. So, for example, disabling OSI means that no OSI data can be created by esmini. Disabling OSG means that esmini can&#8217;t visualize the scenario. However it can still run the scenario and create a .dat file, which can be played and visualized later in another esmini build in which OSG is enabled (even on another platform).</p>
</div>
</div>
<div class="sect2">
<h3 id="_msys2_mingw_w64_support">9.6. MSYS2 / MinGW-w64 support</h3>
<div class="paragraph">
<p>esmini slim can be compiled and executed in the MSYS2 environment. Try following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Download MSYS2 from: <a href="https://www.msys2.org" class="bare">https://www.msys2.org</a></p>
</li>
<li>
<p>Install with default options</p>
</li>
<li>
<p>Start MSYS2 MinGW x64 (e.g. from start menu)</p>
</li>
<li>
<p>Update MSYS2 packages, run:<br>
<code>
pacman -Syu --disable-download-timeout --noconfirm
</code><br>
(MSYS2 should close automatically)</p>
</li>
<li>
<p>Restart MSYS2</p>
</li>
<li>
<p>Finalize update and install needed packages, run:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>pacman -Su --disable-download-timeout --noconfirm
pacman -S --needed base-devel mingw-w64-x86_64-toolchain --disable-download-timeout --noconfirm
pacman -S mingw-w64-x86_64-cmake --disable-download-timeout --noconfirm</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Optional (not needed to compile or run esmini):<br>
<code>pacman -S git --disable-download-timeout --noconfirm</code></p>
</li>
<li>
<p>Build esmini (from MSYS2 MinGW x64 command line):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cmake -G &quot;MSYS Makefiles&quot; -D USE_OSG=False -D USE_SUMO=False -D USE_OSI=False -D USE_GTEST=False ..
cmake --build . --config Release --target install</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_esmini_project">9.7. Build esmini project</h3>
<div class="paragraph">
<p>First generate build configuration (see above)</p>
</div>
<div class="paragraph">
<p>Then it should work on all platform to build using cmake as follows:<br>
<code>cmake --build . --config Release --target install</code></p>
</div>
<div class="paragraph">
<p>Or you can go with platform specific ways of building:</p>
</div>
<div class="paragraph">
<p><strong>Windows/Visual Studio</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open generated solution, build*/EnvironmentSimulator.sln</p>
</li>
<li>
<p>Select configuration, Debug or Release</p>
</li>
<li>
<p>Build CMakePredefinedTargets/INSTALL (right-click and select build)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>macOS</strong></p>
</div>
<div class="paragraph">
<p>To generate a Xcode project file, run the initial cmake command as follows:<br>
<code>cmake -G Xcode ..</code></p>
</div>
<div class="paragraph">
<p>Then build as usual:<br>
<code>cmake --build . --config Release --target install</code></p>
</div>
<div class="paragraph">
<p>or using Xcode directly:<br>
<code>xcodebuild -scheme install -configuration Release build</code></p>
</div>
<div class="paragraph">
<p>or open the generated project file in Xcode, and build from there.</p>
</div>
<div class="paragraph">
<p>To create bundles (shared library container), do from esmini root folder:<br></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>lipo -create bin/libesminiRMLib.dylib -output bin/esminiRMLib.bundle
lipo -create bin/libesminiLib.dylib -output bin/esminiLib.bundle</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Linux</strong></p>
</div>
<div class="paragraph">
<p>Once <code>cmake ..</code> has created the build configuration, of course you can build by calling the gnu <code>make</code> applciation directly instead of going via <code>cmake --build</code> as described above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd build
make -j4 install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will build all projects, in four parallel jobs, and copy the binaries into a dedicated folder found by the demo batch scripts.</p>
</div>
</div>
<div class="sect2">
<h3 id="_centos_7_linux">9.8. CentOS 7 (Linux)</h3>
<div class="paragraph">
<p>CentOS 7 has some limitations, e.g. old versions of C/C++ compiler toolkits and runtimes. So it&#8217;s not possible to link with provided 3rd party binary libraries targeting Ubuntu 18++.
However, by disabling some featuers in esmini, e.g. OSI and SUMO, it can still be used for previewing scenarios.</p>
</div>
<div class="paragraph">
<p>VirtualBox image for Windows host here:<br>
<a href="https://www.linuxvmimages.com/images/centos-7/" class="bare">https://www.linuxvmimages.com/images/centos-7/</a></p>
</div>
<div class="paragraph">
<p>Follow steps below to build and run esmini on CentOS 7.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>sudo yum install git
sudo yum install cmake
sudo yum install gcc-c++

sudo yum install freeglut-devel
sudo yum install fontconfig-devel
sudo yum install libXrandr-devel
sudo yum install libXinerama-devel

sudo yum install epel-release
sudo yum install p7zip

git clone https://github.com/esmini/esmini

cd esmini

cd externals
mkdir OpenSceneGraph
cd OpenSceneGraph
curl -L &quot;https://www.dropbox.com/s/mxztf6zbgojyntp/osg_centos.7z?dl=1&quot; -o osg_centos.7z
7za x osg_centos.7z
rm osg_centos.7z

cd ../..
mkdir build
cd build
cmake -D USE_OSG=True -D USE_SUMO=False -D USE_OSI=False -D USE_GTEST=False ..
cmake --build . --target install --config Release
cd ..
./bin/esmini.exe --headless --fixed_timestep 0.01 --record sim.dat --osc ./resources/xosc/cut-in.xosc</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_command_reference">10. Command reference</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_esmini">10.1. esmini</h3>
<div class="sect3">
<h4 id="_launch_commands">10.1.1. Launch commands</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Usage: esmini [options]
Options:
  --osc &lt;filename&gt;
      OpenSCENARIO filename (required) - if path includes spaces, enclose with &quot;&quot;
  --aa_mode &lt;mode&gt;
      Anti-alias mode=number of multisamples (subsamples, 0=off, 4=default)
  --bounding_boxes
      Show entities as bounding boxes (toggle modes on key ',')
  --capture_screen
      Continuous screen capture. Warning: Many jpeg files will be created
  --camera_mode &lt;mode&gt;
      Initial camera mode (&quot;orbit&quot; (default), &quot;fixed&quot;, &quot;flex&quot;, &quot;flex-orbit&quot;, &quot;top&quot;, &quot;driver&quot;, &quot;custom&quot;) (swith with key 'k')
  --csv_logger &lt;csv_filename&gt;
      Log data for each vehicle in ASCII csv format
  --collision
      Enable global collision detection, potentially reducing performance
  --custom_camera &lt;position&gt;
      Additional custom fixed camera position &lt;x,y,z,h,p&gt; (multiple occurrences supported)
  --custom_fixed_camera &lt;position and optional orientation&gt;
      Additional custom camera position &lt;x,y,z&gt;[,h,p] (multiple occurrences supported)
  --custom_fixed_top_camera &lt;position and rotation&gt;
      Additional custom top camera &lt;x,y,z,rot&gt; (multiple occurrences supported)
  --disable_controllers
      Disable controllers
  --disable_log
      Prevent logfile from being created
  --disable_off_screen
      Disable esmini off-screen rendering, revert to OSG viewer default handling
  --disable_stdout
      Prevent messages to stdout
  --enforce_generate_model
      Generate road 3D model even if SceneGraphFile is specified
  --fixed_timestep &lt;timestep&gt;
      Run simulation decoupled from realtime, with specified timesteps
  --generate_no_road_objects
      Do not generate any OpenDRIVE road objects (e.g. when part of referred 3D model)
  --ground_plane
      Add a large flat ground surface
  --headless
      Run without viewer window
  --help
      Show this help message
  --hide_route_waypoints
      Disable route waypoint visualization (toggle with key 'R')
  --hide_trajectories
      Hide trajectories from start (toggle with key 'n')
  --info_text &lt;mode&gt;
      Show on-screen info text (toggle key 'i') mode 0=None 1=current (default) 2=per_object 3=both
  --logfile_path &lt;path&gt;
      logfile path/filename, e.g. &quot;../esmini.log&quot; (default: log.txt)
  --osc_str &lt;string&gt;
      OpenSCENARIO XML string
  --osi_file [filename]  (default = ground_truth.osi)
      save osi trace file
  --osi_freq &lt;frequence&gt;
      relative frequence for writing the .osi file e.g. --osi_freq=2 -&gt; we write every two simulation steps
  --osi_lines
      Show OSI road lines (toggle during simulation by press 'u')
  --osi_points
      Show OSI road pointss (toggle during simulation by press 'y')
  --osi_receiver_ip &lt;IP address&gt;
      IP address where to send OSI UDP packages
  --path &lt;path&gt;
      Search path prefix for assets, e.g. OpenDRIVE files (multiple occurrences supported)
  --record &lt;filename&gt;
      Record position data into a file for later replay
  --road_features &lt;mode&gt;
      Show OpenDRIVE road features (&quot;on&quot;, &quot;off&quot;  (default)) (toggle during simulation by press 'o')
  --save_generated_model
      Save generated 3D model (n/a when a scenegraph is loaded)
  --seed &lt;number&gt;
      Specify seed number for random generator
  --sensors
      Show sensor frustums (toggle during simulation by press 'r')
  --server
      Launch server to receive state of external Ego simulator
  --threads
      Run viewer in a separate thread, parallel to scenario engine
  --trail_mode &lt;mode&gt;
      Show trail lines and/or dots (toggle key 'j') mode 0=None 1=lines 2=dots 3=both
  --version
      Show version and quit

Additional OSG graphics options:
  --clear-color &lt;color&gt;                      Set the background color of the viewer in the form &quot;r,g,b[,a]&quot;
  --screen &lt;num&gt;                             Set the screen to use when multiple screens are present
  --window &lt;x y w h&gt;                         Set the position x, y and size w, h of the viewer window. -1 -1 -1 -1 for fullscreen.
  --borderless-window &lt;x y w h&gt;              Set the position x, y and size w, h of a borderless viewer window. -1 -1 -1 -1 for fullscreen.
  --SingleThreaded                           Run application and all graphics tasks in one single thread.

For a complete list of OSG options and environment variables, see here:
https://github.com/esmini/esmini/blob/master/docs/osg_options_and_env_variables.txt</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_runtime_key_shortcut_commands">10.1.2. Runtime key shortcut commands</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Key shortcuts

    H (shift + h): This help text
    Space:         Toggle pause/play simulation
    Return:        Step simulation (one timestep) then pause
    TAB:           Move camera to next vehicle
    Shift + TAB:   Move camera to previoius vehicle
    Delete:        Same as above (Shift + TAB)
    o:             Toggle show/hide OpenDRIVE road feature lines
    u:             Toggle show / hide OSI road lines
    y:             Toggle show / hide OSI road points
    p:             Toggle show / hide environment 3D model
    r:             Toggle show / hide sensor view frustums
    R:             Toggle route waypoint visualization
    i:             Toggle on-screen info text modes
    j:             Toggle show trails after vehicles(4 modes: none / dots / lines / both)
    n:             Toggle show active trajectories
    , (comma):     Switch entity view : Model only / Bounding box / Model + Bounding box / None
    ESC:           quit

    Arrow keys is used to drive externally controlled Ego vehicle:
        Up:    Accelerate
        Down:  Brake
        Left:  Steer left
        Right: Steer right

    1 - 9: Camera models acording to :
        1: Custom camera model
        2: Flight
        3: Drive
        4: Terrain
        5: Orbit
        6: FirstPerson
        7: Spherical
        8: NodeTracker
        9: Trackball

    When custom camera model(1) is activated
        k: Switch between the following sub models:
           - Orbit        (camera facing vehicle, rotating around it)
           - Fixed        (fix rotation, always straight behind vehicle)
           - Flex         (imagine the camera attached to vehicle via an elastic string)
           - Flex - orbit (Like flex but allows for roatation around vehicle)
           - Top          (top view, fixed rotation, always straight above vehicle)
           - Driver       (&quot;driver&quot; view, fixed at center of vehicle)

    Viewer options
        f: Toggle full screen mode
        t: Toggle textures
        s: Rendering statistics
        l: Toggle light
        w: Toggle geometry mode(shading, wireframe, dots)
        c: Save screenshot in JPEG format - in the folder where the application was started from
        C: Toggle continuous screen capture (e.g for video creation)
        h: Help

Mouse control

    Left:   Rotate
    Right:  Zoom
    Middle: Pan

    This is typical, exact behaviour depends on active camera model.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_replayer">10.2. replayer</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Usage:  [options]
Options:
  --file &lt;filename&gt;
      Simulation recording data file (.dat)
  --camera_mode &lt;mode&gt;
      Initial camera mode (&quot;orbit&quot; (default), &quot;fixed&quot;, &quot;flex&quot;, &quot;flex-orbit&quot;, &quot;top&quot;, &quot;driver&quot;) (toggle during simulation by press 'k')
  --capture_screen
      Continuous screen capture. Warning: Many jpeg files will be created
  --collision
      Pauses the replay if the ego collides with another entity
  --custom_camera &lt;position&gt;
      Additional custom fixed camera position &lt;x,y,z,h,p&gt; (multiple occurrences supported)
  --custom_fixed_camera &lt;position and optional orientation&gt;
      Additional custom camera position &lt;x,y,z&gt;[,h,p] (multiple occurrences supported)
  --custom_fixed_top_camera &lt;position and rotation&gt;
      Additional custom top camera &lt;x,y,z,rot&gt; (multiple occurrences supported)
  --dir &lt;path&gt;
      Directory containing replays to overlay, pair with &quot;file&quot; argument, where &quot;file&quot; is .dat filename match substring
  --disable_off_screen
      Disable esmini off-screen rendering, revert to OSG viewer default handling
  --hide_trajectories
      Hide trajectories from start (toggle with key 'n')
  --info_text &lt;mode&gt;
      Show on-screen info text (toggle key 'i') mode 0=None 1=current (default) 2=per_object 3=both
  --no_ghost
      Remove ghost entities
  --no_ghost_model
      Remove only ghost model, show trajectory (toggle with key 'g')
  --path &lt;path&gt;
      Search path prefix for assets, e.g. model_ids.txt file (multiple occurrences supported)
  --quit_at_end
      Quit application when reaching end of scenario
  --remove_object &lt;id&gt;
      Remove object(s). Multiple ids separated by comma, e.g. 2,3,4.
  --repeat
      loop scenario
  --res_path &lt;path&gt;
      Path to resources root folder - relative or absolut
  --road_features
      Show OpenDRIVE road features
  --save_merged &lt;filename&gt;
      Save merged data into one dat file, instead of viewing
  --start_time &lt;ms&gt;
      Start playing at timestamp
  --stop_time &lt;ms&gt;
      Stop playing at timestamp (set equal to time_start for single frame)
  --time_scale &lt;factor&gt;
      Playback speed scale factor (1.0 == normal)
  --view_mode &lt;view_mode&gt;
      Entity visualization: &quot;model&quot;(default)/&quot;boundingbox&quot;/&quot;both&quot;

Additional OSG graphics options:
  --clear-color &lt;color&gt;                      Set the background color of the viewer in the form &quot;r,g,b[,a]&quot;
  --screen &lt;num&gt;                             Set the screen to use when multiple screens are present
  --window &lt;x y w h&gt;                         Set the position x, y and size w, h of the viewer window. -1 -1 -1 -1 for fullscreen.
  --borderless-window &lt;x y w h&gt;              Set the position x, y and size w, h of a borderless viewer window. -1 -1 -1 -1 for fullscreen.
  --SingleThreaded                           Run application and all graphics tasks in one single thread.

Key shortcuts

    H (shift + h): This help text
    TAB:           Move camera to next vehicle
    Shift + TAB:   Move camera to previoius vehicle
    Delete:        Same as above (Shift + TAB)
    Space:         Toggle pause / play
    g:             Toggle show / hide ghost models
    o:             Toggle show / hide OpenDRIVE road feature lines
    u:             Toggle show / hide OSI road lines
    y:             Toggle show / hide OSI road points
    p:             Toggle show / hide environment 3D model
    i:             Toggle on-screen info text modes
    n:             Toggle show active trajectories
    , (comma):     Switch entity view : Model only / Bounding box / Model + Bounding box / None
    ESC:           quit

    Arrow keys
        Left:          Pause and move to previous frame(+Shift to skip 10 frames)
        Right:         Pause and move to next frame(+Shift to skip 10 frames)
        Shift + Left:  Pause and jump 10 frames back
        Shift + Right: Pause and jump 10 frames forward
        Ctrl + Left:   Jump to beginning
        Ctrl + Right:  Jump to end
        Up:            Increase timeScale(play faster)
        Down:          Decrease timeScale(play slower)

    1 - 9: Camera models acording to :
        1: Custom camera model
        2: Flight
        3: Drive
        4: Terrain
        5: Orbit
        6: FirstPerson
        7: Spherical
        8: NodeTracker
        9: Trackball

    When custom camera model(1) is activated
        k: Switch between the following sub models:
           - Orbit        (camera facing vehicle, rotating around it)
           - Fixed        (fix rotation, always straight behind vehicle)
           - Flex         (imagine the camera attached to vehicle via an elastic string)
           - Flex - orbit (Like flex but allows for roatation around vehicle)
           - Top          (top view, fixed rotation, always straight above vehicle)
           - Driver       (&quot;driver&quot; view, fixed at center of vehicle)

    Viewer options
        f: Toggle full screen mode
        t: Toggle textures
        s: Rendering statistics
        l: Toggle light
        w: Toggle geometry mode(shading, wireframe, dots)
        c: Save screenshot in JPEG format - in the folder where the application was started from
        C: Toggle continuous screen capture (e.g for video creation)
        h: Help

Mouse control

    Left:   Rotate
    Right:  Zoom
    Middle: Pan

    This is typical, exact behaviour depends on active camera model.

Recommended usage:
    Run esmini headless (fast without viewer) and produce a .dat file. Then launch replayer to view it. Example in Windows PowerShell, starting from esmini/bin folder:

    .\esmini --osc ..\resources\xosc\cut-in.xosc --record sim.dat --headless --fixed_timestep 0.01 ; .\replayer --file sim.dat --window 60 60 800 400 --res_path ..\resources --repeat</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_odrviewer">10.3. odrviewer</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Usage: odrviewer [options]
Options:
  --help
      Show this help message
  --odr &lt;odr_filename&gt;
      OpenDRIVE filename (required)
  --capture_screen
      Continuous screen capture. Warning: Many .tga files will be created
  --density [density]  (default = 1.000000)
      density (cars / 100 m)
  --enforce_generate_model
      Generate road 3D model even if --model is specified
  --disable_log
      Prevent logfile from being created
  --disable_off_screen
      Disable esmini off-screen rendering, revert to OSG viewer default handling
  --disable_stdout
      Prevent messages to stdout
  --fixed_timestep &lt;timestep&gt;
      Run simulation decoupled from realtime, with specified timesteps
  --generate_no_road_objects
      Do not generate any OpenDRIVE road objects (e.g. when part of referred 3D model)
  --ground_plane
      Add a large flat ground surface
  --logfile_path &lt;path&gt;
      logfile path/filename, e.g. &quot;../esmini.log&quot; (default: log.txt)
  --model &lt;model_filename&gt;
      3D Model filename
  --osi_lines
      Show OSI road lines (toggle during simulation by press 'u')
  --osi_points
      Show OSI road points (toggle during simulation by press 'y')
  --path &lt;path&gt;
      Search path prefix for assets, e.g. car and sign model files
  --road_features
      Show OpenDRIVE road features (toggle during simulation by press 'o')
  --save_generated_model
      Save generated 3D model (n/a when a scenegraph is loaded)
  --seed &lt;number&gt;
      Specify seed number for random generator
  --speed_factor [speed_factor]  (default = 1.000000)
      speed_factor &lt;number&gt;
  --traffic_rule &lt;rule (right/left)&gt;
      Enforce left or right hand traffic, regardless OpenDRIVE rule attribute (default: right)
  --version
      Show version and quit

Additional OSG graphics options:
  --clear-color &lt;color&gt;                      Set the background color of the viewer in the form &quot;r,g,b[,a]&quot;
  --screen &lt;num&gt;                             Set the screen to use when multiple screens are present
  --window &lt;x y w h&gt;                         Set the position x, y and size w, h of the viewer window. -1 -1 -1 -1 for fullscreen.
  --borderless-window &lt;x y w h&gt;              Set the position x, y and size w, h of a borderless viewer window. -1 -1 -1 -1 for fullscreen.
  --SingleThreaded                           Run application and all graphics tasks in one single thread.

For a complete list of OSG options and environment variables, see here:
https://github.com/esmini/esmini/blob/master/docs/osg_options_and_env_variables.txt

Examples:

1. View the ODR file and some random traffic on a 3D model, window mode 1000 x 500:
   odrviewer --odr xodr\e6mini.xodr --model models\e6mini.osgb --window 60 60 1000 500

2. Just ODR, fullscreen
   odrviewer --odr xodr\e6mini.xodr

3. Remove traffic
   odrviewer --odr xodr\e6mini.xodr --model models\e6mini.osgb --density 0 --window 60 60 1000 500

4. Sparse traffic (about 0.5 vehicle per 100 meter = 1 per 200 m)
   odrviewer --odr xodr\e6mini.xodr --model models\e6mini.osgb --density 0.5 --window 60 60 1000 500


Key shortcuts

    H (shift h): This help text
    TAB:         Move camera to next vehicle
    Shift - TAB: Move camera to previoius vehicle
    o:           Toggle show/hide OpenDRIVE road feature lines
    u:           Toggle show / hide OSI road lines
    y:           Toggle show / hide OSI road points
    p:           Toggle show / hide environment 3D model
    i:           Toggle info text showing time and speed
    , (comma):   Toggle entity view : Model / None
    ESC:         quit

    1 - 9: Camera models acording to :
        1: Custom camera model
        2: Flight
        3: Drive
        4: Terrain
        5: Orbit
        6: FirstPerson
        7: Spherical
        8: NodeTracker
        9: Trackball

    When custom camera model(1) is activated
        k: Switch between the following sub models:
           - Orbit        (camera facing vehicle, rotating around it)
           - Fixed        (fix rotation, always straight behind vehicle)
           - Flex         (imagine the camera attached to vehicle via an elastic string)
           - Flex - orbit (Like flex but allows for roatation around vehicle)
           - Top          (top view, fixed rotation, always straight above vehicle)
           - Driver       (&quot;driver&quot; view, fixed at center of vehicle)

    Viewer options
        f: Toggle full screen mode
        t: Toggle textures
        s: Rendering statistics
        l: Toggle light
        w: Toggle geometry mode(shading, wireframe, dots)
        c: Save screenshot in JPEG format - in the folder where the application was started from
        C: Toggle continuous screen capture
        h: Help

Mouse control

    Left:   Rotate
    Right:  Zoom
    Middle: Pan

    This is typical, exact behaviour depends on active camera model.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_plot_dat_py">10.4. plot_dat.py</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>usage: plot_dat.py [-h] [--x_axis X_AXIS] [--equal_axis_aspect] [--derive] [--dots] (--list_params | --param PARAM) &lt;filename&gt;

positional arguments:
  filename             dat filename

optional arguments:
  -h, --help           show this help message and exit
  --x_axis X_AXIS      x-axis parameter
  --equal_axis_aspect  lock aspect ratio = 1:1
  --derive             derive values wrt x, i.e. dy/dx
  --dots               add dots
  --list_params        list available parameters in given file
  --param PARAM        parameter to plot (can be specified multiple times)

Note: In addition to &lt;filename&gt; one of the arguments --list_params and --param &lt;PARAM&gt; is required</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_esmini_lib_programming">11. esmini lib programming</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_about_the_lib_itself">11.1. About the lib itself</h3>
<div class="paragraph">
<p>The main idea with esmini lib is to provide a limited, simplifed but useful API to the complex world of esmini, OpenSCENARIO and traffic simulation. By making use of only standard C types it has been possible to wrap and use the library in numerous environments, like for example MATLAB, Simulink and Unity (C#).</p>
</div>
<div class="paragraph">
<p>esmini lib is a, so called, shared library which is linked dynamically with a custom application. This means that it&#8217;s not linked statically with the application, instead it&#8217;s loaded whenever the application is launched. An obvious advantage with shared libraries is that they can be shared between multiple applications, reducing size and potentially simplify maintenance.</p>
</div>
<div class="paragraph">
<p>An additional important advantage with dynamic linking is that the library can be updated without need to recompile the custom application making use of the library (however it can&#8217;t be updated during runtime, only in between launches). An obvious requirement is that the API is compatible when replacing a library with a different version, since the API is established at link-time. On the other side of the "same coin", a disadvantage with dynamic linking is that you need to have the shared library present at run-time.</p>
</div>
<div class="paragraph">
<p>Although esmini lib is a shared library itself, it includes everything needed in terms of 3rd party functionality. It&#8217;s actally linking all dependencies statically. Think about it as a single container including everything needed, e.g. support for 3D graphics, XML, expressions, and SUMO traffic simulation. There are two advantages with this approach: 1. Getting rid of dependency to hundreds of 3rd party shared libraries and 2. The linker makes sure to only include relevant functions which reduce the size by extreme (compared to bundle individual and complete shared libraries).</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_interact_with_esmini_lib_api">11.2. How to interact with esmini lib API</h3>
<div class="paragraph">
<p>Below is a typical interaction between a custom application (e.g. vehicle simulator) and esmini (providing simulation of the environment, like road and traffic).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 7.1428%;">
<col style="width: 35.7142%;">
<col style="width: 7.1428%;">
<col style="width: 35.7145%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Frame</th>
<th class="tableblock halign-left valign-top">app time</th>
<th class="tableblock halign-left valign-top">app events</th>
<th class="tableblock halign-left valign-top">esmini time</th>
<th class="tableblock halign-left valign-top">esmini events</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 (t=0.0)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Init esmini("scenario.xosc") &#8658;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step(dt=0.0)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>check conditions</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>update actions</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>step default controller (establish initial positions and speed)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>save to dat, send OSI</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Draw()</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get Ego state (initial position, speed&#8230;&#8203;) &#8658;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8656; Return Ego initial state</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 (t=0.0&#8594;0.1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update Ego(dt=0.1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Do internal stuff, like vehicle dynamics</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Report Ego state(state) &#8658;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register state of Ego, protect it from default controller (but do not apply state yet)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step esmini(dt=0.1) &#8658;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step(dt=0.1)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>check conditions</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>update actions</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>step default controller (move entities, except Ego)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>update simulation time</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>apply states from external entities (Ego)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>save to dat, send OSI</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Draw()</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 (t=0.1&#8594;0.2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update Ego(dt=0.1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Do internal stuff, like vehicle dynamics</p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Report Ego state(state) &#8658;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register state of Ego, protect it from default controller (but do not apply state yet)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step esmini(dt=0.1) &#8658;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Step(dt=0.1)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>check conditions</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>update actions</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>step default controller (move entities, except Ego)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>update simulation time</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>apply states from external entities (Ego)</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>save to dat, send OSI</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.2</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>Draw()</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">and so on&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_functionality">11.3. Functionality</h3>
<div class="paragraph">
<p>No systematic documentation available. See header files <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp">esminiLib.hpp</a> and <a href="https://github.com/esmini/esmini/blob/master/EnvironmentSimulator/Libraries/esminiRMLib/esminiRMLib.hpp">esminiRMLib.hpp</a> for API details.</p>
</div>
<div class="paragraph">
<p>The following section covers some specific use cases of the library.</p>
</div>
<div class="sect3">
<h4 id="_save_or_grab_images">11.3.1. Save or grab images</h4>
<div class="paragraph">
<p>Screenshots can be controlled via the API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">int</span> SE_SaveImagesToFile(<span class="predefined-type">int</span> nrOfFrames);</code></pre>
</div>
</div>
<div class="paragraph">
<p>nrOfFrames: -1 &#8658; continuously, 0 &#8658; stop, &gt; 0 &#8658; number of frames, e.g. 1=next frame only, 2=next two frames</p>
</div>
<div class="paragraph">
<p>Images will be stored in current folder with name <code>screen_shot_*.tga</code> (* = counter) for post processing.</p>
</div>
<div class="paragraph">
<p>Images can also be saved to memory for instant processing. Control the feature with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">int</span> SE_SaveImagesToRAM(<span class="predefined-type">bool</span> state);</code></pre>
</div>
</div>
<div class="paragraph">
<p>state: true &#8658; capture images, false &#8658; don&#8217;t capture (default, might improve performance on some systems)</p>
</div>
<div class="paragraph">
<p>Grab image with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="predefined-type">int</span> SE_FetchImage(SE_Image *image);</code></pre>
</div>
</div>
<div class="paragraph">
<p>image is a reference to a SE_Image struct which will contain the image meta and image data</p>
</div>
<div class="paragraph">
<p>See <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/image-capture">image-capture</a> code example.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Note:</strong> In order to grab a rendered frame image, it must have been saved to RAM during the post rendering phase. First frame will be saved to RAM by default. The SE_SaveImagesToRAM() function must be used to enable the feature for frames &gt; 0.</p>
</div>
<div class="paragraph">
<p>The reason for not enable always by default is performance savings. On some system the operation to read back rendered pixels from graphics frame buffer to application RAM memory is not neglectable (depending on whether color coding or byte order transformation is needed). So a compromize is to have the feature enabled for the first init frame, and then activate by user when needed.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Finally, to disable esmini image handling altogether and revert to OSG default handling, make the following call before SE_Init():</p>
</div>
<div class="paragraph">
<p><code>SE_SetOffScreenRendering(false);</code></p>
</div>
<div class="paragraph">
<p>Note that disabling the this will permanently disable the callback mechanism for the complete esmini session (overriding any SE_SaveImagesToRAM() call).</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hello_world_programming_tutorial">12. Hello World programming tutorial</h2>
<div class="sectionbody">
<div class="paragraph">
<p>But, of course, if you already have checked out the esmini project from GitHub and compiled it you&#8217;re basically set. Just copy the runtime shared library to the Hello-World_coding_example folder. Exact filename depends on the platform as follows:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>Windows:</strong>
</td>
<td class="hdlist2">
<p>esminiLib.dll</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Linux:</strong>
</td>
<td class="hdlist2">
<p>libesminiLib.so</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Mac:</strong>
</td>
<td class="hdlist2">
<p>libesminiLib.dylib</p>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_steps_to_build_esmini_hello_world">12.1. Steps to build esmini "Hello World"</h3>
<div class="paragraph">
<p>Do following steps to build a minimal esmini-player application</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the folder Hello-World_coding-example.</p>
</li>
<li>
<p>From a command prompt run the following commands to create build scripts and build the provided code example:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>	mkdir build
	cd build
	cmake ..
	cmake --build . --config Release --target install</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note</strong>: If esminiLib is recompiled, make sure to grab the latest copy (e.g. from esmini/bin in case of build target "install").</p>
</div>
<div class="paragraph">
<p>If all works as expected there should be an executable "esmini-player" in the Hello-World_coding-example folder. Try to run it from that directory.
On Linux you might need to define LD_LIBRARY PATH first, like this: <code>export LD_LIBRARY_PATH=.</code></p>
</div>
<div class="paragraph">
<p>If you have any IDE installed, e.g. Visual Studio (Win) or Xcode (Mac), cmake might have produced project files for it, e.g. "build/esmini-player.sln".</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><strong>Note:</strong> On Windows there are two library files: esminiLib.lib and esminiLib.dll. The .lib file (basically only table of contents of the library) is used for compile time linking while the .dll (actual code) for runtime dynamic linking. On other platforms there is only one library file, .so (Shared Object) in Linux and .dylib (Dynamic Library) on Mac, which is used for both compile time and runtime linking.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Here follows a few code examples to try out, e.g. by modifying main.cpp:</p>
</div>
</div>
<div class="sect2">
<h3 id="_examples">12.2. Examples</h3>
<div class="sect3">
<h4 id="_hello_world_load_and_play_a_scenario">12.2.1. Hello world - load and play a scenario</h4>
<div class="listingblock">
<div class="title">Example 1. <a href="https://github.com/esmini/esmini/tree/master/Hello-World_coding-example/main.cpp">Hello-World_coding-example/main.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
        SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);

        <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">500</span>; i++)
        {
                SE_Step();
        }

        SE_Close();

        <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exercise: Change scenario to pedestrian.xosc, then compile and run the program again.</p>
</div>
</div>
<div class="sect3">
<h4 id="_add_optional_argument_to_load_any_scenario">12.2.2. Add optional argument to load any scenario</h4>
<div class="listingblock">
<div class="title">Example 2. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/hw2_arguments.cpp">EnvironmentSimulator/code-examples/hello_world/hw2_arguments.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
        <span class="keyword">if</span> (argc &gt; <span class="integer">1</span>)
        {
                SE_InitWithArgs(argc, (<span class="directive">const</span> <span class="predefined-type">char</span>**)argv);
        }
        <span class="keyword">else</span>
        {
                SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);
        }

        <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">500</span>; i++)
        {
                SE_Step();
        }

        SE_Close();

        <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now specify esmini arguments according to <a href="https://github.com/esmini/esmini/blob/master/docs/commands.txt">esmini launch commands</a>.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./esmini-player --window 60 60 1000 500 --osc ../resources/xosc/pedestrian.xosc --trails</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fetch_state_of_scenario_objects">12.2.3. Fetch state of scenario objects</h4>
<div class="listingblock">
<div class="title">Example 3. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/hw3_fetch_states.cpp">EnvironmentSimulator/code-examples/hello_world/hw3_fetch_states.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;stdio.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
        SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);

        <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">500</span>; i++)
        {
                SE_Step();

                <span class="keyword">for</span> (<span class="predefined-type">int</span> j = <span class="integer">0</span>; j &lt; SE_GetNumberOfObjects(); j++)
                {
                        SE_ScenarioObjectState state;

                        SE_GetObjectState(SE_GetId(j), &amp;state);
                        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">time [%.2f] object[%d] id %d pos[%.2f, %.2f] %.2f %.2f </span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, state.timestamp, j, SE_GetId(j), state.x, state.y, state.wheel_angle, state.wheel_rot);
                }
        }

        SE_Close();

        <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_external_control_of_ego">12.2.4. External control of Ego</h4>
<div class="paragraph">
<p>A silly example showing how you can just take control over vehicle state via the API. The Ego car will move one meter along the Y-axis for each frame while rotating&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>First step is to modify the cut-in_interactive.xosc scenario. Make a copy named "cut-in_external.xosc". In that file, replace <code>interactiveDriver</code> controller with <code>externalController</code> by changing the line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;CatalogReference catalogName="ControllerCatalog" entryName="interactiveDriver" /&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;CatalogReference catalogName="ControllerCatalog" entryName="externalController" /&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Now we will also introduce the quit_flag, which lets you quit by pressing 'Esc' key.</p>
</div>
<div class="listingblock">
<div class="title">Example 4. <a href="https://github.com/esmini/esmini/tree/master//EnvironmentSimulator/code-examples/hello_world/hw4_external_ego_control.cpp">EnvironmentSimulator/code-examples/hello_world/hw4_external_ego_control.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
        <span class="directive">const</span> <span class="predefined-type">char</span>* filename = argc &gt; <span class="integer">1</span> ? argv[<span class="integer">1</span>] : <span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in_external.xosc</span><span class="delimiter">&quot;</span></span>;

        SE_Init(filename, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);

        <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">500</span> &amp;&amp; SE_GetQuitFlag() != <span class="integer">1</span>; i++)
        {
                SE_ReportObjectPos(SE_GetId(<span class="integer">0</span>), <span class="float">0</span><span class="float">.0f</span>, <span class="float">8</span><span class="float">.0f</span>, (<span class="predefined-type">float</span>)i, <span class="float">0</span><span class="float">.0f</span>, <span class="predefined-type">float</span>(<span class="float">1</span><span class="float">.57</span> + <span class="float">0</span><span class="float">.01</span> * i), <span class="float">0</span><span class="float">.0f</span>, <span class="float">0</span><span class="float">.0f</span>);
                SE_Step();
        }

        SE_Close();

        <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exercise: Change heading with i, e.g:</p>
</div>
<div class="paragraph">
<p><code>SE_ReportObjectPos(0, 0.0f, 8.0f, (float)i, 0.0f, 1.57f + 0.01f*i, 0.0f, 0.0f, 15.0f);</code></p>
</div>
<div class="paragraph">
<p>Yes, it looks crazy! But it demonstrates how an application totally can take control of a vehicle.</p>
</div>
</div>
<div class="sect3">
<h4 id="_control_controllers">12.2.5. Control controllers</h4>
<div class="paragraph">
<p>Try to run cut-in_interactive.xosc, as below.</p>
</div>
<div class="listingblock">
<div class="title">Example 5. <a href="https://github.com/esmini/esmini/tree/master//EnvironmentSimulator/code-examples/hello_world/hw5_control_controllers_enabled.cpp">EnvironmentSimulator/code-examples/hello_world/hw5_control_controllers_enabled.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
        SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in_interactive.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);

        <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">2000</span> &amp;&amp; SE_GetQuitFlag() != <span class="integer">1</span>; i++)
        {
                SE_Step();
        }

        SE_Close();

        <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Control the Ego vehicle with arrow keys.</p>
</div>
<div class="paragraph">
<p>To disable controllers and hand over to default scenario behavior set first argument flag (see <a href="https://github.com/esmini/esmini/blob/45ef22ed04867f6e6630bb73461e5d4a3fcd7d93/EnvironmentSimulator/Libraries/esminiLib/esminiLib.hpp#L259">headerfile esminiLib.hpp</a>):</p>
</div>
<div class="listingblock">
<div class="title">Example 6. <a href="https://github.com/esmini/esmini/tree/master//EnvironmentSimulator/code-examples/hello_world/hw6_control_controllers_disabled.cpp">EnvironmentSimulator/code-examples/hello_world/hw6_control_controllers_disabled.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
        SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in_interactive.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);

        <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">2000</span> &amp;&amp; SE_GetQuitFlag() != <span class="integer">1</span>; i++)
        {
                SE_Step();
        }

        SE_Close();

        <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ideal_sensors">12.2.6. Ideal sensors</h4>
<div class="listingblock">
<div class="title">Example 7. <a href="https://github.com/esmini/esmini/tree/master//EnvironmentSimulator/code-examples/hello_world/hw7_ideal_sensors.cpp">EnvironmentSimulator/code-examples/hello_world/hw7_ideal_sensors.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;stdio.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="preprocessor">#define</span> MAX_HITS <span class="integer">10</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
        SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);

        SE_AddObjectSensor(<span class="integer">0</span>, <span class="float">2</span><span class="float">.0f</span>, <span class="float">1</span><span class="float">.0f</span>, <span class="float">0</span><span class="float">.5f</span>, <span class="float">1</span><span class="float">.57f</span>, <span class="float">1</span><span class="float">.0f</span>, <span class="integer">5</span><span class="float">0</span><span class="float">.0f</span>, <span class="float">1</span><span class="float">.57f</span>, MAX_HITS);
        SE_AddObjectSensor(<span class="integer">0</span>, -<span class="float">1</span><span class="float">.0f</span>, <span class="float">0</span><span class="float">.0f</span>, <span class="float">0</span><span class="float">.5f</span>, <span class="float">3</span><span class="float">.14f</span>, <span class="float">0</span><span class="float">.5f</span>, <span class="integer">2</span><span class="float">0</span><span class="float">.0f</span>, <span class="float">1</span><span class="float">.57f</span>, MAX_HITS);

        <span class="comment">// Turn on visualization of object sensors, toggle key 'r'</span>
        SE_ViewerShowFeature(<span class="integer">1</span>, <span class="predefined-constant">true</span>);

        <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">2000</span> &amp;&amp; !(SE_GetQuitFlag() == <span class="integer">1</span>); i++)
        {
                SE_Step();

                <span class="predefined-type">int</span> objList[MAX_HITS];
                <span class="keyword">for</span> (<span class="predefined-type">int</span> j = <span class="integer">0</span>; j &lt; <span class="integer">2</span>; j++)  <span class="comment">// iterate over added sensors</span>
                {
                        <span class="predefined-type">int</span> nHits = SE_FetchSensorObjectList(j, objList);
                        <span class="keyword">for</span> (<span class="predefined-type">int</span> k = <span class="integer">0</span>; k &lt; nHits; k++)
                        {
                                printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Sensor[%d] detected obj: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, j, objList[k]);

                                <span class="comment">// Get some info of that detected object</span>
                                SE_ScenarioObjectState state;

                                SE_GetObjectState(objList[k], &amp;state);
                                printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">object[%d] pos: (%.2f, %.2f) heading: %.2f</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, objList[k], state.x, state.y, state.h);
                        }
                }
        }

        SE_Close();

        <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note</strong>: If you want M_PI, add on top (before includes): <code>#define _USE_MATH_DEFINES</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_driver_model">12.2.7. Driver model</h4>
<div class="paragraph">
<p>Using a simple vehicle model this example demonstrates how a driver model can interact with the scenario, once again using the <code>ExternalController</code>.</p>
</div>
<div class="paragraph">
<p>To show different variants we also show how to set scenario parameters during intialization, via callbacks. In effect this is a way to achieve runtime variants of the same basic scenario.</p>
</div>
<div class="paragraph">
<p>Before heading into the application code we will look into the scenario file <a href="../EnvironmentSimulator/code-examples/test-driver/test-driver.xosc">EnvironmentSimulator/code-examples/test-driver/test-driver.xosc</a>.</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s have a look inside it to see how to activate the ExternalController, which will prevent the DefaultController to interfere with the Ego vehicle and instead hand over exclusive control to our application. You can skip this and go to the C++ code example below if you&#8217;re not interested in the controller setup.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open test-driver.xosc</p>
</li>
<li>
<p>Look in the Entities section, under the <code>&lt;ScenarioObject name="Ego"\&gt;</code> element. Here the controller is defined and assigned to the Ego vehicle.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">          <span class="tag">&lt;ObjectController&gt;</span>
                <span class="tag">&lt;Controller</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MyExternalControllerWithGhost</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;Properties&gt;</span>
                        <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">esminiController</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ExternalController</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                        <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">useGhost</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">$GhostMode</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                        <span class="tag">&lt;Property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">headstartTime</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                    <span class="tag">&lt;/Properties&gt;</span>
                <span class="tag">&lt;/Controller&gt;</span>
          <span class="tag">&lt;/ObjectController&gt;</span>      </code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong> The GhostMode parameter is set to true or false in the ParameterDeclarations section in the top of the scenario file.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Then the initial position is set. This could instead be done by the application, but it&#8217;s convenient to specify it in the scenario file.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">                <span class="tag">&lt;PrivateAction&gt;</span>
                    <span class="tag">&lt;TeleportAction&gt;</span>
                        <span class="tag">&lt;Position&gt;</span>
                            <span class="tag">&lt;LanePosition</span> <span class="attribute-name">roadId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">laneId</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">-1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">s</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">50</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                        <span class="tag">&lt;/Position&gt;</span>
                    <span class="tag">&lt;/TeleportAction&gt;</span>
                <span class="tag">&lt;/PrivateAction&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Finally we need to activate the controller on both lateral and longitudinal domains.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">                <span class="tag">&lt;PrivateAction&gt;</span>
                      <span class="tag">&lt;ActivateControllerAction</span> <span class="attribute-name">longitudinal</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">lateral</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
                <span class="tag">&lt;/PrivateAction&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The reason for putting it AFTER the positioning is that oterwise the position action would have no effect, since once the controller is activated all scenario actions will be ignored. The controller then having exclusive control.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s head into the code example. It will run the scenario three times:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>External controller without ghost mode</p>
<div class="ulist">
<ul>
<li>
<p>just look ahead and follow along current lane. Find point along the lane and steer towards it.</p>
</li>
</ul>
</div>
</li>
<li>
<p>External controller with ghost mode and time based lookahead</p>
<div class="ulist">
<ul>
<li>
<p>find the state of ghost at given time offset. Use it for steering and speed target.</p>
</li>
</ul>
</div>
</li>
<li>
<p>External controller with ghost mode and position based lookahead</p>
<div class="ulist">
<ul>
<li>
<p>given the current Ego position, find ghost state at some look ahead distance along its trail. Use it for steering and speed target.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now, study the code and perhaps play around mainpulating some values.</p>
</div>
<div class="listingblock">
<div class="title">Example 8. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/test-driver/test-driver.cpp">EnvironmentSimulator/code-examples/test-driver/test-driver.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;stdio.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;math.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&lt;string&gt;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>



<span class="directive">void</span> paramDeclCB(<span class="directive">void</span>* user_arg)
{
        <span class="predefined-type">bool</span> ghostMode = *((<span class="predefined-type">bool</span>*)user_arg);

        SE_LogMessage((std::<span class="predefined-type">string</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Running with ghostMode = </span><span class="delimiter">&quot;</span></span>).append(ghostMode == <span class="predefined-constant">true</span> ? <span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>)).c_str());
        SE_SetParameterBool(<span class="string"><span class="delimiter">&quot;</span><span class="content">GhostMode</span><span class="delimiter">&quot;</span></span>, ghostMode);
}

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
        <span class="directive">const</span> <span class="predefined-type">double</span> defaultTargetSpeed = <span class="integer">5</span><span class="float">0</span><span class="float">.0</span>;
        <span class="directive">const</span> <span class="predefined-type">double</span> curveWeight = <span class="integer">3</span><span class="float">0</span><span class="float">.0</span>;
        <span class="directive">const</span> <span class="predefined-type">double</span> throttleWeight = <span class="float">0</span><span class="float">.1</span>;
        <span class="directive">const</span> <span class="predefined-type">float</span> duration = <span class="integer">3</span><span class="float">5</span><span class="float">.0f</span>;
        <span class="predefined-type">bool</span> ghostMode[<span class="integer">3</span>] = { <span class="predefined-constant">false</span>, <span class="predefined-constant">true</span>, <span class="predefined-constant">true</span> };

        <span class="directive">void</span>* vehicleHandle = <span class="integer">0</span>;
        SE_SimpleVehicleState vehicleState = { <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">0</span> };
        SE_ScenarioObjectState objectState;
        SE_RoadInfo roadInfo;

        <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">3</span>; i++)
        {
                <span class="predefined-type">float</span> dt = <span class="float">0</span><span class="float">.0f</span>;

                SE_RegisterParameterDeclarationCallback(paramDeclCB, &amp;ghostMode[i]);

                <span class="keyword">if</span> (SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../EnvironmentSimulator/code-examples/test-driver/test-driver.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>) != <span class="integer">0</span>)
                {
                        SE_LogMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to initialize the scenario, quit</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
                        <span class="keyword">return</span> -<span class="integer">1</span>;
                }

                <span class="comment">// Lock object to the original lane</span>
                <span class="comment">// If setting to false, the object road position will snap to closest lane</span>
                SE_SetLockOnLane(<span class="integer">0</span>, <span class="predefined-constant">true</span>);

                <span class="comment">// Initialize the vehicle model, fetch initial state from the scenario</span>
                SE_GetObjectState(<span class="integer">0</span>, &amp;objectState);
                vehicleHandle = SE_SimpleVehicleCreate(objectState.x, objectState.y, objectState.h, <span class="float">4</span><span class="float">.0</span>, <span class="float">0</span><span class="float">.0</span>);
                SE_SimpleVehicleSteeringRate(vehicleHandle, <span class="float">6</span><span class="float">.0f</span>);

                <span class="comment">// show some road features, including road sensor</span>
                SE_ViewerShowFeature(<span class="integer">4</span> + <span class="integer">8</span>, <span class="predefined-constant">true</span>);  <span class="comment">// NODE_MASK_TRAIL_DOTS (1 &lt;&lt; 2) &amp; NODE_MASK_ODR_FEATURES (1 &lt;&lt; 3),</span>

                <span class="comment">// Run for specified duration or until 'Esc' button is pressed</span>
                <span class="keyword">while</span> (SE_GetSimulationTime() &lt; duration &amp;&amp; SE_GetQuitFlag() != <span class="integer">1</span>)
                {
                        <span class="comment">// Get simulation delta time since last call (first will be minimum timestep)</span>
                        dt = SE_GetSimTimeStep();

                        <span class="comment">// Get road information at a point some speed dependent distance ahead</span>
                        <span class="predefined-type">double</span> targetSpeed;
                        <span class="keyword">if</span> (ghostMode[i] == <span class="predefined-constant">true</span>)
                        {
                                <span class="comment">// ghost version</span>
                                <span class="predefined-type">float</span> ghost_speed = <span class="float">0</span><span class="float">.0f</span>;

                                <span class="keyword">if</span> (i % <span class="integer">2</span> == <span class="integer">0</span>)  <span class="comment">// alternate between time based and position based look ahead modes</span>
                                {
                                        <span class="comment">// Time based look ahead</span>
                                        SE_GetRoadInfoGhostTrailTime(<span class="integer">0</span>, SE_GetSimulationTime() + <span class="float">0</span><span class="float">.25f</span>, &amp;roadInfo, &amp;ghost_speed);
                                }
                                <span class="keyword">else</span>
                                {
                                        <span class="comment">// Position based Time based look ahead</span>
                                        SE_GetRoadInfoAlongGhostTrail(<span class="integer">0</span>, <span class="integer">5</span> + <span class="float">0</span><span class="float">.75f</span> * vehicleState.speed, &amp;roadInfo, &amp;ghost_speed);
                                }
                                targetSpeed = ghost_speed;
                        }
                        <span class="keyword">else</span>
                        {
                                <span class="comment">// Look ahead along the road, to establish target info for the driver model</span>
                                SE_GetRoadInfoAtDistance(<span class="integer">0</span>, <span class="integer">5</span> + <span class="float">0</span><span class="float">.75f</span> * vehicleState.speed, &amp;roadInfo, <span class="integer">0</span>, <span class="predefined-constant">true</span>);

                                <span class="comment">// Slow down when curve ahead - CURVE_WEIGHT is the tuning parameter</span>
                                targetSpeed = defaultTargetSpeed / (<span class="integer">1</span> + curveWeight * fabs(roadInfo.angle));
                        }

                        <span class="comment">// Steer towards where the point</span>
                        <span class="predefined-type">double</span> steerAngle = roadInfo.angle;

                        <span class="comment">// Accelerate or decelerate towards target speed - THROTTLE_WEIGHT tunes magnitude</span>
                        <span class="predefined-type">double</span> throttle = throttleWeight * (targetSpeed - vehicleState.speed);

                        <span class="comment">// Step vehicle model with driver input, but wait until time &gt; 0</span>
                        <span class="keyword">if</span> (SE_GetSimulationTime() &gt; <span class="integer">0</span> &amp;&amp; !SE_GetPauseFlag())
                        {
                                SE_SimpleVehicleControlAnalog(vehicleHandle, dt, throttle, steerAngle);
                        }

                        <span class="comment">// Fetch updated state and report to scenario engine</span>
                        SE_SimpleVehicleGetState(vehicleHandle, &amp;vehicleState);

                        <span class="comment">// Report updated vehicle position and heading. z, pitch and roll will be aligned to the road</span>
                        SE_ReportObjectPosXYH(<span class="integer">0</span>, <span class="integer">0</span>, vehicleState.x, vehicleState.y, vehicleState.h);

                        <span class="comment">// The following values are not necessary to report.</span>
                        <span class="comment">// If not reported, esmini will calculate based on motion over time</span>
                        <span class="comment">// but for accuracy it's recommendeded to report if available.</span>

                        <span class="comment">// wheel status (revolution and steering angles)</span>
                        SE_ReportObjectWheelStatus(<span class="integer">0</span>, vehicleState.wheel_rotation, vehicleState.wheel_angle);

                        <span class="comment">// speed (along vehicle longitudinal (x) axis)</span>
                        SE_ReportObjectSpeed(<span class="integer">0</span>, vehicleState.speed);

                        <span class="comment">// Finally, update scenario using same time step as for vehicle model</span>
                        SE_StepDT(dt);
                }
                SE_Close();
        }
        <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Don&#8217;t worry about the stationary red car on the road, you&#8217;ll just drive through it.</p>
</div>
<div class="paragraph">
<p>Try experimenting with the driver settings, e.g. increase lookahead distance factor from 0.75 to 1.75.</p>
</div>
<div class="paragraph">
<p>When running the application, press key 'j' to toggle ghost trail dots and lines visualization.</p>
</div>
<div class="paragraph">
<p><strong>Challenge</strong>: Attach a front looking sensor to detect it and have the driver to brake to avoid collision&#8230;&#8203;</p>
</div>
<div class="sect4">
<h5 id="_ghost_concept_in_brief">Ghost concept in brief</h5>
<div class="paragraph">
<p>In the first loop the driver model is just capable of driving along the specified lane. It&#8217;s totally detached from any scenario events.</p>
</div>
<div class="paragraph">
<p>The ghost concept is a solution for a driver model to perform scenario actions. Basically it will launch a fore-runner to perform the scenario actions. The trajectory, including speed, is registered into a "trail" which can then be used as reference for steering and speed target.</p>
</div>
<div class="paragraph">
<p>Ghost mode is a parameter of the external controller. Normally this is set in the scenario, for example in test-driver.xosc, change line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;ParameterDeclaration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">GhostMode</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bool</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;ParameterDeclaration</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">GhostMode</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">parameterType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bool</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, in the example code this parameter is controlled by the <code>paramDeclCB()</code> callback. Once it&#8217;s registered with <code>SE_RegisterParameterDeclarationCallback()</code> it will be called each time esmini is initialized (<code>SE_Init()</code>).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_osi_groundtruth">12.2.8. OSI groundtruth</h4>
<div class="paragraph">
<p>To access OSI data we first need to complement the build script (CMakeLists.txt) with OSI include and library info. For example:</p>
</div>
<div class="paragraph">
<p>Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>include_directories(. ../include ../EnvironmentSimulator/Libraries/esminiLib ../externals/OSI/v10/include)

link_directories(. ../lib ../bin ../externals/OSI/v10/lib)

target_link_libraries(${TARGET} esminiLib libprotobuf open_simulation_interface_pic)</pre>
</div>
</div>
<div class="paragraph">
<p>Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>include_directories(. ../include ../EnvironmentSimulator/Libraries/esminiLib ../externals/OSI/linux/include)

link_directories(. ../lib ../bin ../externals/OSI/linux/lib)

target_link_libraries(${TARGET} esminiLib protobuf open_simulation_interface_pic)</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Replace foldername "v10" with linux or mac depending on your platform.</p>
</li>
<li>
<p>If linking with custom applications or libraries: OSI and Google Protobuf versions needs to be consistent (at least major version nr), also with the versions used in esmini (see <a href="https://github.com/esmini/esmini#osi-support">here</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then run <code>cmake ..</code> from the build folder to apply the changes in CMakeFiles.cxx.</p>
</div>
<div class="paragraph">
<p>The following code will update, fetch and print some OSI data each frame.</p>
</div>
<div class="listingblock">
<div class="title">Example 9. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/osi-groundtruth/osi-groundtruth.cpp">EnvironmentSimulator/code-examples/osi-groundtruth/osi-groundtruth.cpp</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c++"><span class="preprocessor">#include</span> <span class="include">&quot;esminiLib.hpp&quot;</span>

<span class="preprocessor">#include</span> <span class="include">&quot;osi_common.pb.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;osi_object.pb.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;osi_groundtruth.pb.h&quot;</span>
<span class="preprocessor">#include</span> <span class="include">&quot;osi_version.pb.h&quot;</span>

<span class="predefined-type">int</span> main(<span class="predefined-type">int</span> argc, <span class="predefined-type">char</span>* argv[])
{
        SE_Init(<span class="string"><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in_simple.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>);

        osi3::GroundTruth* gt;

        <span class="comment">// Initial update of complete Ground Truth, including static things</span>
        SE_UpdateOSIGroundTruth();
        <span class="comment">// You could now retrieve the initial state of all objects before stepping the scenario</span>

        <span class="keyword">for</span> (<span class="predefined-type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">1500</span>; i++)
        {
                SE_StepDT(<span class="float">0</span><span class="float">.01f</span>);

                <span class="comment">// Further updates will only affect dynamic OSI stuff</span>
                SE_UpdateOSIGroundTruth();

                <span class="comment">// Fetch OSI struct</span>
                gt = (osi3::GroundTruth*)SE_GetOSIGroundTruthRaw();

                <span class="comment">// Print timestamp</span>
                printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">Frame %d timestamp: %.2f</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, i, gt-&gt;mutable_timestamp()-&gt;seconds() +
                        <span class="float">1</span>E-<span class="integer">9</span> * gt-&gt;mutable_timestamp()-&gt;nanos());

                <span class="comment">// Lane boundaries</span>
                printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">lane boundaries: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, gt-&gt;lane_boundary_size());
                <span class="keyword">for</span> (<span class="predefined-type">int</span> j = <span class="integer">0</span>; j &lt; gt-&gt;lane_boundary_size(); j++)
                {
                        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">  lane boundary %d, nr of boundary points: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, j, gt-&gt;lane_boundary(j).boundary_line_size());

<span class="comment">#if 0  // change to 1 in order to print all boundary points
                        for (int k = 0; k &lt; gt-&gt;lane_boundary(j).boundary_line_size(); k++)
                        {
                                printf(&quot;    (%.2f, %.2f)\n&quot;,
                                        gt-&gt;lane_boundary(j).boundary_line(k).position().x(),
                                        gt-&gt;lane_boundary(j).boundary_line(k).position().y());
                        }
#endif</span>
                }

                <span class="comment">// Road markings, e.g. zebra lines</span>
                printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">road markings: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, gt-&gt;road_marking_size());

                <span class="comment">// Moving objects</span>
                printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">moving objects: %d</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>, gt-&gt;moving_object_size());

<span class="preprocessor">#if</span> <span class="integer">1</span>  <span class="comment">// change to 1 in order to print some moving object state info</span>
                <span class="comment">// Print object id, position, orientation and velocity</span>
                <span class="keyword">for</span> (<span class="predefined-type">int</span> j = <span class="integer">0</span>; j &lt; gt-&gt;mutable_moving_object()-&gt;size(); j++)
                {
                        printf(<span class="string"><span class="delimiter">&quot;</span><span class="content">  obj id %u pos (%.2f, %.2f, %.2f) orientation (%.2f, %.2f, %.2f) vel (%.2f, %.2f, %.2f) acc (%.2f, %.2f, %.2f)</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>,
                                <span class="keyword">static_cast</span>&lt;<span class="predefined-type">unsigned</span> <span class="predefined-type">int</span>&gt;(gt-&gt;mutable_moving_object(j)-&gt;mutable_id()-&gt;value()),
                                gt-&gt;mutable_moving_object(j)-&gt;mutable_base()-&gt;mutable_position()-&gt;x(),
                                gt-&gt;mutable_moving_object(j)-&gt;mutable_base()-&gt;mutable_position()-&gt;y(),
                                gt-&gt;mutable_moving_object(j)-&gt;mutable_base()-&gt;mutable_position()-&gt;z(),
                                gt-&gt;mutable_moving_object(j)-&gt;mutable_base()-&gt;mutable_orientation()-&gt;yaw(),
                                gt-&gt;mutable_moving_object(j)-&gt;mutable_base()-&gt;mutable_orientation()-&gt;pitch(),
                                gt-&gt;mutable_moving_object(j)-&gt;mutable_base()-&gt;mutable_orientation()-&gt;roll(),
                                gt-&gt;mutable_moving_object(j)-&gt;mutable_base()-&gt;mutable_velocity()-&gt;x(),
                                gt-&gt;mutable_moving_object(j)-&gt;mutable_base()-&gt;mutable_velocity()-&gt;y(),
                                gt-&gt;mutable_moving_object(j)-&gt;mutable_base()-&gt;mutable_velocity()-&gt;z(),
                                gt-&gt;mutable_moving_object(j)-&gt;mutable_base()-&gt;mutable_acceleration()-&gt;x(),
                                gt-&gt;mutable_moving_object(j)-&gt;mutable_base()-&gt;mutable_acceleration()-&gt;y(),
                                gt-&gt;mutable_moving_object(j)-&gt;mutable_base()-&gt;mutable_acceleration()-&gt;z()
                        );
                }
<span class="preprocessor">#endif</span>
        }

        SE_Close();

        <span class="keyword">return</span> <span class="integer">0</span>;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_python_binding">12.3. Python binding</h3>
<div class="paragraph">
<p>A Python wrapper for esmini can easily be created using "ctypes" (thanks David Kaplan for the tip!). Run the following script in a folder where the ScenarioEngineDLL library is present:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Python"><span class="keyword">import</span> <span class="include">ctypes</span>

se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">./esminiLib.dll</span><span class="delimiter">&quot;</span></span>)
se.SE_Init(<span class="binary"><span class="modifier">b</span><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>, <span class="integer">2</span>)

<span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">range</span> (<span class="integer">500</span>):
    se.SE_Step()</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong> Library name varies with the platform as mentioned above (see <a href="#preparations">[preparations]</a>)</p>
</div>
<div class="paragraph">
<p>Below is a bit more flexible variant:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Portable: Works on all supported platforms</p>
</li>
<li>
<p>Provide scenario via argument</p>
</li>
<li>
<p>Quit at press Escape or end of scenario</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example 10. <a href="https://github.com/esmini/esmini/tree/master/Hello-World_coding-example/esmini-player.py">Hello-World_coding-example/esmini-player.py</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">ctypes</span>
<span class="keyword">import</span> <span class="include">sys</span>

<span class="keyword">if</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux</span><span class="delimiter">&quot;</span></span> <span class="keyword">or</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux2</span><span class="delimiter">&quot;</span></span>:
    se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">./libesminiLib.so</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">darwin</span><span class="delimiter">&quot;</span></span>:
    se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">./libesminiLib.dylib</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">win32</span><span class="delimiter">&quot;</span></span>:
    se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">./esminiLib.dll</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">else</span>:
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unsupported platform: {}</span><span class="delimiter">&quot;</span></span>.format(sys.platform))
    quit()

<span class="keyword">if</span> (<span class="predefined">len</span>(sys.argv) &lt; <span class="integer">2</span>):
    print(<span class="string"><span class="delimiter">'</span><span class="content">Usage: {} &lt;xosc file&gt;</span><span class="delimiter">'</span></span>.format(sys.argv[<span class="integer">0</span>]))
    <span class="predefined">exit</span>(-<span class="integer">1</span>)

se.SE_Init(sys.argv[<span class="integer">1</span>].encode(<span class="string"><span class="delimiter">'</span><span class="content">ascii</span><span class="delimiter">'</span></span>), <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>)
 
<span class="keyword">while</span> <span class="keyword">not</span> se.SE_GetQuitFlag():
    se.SE_Step()</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_get_object_states">12.3.1. Get object states</h4>
<div class="paragraph">
<p>Extend previous example to retrieve the state of all scenario objects</p>
</div>
<div class="listingblock">
<div class="title">Example 11. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/get_states.py">EnvironmentSimulator/code-examples/hello_world/get_states.py</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">ctypes</span>
<span class="keyword">from</span> <span class="include">sys</span> <span class="keyword">import</span> <span class="include">platform</span>

<span class="keyword">if</span> platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux</span><span class="delimiter">&quot;</span></span> <span class="keyword">or</span> platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux2</span><span class="delimiter">&quot;</span></span>:
    se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">./libesminiLib.so</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">darwin</span><span class="delimiter">&quot;</span></span>:
    se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">./libesminiLib.dylib</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">win32</span><span class="delimiter">&quot;</span></span>:
    se = ctypes.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">./esminiLib.dll</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">else</span>:
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unsupported platform: {}</span><span class="delimiter">&quot;</span></span>.format(platform))
    quit()

<span class="comment"># Definition of SE_ScenarioObjectState struct</span>
<span class="keyword">class</span> <span class="class">SEScenarioObjectState</span>(ctypes.Structure):
    _fields_ = [
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">model_id</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">control</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">timestamp</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">z</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">h</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">roadId</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">junctionId</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">laneId</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">laneOffset</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">s</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">speed</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">centerOffsetX</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">centerOffsetY</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">centerOffsetZ</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">width</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">length</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">height</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">objectType</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">objectCategory</span><span class="delimiter">&quot;</span></span>, ctypes.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">wheelAngle</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">wheelRot</span><span class="delimiter">&quot;</span></span>, ctypes.c_float),
    ]

se.SE_Init(<span class="binary"><span class="modifier">b</span><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">0</span>)

obj_state = SEScenarioObjectState()  <span class="comment"># object that will be passed and filled in with object state info</span>
 
<span class="keyword">for</span> i <span class="keyword">in</span> <span class="predefined">range</span>(<span class="integer">500</span>):
    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="predefined">range</span>(se.SE_GetNumberOfObjects()):
        se.SE_GetObjectState(se.SE_GetId(j), ctypes.byref(obj_state))
        print(<span class="string"><span class="delimiter">'</span><span class="content">Frame {} Time {:.2f} ObjId {} roadId {} laneId {} laneOffset {:.2f} s {:.2f} x {:.2f} y {:.2f} heading {:.2f} speed {:.2f} wheelAngle {:.2f} wheelRot {:.2f}</span><span class="delimiter">'</span></span>.format(
            i, obj_state.timestamp, obj_state.id, obj_state.roadId, obj_state.laneId, obj_state.laneOffset, 
            obj_state.s, obj_state.x, obj_state.y, obj_state.h, obj_state.speed * <span class="float">3.6</span>, obj_state.wheelAngle, obj_state.wheelRot))
    se.SE_Step()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_example_use_of_esminirmlib_roadmanager">12.3.2. Example use of esminiRMLib (RoadManager)</h4>
<div class="ulist">
<ul>
<li>
<p>Make sure the esminiRMLib is present in the same folder as the script</p>
</li>
<li>
<p>In the code, check filepath to the OpenDRIVE file to load (current search path should work when script is copied to and run from the esmini/Hello-World_coding-example folder)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example 12. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/use_roadmanager.py">EnvironmentSimulator/code-examples/hello_world/use_roadmanager.py</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="keyword">import</span> <span class="include">ctypes</span> <span class="keyword">as</span> ct
<span class="keyword">import</span> <span class="include">sys</span>

<span class="keyword">if</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux</span><span class="delimiter">&quot;</span></span> <span class="keyword">or</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">linux2</span><span class="delimiter">&quot;</span></span>:
    rm = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">./libesminiRMLib.so</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">darwin</span><span class="delimiter">&quot;</span></span>:
    rm = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">./libesminiRMLib.dylib</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">elif</span> sys.platform == <span class="string"><span class="delimiter">&quot;</span><span class="content">win32</span><span class="delimiter">&quot;</span></span>:
    rm = ct.CDLL(<span class="string"><span class="delimiter">&quot;</span><span class="content">./esminiRMLib.dll</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">else</span>:
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unsupported platform: {}</span><span class="delimiter">&quot;</span></span>.format(sys.platform))
    sys.exit(-<span class="integer">1</span>)

<span class="comment"># Definition of RM_PositionData struct - should match esminiRMLib::RM_PositionData struct</span>
<span class="keyword">class</span> <span class="class">RM_PositionData</span>(ct.Structure):
    _fields_ = [
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">z</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">h</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">h_relative</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">road_id</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">junction_id</span><span class="delimiter">&quot;</span></span>, ct.c_int),  <span class="comment"># -1 if not in a junction</span>
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">lane_id</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">lane_offset</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">s</span><span class="delimiter">&quot;</span></span>, ct.c_float),
    ]

<span class="comment"># Specify argument types to a few functions</span>
rm.RM_SetWorldPosition.argtypes = [ct.c_int, ct.c_float, ct.c_float, ct.c_float, ct.c_float, ct.c_float, ct.c_float]
rm.RM_SetLanePosition.argtypes = [ct.c_int, ct.c_int, ct.c_int, ct.c_float, ct.c_float]


<span class="comment"># Initialize esmini RoadManger with given OpenDRIVE file</span>
odr = <span class="string"><span class="delimiter">'</span><span class="content">../resources/xodr/straight_500m.xodr</span><span class="delimiter">'</span></span>
<span class="keyword">if</span> rm.RM_Init(odr.encode()) == -<span class="integer">1</span>:   <span class="comment"># encode() converts string to pure byte array</span>
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">Failed to load OpenDRIVE file </span><span class="delimiter">&quot;</span></span>, )
    sys.exit(-<span class="integer">1</span>)

rm_pos = rm.RM_CreatePosition()  <span class="comment"># create a position object, returns a handle</span>
rm_pos_data = RM_PositionData()  <span class="comment"># object that will be passed and filled in with position info</span>

<span class="comment"># test a few positions</span>
x = <span class="integer">65</span>
y = -<span class="float">1.7</span>
rm.RM_SetWorldPosition(rm_pos, x, y, <span class="float">0.0</span>, <span class="float">0.0</span>, <span class="float">0.0</span>, <span class="float">0.0</span>)
rm.RM_GetPositionData(rm_pos, ct.byref(rm_pos_data))
print(<span class="string"><span class="delimiter">'</span><span class="content">road_id {} lane_id {} lane_offset {:.2f} s {:.2f}</span><span class="delimiter">'</span></span>.format(
    rm_pos_data.road_id, rm_pos_data.lane_id, rm_pos_data.lane_offset, rm_pos_data.s))

road_id = <span class="integer">1</span>
lane_id = <span class="integer">1</span>
lane_offset = -<span class="float">0.2</span>
s = <span class="integer">40</span>
rm.RM_SetLanePosition(rm_pos, road_id, lane_id, lane_offset, s)
rm.RM_GetPositionData(rm_pos, ct.byref(rm_pos_data))
print(<span class="string"><span class="delimiter">'</span><span class="content">x {:.2f} y {:.2f} h (yaw) {:.2f}</span><span class="delimiter">'</span></span>.format(
    rm_pos_data.x, rm_pos_data.y, rm_pos_data.h))</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_storyboard_element_state_callback">12.3.3. Storyboard element state callback</h4>
<div class="paragraph">
<p>The following code shows how to get notification of storyboard events using StoryBoardElementStateChangeCallback.</p>
</div>
<div class="listingblock">
<div class="title">Example 13. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/storyboard_state_callback.py">EnvironmentSimulator/code-examples/hello_world/storyboard_state_callback.py</a> (complete code)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Storyboard element types (see OSCTypeDefs/OSCAction.hpp)</span>
sbe_type = {
    <span class="integer">0</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">UNDEFINED_ELEMENT_TYPE</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">1</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">STORY</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">2</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">ACT</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">3</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">MANEUVER_GROUP</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">4</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">MANEUVER</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">5</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">EVENT</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">6</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">ACTION</span><span class="delimiter">&quot;</span></span>
}

<span class="comment"># Storyboard element states (see OSCTypeDefs/OSCAction.hpp)</span>
sbe_state = {
    <span class="integer">0</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">UNDEFINED_ELEMENT_STATE</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">1</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">STANDBY</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">2</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">RUNNING</span><span class="delimiter">&quot;</span></span>,
    <span class="integer">3</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">COMPLETE</span><span class="delimiter">&quot;</span></span>
}

<span class="comment"># Define callback for scenario storyboard element state changes</span>
<span class="comment"># according to function type: void (*fnPtr)(const char* name, int type, int state)</span>
<span class="comment"># required by SE_RegisterStoryBoardElementStateChangeCallback()</span>
<span class="keyword">def</span> <span class="function">callback</span>(name, <span class="predefined">type</span>, state):
    <span class="comment"># just print the received info</span>
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">callback: {} ({}) state: {}</span><span class="delimiter">&quot;</span></span>.format(codecs.decode(name), sbe_type[<span class="predefined">type</span>], sbe_state[state]))

callback_type = ct.CFUNCTYPE(<span class="predefined-constant">None</span>, ct.c_char_p, ct.c_int, ct.c_int)
callback_func = callback_type(callback)

<span class="comment"># Initialize esmini before register the callback</span>
se.SE_AddPath(<span class="binary"><span class="modifier">b</span><span class="delimiter">&quot;</span><span class="content">../../../resources/xosc</span><span class="delimiter">&quot;</span></span>)  <span class="comment"># search path if run from original location</span>
se.SE_Init(<span class="binary"><span class="modifier">b</span><span class="delimiter">&quot;</span><span class="content">../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">1</span>)

<span class="comment"># register the callback function</span>
se.SE_RegisterStoryBoardElementStateChangeCallback(callback_func)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_object_state_callback">12.3.4. Object state callback</h4>
<div class="paragraph">
<p><mark>Advanced</mark></p>
</div>
<div class="paragraph">
<p>Controllers and callbacks can also be utilized via Python. Following code drafts how to grab state of the first scenario object and then, in a callback, manipulate it and report back. If used in combination with ExternalController in mode=additive the scenario action are applied first. On the contrary, if used with mode=override, the scenario actions will not be applied giving exclusive control to the external callback function.</p>
</div>
<div class="listingblock">
<div class="title">Example 14. <a href="https://github.com/esmini/esmini/tree/master/EnvironmentSimulator/code-examples/hello_world/object_callback.py">EnvironmentSimulator/code-examples/hello_world/object_callback.py</a> (complete code)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="python"><span class="comment"># Definition of SE_ScenarioObjectState struct</span>
<span class="keyword">class</span> <span class="class">SEScenarioObjectState</span>(ct.Structure):
    _fields_ = [
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">model_id</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">control</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">timestamp</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">x</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">z</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">h</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">roadId</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">junctionId</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">t</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">laneId</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">laneOffset</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">s</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">speed</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">centerOffsetX</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">centerOffsetY</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">centerOffsetZ</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">width</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">length</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">height</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">objectType</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">objectCategory</span><span class="delimiter">&quot;</span></span>, ct.c_int),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">wheel_angle</span><span class="delimiter">&quot;</span></span>, ct.c_float),
        (<span class="string"><span class="delimiter">&quot;</span><span class="content">wheel_rot</span><span class="delimiter">&quot;</span></span>, ct.c_float),
    ]


<span class="comment"># Define callback for scenario object enabling manipulating the state AFTER scenario step but BEFORE OSI output</span>
<span class="comment"># Use in combination with ExternalController in mode=additive in order for scenario actions to be applied first</span>
<span class="keyword">def</span> <span class="function">callback</span>(state_ptr, b):
    state = state_ptr.contents
    print(<span class="string"><span class="delimiter">&quot;</span><span class="content">callback for obj {}: x={:.2f} y={:.2f} h={:.2f}</span><span class="delimiter">&quot;</span></span>.format(state.id, state.x, state.y, state.h))
    se.SE_ReportObjectPosXYH(ct.c_int(state.id), ct.c_float(state.timestamp), ct.c_float(state.x + <span class="float">0.02</span>), ct.c_float(state.y), ct.c_float(state.h + <span class="float">0.001</span>))

callback_type = ct.CFUNCTYPE(<span class="predefined-constant">None</span>, ct.POINTER(SEScenarioObjectState), ct.c_void_p)
callback_func = callback_type(callback)

<span class="comment"># Initialize esmini before register the callback</span>
se.SE_Init(<span class="binary"><span class="modifier">b</span><span class="delimiter">&quot;</span><span class="content">../../../resources/xosc/cut-in.xosc</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="integer">1</span>, <span class="integer">0</span>, <span class="integer">1</span>)

<span class="comment"># register callback for first object (id=0)</span>
se.SE_RegisterObjectCallback(<span class="integer">0</span>, callback_func, <span class="integer">0</span>)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_run_asam_openscenario_examples">13. Run ASAM OpenSCENARIO examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With some limitations (see details <a href="https://github.com/esmini/esmini/blob/master/osc_coverage.txt">here</a>) esmini can play the example scenarios provided with the ASAM OpenSCENARIO v1.1 release bundle.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you don&#8217;t have esmini already, download latest demo package for your platform from <a href="https://github.com/esmini/esmini/releases/latest">here</a>.</p>
</li>
<li>
<p>Download the standard from ASAM <a href="https://www.asam.net/standards/detail/openscenario">here</a> (register and download is free of charge).</p>
</li>
<li>
<p>Extract to any folder.</p>
</li>
<li>
<p>Run the examples from command line in esmini root folder, for example: <br>
<code>./bin/esmini --window 60 60 800 400 --osc ../../openscenario-v1.1.0/Examples/DoubleLaneChanger.xosc</code><br>
  or with absolute path: <br>
<code>./bin/esmini --window 60 60 800 400 --osc c:/stuff/openscenario-v1.1.0/Examples/DoubleLaneChanger.xosc</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_about_this_document">14. About this document</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://github.com/esmini/esmini/blob/user_guide/docs/user_guide.adoc">source</a> of this document is written in the <a href="https://asciidoc-py.github.io/index.html">asciidoc</a> format. The html is generated with <a href="https://asciidoctor.org/">asciidoctor</a>. Code snippets, images and other resources are included in the process. Also the version numbers are automatically inserted to avoid "human errors".</p>
</div>
<div class="paragraph">
<p>Install tools:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<strong>Linux</strong>
</td>
<td class="hdlist2">
<p><code>sudo apt install asciidoctor</code><br>
<code>sudo apt install ruby-coderay</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<strong>Windows</strong>
</td>
<td class="hdlist2">
<p>First, if not already done, install ruby: <a href="https://rubyinstaller.org/downloads/" class="bare">https://rubyinstaller.org/downloads/</a><br>
Then:<br>
<code>gem install asciidoctor</code><br>
<code>gem install coderay</code><br></p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Generate html: <code>asciidoctor user_guide.adoc</code></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_version">15. Version</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ESMINI_GIT_TAG="v2.26.7"<br>
ESMINI_GIT_REV="879eabc"</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-10-17 14:43:49 +0200
</div>
</div>
</body>
</html>